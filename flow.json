[{"id":"c8472726.d73988","type":"tab","label":"temp","disabled":false,"info":""},{"id":"9c8fbc42.476be","type":"tab","label":"Handover","disabled":false,"info":""},{"id":"d3e16de4.2262d","type":"tab","label":"Boilerplate","disabled":true,"info":""},{"id":"f65c1e1d.fa70b","type":"tab","label":"DialogFlow & Voice","disabled":true,"info":""},{"id":"9b782c32.24018","type":"subflow","name":"Customize Bot Name & Avatar","info":" - Drag and drop the node in the palette and link it to the inject node\n  - Customize the name and the avatar using the mxc link (learn how to get the mxc file link here: http://bit.ly/get-mxc-link)\n  - Deploy\n - Click on the inject node\n - You're done\n\n\n![enter image description here](https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/43081642120/original/3tP-QasxD7e45Ksr1-aQAK5lenHd-frAjw.gif?1572521514)","category":"tekos chatbot","in":[{"x":160,"y":140,"wires":[{"id":"a898ea71.7e6e28"}]}],"out":[{"x":1060,"y":140,"wires":[{"id":"236f611.2e7279e","port":0}]}],"env":[{"name":"NAME","type":"str","value":"","ui":{"icon":"font-awesome/fa-address-card-o","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"AVATAR","type":"str","value":"","ui":{"icon":"font-awesome/fa-user-circle","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"TEKOS_BOT_ID","type":"env","value":"TEKOS_BOT_ID","ui":{"icon":"font-awesome/fa-commenting-o","type":"input","opts":{"types":["str","env"]},"label":{}}},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"icon":"font-awesome/fa-wrench","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DEB887","icon":"font-awesome/fa-user-circle-o"},{"id":"c903f2e3.23631","type":"subflow","name":"Interaction Classifier","info":"[]()","category":"tekos chatbot","in":[{"x":50,"y":30,"wires":[{"id":"310baf0e.5aae9"}]}],"out":[{"x":520,"y":40,"wires":[{"id":"1c0562c4.cd6e1d","port":0}]},{"x":460,"y":200,"wires":[{"id":"15418071.8974f","port":0},{"id":"15418071.8974f","port":1}]},{"x":1100,"y":160,"wires":[{"id":"b8117a79.fd26f8","port":0},{"id":"b8117a79.fd26f8","port":1}]},{"x":300,"y":140,"wires":[{"id":"f2d831f7.46d79","port":0},{"id":"f2d831f7.46d79","port":1}]},{"x":1280,"y":340,"wires":[{"id":"b8117a79.fd26f8","port":3},{"id":"f8f9afaa.0dfdd","port":0}]}],"env":[{"name":"Bot","type":"env","value":"TEKOS_BOT_ID"},{"name":"Token","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"Bot_name","type":"env","value":"BOT_NAME"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DAC4B4","inputLabels":["Tekos in "],"outputLabels":["New Interaction","@Bot Direct message","Ditect message (user to bot)","file message","Pending STEP"],"icon":"font-awesome/fa-random"},{"id":"d0bf3750.bcab08","type":"subflow","name":"Human handover","info":"Human handover or takeover\nInvite a Human Operator to a discussion","category":"tekos chatbot","in":[{"x":40,"y":80,"wires":[{"id":"d776bb3b.1447b8"}]}],"out":[],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"icon":"font-awesome/fa-key","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"Operator","type":"str","value":"@","ui":{"icon":"font-awesome/fa-address-book","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#A6BBCF","icon":"font-awesome/fa-male"},{"id":"8e8615b6.018d08","type":"subflow","name":"Typing","info":"","category":"in progress","in":[{"x":60,"y":80,"wires":[{"id":"bd4a419b.9ca63"},{"id":"78c06e0c.1563a"}]}],"out":[{"x":702,"y":88,"wires":[{"id":"b193fa12.8c02d8","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"TEKOS_BOT_ID","type":"env","value":"TEKOS_BOT_ID"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DDAA99","icon":"node-red-contrib-credentials/credpass.png"},{"id":"1303f3a1.17536c","type":"subflow","name":"Tekos Segment API","info":"Use segmet.com to send User Data\nMore infos here:\nhttps://segment.com/docs/sources/server/http/","category":"in progress","in":[{"x":80,"y":80,"wires":[{"id":"e08f7a87.7731e8"}]}],"out":[{"x":500,"y":80,"wires":[{"id":"12b731b8.b6cb1e","port":0}]}],"env":[{"name":"EVENT","type":"str","value":"Create BOT","ui":{"icon":"font-awesome/fa-bolt","type":"select","opts":{"opts":[{"l":{"en-US":"Create Bot"},"v":"Create Bot"},{"l":{"en-US":"Fill chat form"},"v":"Fill chat form"},{"l":{"en-US":"Fill flow form"},"v":"Fill flow form"},{"l":{"en-US":"Update Billing Details"},"v":"Update Billing Details"},{"l":{"en-US":"Click Subcribe to Flow"},"v":"Click Subcribe to Flow"},{"l":{"en-US":"Subscribe to Flow"},"v":"Subscribe to Flow"},{"l":{"en-US":"Click Subcribe to Chat Client"},"v":"Click Subcribe to Chat Client"},{"l":{"en-US":"Subscribe to Chat Client"},"v":"Subscribe to Chat Client"},{"l":{"en-US":"Click Subcribe to Hosted HS"},"v":"Click Subcribe to Hosted HS"},{"l":{"en-US":"Subcribe to Hosted HS"},"v":"Subcribe to Hosted HS"},{"l":{"en-US":"Update Card"},"v":"Update Card"},{"l":{"en-US":"Cancel Flow Subscription"},"v":"Cancel Flow Subscription"},{"l":{"en-US":"Cancel Chat Client Subscription"},"v":"Cancel Chat Client Subscription"},{"l":{"en-US":"Cancel Hosted HS Subscription"},"v":"Cancel Hosted HS Subscription"},{"l":{"en-US":"Setup Flow"},"v":"Setup Flow"},{"l":{"en-US":"Setup Chat Client"},"v":"Setup Chat Client"},{"l":{"en-US":"Setup Hosted HS"},"v":"Setup Hosted HS"},{"l":{"en-US":"Talks to Tekos Bot"},"v":"Talks to Tekos Bot"}]},"label":{}}},{"name":"write_key","type":"str","value":"RUFRU2xLV05ZNVJTMDdUeUc1N1lxeU94czVmUFJYb3Y=","ui":{"label":{"en-US":"Write Key encoded"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#3FADB5","icon":"node-red/leveldb.png"},{"id":"b76049a1.e66408","type":"subflow","name":"Tekos only | get Customer","info":"get Customer","category":"Tekos Bot","in":[],"out":[{"x":1120,"y":520,"wires":[{"id":"1d8b4252.bc16ee","port":0}]},{"x":1300,"y":260,"wires":[{"id":"736d71b3.ef432","port":0}]},{"x":660,"y":240,"wires":[{"id":"b7573ec2.70683","port":0}]}],"env":[{"name":"stripe_test_key","type":"str","value":""},{"name":"stripe_prod_key","type":"str","value":""}],"color":"#D8BFD8","outputLabels":["customer found","no customer found","email not found"],"icon":"font-awesome/fa-dollar"},{"id":"c47f16f1.a03068","type":"subflow","name":"Stripe | Update Billing Details","info":"## Stripe customer's billing details\nThis node is essential for updating the billing details of a specific customers, this node take in params the roomId, and the customer email either by manualy setting it in the **environement variables** fields, or passing it directly in the payload data as in `msg.payload.email` for the customer email, and  `msg.payload.roomId` for the room id. after fetching the customer this node return a form with the billing details fields.\n","category":"Payment","in":[{"x":140,"y":160,"wires":[{"id":"5daec203.e47e8c"}]}],"out":[{"x":1032,"y":154,"wires":[{"id":"1faab047.78a39","port":0}]},{"x":1516,"y":330,"wires":[{"id":"26012ab.c1bf3d6","port":0},{"id":"c9041b65.cbff18","port":0},{"id":"4c8e1d7c.e95244","port":0}]}],"env":[{"name":"roomId","type":"str","value":"","ui":{"icon":"font-awesome/fa-comments-o","label":{"en-US":"Room Id"},"type":"input","opts":{"types":["str","env"]}}},{"name":"customer_email","type":"str","value":"","ui":{"icon":"font-awesome/fa-address-book-o","label":{"en-US":"Stripe Customer email"},"type":"input","opts":{"types":["str","env"]}}},{"name":"form_title","type":"str","value":"Update billing details","ui":{"icon":"font-awesome/fa-text-width","label":{"en-US":"Form Title text"},"type":"input","opts":{"types":["str","env"]}}},{"name":"form_button","type":"str","value":"Update","ui":{"icon":"font-awesome/fa-text-width","label":{"en-US":"Form Button text"},"type":"input","opts":{"types":["str","env"]}}}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/stripe.png"},{"id":"52c3ea26.423dc4","type":"subflow","name":"Tekos only | Create Bot (in progress) ","info":"ce noeud a besoin d'une mise a jours, le formulaire + url api ne fonctionne plus","category":"Tekos Bot","in":[{"x":284,"y":66,"wires":[{"id":"ddc21a3.fd3c7e8"}]}],"out":[{"x":482,"y":110,"wires":[{"id":"bb3ccebb.f89e4","port":0}]}],"env":[],"color":"#C0C0C0","icon":"node-red-dashboard/ui_slider.png"},{"id":"ec000337.2949e","type":"subflow","name":"Tekos only | get Customer's subscription","info":"","category":"Tekos Bot","in":[{"x":140,"y":260,"wires":[{"id":"10b6d8b.9fb5527"}]}],"out":[{"x":1208,"y":286,"wires":[{"id":"aa8d4cc4.f6d5a","port":0},{"id":"3f4206cb.39764a","port":0},{"id":"c3e74c5.3ed7fb","port":0}]}],"env":[{"name":"service","type":"str","value":"flow"},{"name":"stripe_test_key","type":"str","value":""},{"name":"stripe_prod_key","type":"str","value":""}],"color":"#D8BFD8","icon":"font-awesome/fa-dollar"},{"id":"36668667.1d6eea","type":"subflow","name":"Typing (in progress)","info":"","category":"in progress","in":[{"x":240,"y":160,"wires":[{"id":"796ee499.f69a3c"}]}],"out":[{"x":1000,"y":160,"wires":[{"id":"d8e4e866.a07188","port":0}]}],"env":[],"color":"#C7E9C0","icon":"font-awesome/fa-commenting-o"},{"id":"8b2c5df2.e16a3","type":"subflow","name":"Tekos Only | Success Checkout","info":"","category":"Tekos Bot","in":[{"x":260,"y":180,"wires":[{"id":"39bd2cf4.e0dbd4"}]}],"out":[{"x":840,"y":280,"wires":[{"id":"469485b.984e07c","port":0},{"id":"fc775646.aeff28","port":0}]},{"x":1140,"y":440,"wires":[{"id":"61a4d8f5.89a448","port":0}]}],"env":[{"name":"tax_rate","type":"env","value":"DEFAULT_TAX_RATE"}],"color":"#D8BFD8","inputLabels":["http response"],"outputLabels":["status response","customer data"],"icon":"font-awesome/fa-dollar"},{"id":"f36f07a7.353538","type":"subflow","name":"Subscription Plan","info":"","category":"Tekos Bot","in":[{"x":60,"y":80,"wires":[{"id":"95a765e2.25e548"}]}],"out":[{"x":540,"y":80,"wires":[{"id":"7c4cc6f.a237438","port":0}]}],"env":[{"name":"Title","type":"str","value":"Flow Subscription Plan"},{"name":"Subtitle","type":"str","value":"7 days free! then â‚¬39.00 / month"},{"name":"Image","type":"str","value":"https://m.tekos.co/_matrix/media/v1/download/m.tekos.co/ASqmvIGjLtJjvawlZTajaQWN"},{"name":"Call To Action","type":"str","value":"Subscribe Now"},{"name":"Learn More Label","type":"str","value":"Learn More"},{"name":"Learn More URL","type":"str","value":"https://tekos.co/flow/"},{"name":"Stripe Plan","type":"str","value":"plan_FONb5RvQ13r5Nv"}],"color":"#7bb1e8","icon":"font-awesome/fa-cart-plus"},{"id":"91f083d1.0d1a3","type":"subflow","name":"AWS Auto deploy FLOW","info":"","category":"Cloud","in":[{"x":240,"y":100,"wires":[{"id":"1cf896a5.cf94a9"}]}],"out":[{"x":380,"y":460,"wires":[{"id":"77684427.6705bc","port":0}]},{"x":380,"y":520,"wires":[{"id":"a024cf5b.0baa1","port":0}]}],"env":[{"name":"AMI","type":"str","value":"ami-02b29b2127225c5f8","ui":{"icon":"font-awesome/fa-key","label":{"en-US":"AMI id"},"type":"input","opts":{"types":["str"]}}},{"name":"subdomain","type":"str","value":""},{"name":"login","type":"str","value":""},{"name":"pwd","type":"str","value":""},{"name":"subscription","type":"str","value":""}],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"d97495d8.5a8468","type":"subflow","name":"AWS Auto deploy Client","info":"","category":"Cloud","in":[{"x":80,"y":60,"wires":[{"id":"10bf42fc.b7be5d"}]}],"out":[{"x":220,"y":420,"wires":[{"id":"76ef21ca.3eade","port":0}]},{"x":220,"y":500,"wires":[{"id":"10b43f98.3ad82","port":0}]},{"x":200,"y":580,"wires":[{"id":"dc3ad172.511d","port":0}]}],"env":[{"name":"subdomain","type":"str","value":"mydomaine"},{"name":"roomId","type":"str","value":""},{"name":"tekosID","type":"str","value":""},{"name":"taskDefinition","type":"json","value":"","ui":{"type":"input","opts":{"types":["json"]},"label":{}}},{"name":"AMI","type":"str","value":""}],"color":"#FFCC66","inputLabels":["data"],"outputLabels":["error","success",""],"icon":"font-awesome/fa-cloud-upload"},{"id":"93dbee73.58db9","type":"subflow","name":"Tekos Only | Create session","info":"","category":"Tekos Bot","in":[{"x":120,"y":100,"wires":[{"id":"370186f9.a4e62a"}]}],"out":[],"env":[{"name":"access_token","type":"str","value":""},{"name":"TaxRateDefault","type":"str","value":"txr_1F764zIWWPzbSFmKjRCP9TPy"},{"name":"TaxRateDefaultPourcentage","type":"str","value":"20"}],"color":"#D8BFD8","icon":"font-awesome/fa-dollar"},{"id":"4326faf3.398664","type":"subflow","name":"Depricated | Home Server form","info":"","category":"Depricated","in":[{"x":120,"y":100,"wires":[{"id":"775b23fd.204cfc"}]}],"out":[{"x":400,"y":100,"wires":[{"id":"775b23fd.204cfc","port":0}]}],"env":[],"color":"#da9"},{"id":"a628a20f.af3f1","type":"subflow","name":"Depricated | Delete Message (2)","info":"","category":"Depricated","in":[{"x":240,"y":100,"wires":[{"id":"839b6843.503d28"}]}],"out":[{"x":720,"y":140,"wires":[{"id":"38f6ac97.787fa4","port":0}]}],"env":[{"name":"eventId","type":"str","value":""},{"name":"roomId","type":"str","value":""},{"name":"access_token","type":"str","value":""}],"color":"#FF2B2B","icon":"font-awesome/fa-trash-o"},{"id":"c7e8665f.63e4d8","type":"subflow","name":"Tekos only | Send Subscription data To email","info":"","category":"Tekos Bot","in":[{"x":64,"y":220,"wires":[{"id":"69ba1cc6.bf29d4"}]}],"out":[],"env":[{"name":"email","type":"str","value":"","ui":{"icon":"font-awesome/fa-database","label":{"en-US":"Email"},"type":"input","opts":{"types":["str"]}}},{"name":"subscriptionId","type":"str","value":"","ui":{"icon":"font-awesome/fa-database","label":{"en-US":"Stripe Subscription Identifier"},"type":"input","opts":{"types":["str"]}}},{"name":"host","type":"str","value":"","ui":{"icon":"font-awesome/fa-database","label":{"en-US":"SMTP Host"},"type":"input","opts":{"types":["str"]}}},{"name":"port","type":"num","value":"","ui":{"icon":"font-awesome/fa-sort-numeric-asc","label":{"en-US":"SMTP Port"},"type":"input","opts":{"types":["num"]}}},{"name":"username","type":"str","value":"","ui":{"icon":"font-awesome/fa-user","label":{"en-US":"SMTP Username"},"type":"input","opts":{"types":["str"]}}},{"name":"password","type":"str","value":"","ui":{"icon":"font-awesome/fa-key","label":{"en-US":"SMTP Password"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#A6BBCF","icon":"node-red/envelope.svg"},{"id":"1a282f04.66edf1","type":"subflow","name":"Tekos only | Setup Flow Instance","info":"","category":"Cloud","in":[{"x":174,"y":88,"wires":[{"id":"9174eba5.38c318"}]}],"out":[{"x":680,"y":120,"wires":[{"id":"dbf8ceed.9061f","port":1}]},{"x":820,"y":400,"wires":[{"id":"c048fb11.9a5c68","port":1}]},{"x":1098,"y":440,"wires":[]},{"x":930,"y":482,"wires":[{"id":"80a7d4ee.0c4c88","port":0}]},{"x":922,"y":572,"wires":[{"id":"80a7d4ee.0c4c88","port":2}]},{"x":1142,"y":814,"wires":[{"id":"7102bf62.dcafe","port":0}]},{"x":988,"y":682,"wires":[{"id":"9d75862a.3568a8","port":0}]},{"x":658,"y":594,"wires":[]}],"env":[{"name":"stripe_test_token","type":"str","value":""},{"name":"stripe_prod_token","type":"str","value":""},{"name":"update_after_get","type":"str","value":""}],"color":"#FFCC66","outputLabels":["no customer by id","subscription token invalid","instance is already linked","error with service creation","subdomaine exist","error while updating subscription","success","start creating message"],"icon":"font-awesome/fa-cloud-upload"},{"id":"486d1d6e.dd5de4","type":"subflow","name":"Stripe | get customer by email","info":"## Get stripe customer by email\n\nThis node take in params the email of customers, then fetch its data in stripe and return an object if found, in order to setup this node you must either set the email of the customer manualy in the node itself or passed it as a `msg.payload.email` from another node.\n\n * input : customer's email.\n * output 1 : the customer's data.\n * output 2 : error in config or no customer found.","category":"Payment","in":[{"x":220,"y":120,"wires":[{"id":"f421e8da.b8b238"}]}],"out":[{"x":860,"y":80,"wires":[{"id":"c1d80c7c.33a6a","port":0}]},{"x":860,"y":140,"wires":[{"id":"c1d80c7c.33a6a","port":1},{"id":"54966e20.d225e","port":0}]}],"env":[{"name":"email","type":"str","value":"","ui":{"icon":"font-awesome/fa-envelope-o","label":{"en-US":"Customer's email"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#D8BFD8","inputLabels":["email"],"outputLabels":["success customer data","error "],"icon":"font-awesome/fa-user-circle"},{"id":"593d5f41.36fc8","type":"subflow","name":"Depricated | Website health check","info":"","category":"Depricated","in":[{"x":80,"y":220,"wires":[{"id":"f53ddc73.3070d"}]}],"out":[{"x":720,"y":160,"wires":[{"id":"72ced5d5.5e3e3c","port":0}]},{"x":700,"y":220,"wires":[{"id":"72ced5d5.5e3e3c","port":1},{"id":"72ced5d5.5e3e3c","port":2}]},{"x":340,"y":240,"wires":[{"id":"f53ddc73.3070d","port":1}]}],"env":[{"name":"subdomain","type":"str","value":"https://tekos.co/"}],"color":"#6FD36F","icon":"font-awesome/fa-feed"},{"id":"39b2c1f9.f0db8e","type":"subflow","name":"Stripe | Apply Tax rate %","info":"## Apply Tax Rate Node\nThis node is very usefull when dealing with a stripe subscription. adding tax can be somtimes mandatory in some european countries. This node take in parameters the data object of a subscription, we recomand using the **Get subscription by id** node, and the default tax rate in the params of this node.\n * input : subscription data.\n * output 1 : subscription data with tax rate.\n * output 2 : technical error or no tax rate found.\n","category":"Payment","in":[{"x":28,"y":132,"wires":[{"id":"3395fece.0bf232"}]}],"out":[{"x":825,"y":260,"wires":[{"id":"db4bcacb.b3c7a8","port":0}]},{"x":825,"y":320,"wires":[{"id":"db4bcacb.b3c7a8","port":1},{"id":"dbd3336d.48d72","port":0}]}],"env":[{"name":"subscriptionId","type":"str","value":""},{"name":"TaxRateDefault","type":"str","value":""}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"8ba283a9.d5f58","type":"subflow","name":"Stripe | get Customer by ID","info":"## Get stripe customer by id\n\nThis node take in params the id of customers, then fetch its data in stripe and return an object if found,this node is particularly usefull if you know in adance the id of the customer and its much faster then the **Stripe | get Customer by email** node.\n\nIn order to setup this node you must either set the id of the customer manualy in the node itself or passed it as a `msg.payload.id` or `msg.subscription.customer` from another node.\n\n * input : customer's id.\n * output 1 : the customer's data.\n * output 2 : error in config or no customer found.","category":"Payment","in":[{"x":200,"y":140,"wires":[{"id":"708e5817.c87968"}]}],"out":[{"x":840,"y":100,"wires":[{"id":"524666d5.4c2e88","port":0}]},{"x":856,"y":308,"wires":[{"id":"3c666965.d00e36","port":0}]}],"env":[{"name":"id","type":"str","value":"","ui":{"label":{"en-US":"Customer ID"},"type":"input","opts":{"types":["str","env"]}}}],"color":"#D8BFD8","icon":"font-awesome/fa-user-circle"},{"id":"c3e6c8de.a6ec88","type":"subflow","name":"get subscription by Id","info":"Tekos Only","category":"Tekos Bot","in":[{"x":180,"y":220,"wires":[{"id":"c281cc76.5b93e"}]}],"out":[{"x":922,"y":484,"wires":[{"id":"868ae420.fe9f68","port":0},{"id":"6cec33c.a1c67cc","port":0}]},{"x":880,"y":320,"wires":[{"id":"8bcb30f2.1ac88","port":1},{"id":"868ae420.fe9f68","port":1}]}],"env":[{"name":"update","type":"str","value":""}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/stripe.png"},{"id":"175e20fb.3d299f","type":"subflow","name":"Tekos Only | Get All Plans","info":"","category":"Tekos Bot","in":[{"x":40,"y":220,"wires":[{"id":"a3795a2e.62f288"}]}],"out":[{"x":940,"y":160,"wires":[{"id":"7432ceef.34e","port":0}]},{"x":700,"y":240,"wires":[{"id":"2eb3e15e.cf11de","port":1}]}],"env":[{"name":"product","type":"str","value":"prod_FONarRtDiOoUhI","ui":{"icon":"font-awesome/fa-clone","label":{"en-US":"Product Id"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"type","type":"str","value":"Flow","ui":{"label":{"en-US":"Type"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"Image","type":"str","value":"https://m.tekos.co/_matrix/media/v1/download/m.tekos.co/ASqmvIGjLtJjvawlZTajaQWN"},{"name":"callToAction","type":"str","value":"Subscribe"},{"name":"learnMoreLabel","type":"str","value":"See more"},{"name":"learnMoreURL","type":"str","value":"https://tekos.co/flow"},{"name":"Token","type":"env","value":"STRIPE_SEC_KEY"},{"name":"subscription","type":"str","value":"subscription"},{"name":"environement variable","type":"str","value":""}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"2e62cdcc.f5cc32","type":"subflow","name":"Tekos only | Update Credit card","info":"","category":"Tekos Bot","in":[{"x":152,"y":44,"wires":[{"id":"e7f92709.fa3768"}]}],"out":[{"x":1052,"y":372,"wires":[{"id":"5a8262fe.8875ac","port":0}]},{"x":1052,"y":416,"wires":[{"id":"5a8262fe.8875ac","port":1}]}],"env":[{"name":"mode","type":"str","value":"setup"},{"name":"post_url","type":"str","value":"","ui":{"icon":"font-awesome/fa-chevron-right","label":{"en-US":"Post url"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"1df83760.b275d9","type":"subflow","name":"Instance in progress","info":"","category":"Tekos Bot","in":[{"x":60,"y":140,"wires":[{"id":"40ccf97e.a39258"}]}],"out":[{"x":2242,"y":110,"wires":[{"id":"cd405a74.50bbd8","port":0}]}],"env":[{"name":"serviceType","type":"str","value":""}],"color":"#FFF0F0","icon":"node-red/timer.svg"},{"id":"1949f526.eab9eb","type":"subflow","name":"Tekos only | Cancel Subscription","info":"","category":"Tekos Bot","in":[{"x":320,"y":60,"wires":[{"id":"6a7de3d7.588b8c"}]}],"out":[{"x":1120,"y":260,"wires":[{"id":"9402ffb1.31f84","port":0}]},{"x":1020,"y":300,"wires":[{"id":"78489e9.24b2c6","port":0}]}],"env":[{"name":"subscription_Id","type":"str","value":""},{"name":"email","type":"str","value":"feedback@tekos.co"},{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"password","type":"str","value":"TekosChat2020!"}],"color":"#D8BFD8","icon":"font-awesome/fa-trash"},{"id":"d5c46538.c915f8","type":"subflow","name":"Hubspot | Get contact","info":"","category":"CRM","in":[{"x":50,"y":30,"wires":[{"id":"c6946236.48316"}]}],"out":[{"x":620,"y":40,"wires":[{"id":"3808528c.de8f8e","port":0}]},{"x":460,"y":180,"wires":[{"id":"e1f9849f.67ae98","port":0}]},{"x":460,"y":240,"wires":[{"id":"e1f9849f.67ae98","port":1}]}],"env":[{"name":"hubspot_api_key","type":"str","value":"","ui":{"label":{"en-US":"HS API Key"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"display_data","type":"str","value":"","ui":{"label":{"en-US":"Display data format"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#FFAAAA","icon":"node-red/leveldb.png"},{"id":"19a4ce64.de4022","type":"subflow","name":"Hubspot | Create Contact","info":"","category":"CRM","in":[{"x":50,"y":30,"wires":[{"id":"8facad14.07966"}]}],"out":[{"x":760,"y":240,"wires":[{"id":"ece26f27.14534","port":0}]},{"x":920,"y":300,"wires":[{"id":"7f5b02e8.1fa73c","port":0}]}],"env":[{"name":"hubspot_api_key","type":"str","value":""},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#FFAAAA","icon":"node-red/leveldb.png"},{"id":"4e3752b2.a4cf3c","type":"subflow","name":"ERPNext | Login","info":"","category":"in progress","in":[{"x":390,"y":120,"wires":[{"id":"3b0ddf52.2ee8c"}]}],"out":[{"x":980,"y":100,"wires":[{"id":"6fd8a2f.b91135c","port":0}]},{"x":980,"y":160,"wires":[{"id":"6fd8a2f.b91135c","port":1}]}],"env":[{"name":"ERP_BASE_URL","type":"str","value":"https://erp.tekos.co"},{"name":"LOGIN","type":"str","value":""},{"name":"PASSWORD","type":"str","value":""}],"color":"#5E64FF","icon":"node-red/leveldb.png"},{"id":"5b3f8201.182d5c","type":"subflow","name":"ERPNext | Create Lead","info":"","category":"in progress","in":[{"x":100,"y":160,"wires":[{"id":"339ef86b.df25e8"}]}],"out":[{"x":820,"y":120,"wires":[{"id":"9fd224fa.4d4628","port":0}]},{"x":820,"y":180,"wires":[{"id":"9fd224fa.4d4628","port":1}]}],"env":[{"name":"ERP_BASE_URL","type":"str","value":"https://erp.tekos.co"},{"name":"ERP_API_KEY","type":"str","value":"2ff1fef3b32e3cc"},{"name":"ERP_API_SEC","type":"str","value":"48da1f06f8426fb"}],"color":"#5E64FF","icon":"node-red/leveldb.png"},{"id":"855c2bc0.26c788","type":"subflow","name":"Add Step ","info":"","category":"Tekos Bot","in":[{"x":200,"y":100,"wires":[{"id":"527f55fd.153f2c"}]}],"out":[{"x":460,"y":80,"wires":[{"id":"527f55fd.153f2c","port":0},{"id":"527f55fd.153f2c","port":1}]},{"x":460,"y":140,"wires":[{"id":"527f55fd.153f2c","port":2}]}],"env":[{"name":"step","type":"str","value":"","ui":{"icon":"font-awesome/fa-bolt","label":{"en-US":"name of the step"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"value","type":"str","value":""}],"color":"#F3B567","icon":"node-red-contrib-tekosbot/chatbot-quick-replies.png"},{"id":"630c701f.59cde","type":"subflow","name":"Setup Chat Client Service","info":"","category":"Cloud","in":[{"x":740,"y":860,"wires":[{"id":"7b901635.678668"}]}],"out":[{"x":220,"y":800,"wires":[{"id":"e2dd8996.82dfd8","port":0}]},{"x":220,"y":860,"wires":[{"id":"6da157ab.6efde8","port":0}]},{"x":420,"y":800,"wires":[{"id":"becaba7.2a68548","port":0}]},{"x":420,"y":860,"wires":[{"id":"c4fe3545.a2f698","port":0}]},{"x":620,"y":800,"wires":[{"id":"234479d9.89bc86","port":0}]},{"x":620,"y":860,"wires":[{"id":"a9ac189c.82a388","port":0}]},{"x":820,"y":800,"wires":[{"id":"7926b0ae.bf113","port":0}]}],"env":[{"name":"titleform","type":"str","value":"Setup Client Instance","ui":{"label":{"en-US":"Form title"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"buttontitle","type":"str","value":"Create Instance","ui":{"label":{"en-US":"Button title"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#FFCC66","icon":"font-awesome/fa-cloud"},{"id":"ab0e04bf.0c2678","type":"subflow","name":"Update Client Service","info":"","category":"Cloud","in":[],"out":[{"x":900,"y":420,"wires":[]},{"x":1252,"y":572,"wires":[{"id":"22e9ad84.8030b2","port":1}]},{"x":1516,"y":572,"wires":[{"id":"3e9dfeea.edabf2","port":1}]},{"x":1538,"y":484,"wires":[{"id":"3e9dfeea.edabf2","port":0}]},{"x":900,"y":572,"wires":[{"id":"ba06fe98.c5b3f","port":1},{"id":"3b6824b2.eab00c","port":0}]}],"env":[{"name":"titleform","type":"str","value":"Update Client"},{"name":"buttontitle","type":"str","value":"Update"}],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"85c6ed92.daf94","type":"subflow","name":"Rasa NLP (Beta)","info":"","category":"in progress","in":[{"x":114.16670227050781,"y":150.0000114440918,"wires":[{"id":"b4f347ab.b64b38"}]}],"out":[{"x":624.1667022705078,"y":90.0000114440918,"wires":[{"id":"67882b69.714db4","port":0}]},{"x":984.1667022705078,"y":150.0000114440918,"wires":[{"id":"8dcc1d08.15d69","port":0}]}],"env":[{"name":"text","type":"str","value":"hello"},{"name":"url","type":"str","value":"http://ip:5005"},{"name":"user","type":"str","value":"userid"}],"color":"#FFAAAA","outputLabels":["Intent","Next Action"],"icon":"node-red/light.svg"},{"id":"941b9034.09257","type":"subflow","name":"File Upload Cloudinary (in progress)","info":"","category":"in progress","in":[{"x":140,"y":180,"wires":[{"id":"21234782.c72238"}]}],"out":[{"x":580,"y":180,"wires":[{"id":"901dc9ba.bb2268","port":0}]},{"x":420,"y":260,"wires":[{"id":"fa30f46e.d367c8","port":0}]}],"env":[{"name":"base_url","type":"env","value":"BASE_URL"},{"name":"cloudinary_cloud_name","type":"str","value":""},{"name":"cloudinary_upload_preset","type":"str","value":""},{"name":"post_url","type":"str","value":"/cloudinary"},{"name":"button_text","type":"str","value":"Upload Your File"},{"name":"flow_url","type":"env","value":"FLOW_URL"}],"color":"#A6BBCF","icon":"node-red/file-in.svg"},{"id":"11b3cac3.191255","type":"subflow","name":"Send a File (in progress)","info":"","category":"in progress","in":[{"x":40,"y":80,"wires":[{"id":"59f3dbad.703d24"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"ccf2bb15.472ad8","port":0}]}],"env":[{"name":"TOKEN","type":"str","value":""}],"color":"#D7D7A0","icon":"font-awesome/fa-file-text-o"},{"id":"9046be0b.a30f1","type":"subflow","name":"Get mxc link (in progress)","info":"","category":"in progress","in":[{"x":60,"y":80,"wires":[{"id":"4b6669bd.8320f8"}]}],"out":[{"x":540,"y":80,"wires":[{"id":"319f8d6c.e498a2","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"FILE_URL","type":"str","value":""},{"name":"content-type","type":"str","value":"","ui":{"type":"select","opts":{"opts":[{"l":{"en-US":"application/pdf"},"v":"application/pdf"},{"l":{"en-US":"audio/mp3"},"v":"audio/mp3"},{"l":{"en-US":"default-src 'none'"},"v":"default-src 'none'"},{"l":{"en-US":"script-src 'none'"},"v":"script-src 'none'"},{"l":{"en-US":"style-src 'unsafe-inline'"},"v":"style-src 'unsafe-inline'"},{"l":{"en-US":"object-src 'self'"},"v":"object-src 'self'"},{"l":{"en-US":"default-src 'none'"},"v":""}]}}}],"color":"#C0C0C0","icon":"node-red/cog.svg"},{"id":"509dfe6d.39977","type":"subflow","name":"Send Video","info":"Send a video to a room\n\nUse the MXC link and not a simple url\n\nses how to get the MXC link: [http://bit.ly/get-mxc-link](http://bit.ly/get-mxc-link)\n","category":"tekos chatbot","in":[{"x":100,"y":200,"wires":[{"id":"a3929fb3.32f98"}]}],"out":[{"x":600,"y":200,"wires":[{"id":"87b5ee2b.e9b5c","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"thumbnail_mxc","type":"str","value":""},{"name":"video_mxc","type":"str","value":""}],"color":"#E9967A","icon":"node-red-contrib-tekosbot/video.png"},{"id":"78fafaed.cd65d4","type":"subflow","name":"Send message","info":"Another way to send a simple message to the room","category":"tekos chatbot","in":[{"x":180,"y":260,"wires":[{"id":"88ba0759.b20fd8"}]}],"out":[{"x":640,"y":260,"wires":[{"id":"7780caf1.a6c774","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"message","type":"str","value":"Hey you ðŸ˜€ "}],"color":"#DAC4B4","icon":"node-red-contrib-tekosbot/chatbot-waiting.png"},{"id":"4f80bedc.87cfc","type":"subflow","name":"Formatted Text","info":"","category":"tekos chatbot","in":[{"x":40,"y":80,"wires":[{"id":"3df7a186.5c2fae"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"bc109ded.1396b","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"message","type":"str","value":"\"thinks <b>this</b> is an example emote\""}],"color":"#D7D7A0","icon":"node-red-contrib-tekosbot/chatbot-waiting.png"},{"id":"afeae1e.cea212","type":"subflow","name":"Send notice","info":"","category":"in progress","in":[{"x":108,"y":66,"wires":[{"id":"b8e88272.6715"}]}],"out":[{"x":504,"y":66,"wires":[{"id":"ec8893d0.f493a","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#C0DEED","icon":"node-red/alert.svg"},{"id":"3ec0df30.dbad9","type":"subflow","name":"Send Audio File (in progress)","info":"","category":"in progress","in":[{"x":60,"y":80,"wires":[{"id":"e8567378.843b3"}]}],"out":[{"x":580,"y":80,"wires":[{"id":"a1f18b27.f0be08","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#D7D7A0","icon":"font-awesome/fa-file-audio-o"},{"id":"7c18ea50.877574","type":"subflow","name":"Stripe | Request Payment","info":"","category":"in progress","in":[{"x":60,"y":80,"wires":[{"id":"cb9e42a6.99f19"}]}],"out":[{"x":920,"y":80,"wires":[{"id":"abfbecb2.c52ef","port":0}]}],"env":[{"name":"bot_token","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"stripe_token","type":"str","value":""},{"name":"cta_message","type":"str","value":""}],"color":"#DDAA99"},{"id":"2d963114.1a31fe","type":"subflow","name":"MovieDB","info":"","category":"in progress","in":[{"x":260,"y":120,"wires":[{"id":"f66ffec2.f0aef"}]}],"out":[{"x":900,"y":220,"wires":[{"id":"70563d49.3a7014","port":0}]}],"env":[{"name":"movie_db_key","type":"str","value":"e056ad6e7bd5444e2989d545d37a7003"}],"color":"#DDAA99"},{"id":"8059b36b.b7ac1","type":"subflow","name":"Trigger on deploy","info":"Use this Node to trigger an action when you deploy the flow","category":"common","in":[],"out":[{"x":340,"y":80,"wires":[{"id":"1f8b4d5e.4bac63","port":0}]}],"env":[],"color":"#E6E0F8","icon":"node-red-contrib-tekosbot/chatbot-quick-replies.png"},{"id":"63d4d540.a3421c","type":"subflow","name":"Pipedrive","info":"","category":"CRM","in":[{"x":40,"y":80,"wires":[{"id":"f33d5103.098ba"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"41979909.178918","port":0}]}],"env":[{"name":"pipedrive_api","type":"str","value":""}],"color":"#DDAA99","icon":"font-awesome/fa-address-book-o"},{"id":"d100d95f.692618","type":"subflow","name":"Manage my subscription","info":"","category":"","in":[{"x":103,"y":139,"wires":[{"id":"671f57ac.046e38"}]}],"out":[{"x":1100,"y":260,"wires":[{"id":"a7cfa0ad.e59c2","port":0},{"id":"d9dd1e2e.af604","port":0},{"id":"8afb3375.7eddd","port":0},{"id":"857696fc.882c08","port":0}]},{"x":809.9999980926514,"y":512.000020980835,"wires":[{"id":"d39dd740.4f02c8","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"label":{"en-US":"Tekos Bot Token"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"API_URL","type":"str","value":"ami.tekos.co","ui":{"label":{"en-US":"API Url"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"service","type":"str","value":"flow"},{"name":"STRIPE_SEC_KEY","type":"env","value":"STRIPE_SEC_KEY","ui":{"label":{"en-US":"Stripe Secret Key"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"email","type":"str","value":""},{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"username","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"callToAction","type":"str","value":"Annuler abonnement"},{"name":"API_URL","type":"env","value":"API_URL"}],"color":"#D8BFD8","outputLabels":["all subscription","Notification success"],"icon":"font-awesome/fa-eur"},{"id":"4ebcae91.b5489","type":"subflow","name":"Update billing details","info":"","category":"","in":[{"x":80,"y":480,"wires":[{"id":"299d3ea8.f5dd72"}]}],"out":[{"x":800,"y":160,"wires":[{"id":"db6aa7c1.713cf8","port":0}]},{"x":1060,"y":380,"wires":[{"id":"6c9b1f96.dd453","port":0},{"id":"88f7ea8a.90bcb8","port":0}]}],"env":[{"name":"STRIPE_SEC_KEY","type":"env","value":"STRIPE_SEC_KEY"},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"API_URL","type":"env","value":"FLOW_URL"}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"5e0c13c0.29fccc","type":"subflow","name":"Update Card (depricated)","info":"Let your users Update Their Payment Cards in your Stripe Account\n\n\nTo connect your stripe account and get your Stripe credentials, use this link\nhttp://bit.ly/tekos-connect-with-stripe\n\n\n\n---\n\n\nTEKOS_BOT_ID  (example: \"@my-bot:m.tekos.co\")\n\nBOT_NAME (example: \"my-bot\")\n\nFLOW_URL (example: \"https://myflow.tekos.co\")\n\nBASE_URL (example:\"https://m.tekos.co\")\n\nSTRIPE_PUB_KEY (example: \"pk_test_iM2cHoIPlKni69kx900zApvMqxD\")\n\nSTRIPE_SEC_KEY (example: \"sk_test_lfQauPCYWIRhS0DgNMNUN00NLLFrxrH\")\n\nAPI_URL  (example: /subscribe)","category":"Payment","in":[{"x":139.00000381469727,"y":55.000006675720215,"wires":[{"id":"5e0b953c.6303dc"}]}],"out":[{"x":1152.9999732971191,"y":274.00000762939453,"wires":[{"id":"ec6218e1.64b838","port":0}]}],"env":[{"name":"STRIPE_SEC_KEY","type":"env","value":"STRIPE_SEC_KEY","ui":{"label":{"en-US":"Stripe Token"}}},{"name":"API_URL","type":"env","value":"API_URL","ui":{"label":{"en-US":"Flow URL"}}},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"label":{"en-US":"Bot Token"}}},{"name":"STRIPE_PUB_KEY","type":"env","value":"STRIPE_PUB_KEY"},{"name":"CTA_BUTTON","type":"str","value":"Update My Card"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"CHAT_CLIENT_URL","type":"str","value":"CHAT_CLIENT_URL"}],"color":"#C0DEED","icon":"font-awesome/fa-credit-card"},{"id":"58396248.f6cb0c","type":"subflow","name":"Ask payment","info":"","category":"in progress","in":[{"x":400,"y":180,"wires":[]}],"out":[{"x":760,"y":160,"wires":[]}],"env":[{"name":"description","type":"str","value":"","ui":{"label":{"en-US":"Description"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"message","type":"str","value":"","ui":{"label":{"en-US":"Message"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"currency","type":"str","value":"EUR","ui":{"label":{"en-US":"Currency"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"price","type":"str","value":"","ui":{"label":{"en-US":"Price"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"pay_button_text","type":"str","value":"","ui":{"label":{"en-US":"Pay Button Text"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"collect_billing_details","type":"bool","value":"true","ui":{"label":{"en-US":"Collect Billing details"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"collect_shipping_address","type":"bool","value":"true","ui":{"label":{"en-US":"Collect Shipping address"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"27aa6202.673c3e","type":"subflow","name":"PipeDrive | Receive Notifications","info":"# 1-Set The webhook\n - Go to Pipedrive Settings, Webhook\n - Choose the  Events that you need to receive\n - Add the webhook url yourtekosflow/pipedrive\n - Add your login and credentials to securise http calls\n\n\n# 2-Create the Bot\n - Create a Bot (for free) using tekos-bot by follwoing this link: [http://bit.ly/create-bot](http://bit.ly/create-bot)\n - Optional: Customize your bot [See how](http://bit.ly/customize-bot)\n\n\n# 3-Connect your bot\n3-Go to your tekos flow instance\nGrab teh PipeDrive | Receive Event Node, link it to your\nAdd bot credentials in Tekos-In\nChoose the room where you need to receive your notifications\n\n\n\n\nUpdated\nLast values (barrÃ©) new value\n\n![](https://i.imgur.com/Sd0Iyt8.png)","category":"CRM","in":[],"out":[{"x":1120,"y":360,"wires":[{"id":"ee7f8179.22d99","port":0}]}],"env":[{"name":"URL","type":"str","value":"/pipedrive"}],"color":"#b9b5bd","icon":"font-awesome/fa-rouble"},{"id":"7c9e2fef.b50e7","type":"subflow","name":"Send Image","info":"Send an image to a room\n\nUse the MXC link and not a simple url\n\nses how to get the MXC link: http://bit.ly/get-mxc-link","category":"tekos chatbot","in":[{"x":50,"y":30,"wires":[{"id":"d9f274ef.a78b28"}]}],"out":[{"x":551.9999847412109,"y":69.00000190734863,"wires":[{"id":"c8ff8afd.5b0628","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"MXC_URL","type":"str","value":""}],"color":"#C0DEED","icon":"font-awesome/fa-image"},{"id":"b2a24cf1.c0661","type":"subflow","name":"Zendesk [ Get Notifications","info":"Go to Zendesk - Webhooks\n\nexemple :https://tekos1.atlassian.net/plugins/servlet/webhooks\n\nAdd the Link:\nTHIS_FLOW_LINK/zendesk\n\nhttps://apps.flock.com/manage/d2c880fb-5fc0-420d-b031-22af6dd8e336/new?flockValidationToken=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhcHBJZCI6ImQyYzg4MGZiLTVmYzAtNDIwZC1iMDMxLTIyYWY2ZGQ4ZTMzNiIsInVzZXJJZCI6InU6MWRyYTFyM3p6ODE5MzAwOSIsImV4cCI6MTU2MzkxNDgyNCwiaWF0IjoxNTYzMzEwMDI0LCJqdGkiOiI5NjIwYjNhOS03ODkzLTQxODktOGI1NS1hMDk0YjVlYjM5MzIifQ.D2EePLXxomd1anpZW6tLCE9MsCZ4K4oUtYS6UQIDY4E&flockEvent=N.A.","category":"","in":[],"out":[{"x":922.4999504089355,"y":99.9999942779541,"wires":[{"id":"4e48b343.fd7e8c","port":0}]}],"env":[],"color":"#A6BBCF","icon":"font-awesome/fa-bug"},{"id":"b92299a8.9af4c8","type":"subflow","name":"Trello (In progress)","info":"","category":"","in":[{"x":195.8333282470703,"y":84.99999809265137,"wires":[{"id":"f5c1e9e0.e3aed8"}]}],"out":[{"x":1104.999994277954,"y":70.00000095367432,"wires":[{"id":"4c7a8993.9015f8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"8a95edf0.1b4f","type":"subflow","name":"Bitbucket In progress","info":"","category":"","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"aab9f259.38912","type":"subflow","name":"Jira | Get Notifications (in progress)","info":"","category":"","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"3ac7a168.cf0ebe","type":"subflow","name":"Movie DB (In progress)","info":"","category":"","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"726321c4.c8126","type":"subflow","name":"ERPNext-Create Lead","info":"","category":"in progress","in":[{"x":223.99999618530273,"y":205.99999523162842,"wires":[{"id":"82f8f6bd.c311e8"}]}],"out":[{"x":657.9999847412109,"y":186.9999942779541,"wires":[{"id":"a92ee034.ed868","port":0}]}],"env":[{"name":"ERP_BASE_URL","type":"str","value":"https://erp.tekos.co"},{"name":"Lead_Name","type":"str","value":""}],"color":"#DDAA99"},{"id":"fb951c08.dec1a","type":"subflow","name":"ERPNext | Login (2)","info":"","category":"in progress","in":[{"x":86.00000190734863,"y":97.00000190734863,"wires":[{"id":"89bc5a8f.82f788"}]}],"out":[{"x":539.9999842643738,"y":90.00000190734863,"wires":[{"id":"4cc292ce.dc607c","port":0}]}],"env":[{"name":"LOGIN","type":"str","value":""},{"name":"PASSWORD","type":"str","value":""},{"name":"ERP_BASE_URL","type":"str","value":"https://erp.tekos.co"}],"color":"#DDAA99"},{"id":"b3e3278d.3ca678","type":"subflow","name":"Send Email  Notification SUB","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"367bb60e.f4b54a"}]}],"out":[],"env":[{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"username","type":"str","value":""},{"name":"password","type":"str","value":""}],"color":"#C7E9C0","icon":"node-red/envelope.svg"},{"id":"f05d1061.cd31d","type":"subflow","name":"Https request Template","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"7951f7b7.d83bf8"}]}],"out":[{"x":636.9999847412109,"y":71.00000095367432,"wires":[{"id":"52800a3c.025804","port":0}]}],"env":[],"color":"#D7D7A0","icon":"font-awesome/fa-chain"},{"id":"989c64eb.c70dc8","type":"subflow","name":"TEKOS | Stripe Connect","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"c2339fd4.02bba"}]}],"out":[{"x":576.9999842643738,"y":75.00000190734863,"wires":[{"id":"465ad5ae.8bb57c","port":0}]}],"env":[{"name":"STRIPE_SEC_KEY","type":"env","value":"STRIPE_SEC_KEY","ui":{"icon":"font-awesome/fa-key","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"CODE","type":"str","value":""}],"color":"#C0DEED","icon":"font-awesome/fa-key"},{"id":"4456c207.c3886c","type":"subflow","name":"HubSpot","info":"","category":"in progress","in":[],"out":[],"env":[{"name":"action","type":"str","value":""},{"name":"hubspot_api_key","type":"str","value":""}],"color":"#9ccc65","icon":"node-red/leveldb.png"},{"id":"9b71ec4c.36fb6","type":"subflow","name":"Set User Attribute (community)","info":"","category":"","in":[{"x":440,"y":240,"wires":[{"id":"d0efa9d.e066358"}]}],"out":[{"x":800,"y":240,"wires":[{"id":"d0efa9d.e066358","port":0}]}],"env":[{"name":"Context","type":"str","value":"","ui":{"type":"select","opts":{"opts":[{"l":{"en-US":"Entertainment"},"v":"entertainment"},{"l":{"en-US":"Shopping"},"v":"shopping"},{"l":{"en-US":"Car"},"v":"car"}]},"label":{}}},{"name":"Variable Name","type":"str","value":"","ui":{"type":"select","opts":{"opts":[{"l":{"en-US":"Color"},"v":"color"},{"l":{"en-US":"Living City"},"v":"living_city"}]},"label":{}}},{"name":"Value","type":"str","value":""}],"color":"#DDAA99"},{"id":"64469bd7.645c44","type":"subflow","name":"Connect with Stripe","info":"","category":"Tekos Bot","in":[{"x":283.00000953674316,"y":115.0000057220459,"wires":[{"id":"54603ba0.be07b4"}]}],"out":[{"x":1508.9999618530273,"y":50,"wires":[{"id":"2c8a55b8.eeddfa","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#DDAA99"},{"id":"4162450a.10e46c","type":"subflow","name":"Send Quotation","info":"","category":"","in":[],"out":[{"x":483,"y":307,"wires":[{"id":"3a3e1b3b.28c964","port":0}]}],"env":[{"name":"email","type":"str","value":""},{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"password","type":"str","value":""}],"color":"#FFAAAA","icon":"node-red/parser-csv.svg"},{"id":"a8e33d40.895b1","type":"subflow","name":"Hubspot | Create contact","info":"","category":"CRM","in":[{"x":352,"y":152,"wires":[{"id":"c77bccb8.85f93"}]}],"out":[{"x":1193,"y":308,"wires":[{"id":"cf9f2756.eac818","port":0}]},{"x":1194,"y":362,"wires":[{"id":"c51a92d6.c8e2d","port":0}]}],"env":[{"name":"hubspot_api_key","type":"str","value":""},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#FA7820","icon":"node-red/leveldb.png"},{"id":"442c770f.96d248","type":"subflow","name":"Send Email with file attached","info":"","category":"","in":[{"x":137,"y":142,"wires":[{"id":"577f3838.949218"}]}],"out":[{"x":498,"y":257,"wires":[{"id":"460a19a9.b9f758","port":0}]}],"env":[{"name":"email","type":"str","value":"feedback@tekos.co"},{"name":"host","type":"str","value":"smtp.mail.eu-west-1.awsapps.com"},{"name":"username","type":"str","value":"feedback@tekos.co"},{"name":"password","type":"str","value":""},{"name":"port","type":"str","value":"465"}],"color":"#C7E9C0","icon":"node-red/envelope.svg"},{"id":"107afeb.05c3601","type":"subflow","name":"Set Room Attribute","info":"","category":"","in":[{"x":50,"y":30,"wires":[]}],"out":[{"x":409.00001525878906,"y":76.00000095367432,"wires":[]}],"env":[{"name":"variable","type":"str","value":""},{"name":"value","type":"str","value":""}],"color":"#DDAA99"},{"id":"242600cf.12cc","type":"subflow","name":"Invite User to a Room","info":"Use this Node in order to get Invited to a room with the user and initiate a direct conversation with him","category":"tekos chatbot","in":[{"x":50.00000190734863,"y":78.00000190734863,"wires":[{"id":"eb24d868.c862e8"}]}],"out":[{"x":526.9999847412109,"y":76.00000190734863,"wires":[{"id":"a7b6ccea.1e6b3","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"Operator","type":"str","value":"","ui":{"label":{"en-US":"User ID"}}},{"name":"ROOM","type":"str","value":"","ui":{"label":{"en-US":"Room ID"}}}],"color":"#DEB887","icon":"font-awesome/fa-address-book-o"},{"id":"82767481.508078","type":"subflow","name":"Hubspot | Receive Notif (in progress)","info":"","category":"in progress","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"fde10ab5.552fe8","type":"subflow","name":"Interaction Classifier (2)","info":"[]()","category":"tekos chatbot","in":[{"x":50,"y":30,"wires":[{"id":"1a1a7f05.afa3f1"}]}],"out":[{"x":684.0000190734863,"y":40.00001335144043,"wires":[{"id":"9ccfba7e.4cba88","port":0}]},{"x":460,"y":200,"wires":[{"id":"ad7d2657.a3c398","port":0},{"id":"ad7d2657.a3c398","port":1}]},{"x":1100,"y":160,"wires":[{"id":"23b18362.81f1cc","port":0},{"id":"23b18362.81f1cc","port":1}]},{"x":300,"y":140,"wires":[{"id":"8ff0b37c.f47e9","port":0},{"id":"8ff0b37c.f47e9","port":1}]},{"x":1280,"y":340,"wires":[{"id":"23b18362.81f1cc","port":3},{"id":"d531bdd3.97c5c","port":0}]},{"x":482,"y":88,"wires":[{"id":"2bb14ec8.9fd482","port":1}]}],"env":[{"name":"Bot","type":"env","value":"TEKOS_BOT_ID"},{"name":"Token","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"Bot_name","type":"env","value":"BOT_NAME"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DAC4B4","inputLabels":["Tekos in "],"outputLabels":["New Interaction","@Bot Direct message","Ditect message (user to bot)","file message","Pending STEP"],"icon":"font-awesome/fa-random"},{"id":"af0345b1.7c4e78","type":"subflow","name":"Dashbot | User message","info":"Send data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()","category":"Analytics","in":[{"x":120,"y":120,"wires":[{"id":"ce906c7.5f25f9"}]}],"out":[{"x":700,"y":100,"wires":[{"id":"96e114ac.503328","port":0}]}],"env":[{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"45e63626.6388b8","type":"subflow","name":"Dashbot | Bot response","info":"Send data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()","category":"Analytics","in":[{"x":50,"y":30,"wires":[{"id":"4e7c77fc.e4b3a8"}]}],"out":[{"x":620,"y":80,"wires":[{"id":"2aa23085.8afea","port":0}]}],"env":[{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#A6BBCF","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"491f6cec.662034","type":"subflow","name":"Dashbot | Track Event","info":"\nSend data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()\n\n[https://www.dashbot.io/docs/universal/generic-events/]()","category":"Analytics","in":[{"x":160,"y":220,"wires":[{"id":"7d78bc33.d01994"}]}],"out":[{"x":680,"y":220,"wires":[{"id":"28b7f8ff.b20778","port":0}]}],"env":[{"name":"EVENT_NAME","type":"str","value":""},{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#AAAA66","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"1a61712.53a9c8f","type":"subflow","name":"Stripe | get Subscription by Id","info":"## Get stripe subscription by id\n\nThis node take in params the id of subscription, then fetch its data in stripe and return an object if found.\n\nIn order to setup this node you must either set the id of the subscription manualy in the node itself or passed it as a `msg.payload.subscription` from another node.\n\n * input : subscription's id.\n * output 1 : the subscription's data.\n * output 2 : error in config or no subscription found.","category":"Payment","in":[{"x":240,"y":160,"wires":[{"id":"7cc79323.dcf43c"}]}],"out":[{"x":1020,"y":100,"wires":[{"id":"5270c291.0a357c","port":0}]},{"x":1020,"y":180,"wires":[{"id":"5270c291.0a357c","port":1}]}],"env":[{"name":"id","type":"str","value":""}],"color":"#D8BFD8","inputLabels":["id"],"outputLabels":["subscription data","no subscription found"],"icon":"font-awesome/fa-eur"},{"id":"a5fd4a6.61c2bb8","type":"subflow","name":"Stripe | get plans by product","info":"## Get All Plans by product\nThis node is used to get all plans under one specific product, you must have one or more plans under your product in order to show the plans cards. this nodes take in parameter the **plan id** only via the param field.\n\n * input : product id.\n * output 1 : json data of cards\n * output 2 : error","category":"Payment","in":[{"x":180,"y":180,"wires":[{"id":"68af5b2d.765564"}]}],"out":[{"x":1060,"y":140,"wires":[{"id":"67b1c959.f85038","port":0}]},{"x":840,"y":180,"wires":[{"id":"df5fea8e.0620f8","port":1}]}],"env":[{"name":"product","type":"str","value":"","ui":{"icon":"font-awesome/fa-cart-plus","label":{"en-US":"Stripe Product Id"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"Image","type":"str","value":"","ui":{"icon":"font-awesome/fa-image","label":{"en-US":"Card image Url"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"callToAction","type":"str","value":"","ui":{"label":{"en-US":"Action text"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"learnMoreLabel","type":"str","value":"","ui":{"label":{"en-US":"Button url text"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"learnMoreURL","type":"str","value":"","ui":{"label":{"en-US":"Second button url"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"44ce6d7c.a949d4","type":"subflow","name":"Update Flow Template","info":"","category":"Cloud","in":[{"x":152,"y":88,"wires":[{"id":"bae8c2bb.53675"}]}],"out":[],"env":[{"name":"subdomaine","type":"str","value":""},{"name":"login","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"template","type":"json","value":"[{\"id\":\"abdf3af3.bc3ea8\",\"type\":\"chatbot-text\",\"z\":\"e08e8c1f.dcb8c\",\"name\":\"\",\"message\":[\"\"],\"x\":290,\"y\":180,\"wires\":[[\"df3bcf64.089f8\"]]},{\"id\":\"6586cd6.b8cfd34\",\"type\":\"inject\",\"z\":\"e08e8c1f.dcb8c\",\"name\":\"\",\"topic\":\"\",\"payload\":\"\",\"payloadType\":\"date\",\"repeat\":\"\",\"crontab\":\"\",\"once\":false,\"onceDelay\":0.1,\"x\":100,\"y\":180,\"wires\":[[\"abdf3af3.bc3ea8\"]]},{\"id\":\"df3bcf64.089f8\",\"type\":\"chatbot-generic-card\",\"z\":\"e08e8c1f.dcb8c\",\"name\":\"\",\"title\":\"\",\"subtitle\":\"\",\"imageUrl\":\"\",\"theme\":\"\",\"sharable\":true,\"aspectRatio\":\"horizontal\",\"buttons\":[],\"x\":460,\"y\":200,\"wires\":[[]]}]"}],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"9b2392b3.300b4","type":"subflow","name":"Segment.com | Send Event","info":"Use segmet.com to send User Data\nMore infos here:\nhttps://segment.com/docs/sources/server/http/","category":"Analytics","in":[{"x":100,"y":80,"wires":[{"id":"58eebebc.649af"}]}],"out":[{"x":500,"y":80,"wires":[{"id":"a5d251fb.142d9","port":0}]}],"env":[{"name":"write_key","type":"str","value":"","ui":{"label":{"en-US":"Write Key encoded"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"EVENT","type":"str","value":"","ui":{"label":{"en-US":"Event"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#87A980","icon":"font-awesome/fa-database"},{"id":"6ec18374.f95cdc","type":"subflow","name":"Save User Attribute","info":"The attributes service is essentially a simple key/value store.\n\nIt allows you to keep track of any attribute (for example, a name, age, or preference).\n\nPlace this node before the bot question if you need to store the user reponse as the attribute value (like shown in the image).\n\nOtherwise, you can set the attribute and it's value whenever you need.\n\n\n\n\n![Attrbites & steps](https://i.imgur.com/Vkq5abQ.png)","category":"tekos chatbot","in":[{"x":160,"y":140,"wires":[{"id":"62cd8a0f.e2c444"}]}],"out":[{"x":440,"y":80,"wires":[{"id":"62cd8a0f.e2c444","port":0},{"id":"62cd8a0f.e2c444","port":1}]},{"x":440,"y":160,"wires":[{"id":"62cd8a0f.e2c444","port":2}]}],"env":[{"name":"step","type":"str","value":"","ui":{"label":{"en-US":"Attribute"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"value","type":"str","value":"","ui":{"label":{"en-US":"Value"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#FFCC66","icon":"font-awesome/fa-universal-access"},{"id":"927e6891.b73778","type":"subflow","name":"Set a STEP","info":"With STEPs you can prevent the user reponse to be passed throw the switch command or the NLP process.\n\nIn a user flow, is the attribute STEP exists, it can have only one value and it is ephemerical.\nWhen a pending Step Pass throw the 'Interaction classifier' Node, it disappean, unliess to call it again before a user response.\n\nThink of them as virtual checkpoints for where the user is within the conversational structure.\n\n\n\nhere is an example of setting a\n![Attributes & steps](https://i.imgur.com/Joigul5.png)\n\n\n![Attributes & steps](https://i.imgur.com/ixnD63S.png)\n\n\n\n![Attributes & steps](https://i.imgur.com/x1aj61B.png)\n\n\n","category":"tekos chatbot","in":[{"x":220,"y":160,"wires":[{"id":"752cecd6.dc4e44"}]}],"out":[{"x":500,"y":100,"wires":[{"id":"752cecd6.dc4e44","port":0},{"id":"752cecd6.dc4e44","port":1}]},{"x":500,"y":160,"wires":[{"id":"752cecd6.dc4e44","port":2}]}],"env":[{"name":"step","type":"str","value":"STEP","ui":{"type":"hide"}},{"name":"value","type":"str","value":"","ui":{"label":{"en-US":"Step Name"}}}],"color":"#E9967A","icon":"font-awesome/fa-bookmark"},{"id":"19938199.71aa0e","type":"subflow","name":"Get All plans (in progress)","info":"","category":"","in":[{"x":60,"y":160,"wires":[{"id":"8d5f4c49.03a97"}]}],"out":[{"x":920,"y":120,"wires":[{"id":"d4630e4c.d5f91","port":0}]},{"x":700,"y":160,"wires":[{"id":"1c231884.d7cee7","port":1}]}],"env":[{"name":"Image","type":"str","value":""},{"name":"callToAction","type":"str","value":"Subscribe"},{"name":"learnMoreLabel","type":"str","value":"See more"},{"name":"learnMoreURL","type":"str","value":"https://tekos.co/flow"},{"name":"Token","type":"env","value":"$STRIPE_SEC_KEY"},{"name":"subscription","type":"str","value":"test"},{"name":"product","type":"str","value":"prod_Dn6TpmOtL6te1v"},{"name":"callToActionURL","type":"str","value":"node-dev.tekos.co"}],"color":"#D8BFD8","icon":"font-awesome/fa-eur"},{"id":"884a2e0c.927b5","type":"subflow","name":"Create Tekos  Server","info":"","category":"Cloud","in":[{"x":280,"y":60,"wires":[{"id":"7b74e0be.604d5"}]}],"out":[{"x":620,"y":60,"wires":[{"id":"6cc1fdc4.9b9424","port":0}]},{"x":614,"y":110,"wires":[{"id":"fcdadb4c.375ca8","port":0}]}],"env":[{"name":"buttontitle","type":"str","value":"Setup service "},{"name":"titleform","type":"str","value":"Setup Server Instant"},{"name":"host","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"email","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"emailTo","type":"str","value":"ayoub@tekos.co,feedback@tekos.co"}],"color":"#FFCC66","outputLabels":["success data","error"],"icon":"font-awesome/fa-cloud"},{"id":"be1c0cd4.343a2","type":"subflow","name":"AWS | create tekos server","info":"","category":"Cloud","in":[{"x":100,"y":80,"wires":[{"id":"9dde0d15.38594"}]}],"out":[{"x":673,"y":572,"wires":[{"id":"c00756ae.cc6d18","port":0}]},{"x":497,"y":572,"wires":[{"id":"1352e2de.c0241d","port":0}]}],"env":[],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"4f8bc972.b172e8","type":"subflow","name":"Get user ","info":"This node take in params the senderId and the roomID, and send back as response the global data\n- if the senderId or the roomId are missing , the output 1 return an empty payload with an error result.\n- if the senderId exist but no global data is found, the node create a new global data and assign it to the sender user.\n- if the senderId exist and the global data exist, the node return a success response with the data as a pyload.","category":"Tekos Bot","in":[{"x":86,"y":198,"wires":[{"id":"8ac25811.4a8e28"}]}],"out":[{"x":438,"y":44,"wires":[{"id":"2d6adbe0.ddf1f4","port":0}]},{"x":658,"y":44,"wires":[{"id":"7dd51b6.6f069e4","port":0}]}],"env":[{"name":"uniqueId","type":"str","value":"001","ui":{"icon":"font-awesome/fa-key","label":{"en-US":"Unique ID"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#9ccc65","inputLabels":["senderId + roomId"],"outputLabels":["global data","missing params"],"icon":"font-awesome/fa-user-circle-o"},{"id":"ed261d7.da9a4e","type":"subflow","name":"Event Subscription","info":"Use this node to subscribe to events in your room\nWire with tekos In as an input","category":"","in":[{"x":218,"y":198,"wires":[{"id":"4dae2ab1.e19be4"}]}],"out":[],"env":[{"name":"Events to Send:","type":"str","value":"","ui":{"type":"none","label":{},"opts":{}}},{"name":"new room created","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-plus-circle","label":{"en-US":"new_interaction"},"type":"checkbox","opts":{}}},{"name":"direct_message","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-comment-o","label":{"en-US":"direct message"},"type":"checkbox","opts":{}}},{"name":"public_message","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-comments-o","label":{"en-US":"message in public"},"type":"checkbox","opts":{}}},{"name":"file","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-file-text","type":"checkbox","label":{},"opts":{}}},{"name":"URL","type":"str","value":"https://","ui":{"icon":"font-awesome/fa-arrow-circle-right","label":{"en-US":"Send to https"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#C0DEED","inputLabels":["wire with Tekos In"],"icon":"node-red/arrow-in.svg"},{"id":"fc68b1d2.502e3","type":"subflow","name":"Incoming Webhook","info":"Wire with Tekos out\nYou need to specify a room when you want to send data ","category":"","in":[],"out":[{"x":350,"y":132,"wires":[{"id":"d99f0aa2.a1f348","port":0}]}],"env":[{"name":"endpoint","type":"str","value":"","ui":{"label":{"en-US":"endpoint:  flowurl/"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#F3B567","outputLabels":["wire with Tekos Out"],"icon":"node-red/status.svg"},{"id":"200a81ed.31baee","type":"subflow","name":"Tekos only | setup homeserver instance","info":"","category":"","in":[{"x":218,"y":44,"wires":[{"id":"97dc2b1.72077d8"}]}],"out":[{"x":768,"y":44,"wires":[{"id":"fb955f17.af02","port":0}]},{"x":570,"y":44,"wires":[{"id":"793dee29.c4fc3","port":0}]}],"env":[],"color":"#FFCC66","inputLabels":["subscription"],"outputLabels":["success","error"],"icon":"font-awesome/fa-cloud-upload"},{"id":"6b38c6c9.48c0b8","type":"subflow","name":"Alert Instance Error","info":"","category":"alert","in":[{"x":350,"y":66,"wires":[{"id":"89fc5d1e.4f3ef"}]}],"out":[],"env":[{"name":"email","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"host","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"username","type":"str","value":""}],"color":"#FFAAAA","inputLabels":["error"],"icon":"node-red/alert.svg"},{"id":"9ba31db0.f17c6","type":"subflow","name":"Deploy from github repo","info":"","category":"","in":[{"x":240,"y":110,"wires":[{"id":"6a319e59.ecc12"}]}],"out":[{"x":871,"y":418,"wires":[{"id":"dded6fa9.c4b1a","port":0}]},{"x":1032,"y":418,"wires":[{"id":"7370a59b.acee6c","port":0}]},{"x":680,"y":198,"wires":[{"id":"5ebae68.ae9e018","port":0}]}],"env":[{"name":"repo","type":"str","value":""}],"color":"#C0C0C0","inputLabels":["github link"],"outputLabels":["cards data","error ","raw data"],"icon":"node-red/parser-html.svg"},{"id":"5f9338e7.a36538","type":"subflow","name":"AWS Auto deploy flow 0.2","info":"","category":"Cloud","in":[{"x":86,"y":132,"wires":[{"id":"dbef7d4e.bbd14"}]}],"out":[{"x":152,"y":462,"wires":[{"id":"a0974875.480ff8","port":0}]},{"x":152,"y":528,"wires":[{"id":"91a9983b.9958d8","port":0}]},{"x":966,"y":110,"wires":[{"id":"c1511b.34fa6ee8","port":0}]}],"env":[],"color":"#FFCC66","icon":"font-awesome/fa-cloud-upload"},{"id":"1cd6648d.066dfb","type":"subflow","name":"Legacy code","info":"","category":"","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"1a407cf6.6df0d3","type":"subflow","name":"Redeem Coupon Code","info":"","category":"","in":[],"out":[{"x":1230,"y":440,"wires":[{"id":"c0fa14c0.6644a8","port":0}]},{"x":1054,"y":572,"wires":[{"id":"c8f74eda.4e1aa","port":0}]}],"env":[{"name":"couponId","type":"str","value":""}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/stripe.png"},{"id":"30517ddd.9e4af2","type":"subflow","name":"Send Email","info":"","category":"","in":[{"x":306,"y":154,"wires":[{"id":"8c7f6e81.a0be8"}]}],"out":[],"env":[{"name":"email","type":"str","value":""},{"name":"host","type":"str","value":""},{"name":"username","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"body","type":"str","value":""},{"name":"topic","type":"str","value":""},{"name":"email_to","type":"str","value":""}],"color":"#C7E9C0","icon":"node-red/envelope.svg"},{"id":"b7373e2f.2c979","type":"subflow","name":"Event Subscription (2)","info":"Use this node to subscribe to events in your room\nWire with tekos In as an input","category":"","in":[{"x":218,"y":198,"wires":[{"id":"4e7ba963.eaba78"}]}],"out":[],"env":[{"name":"Events to Send:","type":"str","value":"","ui":{"type":"none","label":{},"opts":{}}},{"name":"new room created","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-plus-circle","label":{"en-US":"new_interaction"},"type":"checkbox","opts":{}}},{"name":"direct_message","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-comment-o","label":{"en-US":"direct message"},"type":"checkbox","opts":{}}},{"name":"public_message","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-comments-o","label":{"en-US":"message in public"},"type":"checkbox","opts":{}}},{"name":"file","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-file-text","type":"checkbox","label":{},"opts":{}}},{"name":"URL","type":"str","value":"https://","ui":{"icon":"font-awesome/fa-arrow-circle-right","label":{"en-US":"Send to https"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#C0DEED","inputLabels":["wire with Tekos In"],"icon":"node-red/arrow-in.svg"},{"id":"bc6f16b.09d1fe8","type":"subflow","name":"Force Handover","info":"","category":"","in":[{"x":50,"y":30,"wires":[{"id":"b54cbd61.6dfc4"}]}],"out":[{"x":504,"y":88,"wires":[{"id":"75128efd.040b4","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DDAA99"},{"id":"a4d54f7c.548f2","type":"subflow","name":"Send notice (2)","info":"","category":"in progress","in":[{"x":108,"y":66,"wires":[{"id":"2b03c3d7.901d2c"}]}],"out":[{"x":504,"y":66,"wires":[{"id":"28e4ceee.c274b2","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#C0DEED","icon":"node-red/alert.svg"},{"id":"bb6828.189d77d8","type":"subflow","name":"Stripe | get Customer by ID (2)","info":"## Get stripe customer by id\n\nThis node take in params the id of customers, then fetch its data in stripe and return an object if found,this node is particularly usefull if you know in adance the id of the customer and its much faster then the **Stripe | get Customer by email** node.\n\nIn order to setup this node you must either set the id of the customer manualy in the node itself or passed it as a `msg.payload.id` or `msg.subscription.customer` from another node.\n\n * input : customer's id.\n * output 1 : the customer's data.\n * output 2 : error in config or no customer found.","category":"Payment","in":[{"x":200,"y":140,"wires":[{"id":"15ef4d28.1fc163"}]}],"out":[{"x":840,"y":100,"wires":[{"id":"1383a220.9cd8ee","port":0}]},{"x":856,"y":308,"wires":[{"id":"2f3d89a6.551446","port":0}]}],"env":[{"name":"id","type":"str","value":"","ui":{"label":{"en-US":"Customer ID"},"type":"input","opts":{"types":["str","env"]}}}],"color":"#D8BFD8","icon":"font-awesome/fa-user-circle"},{"id":"ac552099.592a9","type":"subflow","name":"Interaction Classifier (3)","info":"[]()","category":"tekos chatbot","in":[{"x":50,"y":30,"wires":[{"id":"ab655128.36fb3"}]}],"out":[{"x":684.0000190734863,"y":40.00001335144043,"wires":[{"id":"aab8ef5e.6e8c6","port":0}]},{"x":460,"y":200,"wires":[{"id":"6daaded9.8115e","port":0},{"id":"6daaded9.8115e","port":1}]},{"x":1100,"y":160,"wires":[{"id":"e81ac4d8.35d6f8","port":0},{"id":"e81ac4d8.35d6f8","port":1}]},{"x":300,"y":140,"wires":[{"id":"d4d94fb6.9eff5","port":0},{"id":"d4d94fb6.9eff5","port":1}]},{"x":1280,"y":340,"wires":[{"id":"e81ac4d8.35d6f8","port":3},{"id":"ee5939c2.18fbf8","port":0}]},{"x":482,"y":88,"wires":[{"id":"6346f6d5.5bf068","port":1}]}],"env":[{"name":"Bot","type":"env","value":"TEKOS_BOT_ID"},{"name":"Token","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"Bot_name","type":"env","value":"BOT_NAME"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DAC4B4","inputLabels":["Tekos in "],"outputLabels":["New Interaction","@Bot Direct message","Ditect message (user to bot)","file message","Pending STEP"],"icon":"font-awesome/fa-random"},{"id":"1c882a73.955f76","type":"subflow","name":"Send message (2)","info":"Another way to send a simple message to the room","category":"tekos chatbot","in":[{"x":180,"y":260,"wires":[{"id":"82acc61f.e3f268"}]}],"out":[{"x":640,"y":260,"wires":[{"id":"500a0b64.708ce4","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"message","type":"str","value":"Hey you ðŸ˜€ "},{"name":"ROOM_ID","type":"str","value":""}],"color":"#DAC4B4","icon":"node-red-contrib-tekosbot/chatbot-waiting.png"},{"id":"fc05d259.ac9b1","type":"subflow","name":"Hubspot | Get contact (2)","info":"","category":"CRM","in":[{"x":50,"y":30,"wires":[{"id":"f22245a8.7d42d8"}]}],"out":[{"x":620,"y":40,"wires":[{"id":"5f68010b.30daa","port":0}]},{"x":460,"y":180,"wires":[{"id":"5d20e2be.019a3c","port":0}]},{"x":460,"y":240,"wires":[{"id":"5d20e2be.019a3c","port":1}]}],"env":[{"name":"hubspot_api_key","type":"str","value":"","ui":{"label":{"en-US":"HS API Key"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"display_data","type":"str","value":"","ui":{"label":{"en-US":"Display data format"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#FFAAAA","icon":"node-red/leveldb.png"},{"id":"468ab68b.786be8","type":"subflow","name":"Hubspot | Create contact (2)","info":"","category":"CRM","in":[{"x":211,"y":229,"wires":[{"id":"e5e6d606.317378"}]}],"out":[{"x":1032,"y":185,"wires":[{"id":"e7dfcf35.0f3a4","port":0},{"id":"4fc83f66.db4bd","port":0}]},{"x":1033,"y":239,"wires":[{"id":"1b020433.5b363c","port":0}]}],"env":[{"name":"hubspot_api_key","type":"str","value":""},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#FA7820","icon":"node-red/leveldb.png"},{"id":"6cd522e2.9c8dbc","type":"subflow","name":"Rasa NLP (Beta) (2)","info":"","category":"in progress","in":[{"x":114.16670227050781,"y":150.0000114440918,"wires":[{"id":"178b6186.51f52e"}]}],"out":[{"x":624.1667022705078,"y":90.0000114440918,"wires":[{"id":"a49c0336.4b3a6","port":0}]},{"x":984.1667022705078,"y":150.0000114440918,"wires":[{"id":"263b82ca.50281e","port":0}]}],"env":[{"name":"text","type":"str","value":"hello"},{"name":"url","type":"str","value":"http://ip:5005"},{"name":"user","type":"str","value":"userid"}],"color":"#FFAAAA","outputLabels":["Intent","Next Action"],"icon":"node-red/light.svg"},{"id":"9bb5c266.46852","type":"subflow","name":"Dashbot | Track Event (2)","info":"\nSend data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()\n\n[https://www.dashbot.io/docs/universal/generic-events/]()","category":"Analytics","in":[{"x":160,"y":220,"wires":[{"id":"9bcff59e.d53358"}]}],"out":[{"x":680,"y":220,"wires":[{"id":"227a71f9.71414e","port":0}]}],"env":[{"name":"EVENT_NAME","type":"str","value":""},{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#AAAA66","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"dc10e8d0.e82a98","type":"subflow","name":"Dashbot | Bot response (2)","info":"Send data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()","category":"Analytics","in":[{"x":50,"y":30,"wires":[{"id":"f98da3d9.1e47e"}]}],"out":[{"x":620,"y":80,"wires":[{"id":"35268b24.e697e4","port":0}]}],"env":[{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#A6BBCF","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"bed1da1b.ae0d78","type":"subflow","name":"Dashbot | User message (2)","info":"Send data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()","category":"Analytics","in":[{"x":120,"y":120,"wires":[{"id":"6ff20347.42a9bc"}]}],"out":[{"x":700,"y":100,"wires":[{"id":"ea6f3361.8cbdb","port":0}]}],"env":[{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"d8e00d64.8e54c","type":"subflow","name":"Human handover (2)","info":"Human handover or takeover\nInvite a Human Operator to a discussion","category":"tekos chatbot","in":[{"x":40,"y":80,"wires":[{"id":"6be03d85.45c5a4"}]}],"out":[{"x":520,"y":80,"wires":[{"id":"c7b4251.e4577d8","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"icon":"font-awesome/fa-key","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"Operator","type":"str","value":"@","ui":{"icon":"font-awesome/fa-address-book","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#A6BBCF","icon":"font-awesome/fa-male"},{"id":"c8082d07.b6dbe","type":"subflow","name":"Typing (2)","info":"Place the typing node just before the interaction node, like text node.\nThe typing time is arount 2s but you can modify that value inside the subflow\n\n![](https://i.imgur.com/ymFjS3b.png)\n","category":"in progress","in":[{"x":60,"y":80,"wires":[{"id":"8e3f6844.bef968"}]}],"out":[{"x":926,"y":80,"wires":[{"id":"ce6ac7e2.adaae8","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"TEKOS_BOT_ID","type":"env","value":"TEKOS_BOT_ID"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#96ceb4","icon":"font-awesome/fa-commenting-o"},{"id":"b82a5682.8ae7c8","type":"subflow","name":"Subflow 1","info":"","category":"","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"536ddfdb.b102e","type":"subflow","name":"Whois","info":"https://matrix.org/docs/spec/client_server/latest#get-matrix-client-r0-admin-whois-userid\n\nGets information about a particular user.\n\nThis API may be restricted to only be called by the user being looked up, or by a server admin. Server-local administrator privileges are not specified in this document.","category":"","in":[{"x":40,"y":80,"wires":[{"id":"328575b7.e586ea"}]}],"out":[{"x":660,"y":80,"wires":[{"id":"ba6d2b8b.2a0d88","port":0}]},{"x":940,"y":140,"wires":[{"id":"64e3a4f.3f90d5c","port":0}]}],"env":[{"name":"token","type":"str","value":"MDAxOGxvY2F0aW9uIG0udGVrb3MuY28KMDAxM2lkZW50aWZpZXIga2V5CjAwMTBjaWQgZ2VuID0gMQowMDJjY2lkIHVzZXJfaWQgPSBAbWlsZWQuZXNzYWFmaTptLnRla29zLmNvCjAwMTZjaWQgdHlwZSA9IGFjY2VzcwowMDIxY2lkIG5vbmNlID0gSFkxLWRyNkt-QC5xLUlRQwowMDJmc2lnbmF0dXJlINjYbSD0CBv1Ir8GOEJRezbnAA3cXoL0EVjeW2dXb2TlCg"},{"name":"user","type":"str","value":"@miled.essaafi:m.tekos.co"}],"color":"#3FADB5","icon":"font-awesome/fa-universal-access"},{"id":"be6d1230.c6132","type":"subflow","name":"tag","info":"","category":"","in":[{"x":40,"y":80,"wires":[{"id":"594616c4.142e48"}]}],"out":[{"x":520,"y":80,"wires":[{"id":"8fa013a1.c0816","port":0}]}],"env":[{"name":"token","type":"str","value":""},{"name":"user","type":"str","value":""},{"name":"room","type":"str","value":""},{"name":"tag","type":"str","value":"work"}],"color":"#DDAA99"},{"id":"d0a9b04.8c7f35","type":"tekos bot","z":"","name":"Your Bot","room":"","userId":"${TEKOS_BOT_ID}","accessToken":"${TEKOS_BOT_TOKEN}","matrixServerURL":"https://m.tekos.co"},{"id":"e65bbf12.d7e23","type":"tekos bot","z":"","name":"Your Bot","room":"","userId":"${TEKOS_BOT_ID}","accessToken":"${TEKOS_BOT_TOKEN}","matrixServerURL":"https://m.tekos.co"},{"id":"4fe304a9.fffffc","type":"dialogflowv2-token","z":"","name":"Tekos Bot AI"},{"id":"a898ea71.7e6e28","type":"function","z":"9b782c32.24018","name":"Change name","func":"msg.url = \"https://\"+env.get('BASE_URL')+'/_matrix/client/r0/profile/' + env.get('TEKOS_BOT_ID')+ '/displayname?access_token='+ env.get('TEKOS_BOT_TOKEN')\nmsg.payload={\n\n  \"displayname\": env.get('NAME')\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["9cc5f0d9.833e4","a1eeb86a.c4b7e8"]]},{"id":"9cc5f0d9.833e4","type":"http request","z":"9b782c32.24018","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":540,"y":140,"wires":[["96eb5745.d5c468"]]},{"id":"96eb5745.d5c468","type":"function","z":"9b782c32.24018","name":"change avatar","func":"msg.url = \"https://\"+env.get('BASE_URL')+'/_matrix/client/r0/profile/' + env.get('TEKOS_BOT_ID')+ '/avatar_url?access_token='+ env.get('TEKOS_BOT_TOKEN')\nmsg.payload={\n\n  \"avatar_url\": env.get('AVATAR')\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":140,"wires":[["236f611.2e7279e"]]},{"id":"236f611.2e7279e","type":"http request","z":"9b782c32.24018","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":910,"y":140,"wires":[[]]},{"id":"a1eeb86a.c4b7e8","type":"debug","z":"9b782c32.24018","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":420,"y":200,"wires":[]},{"id":"c9ca20d4.5ab4b","type":"function","z":"c903f2e3.23631","name":"Get members","func":"msg.url = env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/joined_members?access_token=\"+env.get('Token')\nmsg.payload={\n\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":240,"wires":[["fb346326.266b1"]]},{"id":"fb346326.266b1","type":"http request","z":"c903f2e3.23631","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":610,"y":240,"wires":[["4cfa4afc.bb2644"]]},{"id":"4cfa4afc.bb2644","type":"function","z":"c903f2e3.23631","name":"calculate member's nb","func":"\nvar joined = Object.keys(msg.payload.joined).length;\n\nif(joined == 1){\n    msg.payload = msg.messageContent;\n    return [msg,null,null];\n    \n}else if(joined == 2){\n    msg.payload = msg.messageContent;\n    return [null,msg,null];\n}else{\n    return [null,null,msg];\n}\n\nreturn msg;","outputs":3,"noerr":0,"x":800,"y":240,"wires":[["b8117a79.fd26f8"],["b8117a79.fd26f8"],[]],"icon":"font-awesome/fa-thumbs-o-down"},{"id":"310baf0e.5aae9","type":"switch","z":"c903f2e3.23631","name":"New Interaction ?","property":"room","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":147.99998092651367,"y":83.99998664855957,"wires":[["1c0562c4.cd6e1d"],["f2d831f7.46d79"]],"outputLabels":["","existing interaction"]},{"id":"1c0562c4.cd6e1d","type":"function","z":"c903f2e3.23631","name":"Set Room ID","func":"msg.roomId= msg.room\nreturn msg;","outputs":1,"noerr":0,"x":367.9999809265137,"y":43.99998664855957,"wires":[[]],"outputLabels":["new room"]},{"id":"15418071.8974f","type":"function","z":"c903f2e3.23631","name":"is Dierct message (@bot) ***?","func":"\nvar str = msg.event.event.content.formatted_body;\nvar strmobile = msg.event.event.content.body;\nvar bot = env.get(\"Bot\");\nvar botname = env.get(\"Bot_name\");\nvar strtxt =   msg.payload;\n\nif(str){\n    if(str.includes(bot)){\n        strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[msg,null,null]\n    }\n   \n}else if(strmobile.includes(botname)){\n     strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[null,msg,null]\n    \n}\n\nelse{\n    \n    return[null,null,msg]\n}\nreturn msg;","outputs":3,"noerr":0,"x":210,"y":220,"wires":[[],[],["c9ca20d4.5ab4b"]],"icon":"node-red/switch.svg"},{"id":"f2d831f7.46d79","type":"switch","z":"c903f2e3.23631","name":"","property":"event.event.content.msgtype","propertyType":"msg","rules":[{"t":"eq","v":"m.image","vt":"str"},{"t":"eq","v":"m.file","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":160,"y":154,"wires":[[],[],["15418071.8974f"]]},{"id":"53e95569.8d44dc","type":"link out","z":"c903f2e3.23631","name":"","links":["f746daac.f89698"],"x":1215,"y":260,"wires":[]},{"id":"f746daac.f89698","type":"link in","z":"c903f2e3.23631","name":"","links":["53e95569.8d44dc"],"x":95,"y":320,"wires":[["cf6894d7.bf2a58"]]},{"id":"cf6894d7.bf2a58","type":"function","z":"c903f2e3.23631","name":"pending step found ! ","func":"\nvar data = global.get(msg.roomXD);\nvar pending = data.pendingstep;\n\ndata[pending] = msg.payload;\ndelete data.pendingstep;\nglobal.set(msg.roomXD,data);\n\n\nmsg.step = pending;\nmsg.stepcontent = msg.payload;\n\n\n data = global.get(msg.roomXD);\n\n \n \nif(data[\"STEP\"] && data.hasOwnProperty(data[\"STEP\"])){\n    data = global.get(msg.roomXD);\n    delete data[\"STEP\"];\n    global.set(msg.roomXD,data);\n}\n\n\n\nif(data.STEP){\n        msg.currentstep = data.STEP\n\n         return[msg,null]; // 4\n    }else{\n        return [null,msg];\n    }\n","outputs":2,"noerr":0,"x":255,"y":320,"wires":[["95ebb8cd.1d2b88"],[]]},{"id":"4ba330e7.cf224","type":"debug","z":"c903f2e3.23631","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":470,"y":360,"wires":[]},{"id":"b8117a79.fd26f8","type":"function","z":"c903f2e3.23631","name":"pending step ?","func":"var roomId = msg.roomId;\nroomId= roomId.substr(0, roomId.indexOf(':'));\nif(!global.get(roomId)){\n    return[msg,null,null,null]; // 1\n}else{\n    \n    var data = global.get(roomId);\n    if(data.pendingstep){\n        msg.roomXD = roomId;\n        return [null,null,msg,null]; // 3\n    }else if(data.STEP){\n        msg.roomXD = roomId;\n        msg.currentstep = data.STEP\n         return[null,null,null,msg]; // 4\n    }else{\n   return[null,msg,null,null]; // 2\n\n    }\n}\n\nreturn msg;","outputs":4,"noerr":0,"x":1040,"y":240,"wires":[[],[],["53e95569.8d44dc"],[]],"icon":"node-red/switch.svg"},{"id":"95ebb8cd.1d2b88","type":"link out","z":"c903f2e3.23631","name":"","links":["f8f9afaa.0dfdd"],"x":415,"y":300,"wires":[]},{"id":"f8f9afaa.0dfdd","type":"link in","z":"c903f2e3.23631","name":"","links":["95ebb8cd.1d2b88"],"x":1215,"y":380,"wires":[[]]},{"id":"d776bb3b.1447b8","type":"function","z":"d0bf3750.bcab08","name":"Invite operator","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/invite?access_token=\"+env.get('TOKEN')\nmsg.payload={\n\n  \"user_id\": env.get('Operator')\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["c775e47c.7583d8"]]},{"id":"c775e47c.7583d8","type":"http request","z":"d0bf3750.bcab08","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":370,"y":80,"wires":[[]]},{"id":"d6bd158d.a5c8d8","type":"link in","z":"d3e16de4.2262d","name":"","links":["7129bcbb.f56c34","3cdfa08e.fc078","77fcc078.c5fe8","d6f8779d.3b3c08","26f871a0.d51a3e"],"x":835,"y":140,"wires":[["14005589.bf4baa"]]},{"id":"c587ada8.d9216","type":"Tekos out","z":"d3e16de4.2262d","name":"","bot":"d0a9b04.8c7f35","x":528,"y":206,"wires":[]},{"id":"fd6b03a.c82cb","type":"link out","z":"d3e16de4.2262d","name":"","links":["c6f8f4da.9e7748"],"x":333,"y":209,"wires":[]},{"id":"49271507.a3b45c","type":"link out","z":"d3e16de4.2262d","name":"start","links":["8df6dd96.80c0a"],"x":417,"y":281,"wires":[],"info":"Link to onbording interaction"},{"id":"8df6dd96.80c0a","type":"link in","z":"d3e16de4.2262d","name":"","links":["49271507.a3b45c","a9b2b029.a75cd"],"x":735,"y":320,"wires":[["26eb71c5.4ecabe"]]},{"id":"26eb71c5.4ecabe","type":"chatbot-text","z":"d3e16de4.2262d","name":"Onbording","message":[{"message":"Hello, Iâ€™m a Poilerplate Template Bot. I try to be helpful. (But Iâ€™m still just a bot. Sorry!) ðŸ˜ƒ "}],"x":894,"y":320,"wires":[["9425227e.dd923","53ac0585.64bf3c"]]},{"id":"9425227e.dd923","type":"link out","z":"d3e16de4.2262d","name":"","links":["b2125002.06a3a","4b5a232d.4e28fc"],"x":1021,"y":298,"wires":[]},{"id":"b2125002.06a3a","type":"link in","z":"d3e16de4.2262d","name":"TekosOut","links":["ba7ce9c5.aace78","923ede14.711d3","c289f688.6131d8","79844ae8.305824","9425227e.dd923","48323382.384d2c","80533fcd.c4ae","2e1a67fc.b5ab68","efb78ffa.795f8","9780b1b7.e2d35","8e9b8033.42b7c","7b50f906.830de8","6019764.b9ad088","8b833035.834ae","700965d3.e3fc2c","76c70e2e.71396","4a48a08.e900e6","3b135afa.ba9bf6","24642811.787118","26d91ab7.570356","20f06907.6962d6","65c21c4.f4044e4","8ac227d9.f65d88","13e693de.0ee42c","9f869059.7c014","346e2f7.6bf54d","3db9cb7.b2f4634","713a3fcd.c7fc7","ab6c884f.043998","7252c493.fa00ac","423e6837.667528","15c7555f.ea072b","8799b02c.bda23","e53db452.889128","45d8540d.9a258c","6ca1f2b4.965cdc","51c72751.af9c98","ef8cca20.204848","b6e1939b.f46d7","f562994f.47a488","b25dd224.8228d","848f70f5.b68ac","a753e9ea.8444c8","81f0e039.d0f74","7099eedf.f10f8","bc08308.6e726d","c9ea4cfb.7ba2f","5e9741e3.6dba6","5ca430e.c5866d","7aa2a2d8.8f825c","c4b32145.88b71","bdb94b32.4b2fb8","2c497986.4142e6","c5beba23.690178","916779f.feda788","21467d5e.ba91c2","59272024.cd32d","e2f3679e.be80f8","bd82a545.71abd8","4a9437e7.f8a038","51a60ec1.588d9","48bfa5f4.246bac","4687b71b.7fa6c8","b597d08e.b0c7b","7929bcde.f77764","5f599e01.38c13","4e83ab52.51dc84","c1ea86ab.91c628","44e53416.2e89ac","5d5fa886.29ed58","cc222265.74ade","4e19994d.993458","6984a4b2.93847c","ab4f8c9e.bed59","ead22a8f.61ee18","70a1a76a.2b8798","7cdc912b.354f7","50c864e9.ce303c","e8cbf7c5.403728","cc443cb8.660f4","e4c49a5c.8a3048","6b94e86b.aeafe8","6daca5bf.0593ec","e5cad6e2.4463c8","df8e0a7e.4bb988","5e47bffc.f3b84","c03ca3ea.235ab","ae2c2da.9b56bd","254660ac.f08bf","fccb2d1f.89853","3f1936ea.e961ca","37b977be.ac61d8","6c0d248.5f710dc","2fca68ac.5552c8","79fb66e7.342ff8","56ea3968.841bf8"],"x":417,"y":208,"wires":[["c587ada8.d9216"]]},{"id":"348a3826.462898","type":"chatbot-generic-buttons","z":"d3e16de4.2262d","name":"Menu","buttons":[{"type":"postback","label":"Action 1","value":"action 1","alert":false},{"type":"url","label":"Visit Support Center","url":"https://tekos.freshdesk.com/a/solutions/articles/43000542170"}],"message":"Plans: ","x":1170,"y":140,"wires":[["c289f688.6131d8","4be672ff.2d05fc"]]},{"id":"c289f688.6131d8","type":"link out","z":"d3e16de4.2262d","name":"","links":["b2125002.06a3a"],"x":1255,"y":100,"wires":[]},{"id":"948ea8c5.85ac08","type":"switch","z":"d3e16de4.2262d","name":"onbording","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"menu","vt":"str"},{"t":"eq","v":"services","vt":"str"},{"t":"eq","v":"start","vt":"str"},{"t":"eq","v":"talk to human","vt":"str"},{"t":"eq","v":"Contact Support","vt":"str"},{"t":"cont","v":"deploy template","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":7,"x":352,"y":756,"wires":[["3cdfa08e.fc078"],["3cdfa08e.fc078"],["a9b2b029.a75cd"],["f5119b17.40b3f8"],["f5119b17.40b3f8"],["648e4b20.f00c34"],["cda6ea71.6b54a8"]]},{"id":"41e3fa30.873a84","type":"link in","z":"d3e16de4.2262d","name":"","links":["5893370.a6ee9c8"],"x":703,"y":668,"wires":[["d9dcc619.8a1fd8"]]},{"id":"d9dcc619.8a1fd8","type":"chatbot-text","z":"d3e16de4.2262d","name":"Fallback","message":[{"message":"DÃ©solÃ© je n'ai pas compris votre message ðŸ˜ƒ"},{"message":"Je suis encore un bot"}],"x":814,"y":666,"wires":[["923ede14.711d3"]]},{"id":"923ede14.711d3","type":"link out","z":"d3e16de4.2262d","name":"","links":["b2125002.06a3a"],"x":918.0000286102295,"y":666.0000896453857,"wires":[]},{"id":"77fcc078.c5fe8","type":"link out","z":"d3e16de4.2262d","name":"","links":["d6bd158d.a5c8d8"],"x":1147,"y":378,"wires":[]},{"id":"3cdfa08e.fc078","type":"link out","z":"d3e16de4.2262d","name":"","links":["d6bd158d.a5c8d8"],"x":571,"y":675,"wires":[]},{"id":"a9b2b029.a75cd","type":"link out","z":"d3e16de4.2262d","name":"","links":["8df6dd96.80c0a"],"x":571,"y":715,"wires":[]},{"id":"d739f684.d21f78","type":"link out","z":"d3e16de4.2262d","name":"","links":["cb2e48ed.0dbd68"],"x":571,"y":954,"wires":[]},{"id":"f5119b17.40b3f8","type":"link out","z":"d3e16de4.2262d","name":"","links":["74712369.9a7b1c","146071e.c8df58e","d32bc60b.d39a88"],"x":571,"y":756,"wires":[]},{"id":"a823af14.6f83a","type":"switch","z":"d3e16de4.2262d","name":"actions","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"action 1","vt":"str"},{"t":"eq","v":"action 2","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":360,"y":1020,"wires":[["d739f684.d21f78"],["42bdb23f.dc935c"],["b840afb7.f338c"]]},{"id":"42bdb23f.dc935c","type":"link out","z":"d3e16de4.2262d","name":"","links":["f1b6b836.5fe9c8"],"x":571,"y":998,"wires":[]},{"id":"f1b6b836.5fe9c8","type":"link in","z":"d3e16de4.2262d","name":"","links":["42bdb23f.dc935c"],"x":715,"y":980,"wires":[[]]},{"id":"2df4ada.dbcbc52","type":"chatbot-text","z":"d3e16de4.2262d","name":"capabilites","message":[{"message":"For the time being, you need to customize me"}],"x":842,"y":378,"wires":[["81f0e039.d0f74","9af6da57.03bdc8"]]},{"id":"81f0e039.d0f74","type":"link out","z":"d3e16de4.2262d","name":"","links":["b2125002.06a3a"],"x":987,"y":338,"wires":[]},{"id":"144e7f21.d4ed91","type":"Tekos in","z":"d3e16de4.2262d","name":"","bot":"d0a9b04.8c7f35","x":180,"y":180,"wires":[["fd6b03a.c82cb"]]},{"id":"fab1b7d6.7054b8","type":"chatbot-text","z":"d3e16de4.2262d","name":"will connect ","message":[{"message":"ok, i'll try to find a human connected. \nYou can also rise a support ticket here: https://tekos.freshdesk.com/support/tickets/new\n\n"}],"x":824,"y":756,"wires":[["2c497986.4142e6","78e1df0f.8d5c2"]]},{"id":"2c497986.4142e6","type":"link out","z":"d3e16de4.2262d","name":"","links":["677b0cc5.72afa4","ae715241.a6aa1","b2125002.06a3a"],"x":945,"y":712,"wires":[]},{"id":"d32bc60b.d39a88","type":"link in","z":"d3e16de4.2262d","name":"","links":["60628679.a9a3b8","f5119b17.40b3f8","4a8cd957.79ccc8"],"x":704.9999713897705,"y":755.9999103546143,"wires":[["fab1b7d6.7054b8"]]},{"id":"78e1df0f.8d5c2","type":"subflow:d0bf3750.bcab08","z":"d3e16de4.2262d","name":"","env":[{"name":"Operator","value":"@miled.essaafi:m.tekos.co","type":"str"},{"name":"Opretaor","value":"@miled.essaafi:m.tekos.co","type":"str"}],"x":1024,"y":756,"wires":[]},{"id":"c6f8f4da.9e7748","type":"link in","z":"d3e16de4.2262d","name":"","links":["fd6b03a.c82cb"],"x":197,"y":325,"wires":[["b754a142.97441"]]},{"id":"1bb2774c.3a54c9","type":"inject","z":"d3e16de4.2262d","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":154,"y":140,"wires":[["918a7fdd.6f11a"]]},{"id":"cb2e48ed.0dbd68","type":"link in","z":"d3e16de4.2262d","name":"","links":["d739f684.d21f78","c939c4e7.7e3238","c2a1d953.517618","87fec19b.2393a","f860a85e.919d08"],"x":715,"y":920,"wires":[[]]},{"id":"b754a142.97441","type":"subflow:c903f2e3.23631","z":"d3e16de4.2262d","name":"interaction","env":[],"x":302,"y":325,"wires":[["49271507.a3b45c"],["76c108ca.5c1638"],["76c108ca.5c1638"],[],[]]},{"id":"918a7fdd.6f11a","type":"subflow:9b782c32.24018","z":"d3e16de4.2262d","name":"","env":[{"name":"NAME","value":"Tekos Test","type":"str"},{"name":"AVATAR","value":"mxc://m.tekos.co/PcQNEQaOanMsjrvSTnZtOLKG","type":"str"}],"x":450,"y":140,"wires":[[]]},{"id":"9fb2b573.393e88","type":"comment","z":"d3e16de4.2262d","name":"go to step: name","info":"","x":680,"y":140,"wires":[]},{"id":"f8eefa4c.7262b8","type":"link in","z":"d3e16de4.2262d","name":"","links":["ac637e20.539e","b840afb7.f338c"],"x":703,"y":580,"wires":[[]]},{"id":"dd41769.989e688","type":"debug","z":"d3e16de4.2262d","name":"Response","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"_dialogflow","targetType":"msg","x":1034,"y":514,"wires":[]},{"id":"cda6ea71.6b54a8","type":"link out","z":"d3e16de4.2262d","name":"","links":["df8e8040.18abd"],"x":571,"y":835,"wires":[]},{"id":"df8e8040.18abd","type":"link in","z":"d3e16de4.2262d","name":"","links":["cda6ea71.6b54a8"],"x":235,"y":1020,"wires":[["a823af14.6f83a"]]},{"id":"76c108ca.5c1638","type":"link out","z":"d3e16de4.2262d","name":"","links":["c93958c1.23cfb8"],"x":417,"y":325,"wires":[]},{"id":"c93958c1.23cfb8","type":"link in","z":"d3e16de4.2262d","name":"","links":["76c108ca.5c1638","aaac7a2a.fe3f58"],"x":219,"y":765,"wires":[["948ea8c5.85ac08"]]},{"id":"b840afb7.f338c","type":"link out","z":"d3e16de4.2262d","name":"","links":["b1200440.54a4e8","f8eefa4c.7262b8"],"x":575,"y":1080,"wires":[]},{"id":"4be672ff.2d05fc","type":"chatbot-generic-buttons","z":"d3e16de4.2262d","name":"Menu","buttons":[{"type":"postback","label":"Talk to our team","value":"talk to human","alert":false},{"type":"postback","label":"create your action","value":"action 2","alert":false}],"message":"Account","x":1310,"y":140,"wires":[["e5cad6e2.4463c8"]]},{"id":"e5cad6e2.4463c8","type":"link out","z":"d3e16de4.2262d","name":"","links":["b2125002.06a3a"],"x":1415,"y":140,"wires":[]},{"id":"ab1744fc.146fd8","type":"switch","z":"d3e16de4.2262d","name":"action","property":"_dialogflow.action","propertyType":"msg","rules":[{"t":"eq","v":"action 1","vt":"str"},{"t":"eq","v":"give_capabilities","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1070,"y":560,"wires":[["c2a1d953.517618"],["d98d947a.7a4808"],["f9bb0877.54bae8"]]},{"id":"c2a1d953.517618","type":"link out","z":"d3e16de4.2262d","name":"","links":["cb2e48ed.0dbd68"],"x":1235,"y":500,"wires":[]},{"id":"f9bb0877.54bae8","type":"change","z":"d3e16de4.2262d","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"_dialogflow.fulfillmentMessages[0].text.text[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1300,"y":640,"wires":[["cff4c06e.14882"]]},{"id":"cff4c06e.14882","type":"chatbot-text","z":"d3e16de4.2262d","name":"fullfillment message","message":[{"message":""}],"x":1530,"y":640,"wires":[["56ea3968.841bf8"]]},{"id":"b708096e.4e61a8","type":"link in","z":"d3e16de4.2262d","name":"","links":["53ac0585.64bf3c","d98d947a.7a4808"],"x":736,"y":379,"wires":[["2df4ada.dbcbc52"]]},{"id":"53ac0585.64bf3c","type":"link out","z":"d3e16de4.2262d","name":"","links":["b708096e.4e61a8"],"x":1065,"y":320,"wires":[]},{"id":"d98d947a.7a4808","type":"link out","z":"d3e16de4.2262d","name":"","links":["bafe1309.ead79","b708096e.4e61a8"],"x":1235,"y":540,"wires":[]},{"id":"16b38f3a.0e0431","type":"chatbot-generic-buttons","z":"d3e16de4.2262d","name":"handover ?","buttons":[{"type":"postback","label":"Talk to human","value":"Talk to human","alert":false}],"message":"Do you need to talk to a human ?","x":1336,"y":734,"wires":[[]]},{"id":"f75d0a70.cf9048","type":"link in","z":"d3e16de4.2262d","name":"","links":[],"x":1231,"y":734,"wires":[["16b38f3a.0e0431"]]},{"id":"4a8cd957.79ccc8","type":"link out","z":"d3e16de4.2262d","name":"","links":["d32bc60b.d39a88"],"x":1235,"y":580,"wires":[]},{"id":"bf297103.64ef9","type":"link in","z":"d3e16de4.2262d","name":"","links":["293a37c5.1ff7a8"],"x":715,"y":1040,"wires":[[]]},{"id":"648e4b20.f00c34","type":"link out","z":"d3e16de4.2262d","name":"","links":["51848f1c.38d28"],"x":571,"y":800,"wires":[]},{"id":"9af6da57.03bdc8","type":"chatbot-text","z":"d3e16de4.2262d","name":"emoji","message":[{"message":"ðŸ¤—"}],"x":1032,"y":378,"wires":[["77fcc078.c5fe8","2fca68ac.5552c8"]]},{"id":"2fca68ac.5552c8","type":"link out","z":"d3e16de4.2262d","name":"","links":["b2125002.06a3a"],"x":1127,"y":338,"wires":[]},{"id":"14005589.bf4baa","type":"chatbot-text","z":"d3e16de4.2262d","name":"","message":[{"message":"This is the main Menu ðŸ˜Ž "}],"x":960,"y":140,"wires":[["348a3826.462898","79fb66e7.342ff8"]]},{"id":"79fb66e7.342ff8","type":"link out","z":"d3e16de4.2262d","name":"","links":["b2125002.06a3a","4b5a232d.4e28fc"],"x":1055,"y":120,"wires":[]},{"id":"f00d72f2.7ddc7","type":"comment","z":"d3e16de4.2262d","name":"Use NLP service","info":"","x":420,"y":1080,"wires":[]},{"id":"d35a5c54.51fd1","type":"comment","z":"d3e16de4.2262d","name":"See here","info":"","x":800,"y":580,"wires":[]},{"id":"56ea3968.841bf8","type":"link out","z":"d3e16de4.2262d","name":"","links":["b2125002.06a3a"],"x":1675,"y":640,"wires":[]},{"id":"bd4a419b.9ca63","type":"function","z":"8e8615b6.018d08","name":"typing status","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/typing/' +env.get('TEKOS_BOT_ID')+ '?access_token=' + env.get('TEKOS_BOT_TOKEN')\n\nmsg.headers ={\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload={\n  \"typing\": true,\n  \"timeout\": 30000\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":246,"y":88,"wires":[["c04d032d.b7496","78c06e0c.1563a"]]},{"id":"c04d032d.b7496","type":"http request","z":"8e8615b6.018d08","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":422,"y":88,"wires":[["b193fa12.8c02d8"]]},{"id":"78c06e0c.1563a","type":"debug","z":"8e8615b6.018d08","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":402,"y":22,"wires":[]},{"id":"b193fa12.8c02d8","type":"delay","z":"8e8615b6.018d08","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":588,"y":88,"wires":[[]]},{"id":"12b731b8.b6cb1e","type":"http request","z":"1303f3a1.17536c","name":"Segment","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":360,"y":80,"wires":[[]]},{"id":"e08f7a87.7731e8","type":"function","z":"1303f3a1.17536c","name":"","func":"msg.url = 'https://api.segment.io/v1/track'\n\n\n\nmsg.headers ={\n    \"Authorization\" : \"Basic \"+env.get('write_key'),  //RUFRU2xLV05ZNVJTMDdUeUc1N1lxeU94czVmUFJYb3Y=\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload = {\n  \"userId\": msg.payload.senderId, //\"miled@tekos.co\", // msg.payload.email\n  \"email\": msg.payload.email, //\"miled@tekos.co\", //msg.payload.email,\n  \"event\": env.get('EVENT')\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["12b731b8.b6cb1e"]]},{"id":"b5f39f3.c2b886","type":"function","z":"b76049a1.e66408","name":"create customer","func":" msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nnode.warn(\"creating customer now\")  \nnode.warn(msg)\n    msg.url =\"https://api.stripe.com/v1/customers\";\n var dataString ='description=tekos account stripe customer&email='+msg.tekos.email+'&balance=0&metadata[tekos_id]='+msg.tekos.senderId+'&metadata[tekos_email]='+msg.tekos.email\n msg.payload = dataString;\n node.warn(dataString)\nreturn msg;","outputs":1,"noerr":0,"x":940,"y":260,"wires":[["736d71b3.ef432"]]},{"id":"78e85d26.f7ef14","type":"switch","z":"b76049a1.e66408","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"lte","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":160,"wires":[["a4d52ba5.9649b8"],["b5f39f3.c2b886"]]},{"id":"23a932a1.19362e","type":"http request","z":"b76049a1.e66408","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":710,"y":160,"wires":[["78e85d26.f7ef14"]]},{"id":"a2b2ebf4.44a0c8","type":"function","z":"b76049a1.e66408","name":"Get Customers","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.email = msg.payload.email\n    msg.tekos = msg.payload.data.data\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return msg;\n","outputs":1,"noerr":0,"x":500,"y":160,"wires":[["23a932a1.19362e"]]},{"id":"247aff4b.9e527","type":"switch","z":"b76049a1.e66408","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":330,"y":200,"wires":[["a2b2ebf4.44a0c8"],["b7573ec2.70683"]]},{"id":"b7573ec2.70683","type":"function","z":"b76049a1.e66408","name":"no email linked","func":"node.warn(\"no email found\")\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":500,"y":220,"wires":[[]]},{"id":"1d8b4252.bc16ee","type":"function","z":"b76049a1.e66408","name":" return customer ","func":"node.warn(\"return customer found !\");\nnode.warn(msg);\nmsg.roomId =  msg.tekos.roomId;\nmsg.payload.users = msg.tekos.users;\nmsg.payload.roomId = msg.tekos.roomId;\nnode.warn(msg);\n\nreturn msg;","outputs":1,"noerr":0,"x":980,"y":520,"wires":[[]]},{"id":"736d71b3.ef432","type":"http request","z":"b76049a1.e66408","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"bearer","x":1130,"y":260,"wires":[[]]},{"id":"358680b7.8b81f","type":"http in","z":"b76049a1.e66408","name":"","url":"/authorize","method":"post","upload":false,"swaggerDoc":"","x":100,"y":260,"wires":[["ef524153.83d41","247aff4b.9e527"]]},{"id":"ef524153.83d41","type":"http response","z":"b76049a1.e66408","name":"code","statusCode":"200","headers":{},"x":310,"y":320,"wires":[]},{"id":"991ade88.03c98","type":"function","z":"b76049a1.e66408","name":"customer update metadata","func":"node.warn(\"update found !\");\nnode.warn(msg);\nmsg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.roomId =  msg.tekos.roomId;\nmsg.payload.users = msg.tekos.users;\nmsg.payload.roomId = msg.tekos.roomId;\nvar customer = msg.payload.data.data[0]\nmsg.url =\"https://api.stripe.com/v1/customers/\"+customer.id.email\nvar dataString = 'metadata[tekos_id]='+msg.tekos.senderId+'metadata[tekos_email]='+msg.email;\n    \nmsg.payload=dataString\n\nreturn msg;","outputs":1,"noerr":0,"x":580,"y":520,"wires":[["1f58dec5.eccd01"]]},{"id":"a4d52ba5.9649b8","type":"link out","z":"b76049a1.e66408","name":"","links":["54cb45c6.04974c","5d7108c2.205548"],"x":1015,"y":160,"wires":[]},{"id":"5d7108c2.205548","type":"link in","z":"b76049a1.e66408","name":"","links":["a4d52ba5.9649b8"],"x":395,"y":520,"wires":[["991ade88.03c98"]]},{"id":"aced3aaa.e5dcd8","type":"comment","z":"b76049a1.e66408","name":"customer is found","info":"if customer if found in our stripe database,\nwe must retreive the customer and update its metadata with the tekos id and tekos mail","x":950,"y":80,"wires":[]},{"id":"d133c841.8dd1c8","type":"comment","z":"b76049a1.e66408","name":"get and update customer","info":"","x":630,"y":440,"wires":[]},{"id":"1f58dec5.eccd01","type":"http request","z":"b76049a1.e66408","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"bearer","x":790,"y":520,"wires":[["1d8b4252.bc16ee"]]},{"id":"23be57dc.868e78","type":"switch","z":"c47f16f1.a03068","name":"","property":"payload","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":690,"y":100,"wires":[["e40a6481.9ddfb8"],["1faab047.78a39"]]},{"id":"1faab047.78a39","type":"chatbot-text","z":"c47f16f1.a03068","name":"no stripe account","message":[{"message":"Your dont seem to have a Stripe account in the first place, please subscribe to a plan first."}],"x":890,"y":140,"wires":[[]]},{"id":"43a54b00.1fc184","type":"http request","z":"c47f16f1.a03068","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":120,"wires":[["23be57dc.868e78","e390c3b9.76a53"]]},{"id":"5daec203.e47e8c","type":"function","z":"c47f16f1.a03068","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nif((env.get(\"roomId\") &&  env.get(\"stripeId\")) || (msg.payload.stripeId && msg.payload.rooms)){\n\n    var stripeId = msg.payload.stripeId || env.get(\"stripeId\");\n   \n    msg.url =\"https://api.stripe.com/v1/customers/\"+stripeId;\n    return [msg,null]\n}else{\n    msg.payload = \"error, missing params.\";\n    return [null,msg]\n}\n   \n","outputs":2,"noerr":0,"x":320,"y":160,"wires":[["43a54b00.1fc184"],["81274faa.4f1bc"]]},{"id":"f96401ce.e5a84","type":"http in","z":"c47f16f1.a03068","name":"","url":"/billing/update/:roomId/:customer","method":"post","upload":false,"swaggerDoc":"","x":216,"y":352,"wires":[["93fd90e9.c2ca6","edd181d3.0970d"]]},{"id":"e40a6481.9ddfb8","type":"function","z":"c47f16f1.a03068","name":"get room id","func":"node.warn(\"start creating form\")\n\nmsg.roomId = msg.roomId;\nmsg.customer = msg.payload\nmsg.users = 1;\nmsg.trial = 0\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":100,"wires":[["3d87b3d5.85834c"]]},{"id":"35ce43d.61c30bc","type":"function","z":"c47f16f1.a03068","name":"Update billing details form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\n\n\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\nvar line1, line2, country, postalcode, state, city, taxid, phone, company, name,gole,role;\n\nif(customer.metadata){\n    phone = customer.phone;\n    company = customer.metadata.company;\n    name = customer.name;\n}else{\n    phone = \"\";\n    company = \"\";\n    name = \"\";\n}\n\nif(customer.address){\n    if(customer.address.line1){\n         line1 = customer.address.line1;\n\n    }else{\n        line1 =\"\";\n    }\n    if(customer.address.line2){\n         line2 = customer.address.line2 ;\n    }else{\n        line2 =\"\";\n    }\n    if(customer.address.country){\n         country = customer.address.country;\n\n    }else{\n        country = \"\";\n    }\n    if(customer.address.postal_code){\n         postalcode= customer.address.postal_code; \n\n    }else{\n        postal_code = \"\";\n    }\n    if(customer.address.state){\n         state = customer.address.state ;\n\n    }else{\n        state = \"\";\n    }\n    if(customer.address.city){\n         city =  customer.address.city;\n\n    }else{\n        city = \"\"\n    }\n if(customer.tax_ids.data.length  > 0){\n      taxid = customer.tax_ids.data[0].value ;\n\n }else{\n     taxid = \"\";\n }\n\n}else{\n line1 = \"\";\n line2 = \"\";\n country = \"\";\n postalcode= \"\";\n state = \"\";\n city =  \"\";\n taxid = \"\"; \n}\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get('form_title'),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/update/\"+msg.roomId+\"/\"+customer.id,\n    \"buttontitle\": env.get('form_button'),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Address\",\n        \"key\": \"address\",\n        \"defaultValue\":line1,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Address 2\",\n        \"key\": \"address2\",\n        \"defaultValue\":line2\n      },\n       {\n        \"type\": \"select\",\n        \"subtype\": \"select\",\n        \"label\": \"Country\",\n        \"key\": \"country\",\n        \"defaultValue\":country,\n        \"required\":true,\n        \"options\":[\n           {\"value\":\"AF\",\"label\":\"Afghanistan\"},\n{\"value\":\"AX\",\"label\":\"Ã…land Islands\"},\n{\"value\":\"AL\",\"label\":\"Albania\"},\n{\"value\":\"DZ\",\"label\":\"Algeria\"},\n{\"value\":\"AS\",\"label\":\"American Samoa\"},\n{\"value\":\"AD\",\"label\":\"Andorra\"},\n{\"value\":\"AO\",\"label\":\"Angola\"},\n{\"value\":\"AI\",\"label\":\"Anguilla\"},\n{\"value\":\"AQ\",\"label\":\"Antarctica\"},\n{\"value\":\"AG\",\"label\":\"Antigua and Barbuda\"},\n{\"value\":\"AR\",\"label\":\"Argentina\"},\n{\"value\":\"AM\",\"label\":\"Armenia\"},\n{\"value\":\"AW\",\"label\":\"Aruba\"},\n{\"value\":\"AU\",\"label\":\"Australia\"},\n{\"value\":\"AT\",\"label\":\"Austria\"},\n{\"value\":\"AZ\",\"label\":\"Azerbaijan\"},\n{\"value\":\"BH\",\"label\":\"Bahrain\"},\n{\"value\":\"BS\",\"label\":\"Bahamas\"},\n{\"value\":\"BD\",\"label\":\"Bangladesh\"},\n{\"value\":\"BB\",\"label\":\"Barbados\"},\n{\"value\":\"BY\",\"label\":\"Belarus\"},\n{\"value\":\"BE\",\"label\":\"Belgium\"},\n{\"value\":\"BZ\",\"label\":\"Belize\"},\n{\"value\":\"BJ\",\"label\":\"Benin\"},\n{\"value\":\"BM\",\"label\":\"Bermuda\"},\n{\"value\":\"BT\",\"label\":\"Bhutan\"},\n{\"value\":\"BO\",\"label\":\"Bolivia, Plurinational State of\"},\n{\"value\":\"BQ\",\"label\":\"Bonaire, Sint Eustatius and Saba\"},\n{\"value\":\"BA\",\"label\":\"Bosnia and Herzegovina\"},\n{\"value\":\"BW\",\"label\":\"Botswana\"},\n{\"value\":\"BV\",\"label\":\"Bouvet Island\"},\n{\"value\":\"BR\",\"label\":\"Brazil\"},\n{\"value\":\"IO\",\"label\":\"British Indian Ocean Territory\"},\n{\"value\":\"BN\",\"label\":\"Brunei Darussalam\"},\n{\"value\":\"BG\",\"label\":\"Bulgaria\"},\n{\"value\":\"BF\",\"label\":\"Burkina Faso\"},\n{\"value\":\"BI\",\"label\":\"Burundi\"},\n{\"value\":\"KH\",\"label\":\"Cambodia\"},\n{\"value\":\"CM\",\"label\":\"Cameroon\"},\n{\"value\":\"CA\",\"label\":\"Canada\"},\n{\"value\":\"CV\",\"label\":\"Cape Verde\"},\n{\"value\":\"KY\",\"label\":\"Cayman Islands\"},\n{\"value\":\"CF\",\"label\":\"Central African Republic\"},\n{\"value\":\"TD\",\"label\":\"Chad\"},\n{\"value\":\"CL\",\"label\":\"Chile\"},\n{\"value\":\"CN\",\"label\":\"China\"},\n{\"value\":\"CX\",\"label\":\"Christmas Island\"},\n{\"value\":\"CC\",\"label\":\"Cocos (Keeling) Islands\"},\n{\"value\":\"CO\",\"label\":\"Colombia\"},\n{\"value\":\"KM\",\"label\":\"Comoros\"},\n{\"value\":\"CG\",\"label\":\"Congo\"},\n{\"value\":\"CD\",\"label\":\"Congo, the Democratic Republic of the\"},\n{\"value\":\"CK\",\"label\":\"Cook Islands\"},\n{\"value\":\"CR\",\"label\":\"Costa Rica\"},\n{\"value\":\"CI\",\"label\":\"CÃ´te d'Ivoire\"},\n{\"value\":\"HR\",\"label\":\"Croatia\"},\n{\"value\":\"CU\",\"label\":\"Cuba\"},\n{\"value\":\"CW\",\"label\":\"CuraÃ§ao\"},\n{\"value\":\"CY\",\"label\":\"Cyprus\"},\n{\"value\":\"CZ\",\"label\":\"Czech Republic\"},\n{\"value\":\"DK\",\"label\":\"Denmark\"},\n{\"value\":\"DJ\",\"label\":\"Djibouti\"},\n{\"value\":\"DM\",\"label\":\"Dominica\"},\n{\"value\":\"DO\",\"label\":\"Dominican Republic\"},\n{\"value\":\"EC\",\"label\":\"Ecuador\"},\n{\"value\":\"EG\",\"label\":\"Egypt\"},\n{\"value\":\"SV\",\"label\":\"El Salvador\"},\n{\"value\":\"GQ\",\"label\":\"Equatorial Guinea\"},\n{\"value\":\"ER\",\"label\":\"Eritrea\"},\n{\"value\":\"EE\",\"label\":\"Estonia\"},\n{\"value\":\"ET\",\"label\":\"Ethiopia\"},\n{\"value\":\"FK\",\"label\":\"Falkland Islands (Malvinas)\"},\n{\"value\":\"FO\",\"label\":\"Faroe Islands\"},\n{\"value\":\"FJ\",\"label\":\"Fiji\"},\n{\"value\":\"FI\",\"label\":\"Finland\"},\n{\"value\":\"FR\",\"label\":\"France\"},\n{\"value\":\"GF\",\"label\":\"French Guiana\"},\n{\"value\":\"PF\",\"label\":\"French Polynesia\"},\n{\"value\":\"TF\",\"label\":\"French Southern Territories\"},\n{\"value\":\"GA\",\"label\":\"Gabon\"},\n{\"value\":\"GM\",\"label\":\"Gambia\"},\n{\"value\":\"GE\",\"label\":\"Georgia\"},\n{\"value\":\"DE\",\"label\":\"Germany\"},\n{\"value\":\"GH\",\"label\":\"Ghana\"},\n{\"value\":\"GI\",\"label\":\"Gibraltar\"},\n{\"value\":\"GR\",\"label\":\"Greece\"},\n{\"value\":\"GL\",\"label\":\"Greenland\"},\n{\"value\":\"GD\",\"label\":\"Grenada\"},\n{\"value\":\"GP\",\"label\":\"Guadeloupe\"},\n{\"value\":\"GU\",\"label\":\"Guam\"},\n{\"value\":\"GT\",\"label\":\"Guatemala\"},\n{\"value\":\"GG\",\"label\":\"Guernsey\"},\n{\"value\":\"GN\",\"label\":\"Guinea\"},\n{\"value\":\"GW\",\"label\":\"Guinea-Bissau\"},\n{\"value\":\"GY\",\"label\":\"Guyana\"},\n{\"value\":\"HT\",\"label\":\"Haiti\"},\n{\"value\":\"HM\",\"label\":\"Heard Island and McDonald Islands\"},\n{\"value\":\"VA\",\"label\":\"Holy See (Vatican City State)\"},\n{\"value\":\"HN\",\"label\":\"Honduras\"},\n{\"value\":\"HK\",\"label\":\"Hong Kong\"},\n{\"value\":\"HU\",\"label\":\"Hungary\"},\n{\"value\":\"IS\",\"label\":\"Iceland\"},\n{\"value\":\"IN\",\"label\":\"India\"},\n{\"value\":\"ID\",\"label\":\"Indonesia\"},\n{\"value\":\"IR\",\"label\":\"Iran, Islamic Republic of\"},\n{\"value\":\"IQ\",\"label\":\"Iraq\"},\n{\"value\":\"IE\",\"label\":\"Ireland\"},\n{\"value\":\"IM\",\"label\":\"Isle of Man\"},\n{\"value\":\"IL\",\"label\":\"Israel\"},\n{\"value\":\"IT\",\"label\":\"Italy\"},\n{\"value\":\"JM\",\"label\":\"Jamaica\"},\n{\"value\":\"JP\",\"label\":\"Japan\"},\n{\"value\":\"JE\",\"label\":\"Jersey\"},\n{\"value\":\"JO\",\"label\":\"Jordan\"},\n{\"value\":\"KZ\",\"label\":\"Kazakhstan\"},\n{\"value\":\"KE\",\"label\":\"Kenya\"},\n{\"value\":\"KI\",\"label\":\"Kiribati\"},\n{\"value\":\"KP\",\"label\":\"Korea, Democratic People's Republic of\"},\n{\"value\":\"KR\",\"label\":\"Korea, Republic of\"},\n{\"value\":\"KW\",\"label\":\"Kuwait\"},\n{\"value\":\"KG\",\"label\":\"Kyrgyzstan\"},\n{\"value\":\"LA\",\"label\":\"Lao People's Democratic Republic\"},\n{\"value\":\"LV\",\"label\":\"Latvia\"},\n{\"value\":\"LB\",\"label\":\"Lebanon\"},\n{\"value\":\"LS\",\"label\":\"Lesotho\"},\n{\"value\":\"LR\",\"label\":\"Liberia\"},\n{\"value\":\"LY\",\"label\":\"Libya\"},\n{\"value\":\"LI\",\"label\":\"Liechtenstein\"},\n{\"value\":\"LT\",\"label\":\"Lithuania\"},\n{\"value\":\"LU\",\"label\":\"Luxembourg\"},\n{\"value\":\"MO\",\"label\":\"Macao\"},\n{\"value\":\"MK\",\"label\":\"Macedonia, the Former Yugoslav Republic of\"},\n{\"value\":\"MG\",\"label\":\"Madagascar\"},\n{\"value\":\"MW\",\"label\":\"Malawi\"},\n{\"value\":\"MY\",\"label\":\"Malaysia\"},\n{\"value\":\"MV\",\"label\":\"Maldives\"},\n{\"value\":\"ML\",\"label\":\"Mali\"},\n{\"value\":\"MT\",\"label\":\"Malta\"},\n{\"value\":\"MH\",\"label\":\"Marshall Islands\"},\n{\"value\":\"MQ\",\"label\":\"Martinique\"},\n{\"value\":\"MR\",\"label\":\"Mauritania\"},\n{\"value\":\"MU\",\"label\":\"Mauritius\"},\n{\"value\":\"YT\",\"label\":\"Mayotte\"},\n{\"value\":\"MX\",\"label\":\"Mexico\"},\n{\"value\":\"FM\",\"label\":\"Micronesia, Federated States of\"},\n{\"value\":\"MD\",\"label\":\"Moldova, Republic of\"},\n{\"value\":\"MC\",\"label\":\"Monaco\"},\n{\"value\":\"MN\",\"label\":\"Mongolia\"},\n{\"value\":\"ME\",\"label\":\"Montenegro\"},\n{\"value\":\"MS\",\"label\":\"Montserrat\"},\n{\"value\":\"MA\",\"label\":\"Morocco\"},\n{\"value\":\"MZ\",\"label\":\"Mozambique\"},\n{\"value\":\"MM\",\"label\":\"Myanmar\"},\n{\"value\":\"NA\",\"label\":\"Namibia\"},\n{\"value\":\"NR\",\"label\":\"Nauru\"},\n{\"value\":\"NP\",\"label\":\"Nepal\"},\n{\"value\":\"NL\",\"label\":\"Netherlands\"},\n{\"value\":\"NC\",\"label\":\"New Caledonia\"},\n{\"value\":\"NZ\",\"label\":\"New Zealand\"},\n{\"value\":\"NI\",\"label\":\"Nicaragua\"},\n{\"value\":\"NE\",\"label\":\"Niger\"},\n{\"value\":\"NG\",\"label\":\"Nigeria\"},\n{\"value\":\"NU\",\"label\":\"Niue\"},\n{\"value\":\"NF\",\"label\":\"Norfolk Island\"},\n{\"value\":\"MP\",\"label\":\"Northern Mariana Islands\"},\n{\"value\":\"NO\",\"label\":\"Norway\"},\n{\"value\":\"OM\",\"label\":\"Oman\"},\n{\"value\":\"PK\",\"label\":\"Pakistan\"},\n{\"value\":\"PW\",\"label\":\"Palau\"},\n{\"value\":\"PS\",\"label\":\"Palestine, State of\"},\n{\"value\":\"PA\",\"label\":\"Panama\"},\n{\"value\":\"PG\",\"label\":\"Papua New Guinea\"},\n{\"value\":\"PY\",\"label\":\"Paraguay\"},\n{\"value\":\"PE\",\"label\":\"Peru\"},\n{\"value\":\"PH\",\"label\":\"Philippines\"},\n{\"value\":\"PN\",\"label\":\"Pitcairn\"},\n{\"value\":\"PL\",\"label\":\"Poland\"},\n{\"value\":\"PT\",\"label\":\"Portugal\"},\n{\"value\":\"PR\",\"label\":\"Puerto Rico\"},\n{\"value\":\"QA\",\"label\":\"Qatar\"},\n{\"value\":\"RE\",\"label\":\"RÃ©union\"},\n{\"value\":\"RO\",\"label\":\"Romania\"},\n{\"value\":\"RU\",\"label\":\"Russian Federation\"},\n{\"value\":\"RW\",\"label\":\"Rwanda\"},\n{\"value\":\"BL\",\"label\":\"Saint BarthÃ©lemy\"},\n{\"value\":\"SH\",\"label\":\"Saint Helena, Ascension and Tristan da Cunha\"},\n{\"value\":\"KN\",\"label\":\"Saint Kitts and Nevis\"},\n{\"value\":\"LC\",\"label\":\"Saint Lucia\"},\n{\"value\":\"MF\",\"label\":\"Saint Martin (French part)\"},\n{\"value\":\"PM\",\"label\":\"Saint Pierre and Miquelon\"},\n{\"value\":\"VC\",\"label\":\"Saint Vincent and the Grenadines\"},\n{\"value\":\"WS\",\"label\":\"Samoa\"},\n{\"value\":\"SM\",\"label\":\"San Marino\"},\n{\"value\":\"ST\",\"label\":\"Sao Tome and Principe\"},\n{\"value\":\"SA\",\"label\":\"Saudi Arabia\"},\n{\"value\":\"SN\",\"label\":\"Senegal\"},\n{\"value\":\"RS\",\"label\":\"Serbia\"},\n{\"value\":\"SC\",\"label\":\"Seychelles\"},\n{\"value\":\"SL\",\"label\":\"Sierra Leone\"},\n{\"value\":\"SG\",\"label\":\"Singapore\"},\n{\"value\":\"SX\",\"label\":\"Sint Maarten (Dutch part)\"},\n{\"value\":\"SK\",\"label\":\"Slovakia\"},\n{\"value\":\"SI\",\"label\":\"Slovenia\"},\n{\"value\":\"SB\",\"label\":\"Solomon Islands\"},\n{\"value\":\"SO\",\"label\":\"Somalia\"},\n{\"value\":\"ZA\",\"label\":\"South Africa\"},\n{\"value\":\"GS\",\"label\":\"South Georgia and the South Sandwich Islands\"},\n{\"value\":\"SS\",\"label\":\"South Sudan\"},\n{\"value\":\"ES\",\"label\":\"Spain\"},\n{\"value\":\"LK\",\"label\":\"Sri Lanka\"},\n{\"value\":\"SD\",\"label\":\"Sudan\"},\n{\"value\":\"SR\",\"label\":\"Suriname\"},\n{\"value\":\"SJ\",\"label\":\"Svalbard and Jan Mayen\"},\n{\"value\":\"SZ\",\"label\":\"Swaziland\"},\n{\"value\":\"SE\",\"label\":\"Sweden\"},\n{\"value\":\"CH\",\"label\":\"Switzerland\"},\n{\"value\":\"SY\",\"label\":\"Syrian Arab Republic\"},\n{\"value\":\"TW\",\"label\":\"Taiwan, Province of China\"},\n{\"value\":\"TJ\",\"label\":\"Tajikistan\"},\n{\"value\":\"TZ\",\"label\":\"Tanzania, United Republic of\"},\n{\"value\":\"TH\",\"label\":\"Thailand\"},\n{\"value\":\"TL\",\"label\":\"Timor-Leste\"},\n{\"value\":\"TG\",\"label\":\"Togo\"},\n{\"value\":\"TK\",\"label\":\"Tokelau\"},\n{\"value\":\"TO\",\"label\":\"Tonga\"},\n{\"value\":\"TT\",\"label\":\"Trinidad and Tobago\"},\n{\"value\":\"TN\",\"label\":\"Tunisia\"},\n{\"value\":\"TR\",\"label\":\"Turkey\"},\n{\"value\":\"TM\",\"label\":\"Turkmenistan\"},\n{\"value\":\"TC\",\"label\":\"Turks and Caicos Islands\"},\n{\"value\":\"TV\",\"label\":\"Tuvalu\"},\n{\"value\":\"UG\",\"label\":\"Uganda\"},\n{\"value\":\"UA\",\"label\":\"Ukraine\"},\n{\"value\":\"AE\",\"label\":\"United Arab Emirates\"},\n{\"value\":\"GB\",\"label\":\"United Kingdom\"},\n{\"value\":\"US\",\"label\":\"United States\"},\n{\"value\":\"UM\",\"label\":\"United States Minor Outlying Islands\"},\n{\"value\":\"UY\",\"label\":\"Uruguay\"},\n{\"value\":\"UZ\",\"label\":\"Uzbekistan\"},\n{\"value\":\"VU\",\"label\":\"Vanuatu\"},\n{\"value\":\"VE\",\"label\":\"Venezuela, Bolivarian Republic of\"},\n{\"value\":\"VN\",\"label\":\"Viet Nam\"},\n{\"value\":\"VG\",\"label\":\"Virgin Islands, British\"},\n{\"value\":\"VI\",\"label\":\"Virgin Islands, U.S.\"},\n{\"value\":\"WF\",\"label\":\"Wallis and Futuna\"},\n{\"value\":\"EH\",\"label\":\"Western Sahara\"},\n{\"value\":\"YE\",\"label\":\"Yemen\"},\n{\"value\":\"ZM\",\"label\":\"Zambia\"},\n{\"value\":\"ZW\",\"label\":\"Zimbabwe\"}\n        ]\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Postal Code\",\n        \"key\": \"postalcode\",\n        \"defaultValue\":postalcode,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"State\",\n        \"key\": \"stat\",\n        \"defaultValue\":state,\n        \"required\":false,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"City\",\n        \"key\": \"city\",\n        \"defaultValue\":city,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Tax ID\",\n        \"key\": \"taxid\",\n        \"defaultValue\":taxid\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Phone number\",\n        \"key\": \"phone\",\n        \"defaultValue\":phone,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Company name\",\n        \"key\": \"company\",\n        \"defaultValue\":company,\n        \"required\":true,\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Your name\",\n        \"key\": \"yourname\",\n        \"defaultValue\":name,\n        \"required\":true,\n      }\n    ]\n}\nif(!customer.metadata.gole && !customer.metadata.role){\n    role = {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<br><div><strong>One last step!</strong><div>In order to customize your experience, tell us a little about you</div><br><div>What is your role ?<div  style='color:gray'>exp : ceo, developer, marketing, sales</div></div></div>\",\n        \"key\": \"role\"\n       \n      }\n      gole = {\n         \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>What are your top 3 goals for using Tekos ?<div  style='color:gray'>exp : automate workflows, create chatbots ..</div></div>\",\n        \"key\": \"gole\"\n      }\n    msg.payload.tekosform.push(role);\n    msg.payload.tekosform.push(gole);\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"x":1056,"y":572,"wires":[["262b70c6.35eae"]],"icon":"node-red/debug.svg"},{"id":"93fd90e9.c2ca6","type":"function","z":"c47f16f1.a03068","name":"update billing details","func":"  msg.roomId = msg.payload.roomId;\n  msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar country;\n\nif(msg.payload.country.value){\n    country = msg.payload.country.value\n}else{\n   country=  msg.payload.country;\n}\nmsg.url =\"https://api.stripe.com/v1/customers/\"+msg.req.params.customer;\nvar dataString = \"phone=\"+msg.payload.phone+\"&name=\"+msg.payload.yourname+\"&metadata[company]=\"+msg.payload.company+\"&address[line1]=\"+msg.payload.address+\"&address[city]=\"+msg.payload.city+\"&address[line2]=\"+msg.payload.address2+\"&address[country]=\"+country+\"&address[postal_code]=\"+msg.payload.postalcode;\n/*if(msg.payload.taxid ){\n    dataString += \"&tax_info[tax_id]=\"+msg.payload.taxid+\"&tax_info[type]=vat\";\n}else{\n    dataString += \"&tax_info[tax_id]=&tax_info[type]=vat\";\n}*/\nif(msg.payload.role){\n    dataString +=\"&metadata[role]=\"+msg.payload.role;\n}\nif(msg.payload.gole){\n    dataString +=\"&metadata[gole]=\"+msg.payload.gole;\n1\n\n}\nif(msg.payload.stat){\n    dataString +=\"&address[state]=\"+msg.payload.stat;\n}else{\n     dataString +=\"&address[state]=\";\n}\nif(msg.payload.line2){\n   dataString += \"&address[line2]=\"+msg.payload.address2;\n}else{\n    dataString += \"&address[line2]=\";\n}\nmsg.payload = dataString\nreturn msg;","outputs":1,"noerr":0,"x":562,"y":352,"wires":[["3a37dc4d.4cca44","e5c88aea.eda408"]]},{"id":"e5c88aea.eda408","type":"http request","z":"c47f16f1.a03068","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":780,"y":352,"wires":[["9e062dd0.c813b","1c983f02.d57a21"]]},{"id":"9e062dd0.c813b","type":"switch","z":"c47f16f1.a03068","name":"","property":"payload.error","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":930,"y":352,"wires":[["26012ab.c1bf3d6","567286a3.3e0a28"],["fae4bb41.fd93d8","cfcff58d.ed1c28"]]},{"id":"c9041b65.cbff18","type":"chatbot-text","z":"c47f16f1.a03068","name":"Update done","message":[{"message":"Your Stripe billing details have been updated successuflyðŸ˜Š."}],"x":1346,"y":374,"wires":[[]]},{"id":"26012ab.c1bf3d6","type":"chatbot-text","z":"c47f16f1.a03068","name":"error update","message":[{"message":"ops ðŸ˜³, something went wrong, please try in a couple of minutes... "}],"x":1130,"y":320,"wires":[[]]},{"id":"79197f65.810cb","type":"function","z":"52c3ea26.423dc4","name":"Preapare Bot","func":"\nvar password = Math.random().toString(36).substring(7);\nnode.warn(msg.payload);\nvar name = msg.payload.name;\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/register?kind=user'\nmsg.roomId= msg.req.params.roomId;\n\nmsg.payload = {\n    \"password\": password,\n    \"username\": name,\n    \"auth\": {\n        \"type\":\"m.login.dummy\"\n    }\n}\n\n\nnode.warn(\"is there any room id\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":420,"wires":[["d88c22ee.9c691"]]},{"id":"7bea3801.aae698","type":"chatbot-text","z":"52c3ea26.423dc4","name":"","message":[{"message":"Congratulations ! Your bot is successfully created !\nyou can chat with via this link https://chat.tekos.co/#/user/{{user_id}}\nYour user ID = {{user_id}}\nYour access token = {{access_token}}\nIf you're new to Building Bots and Apps, please see this webpage: https://tekos.co/build-apps/\n\n"}],"x":870,"y":280,"wires":[["db299292.b9ba8","31366499.399f9c"]]},{"id":"69757ad7.a30424","type":"function","z":"52c3ea26.423dc4","name":"Send Analytics data","func":"const Analytics = global.get('analytics');\nconst client = new Analytics('EAQSlKWNY5RS07TyG57YqyOxs5fPRXov');\n//vNnBOao9rVMYWaOt5KKwFP4zUoas9RPD\n \nclient.track({\n  event: 'Create Bot',\n  userId: msg.payload.user_id\n});\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":580,"wires":[[]]},{"id":"587f9096.69369","type":"switch","z":"52c3ea26.423dc4","name":"","property":"payload.errcode","propertyType":"msg","rules":[{"t":"eq","v":"M_USER_IN_USE","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":260,"wires":[["8426536a.d51d2","a5ed5058.aa11e"],["7bea3801.aae698","702acec6.569c4"]]},{"id":"8426536a.d51d2","type":"chatbot-text","z":"52c3ea26.423dc4","name":"bot exist","message":[{"message":"Bot name already taken!"}],"x":860,"y":220,"wires":[["31366499.399f9c"]]},{"id":"ddc21a3.fd3c7e8","type":"function","z":"52c3ea26.423dc4","name":"create form ","func":"node.warn(\"start create bot\");\nmsg.roomId= msg.roomId || payload.roomId;\nmsg.payload = {\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"titleform\": \"Create Bot form\",\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/create/bot/\"+msg.roomId,\n    \"buttontitle\": \"Create Bot\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Please enter your bot name\",\n        \"maxLength\": \"20\",\n        \"key\": \"name\",\n        \"required\":true,\n\n      }\n    ]\n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\n\n\nreturn msg;","outputs":1,"noerr":0,"x":444,"y":66,"wires":[["7dcdc844.885d78"]],"icon":"node-red/debug.svg"},{"id":"9ac3d226.d9045","type":"http in","z":"52c3ea26.423dc4","name":"","url":"/create/bot/:roomId","method":"post","upload":false,"swaggerDoc":"","x":132,"y":396,"wires":[["1f4612e.d5bd9ed","e5cf7a55.167158"]]},{"id":"1f4612e.d5bd9ed","type":"switch","z":"52c3ea26.423dc4","name":"","property":"payload.name","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":250,"y":460,"wires":[["79197f65.810cb"],["3afa68ed.b08e08","e7cb6f36.69812"]]},{"id":"4d7bebad.4aae84","type":"chatbot-text","z":"52c3ea26.423dc4","name":"is empty","message":[{"message":"Bot name cannot be empty ðŸ˜“"}],"x":580,"y":480,"wires":[["4e302f73.f62e1"]]},{"id":"3afa68ed.b08e08","type":"function","z":"52c3ea26.423dc4","name":"get roomId","func":"node.warn(msg)\nmsg.roomId= msg.req.params.roomId;\nreturn msg;","outputs":1,"noerr":0,"x":410,"y":480,"wires":[["4d7bebad.4aae84"]]},{"id":"fea10712.42de28","type":"debug","z":"52c3ea26.423dc4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":650,"y":320,"wires":[]},{"id":"10b6d8b.9fb5527","type":"function","z":"ec000337.2949e","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n  \n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/customers/\"+msg.payload.stripeId\n    return msg;\n","outputs":1,"noerr":0,"x":300,"y":260,"wires":[["c9d6f46d.2feb48"]]},{"id":"c9d6f46d.2feb48","type":"http request","z":"ec000337.2949e","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":510,"y":260,"wires":[["c1f4322.1a62fd","f0f33b27.6070d8"]]},{"id":"aa8d4cc4.f6d5a","type":"function","z":"ec000337.2949e","name":"get all subscriptions ","func":"var room;\nif(msg.roomId){\n    room = msg.roomId;\n}else if(msg.tekos){\n    room = msg.tekos.rooms[msg.tekos.rooms.length -1];\n    msg.roomId = room;\n}\n\nnode.warn(msg);\nvar customer = msg.payload;\nvar subs = customer.subscriptions.data;\nvar elementsY=[];\nvar canceldate;\nif(env.get(\"service\")== \"all\"){\n\nfor (let i = 0; i < subs.length; i++) \n{\n       let plan =subs[i];\n       let currency = \"â‚¬\";\n       if(plan.plan.currency != \"eur\"){\n           currency = plan.plan.currency;\n       }\n         let buttons;\n       var date = new Date(plan.created*1000);\n       date = date.toDateString();\n       var subdomaine = \"<div style='color:#CF5128'>No active instance yet</div><div>Subscription token <b>\"+plan.id+\"</b></div>\";\n         if(plan.metadata.subdomaine){\n             subdomaine = \"<div style='color:#5DB640'>Instance : \"+plan.metadata.subdomaine+\"</div>\";\n         }\n         if(plan.cancel_at_period_end){\n             canceldate =  new Date(plan.cancel_at*1000);\n             subdomaine+=\"<div>subscription will be cancelled on \"+canceldate+\"</div>\"\n         }else{\n           \n       buttons = [\n                    {\n                        \"type\": \"postback\",\n                        \"label\": \"Cancel plan\",\n                        \"value\": \"cancel \"+plan.id,\n                        \"alert\": false\n                    }\n                ]\n         }\n         if(plan.plan.metadata.service == \"hosted_flow\" && !plan.metadata.subdomaine){\n              \n                    buttons.push({\n                        \"type\": \"postback\",\n                        \"label\": \"Setup your instance\",\n                        \"value\": \"setup flow instance\",\n                        \"alert\": false\n                    })\n        }\n           elementsY.push\n       ({\n                \"title\": \"Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                \"subtitle\": currency+(plan.plan.amount)/100+\" per \"+plan.plan.interval+\"<div>Created : \"+date+\"</div><div>Type : <strong>\"+plan.metadata.type+\"</strong></div><div>\"+subdomaine+\"</div>\",\n                \"buttons\": buttons\n                \n        })\n       \n      \n}\n}else if(env.get(\"service\")== \"flow\" ){\n    node.warn(\"flow in\")\n    for (let i = 0; i < subs.length; i++) {\n\n       let plan = subs[i];\n       let subtitle,buttons;\n       if(plan.metadata.subdomaine){\n           subtitle = \"<div>Instance : \"+plan.metadata.subdomaine+\"</div><div>https://\"+plan.metadata.subdomaine+\".tekos.co</div>\";\n                if(plan.cancel_at_period_end){\n             canceldate =  new Date(plan.cancel_at*1000);\n             subtitle+=\"<div>subscription will be cancelled on \"+canceldate+\"</div>\"\n                    }\n                    \n            buttons=[\n                        {\n                        \"type\": \"url\",\n                        \"label\": \"Go to Instance\",\n                        \"url\": \"https://\"+plan.metadata.subdomaine+\".tekos.co\",\n                        \"alert\": false\n                        }\n            ];\n                    \n            \n            if(plan.metadata.botToken && plan.metadata.botId){\n                buttons.push({\n                    \"type\": \"url\",\n                        \"label\": \"Interact with Bot\",\n                        \"url\": \"https://chat.tekos.co/#/user/\"+plan.metadata.botId,\n                        \"alert\": false\n                })\n                buttons.push(\n                    {\n                        \"type\": \"request_url_only\",\n                        \"label\": \"Update Environment variables\",\n                        \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/update/plan/flow/\"+plan.id+\"/\"+room,\n                        \"alert\": false\n                    })\n            }\n       }else{\n           subtitle = \"<div>no instance yet</div><div>Token : <strong>\"+plan.id+\"</strong></div>\";\n           buttons = [\n                    {\n                        \"type\": \"postback\",\n                        \"label\": \"Setup your instance\",\n                        \"value\": \"setup flow instance\",\n                        \"alert\": false\n                    }\n                ];\n       }\n       if(plan.plan.metadata.service == \"hosted_flow\"){\n               elementsY.push\n       ({\n                \"title\": \"Flow Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                \"subtitle\":subtitle  ,\n                \"buttons\": buttons\n        })\n       }\n    }\n    \n}else if(env.get(\"service\")== \"chat\" ){\n     node.warn(\"flow in\")\n    for (let i = 0; i < subs.length; i++) {\n\n       let plan = subs[i];\n       let subtitle,buttons;\n       if(plan.metadata.subdomaine){\n           subtitle = \"<div>Instance : \"+plan.metadata.subdomaine+\"</div><div>https://\"+plan.metadata.subdomaine+\".tekos.co</div>\";\n            buttons = [\n                    {\n                        \"type\": \"url\",\n                        \"label\": \"go to my Wesbite\",\n                        \"url\": \"https://\"+plan.metadata.subdomaine+\".tekos.co\",\n                        \"alert\": false\n                    },\n                    {\n                        \"type\": \"request_url_only\",\n                        \"label\": \"Update Wesbite settings\",\n                        \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/update/plan/chat/\"+plan.id+\"/\"+room,\n                        \"alert\": false\n                    }\n                ]\n           \n       }else{\n           subtitle = \"<div>no instance yet</div><div>Token : \"+plan.id+\"</div>\";\n           buttons  = [\n                    {\n                        \"type\": \"postback\",\n                        \"label\": \"Setup my instance\",\n                        \"value\": \"setup client instance\",\n                        \"alert\": false\n                    }\n                ]\n       }\n       if(plan.metadata.type == \"chat\"){\n               elementsY.push\n       ({\n                \"title\": \"Chat Client Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                \"subtitle\": subtitle ,\n                \"buttons\": buttons\n               \n        })\n       }\n    }\n}\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nif(elementsY.length < 1 ){\n    msg.payload = {};\n   return[null,msg];\n}else{\n    return [msg,null];\n}\n\n","outputs":2,"noerr":0,"x":948,"y":220,"wires":[[],["710333f9.c4305c"]]},{"id":"f0f33b27.6070d8","type":"switch","z":"ec000337.2949e","name":"","property":"payload.subscriptions.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":688,"y":264,"wires":[["aa8d4cc4.f6d5a"],["245928b4.6d29c8"]]},{"id":"3f4206cb.39764a","type":"chatbot-text","z":"ec000337.2949e","name":"no subscriptions","message":[{"message":"Your dont seem to have any active purchases, please subscribe to a plan first."}],"x":1026,"y":286,"wires":[[]]},{"id":"e5cf7a55.167158","type":"debug","z":"52c3ea26.423dc4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":310,"y":340,"wires":[]},{"id":"829f7ab0.a23728","type":"function","z":"36668667.1d6eea","name":"Typing","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' + env.get('ROOM')+ '/typing/' + env.get('BOT')+'?access_token='+ env.get('TOKEN')\nmsg.payload={\n\n  \"typing\": true,\n  \"timeout\": 2000\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":490,"y":160,"wires":[["69474c1c.c5b794"]]},{"id":"69474c1c.c5b794","type":"http request","z":"36668667.1d6eea","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":650,"y":160,"wires":[["d8e4e866.a07188","ed3212b9.36aa3"]]},{"id":"d8e4e866.a07188","type":"delay","z":"36668667.1d6eea","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":820,"y":160,"wires":[[]]},{"id":"ed3212b9.36aa3","type":"debug","z":"36668667.1d6eea","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":810,"y":220,"wires":[]},{"id":"796ee499.f69a3c","type":"delay","z":"36668667.1d6eea","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":160,"wires":[["829f7ab0.a23728"]]},{"id":"867e8e24.bde5d","type":"http request","z":"52c3ea26.423dc4","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"authType":"","x":110,"y":160,"wires":[[]]},{"id":"522e775b.2a9618","type":"http request","z":"52c3ea26.423dc4","name":"Segment","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":984,"y":374,"wires":[[]]},{"id":"62be5d6e.7addf4","type":"function","z":"52c3ea26.423dc4","name":"","func":"msg.url = 'https://api.segment.io/v1/track'\n\nmsg.payload = {\n  \"userId\": \"X19mr8mf4r\",\n  \"event\": \"Item Purchased\",\n  \"properties\": {\n    \"name\": \"Leap to Conclusions Mat\",\n    \"revenue\": 14.99\n  },\n  \"context\": {\n    \"ip\": \"24.5.68.47\"\n  },\n  \"timestamp\": \"2012-12-02T00:30:12.984Z\"\n}","outputs":1,"noerr":0,"x":810,"y":360,"wires":[["522e775b.2a9618"]]},{"id":"7c4cc6f.a237438","type":"function","z":"f36f07a7.353538","name":"flow plans cards","func":"\nvar elementsY=[];\n elementsY.push\n({\n    \"title\": env.get('Title'),\n    \"subtitle\":env.get('Subtitle'), //\"7 days free! then â‚¬9.00 / month\"\n    \"imageUrl\": env.get('Image'),//\"\n    \"buttons\": \n        [\n            {\n                \"type\": \"request_url_only\",\n                \"label\": env.get('Call To Action'), //\"Subscribe\",\n                \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/subscribe/flow\" + '/'+env.get('Stripe Plan'),\n                \"alert\": false\n            },\n            {\n                \"type\": \"url\",\n                \"label\": env.get('Learn More Label'), // \"See more\",\n                \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/subscribe/flow\",\n                \"alert\": false\n            }\n        ]\n});\n \n       \n       \n    \n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":80,"wires":[[]]},{"id":"95a765e2.25e548","type":"delay","z":"f36f07a7.353538","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":180,"y":80,"wires":[["7c4cc6f.a237438"]]},{"id":"db299292.b9ba8","type":"chatbot-generic-buttons","z":"52c3ea26.423dc4","name":"","buttons":[{"type":"postback","label":"Tekos Flow Plans","value":"subscribe to flow","alert":false},{"type":"postback","label":"My Flows","value":"my flows","alert":false}],"message":"To build and customize your Chatbot, you need to use Tekos Flow service !","x":1020,"y":320,"wires":[["31366499.399f9c"]]},{"id":"1cf896a5.cf94a9","type":"function","z":"91f083d1.0d1a3","name":"start creation flow","func":"node.warn(\"test env var\")\nnode.warn(msg)\nnode.warn(env.get(\"AMI\"))\n\nif(env.get(\"subdomain\")&& env.get(\"subscription\") || (msg.subdomain   && msg.subscription)){\n    var clientname = env.get(\"subdomain\") || msg.subdomain\n   \n    var subscription = msg.subscription\n    msg.payload = clientname;\n    msg.clientname = clientname\n    msg.subscription  =subscription\n    msg.roomId = msg.roomId;\n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":390,"y":100,"wires":[[],["374f0bfc.711d04"]]},{"id":"286e37e0.5631c8","type":"switch","z":"91f083d1.0d1a3","name":"","property":"payload.ChangeInfo.Status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":60,"wires":[["99264edf.ca29"],["def9a5d4.ff4428"]]},{"id":"def9a5d4.ff4428","type":"function","z":"91f083d1.0d1a3","name":"fail","func":"msg.payload = \"le domaine existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":80,"wires":[["d10c5698.66fcb8"]]},{"id":"99264edf.ca29","type":"function","z":"91f083d1.0d1a3","name":"success","func":"//msg.payload = \"le domaine \"+msg.clientname+\".tekos.co est creer\"\nmsg.payload.subdomain = msg.clientname;\nreturn msg;","outputs":1,"noerr":0,"x":1020,"y":40,"wires":[["2a7008dc.351028"]]},{"id":"2a7008dc.351028","type":"link out","z":"91f083d1.0d1a3","name":"","links":["81349065.43eaf"],"x":1115,"y":40,"wires":[]},{"id":"81349065.43eaf","type":"link in","z":"91f083d1.0d1a3","name":"","links":["2a7008dc.351028"],"x":255,"y":200,"wires":[[]]},{"id":"69e61f85.dbbf5","type":"switch","z":"91f083d1.0d1a3","name":"","property":"payload.TargetGroups[0].TargetGroupArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":650,"y":200,"wires":[["6cdd3a61.ef3794"],["359501bb.5a5f4e"]]},{"id":"359501bb.5a5f4e","type":"function","z":"91f083d1.0d1a3","name":"fail","func":"msg.payload = \"erreur lors de la creation d'un target group : le groupe existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":220,"wires":[["bdf31cb2.b44af"]]},{"id":"6cdd3a61.ef3794","type":"link out","z":"91f083d1.0d1a3","name":"","links":["f1f9d951.71a288"],"x":775,"y":160,"wires":[]},{"id":"f1f9d951.71a288","type":"link in","z":"91f083d1.0d1a3","name":"","links":["6cdd3a61.ef3794"],"x":255,"y":260,"wires":[[]]},{"id":"2a2cf56e.e684ea","type":"function","z":"91f083d1.0d1a3","name":"return unique priotrity","func":"function getMissingNumber(nums) {\n    var swap = function(i, j) {\n        var tmp = nums[i];\n        nums[i] = nums[j];\n        nums[j] = tmp;\n    };\n\n    for (let i = 0; i < nums.length; i++) {\n        while (0 < nums[i] && nums[i] - 1 < nums.length && nums[i] != i + 1 && nums[i] != nums[nums[i] - 1]) {\n            swap(i, nums[i] - 1);\n        }\n    }\n\n    for (let i = 0; i < nums.length; i++) {\n        if (nums[i] != i + 1) {\n            return i + 1;\n        }\n    }\n    return nums.length + 1;\n}\n\n\nnode.warn(msg)\nmsg.subdomain = msg.subdomain\nvar allrules = msg.payload.Rules;\nvar priorities = [];\nfor(var i=0, len=allrules.length; i < len; i++){\n    let prio;\n    if(allrules[i].Priority == \"default\")\n    prio = 0\n    else\n    prio = Number(allrules[i].Priority)\n    priorities.push(prio)\n}\nvar firstMissingPositive = getMissingNumber(priorities)\nmsg.payload = firstMissingPositive\nmsg.targetgroup = msg.targetgroup;\n\nnode.warn(\"finish geting the smallest int\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":260,"wires":[["127b63a7.1894dc"]]},{"id":"eb427e61.433cf","type":"link in","z":"91f083d1.0d1a3","name":"","links":["127b63a7.1894dc"],"x":255,"y":320,"wires":[[]]},{"id":"127b63a7.1894dc","type":"link out","z":"91f083d1.0d1a3","name":"","links":["eb427e61.433cf"],"x":795,"y":260,"wires":[]},{"id":"c99f49f4.7f22f8","type":"function","z":"91f083d1.0d1a3","name":"Base64 script converter","func":"    function utf8encode (string) {\n    string = string.replace(/\\r\\n/g,\"\\n\");\n    var utftext = \"\";\n\n    for (var n = 0; n < string.length; n++) {\n\n        var c = string.charCodeAt(n);\n\n        if (c < 128) {\n            utftext += String.fromCharCode(c);\n        }\n        else if((c > 127) && (c < 2048)) {\n            utftext += String.fromCharCode((c >> 6) | 192);\n            utftext += String.fromCharCode((c & 63) | 128);\n        }\n        else {\n            utftext += String.fromCharCode((c >> 12) | 224);\n            utftext += String.fromCharCode(((c >> 6) & 63) | 128);\n            utftext += String.fromCharCode((c & 63) | 128);\n        }\n\n    }\n\n    return utftext;\n}\n function encode (input) {\n    var keyStr = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n    var output = \"\";\n    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;\n    var i = 0;\n\n    input = utf8encode(input);\n\n    while (i < input.length) {\n\n        chr1 = input.charCodeAt(i++);\n        chr2 = input.charCodeAt(i++);\n        chr3 = input.charCodeAt(i++);\n\n        enc1 = chr1 >> 2;\n        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);\n        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);\n        enc4 = chr3 & 63;\n\n        if (isNaN(chr2)) {\n            enc3 = enc4 = 64;\n        } else if (isNaN(chr3)) {\n            enc4 = 64;\n        }\n\n        output = output +\n        keyStr.charAt(enc1) + keyStr.charAt(enc2) +\n        keyStr.charAt(enc3) + keyStr.charAt(enc4);\n\n    }\n\n    return output;\n}\n\nvar script = \"#!/bin/bash \\nsed -i -e 's/tekos-user-readonly/\"+msg.login+\"/g' /home/ubuntu/.node-red/settings.js \\nhashed_password=$(node -e \\\"console.log(require('/home/ubuntu/.node-red/node_modules/bcryptjs').hashSync(process.argv[1], 8));\\\" \"+msg.pwd+\") \\nsed -i -e 's|tekosuser_pass_readonly|'$hashed_password'|g' /home/ubuntu/.node-red/settings.js \\nsed -i -e 's/instance-environment/prod/g' /home/ubuntu/.node-red/settings.js \\nreboot\"\n\nmsg.payload = msg.payload;\nmsg.script = encode(script);\nmsg.ami = env.get(\"AMI\");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":870,"y":660,"wires":[[]]},{"id":"10bf42fc.b7be5d","type":"function","z":"d97495d8.5a8468","name":"start creation client","func":"node.warn(\"test env var\")\nnode.warn(msg)\n\nif((env.get(\"subdomain\")  && env.get(\"subscription\") )|| (msg.subdomain && msg.subscription)){\n    var clientname =  msg.subdomain || env.get(\"subdomain\")\n \n    var subscription = msg.subscription\n    msg.payload = clientname;\n    msg.clientname = clientname\n    msg.subscription  =subscription\n    msg.client.subscription = subscription;\n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":250,"y":60,"wires":[[],["191c4fb3.3ef04"]]},{"id":"b27e76d7.09a418","type":"switch","z":"d97495d8.5a8468","name":"","property":"payload.ChangeInfo.Status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":750,"y":60,"wires":[["7ac83ca6.90bd44"],["9bb39c73.4a3e8"]]},{"id":"9bb39c73.4a3e8","type":"function","z":"d97495d8.5a8468","name":"fail","func":"msg.payload = \"le domaine existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":890,"y":60,"wires":[["3fcb1380.ded4bc"]]},{"id":"7ac83ca6.90bd44","type":"function","z":"d97495d8.5a8468","name":"success","func":"//msg.payload = \"le domaine \"+msg.clientname+\".tekos.co est creer\"\nmsg.payload.subdomain = msg.clientname;\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":20,"wires":[["eb7b1e0.8a0b9e"]]},{"id":"eb7b1e0.8a0b9e","type":"link out","z":"d97495d8.5a8468","name":"","links":["c2e3336d.76252"],"x":1015,"y":20,"wires":[]},{"id":"c2e3336d.76252","type":"link in","z":"d97495d8.5a8468","name":"","links":["eb7b1e0.8a0b9e"],"x":75,"y":140,"wires":[[]]},{"id":"63a0cd60.84b314","type":"switch","z":"d97495d8.5a8468","name":"","property":"payload.TargetGroups[0].TargetGroupArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":140,"wires":[["10f221a1.d476fe"],["a3203805.240cd8"]]},{"id":"a3203805.240cd8","type":"function","z":"d97495d8.5a8468","name":"fail","func":"msg.payload = \"erreur lors de la creation d'un target group : le groupe existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":180,"wires":[["adfeb5fe.020af8"]]},{"id":"10f221a1.d476fe","type":"link out","z":"d97495d8.5a8468","name":"","links":["a4aeb42f.553a08"],"x":595,"y":120,"wires":[]},{"id":"a4aeb42f.553a08","type":"link in","z":"d97495d8.5a8468","name":"","links":["10f221a1.d476fe"],"x":75,"y":240,"wires":[[]]},{"id":"6241fbac.d82644","type":"function","z":"d97495d8.5a8468","name":"return unique priotrity","func":"function getMissingNumber(nums) {\n    var swap = function(i, j) {\n        var tmp = nums[i];\n        nums[i] = nums[j];\n        nums[j] = tmp;\n    };\n\n    for (let i = 0; i < nums.length; i++) {\n        while (0 < nums[i] && nums[i] - 1 < nums.length && nums[i] != i + 1 && nums[i] != nums[nums[i] - 1]) {\n            swap(i, nums[i] - 1);\n        }\n    }\n\n    for (let i = 0; i < nums.length; i++) {\n        if (nums[i] != i + 1) {\n            return i + 1;\n        }\n    }\n    return nums.length + 1;\n}\n\n\nnode.warn(msg)\nmsg.subdomain = msg.subdomain\nvar allrules = msg.payload.Rules;\nvar priorities = [];\nfor(var i=0, len=allrules.length; i < len; i++){\n    let prio;\n    if(allrules[i].Priority == \"default\")\n    prio = 0\n    else\n    prio = Number(allrules[i].Priority)\n    priorities.push(prio)\n}\nvar firstMissingPositive = getMissingNumber(priorities)\nmsg.payload = firstMissingPositive\nmsg.targetgroup = msg.targetgroup;\n\nnode.warn(\"finish geting the smallest int\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":584,"y":242,"wires":[["6ced8b3b.9e53c4"]]},{"id":"9329a8ab.f9ded8","type":"link in","z":"d97495d8.5a8468","name":"","links":["6ced8b3b.9e53c4"],"x":59,"y":330,"wires":[[]]},{"id":"6ced8b3b.9e53c4","type":"link out","z":"d97495d8.5a8468","name":"","links":["9329a8ab.f9ded8"],"x":725,"y":240,"wires":[]},{"id":"3fcb1380.ded4bc","type":"link out","z":"d97495d8.5a8468","name":"","links":["932feb4d.3535e","76ef21ca.3eade"],"x":983,"y":66,"wires":[]},{"id":"adfeb5fe.020af8","type":"link out","z":"d97495d8.5a8468","name":"","links":["932feb4d.3535e","dc3ad172.511d"],"x":735,"y":180,"wires":[]},{"id":"76ef21ca.3eade","type":"link in","z":"d97495d8.5a8468","name":"","links":["191c4fb3.3ef04","3fcb1380.ded4bc"],"x":75,"y":420,"wires":[[]]},{"id":"10b43f98.3ad82","type":"link in","z":"d97495d8.5a8468","name":"","links":["93a235e4.537da8"],"x":75,"y":500,"wires":[[]]},{"id":"95f4ffe7.c9b02","type":"comment","z":"d97495d8.5a8468","name":"error while creating the client","info":"","x":440,"y":420,"wires":[]},{"id":"f7a574e5.d446a8","type":"comment","z":"d97495d8.5a8468","name":"auto deploy done successfuly","info":"","x":440,"y":500,"wires":[]},{"id":"93a235e4.537da8","type":"link out","z":"d97495d8.5a8468","name":"","links":["10b43f98.3ad82"],"x":1181,"y":286,"wires":[]},{"id":"77684427.6705bc","type":"link in","z":"91f083d1.0d1a3","name":"","links":["b140a3be.35ec6","bdf31cb2.b44af","374f0bfc.711d04","d10c5698.66fcb8"],"x":235,"y":460,"wires":[[]]},{"id":"bdf31cb2.b44af","type":"link out","z":"91f083d1.0d1a3","name":"","links":["77684427.6705bc"],"x":915,"y":220,"wires":[]},{"id":"374f0bfc.711d04","type":"link out","z":"91f083d1.0d1a3","name":"","links":["77684427.6705bc"],"x":535,"y":120,"wires":[]},{"id":"fd3e5cef.06df8","type":"http request","z":"93dbee73.58db9","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","persist":false,"proxy":"","authType":"","x":466,"y":242,"wires":[["99b6d1de.9d99d","baf1b3.1d514e5"]]},{"id":"1e0085a9.c56eea","type":"function","z":"93dbee73.58db9","name":"create session","func":"node.warn(\"start creating session\")\nnode.warn(msg)\nvar dataString,plan,room;\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar nbr_users = msg.nbrusers\nvar customer = msg.customer\nvar typeplan = msg.typeplan;\nif(msg.tekos.roomId && !msg.roomId){\n    msg.roomId = msg.tekos.roomId;\n}\nif(!nbr_users ){\n   nbr_users = 1\n}\n\nplan = msg.plan_id;\nif(msg.tekos.trial > 0 ){\n      dataString = 'payment_method_types[]=card&customer='+customer.id+'&success_url=https://chat.tekos.co/#/room/'+msg.roomId+'&mode=subscription&subscription_data[items][][plan]='+plan+'&subscription_data[items][][quantity]='+nbr_users+'&subscription_data[trial_period_days]='+msg.tekos.trial+'&cancel_url=https://chat.tekos.co/#/room/'+msg.roomId+\"&subscription_data[metadata][roomId]=\"+msg.roomId+\"&subscription_data[metadata][origin]=bot&subscription_data[metadata][type]=\"+typeplan;\n\n}\nelse{\n      dataString = 'payment_method_types[]=card&customer='+customer.id+'&success_url=https://chat.tekos.co/#/room/'+msg.roomId+'&mode=subscription&subscription_data[items][][plan]='+plan+'&subscription_data[items][][quantity]='+nbr_users+'&cancel_url=https://chat.tekos.co/#/room/'+msg.roomId+'&subscription_data[metadata][roomId]='+msg.roomId+'&subscription_data[metadata][origin]=bot&subscription_data[metadata][type]='+typeplan;\n}\nif(msg.tekos.senderId){\n    dataString+= \"&subscription_data[metadata][user]=\"+msg.tekos.senderId;\n}\n//sk_test_fY14VeGn3yvgxSPpmsuyt5pB\n//sk_test_jHqWveQupcd4bBiapSFB3wB6\n    \nmsg.payload=dataString\n  \nreturn msg;","outputs":1,"noerr":0,"x":260,"y":240,"wires":[["fd3e5cef.06df8","5d7bdba2.24dac4"]]},{"id":"971036e8.c62c28","type":"function","z":"93dbee73.58db9","name":"show button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"sending button\");\nnode.warn(msg);\nfunction percentage(num, per)\n{\n  return (num/100)*per;\n}\nnode.warn(msg)\nvar str = msg.payload.success_url; \nvar n = str.lastIndexOf('/'); \nvar result = str.substring(n + 1); \nvar ammounttopay = (msg.payload.display_items[0].amount)/100 \nvar origin = ammounttopay;\n\nvar diff;\nammounttopay = ammounttopay + percentage(ammounttopay,msg.pourcentage)\nammounttopay = ammounttopay.toFixed(2);\nif(msg.nbrusers){\n    if(msg.nbrusers > 1){\n        var nbr = Number(msg.nbrusers)\n        ammounttopay = ammounttopay * nbr;\n        origin = origin * nbr;\n        diff = ammounttopay - origin;\n        diff = diff.toFixed(2);\n        origin = origin.toFixed(2);\n    }\n}else{\n    origin = origin.toFixed(2);\n}\ndiff = ammounttopay - origin;\ndiff = diff.toFixed(2);\n // end subsctract string code\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\":\"Pay â‚¬\"+ammounttopay+\" (â‚¬\"+origin+\" + â‚¬\"+diff+\" tax)\",\n    \t\"token_stripe\": env.get(\"STRIPE_PUB_KEY\")\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1038,"y":220,"wires":[["1cd2b10a.57754f"]]},{"id":"775b23fd.204cfc","type":"chatbot-generic-form","z":"4326faf3.398664","name":"setup 1","title":"Create your own tekos homeserver","subtitle":"Set up your hosted homeserver","formId":"setup1","posturl":"https://wided.tekos.co/setup/homeserver/1","action":"Next","cancel":"Cancel","options":[{"label":"Step 1 - Choose a hostname","value":"hostname","type":"text","list":"","required":true},{"label":"Enable federation","value":"enable_federation","type":"list","list":"on:ON,off:OFF","required":true},{"label":"Allow guest users","value":"allow_guest_users","type":"list","list":"on:ON,off:OFF","required":true},{"label":"Enable public registration","value":"enable_public_regstration","type":"list","list":"on:ON,off:OFF","required":true},{"label":"Whitelisted registration domains & email addresses","value":"whitelist","type":"text","list":"","required":true},{"label":"Reserved user accounts","value":"reserved_user_accounts","type":"text","list":"","required":true},{"label":"Custom DNS","value":"custom_dns","type":"list","list":"off:OFF,on:ON","required":true},{"label":"Custom Homeserver domain","value":"custom_homeserver_domain","type":"text","list":"","required":true},{"label":"Custom Client domain","value":"custom_client_domain","type":"text","list":"","required":true}],"formValue":{"hostname":"","enable_federation":"","allow_guest_users":"","enable_public_regstration":"","whitelist":"","reserved_user_accounts":"","custom_dns":"","custom_homeserver_domain":"","custom_client_domain":""},"payload":"","topic":"","x":240,"y":100,"wires":[[]]},{"id":"cf70005e.a75ae","type":"http in","z":"4326faf3.398664","name":"","url":"/setup/homeserver/1","method":"post","upload":false,"swaggerDoc":"","x":210,"y":200,"wires":[["5e7e6fcd.4ba22","d94a2d1.b32ccd"]]},{"id":"5e7e6fcd.4ba22","type":"http response","z":"4326faf3.398664","name":"OK","statusCode":"200","headers":{},"x":390,"y":160,"wires":[]},{"id":"3b8a9f55.cde6","type":"function","z":"4326faf3.398664","name":"create email body","func":"msg={\n    payload:msg.payload,\n    topic:\"the user \"+msg.payload.senderId+\" oredred a homeserver plan\",\n    to:\"mohamedayoubghaddab@gmail.com\",\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":200,"wires":[[]]},{"id":"d94a2d1.b32ccd","type":"function","z":"4326faf3.398664","name":"create table","func":"var jsondata = msg.payload;\n\nvar services = [];\nfor(var i in jsondata){\n    \n    var item = jsondata[i];   \n    if(item.value){\n          services.push({\n        \"Service\":i,\n        \"Value\":item.value\n    })\n    }else{\n        services.push({\n        \"Service\":i,\n        \"Value\":item\n    })\n    }\n    \n}\n\n\n\nnode.warn(\"array\");\nnode.warn(services);\nmsg.payload = services;\nreturn msg;","outputs":1,"noerr":0,"x":430,"y":200,"wires":[["924c1531.9667e8"]]},{"id":"1d6a8857.cbf328","type":"template","z":"4326faf3.398664","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<table width=\"100%\">\n  <tr>\n    <th>Service</th>\n    <th>Value</th> \n  </tr>\n  {{#payload}}\n  <tr>\n    <td>{{{Service}}}</td>\n    <td>{{Value}}</td> \n  </tr>\n  {{/payload}}\n</table>","x":850,"y":200,"wires":[["3b8a9f55.cde6"]]},{"id":"17b2c20f.820f1e","type":"template","z":"4326faf3.398664","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":710,"y":200,"wires":[["1d6a8857.cbf328"]]},{"id":"924c1531.9667e8","type":"json","z":"4326faf3.398664","name":"","property":"payload","action":"obj","pretty":false,"x":570,"y":200,"wires":[["17b2c20f.820f1e"]]},{"id":"d1fc54a8.338638","type":"function","z":"8b2c5df2.e16a3","name":"Check Subscription details","func":"node.warn(\"### payload success #####\");\nnode.warn(msg)\n// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nvar metadata = msg.payload.data.object.metadata; \n \n\nif(metadata.origin){\n     // end subsctract string code\nmsg.roomId = metadata.roomId;\nmsg.payload = msg.payload;\nmsg.plan =msg.payload.data.object.plan.id\nnode.warn(\"## retreive plan ##\");\nmsg.sub  = {};\nmsg.sub.id = msg.payload.data.object.id;\nnode.warn(msg);\nreturn [msg,null];\n\n\n}else{\nnode.warn(\"before retrive\")\nnode.warn(msg)\nmsg.payload = msg.payload \nmsg.plan =msg.payload.data.object.plan.id\nreturn [null,msg];\n\n\n}\n","outputs":2,"noerr":0,"x":640,"y":180,"wires":[["dd500c85.c4ddf"],["54536c3e.cfee14"]],"outputLabels":["chat bot subscription","tekos.co subscription"]},{"id":"39bd2cf4.e0dbd4","type":"switch","z":"8b2c5df2.e16a3","name":"payment ?","property":"payload.type","propertyType":"msg","rules":[{"t":"eq","v":"customer.subscription.created","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":180,"wires":[["d1fc54a8.338638"],[]]},{"id":"a63c789d.54ad58","type":"link out","z":"8b2c5df2.e16a3","name":"","links":[],"x":1093,"y":726,"wires":[]},{"id":"dd500c85.c4ddf","type":"link out","z":"8b2c5df2.e16a3","name":"","links":["8f054de9.43039"],"x":815,"y":160,"wires":[]},{"id":"8f054de9.43039","type":"link in","z":"8b2c5df2.e16a3","name":"","links":["dd500c85.c4ddf"],"x":257,"y":264,"wires":[["299fb353.d06d2c"]]},{"id":"842f4bad.701848","type":"subflow:4326faf3.398664","z":"8b2c5df2.e16a3","name":"","env":[],"x":922,"y":726,"wires":[["a63c789d.54ad58"]]},{"id":"907a7137.106b1","type":"switch","z":"8b2c5df2.e16a3","name":"flow or chat plans ?","property":"plan","propertyType":"msg","rules":[{"t":"eq","v":"plan_FOIJii5a6nfSri","vt":"str"},{"t":"eq","v":"flow_test_nano","vt":"str"},{"t":"eq","v":"plan_FVVUA068cJDpEc","vt":"str"},{"t":"eq","v":"plan_FVVTFqVAIIdWJl","vt":"str"},{"t":"eq","v":"put_server_plan_here","vt":"str"}],"checkall":"true","repair":false,"outputs":5,"x":390,"y":620,"wires":[["50264a89.96cde4"],["50264a89.96cde4"],["f87d8f9f.5742d"],["f87d8f9f.5742d"],["7b07f598.36564c"]]},{"id":"50264a89.96cde4","type":"function","z":"8b2c5df2.e16a3","name":"create subflow ","func":"node.warn(\"### console log #####\");\n\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":640,"y":600,"wires":[["bce055d2.153c38"]]},{"id":"4bf73b18.0ac9e4","type":"link in","z":"8b2c5df2.e16a3","name":"","links":[],"x":235,"y":620,"wires":[["907a7137.106b1"]]},{"id":"61a4d8f5.89a448","type":"http request","z":"8b2c5df2.e16a3","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":990,"y":400,"wires":[["bfab11fe.4525"]]},{"id":"88e65d45.e270c","type":"function","z":"8b2c5df2.e16a3","name":"customer update email","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\nvar customer = msg.customer;\n\nmsg.url =\"https://api.stripe.com/v1/customers/\"+customer.id\nvar dataString = 'metadata[other_emails]='+customer.email+'&email='+customer.email;\n    \nmsg.payload=dataString\n\nreturn msg;","outputs":1,"noerr":0,"x":790,"y":400,"wires":[["61a4d8f5.89a448"]]},{"id":"7f78f92c.f49738","type":"function","z":"8b2c5df2.e16a3","name":"Get Customers","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    node.warn(\"get customer after payment\")\n    node.warn(msg)\n    var customer\n    if(msg.subscription){\n     customer = msg.subscription.customer;  \n    }else{\n        customer = msg.customer;\n    }\n    msg.url =\"https://api.stripe.com/v1/customers/\"+customer.id;\n    return msg;\n","outputs":1,"noerr":0,"x":520,"y":396,"wires":[["88e65d45.e270c"]]},{"id":"48a28d7f.3002f4","type":"link in","z":"8b2c5df2.e16a3","name":"","links":["7c95a309.9aec9c"],"x":389,"y":396,"wires":[["7f78f92c.f49738"]]},{"id":"f87d8f9f.5742d","type":"function","z":"8b2c5df2.e16a3","name":"create chat client ","func":"node.warn(\"### console log #####\");\n\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":660,"wires":[[]]},{"id":"7b07f598.36564c","type":"function","z":"8b2c5df2.e16a3","name":"create custom server ","func":"node.warn(\"### console log #####\");\n\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":660,"y":720,"wires":[["842f4bad.701848"]]},{"id":"e172a0c4.2fc43","type":"http in","z":"d97495d8.5a8468","name":"After Payment ","url":"/setup/homeserver/3","method":"post","upload":false,"swaggerDoc":"","x":450,"y":460,"wires":[["b492ac5e.1ad56","9eb4cd97.0b22d","91a6fd26.3dd1b"]]},{"id":"b492ac5e.1ad56","type":"http response","z":"d97495d8.5a8468","name":"","statusCode":"200","headers":{},"x":680,"y":420,"wires":[]},{"id":"9eb4cd97.0b22d","type":"function","z":"d97495d8.5a8468","name":" coded data","func":"msg.subdomain = msg.payload.hostname;\nmsg.login = msg.payload.login;\nmsg.pwd = msg.payload;\nmsg.email = \"ayoub@tekos.co\"\nreturn msg;","outputs":1,"noerr":0,"x":690,"y":480,"wires":[["9df58d70.09fd9"]]},{"id":"9df58d70.09fd9","type":"link out","z":"d97495d8.5a8468","name":"","links":[],"x":835,"y":480,"wires":[]},{"id":"91a6fd26.3dd1b","type":"debug","z":"d97495d8.5a8468","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":690,"y":540,"wires":[]},{"id":"ef353dc6.dd61c","type":"http in","z":"91f083d1.0d1a3","name":"After Payment ","url":"/setup/homeserver/2/:roomId","method":"post","upload":false,"swaggerDoc":"","x":310,"y":580,"wires":[["a17f8bc0.3768c8","181dc2ad.9689ed","61c3d298.c787bc"]]},{"id":"a17f8bc0.3768c8","type":"http response","z":"91f083d1.0d1a3","name":"","statusCode":"200","headers":{},"x":500,"y":540,"wires":[]},{"id":"181dc2ad.9689ed","type":"function","z":"91f083d1.0d1a3","name":" coded data","func":"msg.subdomain = msg.payload.hostname;\nmsg.login = msg.payload.login;\nmsg.pwd = msg.payload.pwd\nmsg.email = \"ayoub@tekos.co\"\nmsg.roomId = msg.req.params.roomId\nreturn msg;","outputs":1,"noerr":0,"x":510,"y":580,"wires":[["35caa31a.1ba2cc"]]},{"id":"35caa31a.1ba2cc","type":"link out","z":"91f083d1.0d1a3","name":"","links":["7c73f526.72f63c"],"x":635,"y":580,"wires":[]},{"id":"61c3d298.c787bc","type":"debug","z":"91f083d1.0d1a3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":480,"y":640,"wires":[]},{"id":"bce055d2.153c38","type":"function","z":"8b2c5df2.e16a3","name":"create flow param form","func":"\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Create your own Subflow',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/createflow/\"+msg.payload.id+\"/\"+msg.roomId,\n    \"buttontitle\": \"Valider\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Step 1 - Choose a hostname\",\n        \"key\": \"hostname\"\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Step 2 - Choose a login\",\n        \"key\": \"login\"\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Step 3 - Choose a password\",\n        \"key\": \"pwd\"\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Repeat password\",\n        \"key\": \"repwd\"\n      }\n    ]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":600,"wires":[["5ee67508.2c536c"]]},{"id":"5ee67508.2c536c","type":"http request","z":"8b2c5df2.e16a3","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1060,"y":600,"wires":[["8230b711.c3c388"]]},{"id":"54743d6d.906514","type":"function","z":"8b2c5df2.e16a3","name":"debug","func":"node.warn(\"event id maybe\");\nvar roomId = msg.roomId;\nnode.warn(msg);\nflow.set(\"formevent\"+roomId, msg.payload.event_id)\nreturn msg;","outputs":1,"noerr":0,"x":1310,"y":580,"wires":[[]]},{"id":"8230b711.c3c388","type":"switch","z":"8b2c5df2.e16a3","name":"","property":"payload.event_id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1190,"y":600,"wires":[["54743d6d.906514"],[]]},{"id":"839b6843.503d28","type":"function","z":"a628a20f.af3f1","name":"Initial check","func":"\n\nif((env.get(\"roomId\") &&  env.get(\"evenId\") && env.get(\"access_token\")) || (msg.access_token && msg.evenId && msg.roomIdl)){\n    var roomId = env.get(\"roomId\") || msg.roomId\n    var evenId = env.get(\"evenId\") || msg.evenId\n    var access_token = env.get(\"access_token\") || msg.access_token\n    msg.access_token = access_token;\n    msg.roomId = roomId\n    msg.evenId = evenId;\n   \n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":380,"y":100,"wires":[["a5dcb5bc.18c968"],["38f6ac97.787fa4"]]},{"id":"a5dcb5bc.18c968","type":"function","z":"a628a20f.af3f1","name":"Create API call","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/redact/\"+msg.eventId+\"/1\" \nmsg.payload=\n{\n  \"reason\": \"Deleted after flow purchased\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":600,"y":60,"wires":[["d6729be0.943788"]]},{"id":"d6729be0.943788","type":"http request","z":"a628a20f.af3f1","name":"post to tekos","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":790,"y":60,"wires":[[]]},{"id":"38f6ac97.787fa4","type":"chatbot-text","z":"a628a20f.af3f1","name":"Param missing","message":[{"message":"one or more parameters is/are missing"}],"x":580,"y":140,"wires":[[]]},{"id":"7c73f526.72f63c","type":"link in","z":"91f083d1.0d1a3","name":"","links":["35caa31a.1ba2cc"],"x":235,"y":40,"wires":[["1cf896a5.cf94a9"]]},{"id":"262b70c6.35eae","type":"http request","z":"c47f16f1.a03068","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1490,"y":572,"wires":[["e5be406b.ea765"]]},{"id":"8346c9b2.b97c18","type":"subflow:c7e8665f.63e4d8","z":"8b2c5df2.e16a3","name":"","env":[{"name":"email","value":"feedback@tekos.co","type":"str"},{"name":"host","value":"smtp.mail.eu-west-1.awsapps.com","type":"str"},{"name":"port","value":"465","type":"num"},{"name":"username","value":"feedback@tekos.co","type":"str"},{"name":"password","value":"TekosChat2020!","type":"str"},{"name":"smtpHost","value":"smtp.mail.eu-west-1.awsapps.com","type":"str"}],"x":500,"y":506,"wires":[]},{"id":"c807a0db.0c8ed","type":"function","z":"c7e8665f.63e4d8","name":"Get Subscription ","func":"msg.customer = msg.payload\n\nmsg.plan = msg.plan\n\nnode.warn(\"start sending subscription plan via email\");\nnode.warn(msg);\nmsg.payload.subscriptionId = msg.plan.data.object.subscription;\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":300,"wires":[["87aae4d2.190fc8"]]},{"id":"54536c3e.cfee14","type":"link out","z":"8b2c5df2.e16a3","name":"","links":["b935b24b.092b7"],"x":815,"y":200,"wires":[]},{"id":"b935b24b.092b7","type":"link in","z":"8b2c5df2.e16a3","name":"","links":["54536c3e.cfee14"],"x":260,"y":500,"wires":[["8346c9b2.b97c18"]]},{"id":"a854748a.bd6448","type":"function","z":"c7e8665f.63e4d8","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\nnode.warn(msg.customer.email);\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\n\nmsg={\n    payload:msg.payload,\n    topic:\"Action required: Setup your Tekos Flow Workspace\",\n    to:msg.customer.email\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":740,"y":300,"wires":[[]]},{"id":"472ebaad.57bb24","type":"template","z":"c7e8665f.63e4d8","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n<p>Hi there !</p>\n<p>Thank you for your subscription to Tekos Flow and welcome aboard!<br />To start using your Flow, you need to customize your worspace with our TekosBot using this token:&nbsp;&nbsp;{{{plan.data.object.id}}} and following this link:&nbsp;<a href=\"https://chat.tekos.co/?msg=setup%20flow%20instance#/user/@tekos-bot:m.tekos.co\">Customize my Flow</a></p>\n<p>As part of your subscription plan you have access to support via email and issue tracking system. <a href=\"https://tekos.freshdesk.com/support/home. \">https://tekos.freshdesk.com/support/home. </a></p>\n<p>For any questions or concerns do not hesitate to contact us at anytime at <a href=\"mailto:support@tekos.co\">support@tekos.co</a></p>\n<p><br /> Tekos Team</p>\n</body>","x":550,"y":300,"wires":[["a854748a.bd6448"]]},{"id":"87aae4d2.190fc8","type":"template","z":"c7e8665f.63e4d8","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":390,"y":300,"wires":[["472ebaad.57bb24"]]},{"id":"8d048c9b.74607","type":"http request","z":"c7e8665f.63e4d8","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":430,"y":220,"wires":[["9c9ce4f0.a770e8","7122dfbf.a9a85"]]},{"id":"69ba1cc6.bf29d4","type":"function","z":"c7e8665f.63e4d8","name":"Get Customers","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    msg.plan = msg.payload;\n    msg.url =\"https://api.stripe.com/v1/customers/\"+msg.payload.data.object.customer\n    return msg;\n","outputs":1,"noerr":0,"x":240,"y":220,"wires":[["8d048c9b.74607"]]},{"id":"9c9ce4f0.a770e8","type":"link out","z":"c7e8665f.63e4d8","name":"","links":["3233098e.f8e306"],"x":555,"y":220,"wires":[]},{"id":"3233098e.f8e306","type":"link in","z":"c7e8665f.63e4d8","name":"","links":["9c9ce4f0.a770e8"],"x":55,"y":300,"wires":[["c807a0db.0c8ed"]]},{"id":"7122dfbf.a9a85","type":"debug","z":"c7e8665f.63e4d8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":610,"y":160,"wires":[]},{"id":"9174eba5.38c318","type":"function","z":"1a282f04.66edf1","name":"","func":"node.warn(\"get subscription by id\")\nnode.warn(msg)\n\nmsg.tekos = msg.payload;\nif(msg.subscription){\n    msg.sub = msg.subscription;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":292,"y":88,"wires":[["dbf8ceed.9061f"]]},{"id":"80325d1.a2c05a","type":"http request","z":"486d1d6e.dd5de4","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":570,"y":120,"wires":[["c1d80c7c.33a6a","663943f9.a02dac"]]},{"id":"f421e8da.b8b238","type":"function","z":"486d1d6e.dd5de4","name":"Get Customers","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nif(env.get('email') || msg.payload.email){\n    var email = msg.payload.email ||  env.get('email');\n   \n    msg.email = email\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return [msg,null];\n}else{\n    msg.payload=\"error setting up get customer by email\";\n    return [null,msg];\n}\n    \n","outputs":2,"noerr":0,"x":344,"y":110,"wires":[["80325d1.a2c05a"],["def790aa.fcea4"]]},{"id":"c1d80c7c.33a6a","type":"switch","z":"486d1d6e.dd5de4","name":"","property":"payload.data[0].id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":120,"wires":[[],[]]},{"id":"dbeab1dc.4ab4b","type":"link out","z":"1a282f04.66edf1","name":"","links":["62313904.cf67c8"],"x":695,"y":40,"wires":[]},{"id":"3bc33444.a7465c","type":"debug","z":"1a282f04.66edf1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":770,"y":80,"wires":[]},{"id":"62313904.cf67c8","type":"link in","z":"1a282f04.66edf1","name":"","links":["dbeab1dc.4ab4b","fac562f3.b2532"],"x":213,"y":220,"wires":[["f661a75f.30ac48"]]},{"id":"f661a75f.30ac48","type":"function","z":"1a282f04.66edf1","name":"Setup form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nif(!msg.roomId){\n    \n    msg.roomId = msg.customer.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nif(msg.payload.subscriptions){\nfor(let i=0;i<msg.payload.subscriptions.data.length;i++){\n    var sub = msg.payload.subscriptions.data[i];\n    if(!sub.metadata.instance){\n        subscriptionToken = msg.payload.subscriptions.data[i].id;\n        token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n        }\n        break;\n    }else{\n        token = {};\n    }\n}\n}\n\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Setup Instance',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/setup/instance/\"+msg.roomId,\n    \"buttontitle\": \"Setup Instance\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Subscription Token</div><div style='color:gray;' >Your subscription token is the unique id that identify you subscrption plan</div>\",\n        \"key\": \"subscription\",\n         \"required\":true,\n        token\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>App name</div><div style='color:gray;'>Your App name will be the subdomain of your instance web app, you can access your flow later with the url 'mycoolapp<b>.tekos.co</b>'</div>\",\n        \"key\": \"hostname\",\n        \"maxLength\": \"20\",\n        \"required\":true,\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Login</div><div style='color:gray;'>Choose your login for your flow instance.</div>\",\n        \"key\": \"login\",\n          \"maxLength\": \"20\",\n          \"required\":true,\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Password</div><div style='color:gray;'>Choose a secure password for your flow instance.</div>\",\n        \"key\": \"password\",\n        \"required\":true,\n      }\n    ]\n}\n\n\n\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":334,"y":220,"wires":[["cff6b2a5.724f4"]],"icon":"node-red/debug.svg"},{"id":"26003965.7bda16","type":"http request","z":"1a282f04.66edf1","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":984,"y":308,"wires":[["f7480a8a.00bb38"]]},{"id":"f1781a42.426068","type":"http in","z":"1a282f04.66edf1","name":"setup instance","url":"/billing/setup/instance/:roomId","method":"post","upload":false,"swaggerDoc":"","x":160,"y":360,"wires":[["dd47992b.6c0488"]]},{"id":"4860233e.e8770c","type":"function","z":"1a282f04.66edf1","name":"Analyse subscription","func":"function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nvar sub = msg.payload;\nreturn msg;\n","outputs":1,"noerr":0,"x":914,"y":352,"wires":[["51618d78.0b8164"]]},{"id":"d2da1ed7.b21c4","type":"function","z":"1a282f04.66edf1","name":"hard coded data","func":"msg.subdomain = msg.instance.hostname;\n//msg.login = msg.instance.username;\n//msg.pwd = msg.instance.password;\nmsg.subscription = msg.instance.subscription;\nif(msg.instance){\n    if(msg.instance.botoken && msg.instance.botid){\n        msg.env.botoken = msg.instance.botoken;\n        msg.env.botid = msg.instance.botid;\n    }\n}\nnode.warn(\"last step before deploy\");\nmsg.instance.stripepayload = msg.payload;\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":366,"y":748,"wires":[["d8fd20ba.c6f1"]]},{"id":"663943f9.a02dac","type":"debug","z":"486d1d6e.dd5de4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":730,"y":60,"wires":[]},{"id":"df9076d7.0752a8","type":"function","z":"1a282f04.66edf1","name":"Update instance ","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.subscription;\nvar dataString = \"metadata[botToken]=\"+msg.bot.access_token+\"&metadata[botId]=\"+msg.bot.user_id+\"&metadata[subdomaine]=\"+msg.subdomain+\"&metadata[targetGroupARN]=\"+msg.targetGroupARN+\"&metadata[instance]=Running&metadata[ServiceArn]=\"+msg.serviceArn.serviceArn;\n\nmsg.payload = dataString;\nnode.warn(\"proceed to update subscription\");\nnode.warn(msg);\n\n\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":620,"wires":[[]]},{"id":"d03a56d3.5643d8","type":"link out","z":"1a282f04.66edf1","name":"","links":["4cb61a86.ebc4a4","3bf4c2e5.91a92e"],"x":917,"y":528,"wires":[]},{"id":"4cb61a86.ebc4a4","type":"link in","z":"1a282f04.66edf1","name":"","links":["d03a56d3.5643d8"],"x":215,"y":620,"wires":[["df9076d7.0752a8"]]},{"id":"c1f4322.1a62fd","type":"debug","z":"ec000337.2949e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":660,"y":340,"wires":[]},{"id":"bfab11fe.4525","type":"debug","z":"8b2c5df2.e16a3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1170,"y":400,"wires":[]},{"id":"f7480a8a.00bb38","type":"debug","z":"1a282f04.66edf1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1106,"y":308,"wires":[]},{"id":"dd47992b.6c0488","type":"function","z":"1a282f04.66edf1","name":"Validator","func":"node.warn(msg)\nfunction validURL(str) {\n  var pattern = new RegExp('^(https?:\\\\/\\\\/)?'+ // protocol\n    '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|'+ // domain name\n    '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))'+ // OR ip (v4) address\n    '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'+ // port and path\n    '(\\\\?[;&a-z\\\\d%_.~+=-]*)?'+ // query string\n    '(\\\\#[-a-z\\\\d_]*)?$','i'); // fragment locator\n  return !!pattern.test(str);\n}\nformat = /[ !@#$%^&*()_+\\=\\[\\]{};':\"\\\\|,.<>\\/?]/;\n\nvar hostname = msg.payload.hostname;\nif(!format.test(hostname) && validURL(\"https://\"+hostname+\".tekos.co\") && !format.test(msg.payload.login)){\n    \n    if(msg.payload.senderId){\n    let sender = msg.payload.senderId.substring(\n    msg.payload.senderId.lastIndexOf(\"@\") + 1, \n    msg.payload.senderId.lastIndexOf(\":\"));\n    sender = sender.replace(\".\", \"_\");\n    if(global.get(sender) && msg.payload.template){\n        if(msg.payload.template.template && msg.payload.template.user && msg.payload.template.repo ){\n            global.set(sender+\".template\",msg.payload.template)\n        }\n    }\n    }\n    \n    msg.roomId = msg.req.params.roomId;\n    msg.senderId = msg.payload.senderId;\n    if(msg.payload.template){\n        msg.template = msg.payload.template;   \n    }else{\n        msg.template = false;\n    }1\n    msg.env = {};\n    msg.env.login = msg.payload.login;\n    msg.env.password = msg.payload.password;\n    node.log(\"true\")\n    return[msg,null,null];\n}else if(format.test(msg.payload.login)){\n    node.warn(\"false login\");\n     return[null,null,msg];\n}else{\n    node.log(\"false\");\n    return[null,msg,null];\n}\nreturn msg;","outputs":3,"noerr":0,"x":340,"y":360,"wires":[["c048fb11.9a5c68","a04bde74.4d774"],["a134ae20.e4fd9"],["d2720996.cc5478"]],"icon":"font-awesome/fa-check-circle"},{"id":"6c30768d.13afb8","type":"http response","z":"1a282f04.66edf1","name":"404","statusCode":"404","headers":{"msg":"A hostname can only contain lower case letters, numbers and '=_-./'"},"x":670,"y":420,"wires":[]},{"id":"a134ae20.e4fd9","type":"template","z":"1a282f04.66edf1","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"A hostname can only contain lower case letters and numbers","output":"str","x":544,"y":418,"wires":[["6c30768d.13afb8"]]},{"id":"6d9bc341.d15ebc","type":"http request","z":"593d5f41.36fc8","name":"Nodered site check","method":"GET","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":410,"y":200,"wires":[["72ced5d5.5e3e3c"]]},{"id":"f53ddc73.3070d","type":"function","z":"593d5f41.36fc8","name":"check params","func":"if(msg.subdomain){\n    node.warn(\"start checking website health 1\");\n    msg.url = \"https://\"+msg.subdomain+\".tekos.co\";\n    return [msg,null];\n}\nelse if(env.get(\"subdomain\")){\n     node.warn(\"start checking website health 2\");\n    msg.url = env.get(\"subdomain\");\n    return [msg,null];\n\n}else{\n     msg.payload = \"one or params are missing\";\n    node.error(msg.payload)\n     return [null,msg];\n}\n","outputs":2,"noerr":0,"x":200,"y":220,"wires":[["6d9bc341.d15ebc"],[]]},{"id":"72ced5d5.5e3e3c","type":"switch","z":"593d5f41.36fc8","name":"","property":"statusCode","propertyType":"msg","rules":[{"t":"eq","v":"200","vt":"str"},{"t":"eq","v":"503","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":570,"y":200,"wires":[[],[],[]]},{"id":"4ce0d196.da56d","type":"function","z":"39b2c1f9.f0db8e","name":"Appliquer 20% Tax","func":"node.warn(\"start tax rate\")\nnode.warn(msg)\nvar subId = msg.subscription.id\nif(msg.payload.data){\n   msg.subscription = msg.payload.data.object \n}\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/subscriptions/\"+subId;\nvar dataString = 'default_tax_rates[]='+msg.defaulttaxrate;\nmsg.payload = dataString;\n\nreturn msg;","outputs":1,"noerr":0,"x":270,"y":300,"wires":[["f26ccd98.9340e"]],"icon":"font-awesome/fa-pie-chart"},{"id":"f26ccd98.9340e","type":"http request","z":"39b2c1f9.f0db8e","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":470,"y":300,"wires":[["db4bcacb.b3c7a8","c8177685.afba68"]]},{"id":"db4bcacb.b3c7a8","type":"switch","z":"39b2c1f9.f0db8e","name":"payment ?","property":"payload.object","propertyType":"msg","rules":[{"t":"eq","v":"subscription","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":300,"wires":[[],[]]},{"id":"469485b.984e07c","type":"chatbot-text","z":"8b2c5df2.e16a3","name":"success ","message":[{"message":"your payment was successful ðŸŽ‰ðŸŽ‰, start setting up your instance. You can follow this guide: http://bit.ly/setup-chat-client"}],"x":700,"y":260,"wires":[[]]},{"id":"fc775646.aeff28","type":"chatbot-text","z":"8b2c5df2.e16a3","name":"failed","message":[{"message":"An error has occurred, please contact support, or try again in a couple of minutes."}],"x":690,"y":300,"wires":[[]]},{"id":"7c95a309.9aec9c","type":"link out","z":"8b2c5df2.e16a3","name":"","links":["48a28d7f.3002f4"],"x":695,"y":220,"wires":[]},{"id":"299fb353.d06d2c","type":"subflow:39b2c1f9.f0db8e","z":"8b2c5df2.e16a3","name":"","env":[{"name":"TaxRateDefault","value":"tax_rate","type":"env"}],"x":450,"y":260,"wires":[["469485b.984e07c","7c95a309.9aec9c"],["fc775646.aeff28"]]},{"id":"3395fece.0bf232","type":"function","z":"39b2c1f9.f0db8e","name":"subscription ?","func":"if(msg.payload.data.object || msg.subscription || env.get('subscription')){\nmsg.subscription = msg.payload.data.object || msg.subscription || env.get('subscription');\nnode.warn(msg);\nnode.warn(\"start get customer\");\nreturn [msg,null];  \n}else{\n    return[null,msg]\n}\n\n","outputs":2,"noerr":0,"x":168,"y":132,"wires":[["fcf999aa.0b05e8","ad4eb206.58677"],["8bf237c3.81cd38","fcf999aa.0b05e8"]]},{"id":"488718a5.d22948","type":"http request","z":"8ba283a9.d5f58","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":570,"y":140,"wires":[["524666d5.4c2e88","3f07363c.5f2bda"]]},{"id":"708e5817.c87968","type":"function","z":"8ba283a9.d5f58","name":"Get Customers","func":"   \nif(env.get(\"id\") || msg.payload.id || msg.subscribtion){\n    \n    msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n    var customer;\n    if(msg.subscription){\n       customer =  msg.subscription.customer\n    }else if(env.get('id')){\n       customer =  env.get('id')\n    }else{\n       customer =  msg.payload.id;\n    }\n    msg.url =\"https://api.stripe.com/v1/customers/\"+customer;\n    return [msg,null];\n}else{\n    msg.payload = \"missing params\";\n    return[null,msg]\n}\n   \n","outputs":2,"noerr":0,"x":380,"y":140,"wires":[["488718a5.d22948","b1518991.a61828"],["cf510288.73f0b"]]},{"id":"524666d5.4c2e88","type":"switch","z":"8ba283a9.d5f58","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":140,"wires":[[],["41b116fe.3dbdb8"]]},{"id":"3f07363c.5f2bda","type":"debug","z":"8ba283a9.d5f58","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":710,"y":200,"wires":[]},{"id":"dbd3336d.48d72","type":"link in","z":"39b2c1f9.f0db8e","name":"","links":["3ee2b369.c72ecc","8bf237c3.81cd38"],"x":755,"y":360,"wires":[[]]},{"id":"4b725f60.00de4","type":"link in","z":"39b2c1f9.f0db8e","name":"","links":["4cb1367b.4b8838","26bdf5e.aca480a","e51a1a3a.1388e8"],"x":115,"y":300,"wires":[["4ce0d196.da56d"]]},{"id":"e5bb8eea.4f99a","type":"http request","z":"39b2c1f9.f0db8e","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/tax_rates","tls":"","persist":false,"proxy":"","authType":"","x":730,"y":88,"wires":[["49078fd0.530ab","1c5f6b59.d464e5"]]},{"id":"49078fd0.530ab","type":"function","z":"39b2c1f9.f0db8e","name":"jurisdiction ?","func":"var customer = msg.customer;\nvar taxrates = msg.payload.data;\nvar defaulttaxrate = env.get(\"TaxRateDefault\")\n  msg.defaulttaxrate = defaulttaxrate\nfor (var i = 0; i < taxrates.length; i++) {\n    if(customer.country == taxrates[i].jurisdiction){\n        defaulttaxrate = taxrates[i].id;\n        msg.defaulttaxrate = defaulttaxrate\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1030,"y":60,"wires":[["26bdf5e.aca480a"]]},{"id":"26bdf5e.aca480a","type":"link out","z":"39b2c1f9.f0db8e","name":"","links":["4b725f60.00de4"],"x":1155,"y":60,"wires":[]},{"id":"370186f9.a4e62a","type":"function","z":"93dbee73.58db9","name":"country ?","func":"node.warn(msg);\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.customer = msg.payload\nif(msg.customer.address){\n    \n    return [msg,null];\n    \n}else{\n    msg.defaulttaxrate=env.get(\"TaxRateDefault\");\n    msg.pourcentage = env.get(\"TaxRateDefaultPourcentage\");\n    return [null,msg];\n}\n    \n","outputs":2,"noerr":0,"x":240,"y":100,"wires":[["a4c40342.a9b57"],["977f3266.2e534"]]},{"id":"929c0f50.59fc9","type":"link in","z":"93dbee73.58db9","name":"","links":["977f3266.2e534","d2658438.91c8d8"],"x":115,"y":240,"wires":[["1e0085a9.c56eea"]]},{"id":"977f3266.2e534","type":"link out","z":"93dbee73.58db9","name":"","links":["929c0f50.59fc9"],"x":355,"y":140,"wires":[]},{"id":"a4c40342.a9b57","type":"http request","z":"93dbee73.58db9","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/tax_rates","tls":"","persist":false,"proxy":"","authType":"","x":410,"y":60,"wires":[["bd01f46.db3ab08"]]},{"id":"bd01f46.db3ab08","type":"function","z":"93dbee73.58db9","name":"jurisdiction ?","func":"var customer = msg.customer;\nvar taxrates = msg.payload.data;\nvar defaultaxrate = env.get(\"TaxRateDefault\")\nvar pourcentage = env.get(\"TaxRateDefaultPourcentage\")\n\n msg.defaultaxrate = defaultaxrate;\n msg.pourcentage =pourcentage;\nfor (var i = 0; i < taxrates.length; i++) {\n    if(customer.address.country == taxrates[i].jurisdiction){\n        defaultaxrate = taxrates[i].id;\n        msg.defaultaxrate = defaultaxrate\n        msg.pourcentage = taxrates[i].percentage;\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":590,"y":60,"wires":[["d2658438.91c8d8"]]},{"id":"d2658438.91c8d8","type":"link out","z":"93dbee73.58db9","name":"","links":["929c0f50.59fc9"],"x":715,"y":60,"wires":[]},{"id":"baf1b3.1d514e5","type":"debug","z":"93dbee73.58db9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":644,"y":198,"wires":[]},{"id":"8a162ab2.085678","type":"comment","z":"b76049a1.e66408","name":"Create Bot","info":"","x":731,"y":330,"wires":[]},{"id":"c8177685.afba68","type":"debug","z":"39b2c1f9.f0db8e","name":"20%taxrate","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":630,"y":360,"wires":[]},{"id":"3199cce7.ffc9f4","type":"http request","z":"c3e6c8de.a6ec88","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":530,"y":220,"wires":[["8bcb30f2.1ac88","c32ebd15.059b6"]]},{"id":"c281cc76.5b93e","type":"function","z":"c3e6c8de.a6ec88","name":"Get Subscription","func":"msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    msg.roomId =msg.req.params.roomId\n    msg.instance = msg.payload\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.payload.subscription\n    return msg;\n","outputs":1,"noerr":0,"x":330,"y":220,"wires":[["3199cce7.ffc9f4"]]},{"id":"8bcb30f2.1ac88","type":"switch","z":"c3e6c8de.a6ec88","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":690,"y":220,"wires":[["bba72e21.e5ffc"],[]]},{"id":"c32ebd15.059b6","type":"debug","z":"c3e6c8de.a6ec88","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":700,"y":300,"wires":[]},{"id":"c048fb11.9a5c68","type":"subflow:c3e6c8de.a6ec88","z":"1a282f04.66edf1","name":"","env":[{"name":"update","value":"false","type":"str"}],"x":602,"y":374,"wires":[["4860233e.e8770c"],[]]},{"id":"7432ceef.34e","type":"function","z":"175e20fb.3d299f","name":"flow plans cards","func":"function compare( a, b ) {\n  if ( a.amount < b.amount ){\n    return -1;\n  }\n  if ( a.amount > b.amount ){\n    return 1;\n  }\n  return 0;\n}\nnode.warn(\"all flows\");\nnode.warn(msg);\nvar allThePlans=[];\nvar plans = msg.payload.data;\nvar roomId= msg.event.event.room_id;\n\nmsg.roomId = roomId;\nlet type = env.get(\"type\");\nfor (let i = 0; i < plans.length; i++) {\nlet plan =plans[i];\nvar postUrl;\nif(plan.trial_period_days){\n     postUrl = \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('callToActionURL')+\"/subscribe/\"+env.get('subscription')+\"/\"+plan.id+\"/\"+plan.trial_period_days;\n\n}else{\n     postUrl = \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('callToActionURL')+\"/subscribe/\"+env.get('subscription')+\"/\"+plan.id+\"/0\";\n\n}\nvar oneplan = {\n    amount:plan.amount,\n    title: \"Tekos \"+type+\" <nobr style='color:#7061E2'>\"+plan.nickname+\"</nobr> plan\",\n    subtitle: \"â‚¬\"+(parseInt(plan.amount)/100) +\" per \"+plan.interval, //\"7 days free! then â‚¬9.00 / month\"\n    imageUrl: env.get('Image'),\n    buttons: \n        [\n            {\n                type: \"request_url_only\",\n                label: env.get('callToAction'), //\"Subscribe\",\n                value: postUrl,\n             \n                alert: false\n            },\n            {\n                type: \"url\",\n                label: env.get('learnMoreLabel'), // \"See more\",\n                url: env.get('learnMoreURL'), \n                alert: false\n            }\n        ]\n};\nif(plan.trial_period_days){\n    oneplan.subtitle = plan.trial_period_days+\" days free! then \"+oneplan.subtitle;\n}\n\nallThePlans.push(oneplan);\n \n}     \n       \nallThePlans.sort(compare);  \nnode.warn(allThePlans);\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":760,"y":180,"wires":[[]]},{"id":"a3795a2e.62f288","type":"function","z":"175e20fb.3d299f","name":"create get product","func":"\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\",\n}\nvar product = env.get(\"product\")\nmsg.url = \"https://api.stripe.com/v1/plans?product=\"+product;\n\nnode.warn(\"get all flows data\");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":220,"wires":[["2e5ffbf2.f9a974"]]},{"id":"2e5ffbf2.f9a974","type":"http request","z":"175e20fb.3d299f","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":390,"y":220,"wires":[["ae12b846.baab48","2eb3e15e.cf11de"]]},{"id":"ae12b846.baab48","type":"debug","z":"175e20fb.3d299f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":570,"y":240,"wires":[]},{"id":"2eb3e15e.cf11de","type":"switch","z":"175e20fb.3d299f","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":570,"y":200,"wires":[["7432ceef.34e"],[]]},{"id":"d08d48a0.881678","type":"chatbot-generic-buttons","z":"1df83760.b275d9","name":"Success","buttons":[{"type":"postback","label":"my chat clients","value":"my chat clients","alert":false}],"message":"Click here to visualize your chat instance","x":1578,"y":22,"wires":[[]]},{"id":"40ccf97e.a39258","type":"chatbot-text","z":"1df83760.b275d9","name":"initialising","message":[{"message":"Your instance is initialising, it should take around 3 minutes ðŸ˜€ "}],"x":200,"y":140,"wires":[["67229c2f.202584","82d2a3af.eab9c"]]},{"id":"7ab2e3d6.6b818c","type":"chatbot-text","z":"1df83760.b275d9","name":"creating","message":[{"message":"i'm creating the subdomain..."}],"x":500,"y":140,"wires":[["a9ac6103.421e3","2e91fec2.d7afe2"]]},{"id":"3f9a0c0c.887cf4","type":"chatbot-text","z":"1df83760.b275d9","name":"customising","message":[{"message":"i'm customising your experience ...your  instance will be up in a couple of minutes !"}],"x":1090,"y":140,"wires":[["20e27073.8aba6","fedb2d73.490c"]]},{"id":"4ffb0c16.578794","type":"chatbot-text","z":"1df83760.b275d9","name":"instance","message":[{"message":"setting the instance..."}],"x":800,"y":140,"wires":[["78f7c76d.79c288","69e9038b.ea288c"]]},{"id":"67229c2f.202584","type":"delay","z":"1df83760.b275d9","name":"","pauseType":"delay","timeout":"20","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":360,"y":140,"wires":[["7ab2e3d6.6b818c"]]},{"id":"a9ac6103.421e3","type":"delay","z":"1df83760.b275d9","name":"","pauseType":"delay","timeout":"30","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":660,"y":140,"wires":[["4ffb0c16.578794"]]},{"id":"78f7c76d.79c288","type":"delay","z":"1df83760.b275d9","name":"","pauseType":"delay","timeout":"50","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":940,"y":140,"wires":[["3f9a0c0c.887cf4"]]},{"id":"41b43922.9e3bb8","type":"function","z":"1949f526.eab9eb","name":"cancel subscription","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    node.warn(\"cancel subscription\")\n    node.warn(msg);\n    let subscription = msg.req.params.id\n    msg.roomId = msg.payload.roomId\n    msg.why = msg.payload.cancelData\n\n    \n    node.warn(subscription);\n\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+subscription\n    msg.payload = \"cancel_at_period_end=true\";\n    \n    return msg;\n","outputs":1,"noerr":0,"x":390,"y":280,"wires":[["2bf03026.3bb58"]]},{"id":"2bf03026.3bb58","type":"http request","z":"1949f526.eab9eb","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":590,"y":280,"wires":[["6790141c.40c04c","8698ae2a.b68ab"]]},{"id":"6790141c.40c04c","type":"switch","z":"1949f526.eab9eb","name":"","property":"payload.cancel_at_period_end","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":750,"y":280,"wires":[["9402ffb1.31f84","6c3e11a.0ded8f"],["78489e9.24b2c6"]]},{"id":"9402ffb1.31f84","type":"chatbot-text","z":"1949f526.eab9eb","name":"subsctription canceled","message":[{"message":"You canceled your subscription."}],"x":960,"y":260,"wires":[[]]},{"id":"78489e9.24b2c6","type":"chatbot-text","z":"1949f526.eab9eb","name":"error","message":[{"message":"No such subscription, your subscription is either canceled or didn't exist in the first place, if you think this is an error please contact support@tekos.co."}],"x":890,"y":300,"wires":[[]]},{"id":"8698ae2a.b68ab","type":"debug","z":"1949f526.eab9eb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":770,"y":340,"wires":[]},{"id":"6a7de3d7.588b8c","type":"function","z":"1949f526.eab9eb","name":"Why cancel form ?","func":"node.warn(msg);\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar subscription = msg.payload.split(' ')[1];\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':' Why do you want to cancel your subscription?',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/cancel/subscription/\"+subscription,\n    \"buttontitle\": \"I want to cancel my subscription\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"send data to support@tekos.co\",\n        \"key\": \"cancelData\"\n      },\n      \n    ]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":60,"wires":[["1d2b7db.6d45d82"]]},{"id":"1d2b7db.6d45d82","type":"http request","z":"1949f526.eab9eb","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":660,"y":60,"wires":[[]]},{"id":"ec5d890f.f97418","type":"http in","z":"1949f526.eab9eb","name":"","url":"/cancel/subscription/:id","method":"post","upload":false,"swaggerDoc":"","x":350,"y":220,"wires":[["41b43922.9e3bb8","4955b1f3.a2e56"]]},{"id":"3d517dd.b0eac82","type":"function","z":"1949f526.eab9eb","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"the customer \"+msg.subscription.customer+\" had canceled his subscription \"+msg.subscription.id,\n    to:\"ayoub@tekos.co,support@tekos.co\"\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":700,"y":440,"wires":[[]]},{"id":"733fb939.fb6098","type":"template","z":"1949f526.eab9eb","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n    <h3>Tekos Flow Subscription Canceled</h3>\n    <p>\n      reason for cancel request : {{{payload.why}}}\n    </p>\n</body>","x":530,"y":440,"wires":[["3d517dd.b0eac82"]]},{"id":"c31c4d68.2a9b8","type":"template","z":"1949f526.eab9eb","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":390,"y":440,"wires":[["733fb939.fb6098"]]},{"id":"4955b1f3.a2e56","type":"http response","z":"1949f526.eab9eb","name":"OK","statusCode":"200","headers":{},"x":550,"y":200,"wires":[]},{"id":"6c3e11a.0ded8f","type":"link out","z":"1949f526.eab9eb","name":"","links":["7b33c669.d02ec8"],"x":855,"y":220,"wires":[]},{"id":"7b33c669.d02ec8","type":"link in","z":"1949f526.eab9eb","name":"","links":["6c3e11a.0ded8f"],"x":335,"y":360,"wires":[["fa846d0e.ee64c"]]},{"id":"fa846d0e.ee64c","type":"function","z":"1949f526.eab9eb","name":"send mail","func":"msg.subscription = msg.payload;\nmsg.payload.why = msg.why\nreturn msg;","outputs":1,"noerr":0,"x":380,"y":400,"wires":[["c31c4d68.2a9b8"]]},{"id":"26ef034f.8ae28c","type":"link out","z":"c3e6c8de.a6ec88","name":"","links":["70f16359.c3d4dc"],"x":1005,"y":154,"wires":[]},{"id":"70f16359.c3d4dc","type":"link in","z":"c3e6c8de.a6ec88","name":"","links":["26ef034f.8ae28c"],"x":135,"y":440,"wires":[["86d2ada2.12fa9"]]},{"id":"86d2ada2.12fa9","type":"function","z":"c3e6c8de.a6ec88","name":"update Subscription metadata","func":"msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.payload.id\n    var dataString = \"metadata[company]=\"+msg.instance.customize+\"&metadata[role]=\"+msg.instance.role+\"&metadata[gole]=\"+msg.instance.gole;\n   msg.payload = dataString;\n    return msg;\n","outputs":1,"noerr":0,"x":310,"y":440,"wires":[["101a97cd.622968"]]},{"id":"101a97cd.622968","type":"http request","z":"c3e6c8de.a6ec88","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":550,"y":440,"wires":[["868ae420.fe9f68","abfef27b.3197"]]},{"id":"868ae420.fe9f68","type":"switch","z":"c3e6c8de.a6ec88","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":440,"wires":[[],[]]},{"id":"abfef27b.3197","type":"debug","z":"c3e6c8de.a6ec88","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":630,"y":580,"wires":[]},{"id":"d204f3ff.0fe17","type":"change","z":"1949f526.eab9eb","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":320,"y":840,"wires":[[]]},{"id":"b1518991.a61828","type":"debug","z":"8ba283a9.d5f58","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":556,"y":88,"wires":[]},{"id":"d2598762.473f88","type":"http request","z":"2e62cdcc.f5cc32","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","persist":false,"proxy":"","authType":"","x":510,"y":66,"wires":[["7f49c16e.98073","2d924cfb.938d34"]]},{"id":"e7f92709.fa3768","type":"function","z":"2e62cdcc.f5cc32","name":"create session","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar customer = msg.payload.stripeId;\n\n var dataString = 'customer_email='+msg.tekos.email+'&setup_intent_data[metadata][customer]='+customer+'&setup_intent_data[metadata][intent]=ucc&setup_intent_data[metadata][roomId]='+msg.roomId+'&mode=setup&payment_method_types[]=card&success_url=https://chat.tekos.co/#/room/'+msg.roomId+'&cancel_url=https://chat.tekos.co/#/room/'+msg.roomId;\n    \nmsg.payload=dataString\n  \nreturn msg;","outputs":1,"noerr":0,"x":302,"y":56,"wires":[["2d924cfb.938d34","d2598762.473f88"]]},{"id":"2fbb2a35.076636","type":"http request","z":"2e62cdcc.f5cc32","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","x":852,"y":44,"wires":[[]]},{"id":"7f49c16e.98073","type":"function","z":"2e62cdcc.f5cc32","name":"show button","func":"\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\":\"Update My Card\",\n    \t\"token_stripe\": env.get(\"STRIPE_PUB_KEY\")\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":664,"y":44,"wires":[["2fbb2a35.076636"]]},{"id":"2d924cfb.938d34","type":"debug","z":"2e62cdcc.f5cc32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":534,"y":176,"wires":[]},{"id":"77f6364a.e32f38","type":"http in","z":"2e62cdcc.f5cc32","name":"intent success","url":"/webhook/stripe/setup_intent","method":"post","upload":false,"swaggerDoc":"","x":268,"y":308,"wires":[["7fadb55f.8f53ec","a7dc6bfb.c89c58","fef7984d.0d5df8"]]},{"id":"a7dc6bfb.c89c58","type":"debug","z":"2e62cdcc.f5cc32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":532,"y":296,"wires":[]},{"id":"7fadb55f.8f53ec","type":"http response","z":"2e62cdcc.f5cc32","name":"success","statusCode":"200","headers":{},"x":542,"y":336,"wires":[]},{"id":"fef7984d.0d5df8","type":"switch","z":"2e62cdcc.f5cc32","name":"","property":"payload.data.object.metadata.intent","propertyType":"msg","rules":[{"t":"eq","v":"ucc","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":232,"y":376,"wires":[["da8494b7.e36dc8"],[]]},{"id":"da8494b7.e36dc8","type":"function","z":"2e62cdcc.f5cc32","name":"get customer","func":"msg.intent = msg.payload;\nvar response = msg.payload.data.object;\nvar customer = response.metadata.customer;\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/payment_methods/\"+response.payment_method+\"/attach\";\n    var dataString =\"customer=\"+customer;\n    msg.payload = dataString;\n    return msg;\n","outputs":1,"noerr":0,"x":392,"y":376,"wires":[["eb3928d6.9403e8"]]},{"id":"5a8262fe.8875ac","type":"switch","z":"2e62cdcc.f5cc32","name":"","property":"payload.card","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":842,"y":396,"wires":[[],[]]},{"id":"eb3928d6.9403e8","type":"http request","z":"2e62cdcc.f5cc32","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":572,"y":376,"wires":[["813fe661.88a968","75bb4ed.11bb0b"]]},{"id":"813fe661.88a968","type":"debug","z":"2e62cdcc.f5cc32","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":712,"y":436,"wires":[]},{"id":"5cac886d.f83b68","type":"http request","z":"d5c46538.c915f8","name":"Get Contact by Email","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":320,"y":120,"wires":[["596a6787.4c1778"]]},{"id":"c6946236.48316","type":"function","z":"d5c46538.c915f8","name":"API","func":"node.warn(\"start hubspot get contact\");\nnode.warn(msg);\nvar email = msg.payload.split(' ')[1]; \nnode.warn(email);\nmsg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+email+\"/profile?hapikey=\"+env.get('hubspot_api_key');\n\nreturn msg;\n","outputs":1,"noerr":0,"x":150,"y":120,"wires":[["5cac886d.f83b68"]]},{"id":"596a6787.4c1778","type":"switch","z":"d5c46538.c915f8","name":"","property":"payload.profile-token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":120,"wires":[["fb98b2c8.d2587"],["96555525.811a58"]]},{"id":"fb98b2c8.d2587","type":"link out","z":"d5c46538.c915f8","name":"","links":["c8e24e36.d6691"],"x":620,"y":100,"wires":[]},{"id":"96555525.811a58","type":"link out","z":"d5c46538.c915f8","name":"","links":["77b6a15d.16807"],"x":620,"y":160,"wires":[]},{"id":"3808528c.de8f8e","type":"link in","z":"d5c46538.c915f8","name":"","links":["ce8541ab.f7116"],"x":535,"y":40,"wires":[[]]},{"id":"e1f9849f.67ae98","type":"switch","z":"d5c46538.c915f8","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"contact does not exist","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":200,"wires":[["284b2d.ce2354d4"],[]]},{"id":"77b6a15d.16807","type":"link in","z":"d5c46538.c915f8","name":"","links":["96555525.811a58"],"x":155,"y":200,"wires":[["e1f9849f.67ae98"]]},{"id":"284b2d.ce2354d4","type":"link out","z":"d5c46538.c915f8","name":"","links":[],"x":395,"y":160,"wires":[]},{"id":"d385c948.62ac18","type":"function","z":"d5c46538.c915f8","name":"display","func":"var data;\nnode.warn(msg.payload);\nif(env.get(\"display_data\")===\"text\"){\n    data = msg.payload;\n}else if(env.get(\"display_data\")===\"card\"){\n    var response = msg.payload;\nvar allThePlans = [];\nvar contact = {\n    title: response.properties.email.value,\n    subtitle:  response.properties.firstname.value +\" \"+response.properties.lastname.value,\n    img:\"https://i0.pngocean.com/files/281/858/545/logo-hubspot-inc-marketing-asg-capital-group-pty-ltd-brand-marketing.jpg\",\n    buttons: \n        [\n            {\n                type: \"url\",\n                label: \"Voir fiche\" ,// \"See more\",\n                url: response[\"profile-url\"],\n                alert: false\n            }\n        ]\n};\n\n    allThePlans.push(contact);\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\ndata = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\n}else{\n    data=msg.payload;\n}\nmsg.payload = data;\nreturn msg;\n","outputs":1,"noerr":0,"x":270,"y":300,"wires":[["ce8541ab.f7116"]]},{"id":"c8e24e36.d6691","type":"link in","z":"d5c46538.c915f8","name":"","links":["fb98b2c8.d2587"],"x":155,"y":300,"wires":[["d385c948.62ac18"]]},{"id":"ce8541ab.f7116","type":"link out","z":"d5c46538.c915f8","name":"","links":["3808528c.de8f8e"],"x":375,"y":300,"wires":[]},{"id":"8facad14.07966","type":"link out","z":"19a4ce64.de4022","name":"","links":["c19d9e85.0ba62"],"x":135,"y":40,"wires":[]},{"id":"117db0a1.977b9f","type":"function","z":"19a4ce64.de4022","name":"authorise","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/authorize/hubspot/1\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":335,"y":180,"wires":[["9286ce19.1cb2b"]]},{"id":"9286ce19.1cb2b","type":"http request","z":"19a4ce64.de4022","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":495,"y":180,"wires":[[]]},{"id":"c19d9e85.0ba62","type":"link in","z":"19a4ce64.de4022","name":"","links":["8facad14.07966"],"x":70,"y":160,"wires":[["8df3ffbe.43193"]]},{"id":"8df3ffbe.43193","type":"switch","z":"19a4ce64.de4022","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":185,"y":160,"wires":[["35b814f4.76ef9c"],["117db0a1.977b9f"]]},{"id":"35b814f4.76ef9c","type":"link out","z":"19a4ce64.de4022","name":"","links":["c566f8f2.71f6e8"],"x":310,"y":140,"wires":[]},{"id":"3c557909.014756","type":"function","z":"19a4ce64.de4022","name":"Contact form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\n\n\n\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.payload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Tell us a little about you ?',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/hs/create/\"+msg.payload.roomId+\"/\"+msg.payload.email,\n    \"buttontitle\": \"Update\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Nom\",\n        \"key\": \"name\",\n      },\n        {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Prenom\",\n        \"key\": \"prename\",\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"NumÃ©ro de telephone\",\n        \"key\": \"phone\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Entreprise\",\n        \"key\": \"company\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Site web\",\n        \"key\": \"website\",\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":325,"y":280,"wires":[["86675b1f.8dfcd8"]]},{"id":"86675b1f.8dfcd8","type":"http request","z":"19a4ce64.de4022","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":475,"y":280,"wires":[["71405a4b.343e24"]]},{"id":"541b63dc.fe1e7c","type":"http response","z":"19a4ce64.de4022","name":"OK","statusCode":"200","headers":{},"x":305,"y":240,"wires":[]},{"id":"61ffe967.a57128","type":"http in","z":"19a4ce64.de4022","name":"Create ?","url":"/hs/create/:roomId/:email","method":"post","upload":false,"swaggerDoc":"","x":115,"y":340,"wires":[["cd3d526c.0d76e","e076ea95.4c56a8"]]},{"id":"992f9d59.fcea7","type":"http request","z":"19a4ce64.de4022","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":465,"y":340,"wires":[["71405a4b.343e24","ece26f27.14534"]]},{"id":"cd3d526c.0d76e","type":"function","z":"19a4ce64.de4022","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nmsg.roomId = msg.req.params.roomId\nvar dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": msg.req.params.email\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": msg.payload.prename\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": msg.payload.name\n    },\n    {\n      \"property\": \"website\",\n      \"value\": msg.payload.website\n    },\n    {\n      \"property\": \"company\",\n      \"value\": msg.payload.company\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": msg.payload.phone\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":265,"y":340,"wires":[["992f9d59.fcea7"]]},{"id":"71405a4b.343e24","type":"debug","z":"19a4ce64.de4022","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":310,"y":420,"wires":[]},{"id":"c566f8f2.71f6e8","type":"link in","z":"19a4ce64.de4022","name":"","links":["35b814f4.76ef9c","d95eb0d9.da049"],"x":215,"y":280,"wires":[["3c557909.014756"]]},{"id":"f917909a.69b87","type":"switch","z":"19a4ce64.de4022","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":520,"wires":[["d95eb0d9.da049"],["35f4f9ed.b85fb6"]]},{"id":"af5a5926.a70438","type":"http in","z":"19a4ce64.de4022","name":"","url":"/authorize/hubspot/1","method":"post","upload":false,"swaggerDoc":"","x":210,"y":520,"wires":[["1add029a.06e34d","f917909a.69b87","9f1420e7.dd2af"]]},{"id":"1add029a.06e34d","type":"http response","z":"19a4ce64.de4022","name":"success","statusCode":"200","headers":{},"x":420,"y":480,"wires":[]},{"id":"d95eb0d9.da049","type":"link out","z":"19a4ce64.de4022","name":"link customer","links":["c566f8f2.71f6e8"],"x":515,"y":500,"wires":[]},{"id":"35f4f9ed.b85fb6","type":"link out","z":"19a4ce64.de4022","name":"error msg","links":[],"x":535,"y":540,"wires":[]},{"id":"9f1420e7.dd2af","type":"debug","z":"19a4ce64.de4022","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":430,"y":560,"wires":[]},{"id":"e076ea95.4c56a8","type":"http response","z":"19a4ce64.de4022","name":"success","statusCode":"200","headers":{},"x":120,"y":380,"wires":[]},{"id":"ece26f27.14534","type":"switch","z":"19a4ce64.de4022","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"Contact already exists","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":300,"wires":[[],["7f5b02e8.1fa73c"]]},{"id":"7f5b02e8.1fa73c","type":"switch","z":"19a4ce64.de4022","name":"","property":"payload.vid","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":320,"wires":[[],[]]},{"id":"3b0ddf52.2ee8c","type":"function","z":"4e3752b2.a4cf3c","name":"ERPNext","func":"msg.url = env.get('ERP_BASE_URL')+ '/api/method/login?usr='+env.get('LOGIN') + '&pwd='+env.get('PASSWORD');\nreturn msg;","outputs":1,"noerr":0,"x":520,"y":120,"wires":[["2a905ade.62ba36"]]},{"id":"2a905ade.62ba36","type":"http request","z":"4e3752b2.a4cf3c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":700,"y":120,"wires":[["6fd8a2f.b91135c"]]},{"id":"6fd8a2f.b91135c","type":"switch","z":"4e3752b2.a4cf3c","name":"","property":"payload.home_page","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":870,"y":120,"wires":[[],[]]},{"id":"7ae164ad.9e636c","type":"function","z":"5b3f8201.182d5c","name":"ERPNext","func":"msg.url = env.get('ERP_BASE_URL')+'/api/resource/Lead';\nmsg.payload = JSON.parse(msg.payload);\nmsg.headers ={\n    \"Content-type\": \"application/json\",\n    \"Accept\": \"application/json\",\n    'Authorization': \"Basic NWVlNWRkZTNiNGFjYTA1OmE5Mzg2ODczZmQ3NmJhZA==\"\n}\nnode.warn(msg.headers);\nnode.warn(msg.payload);\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":160,"wires":[["99c5bdcc.1914f"]]},{"id":"99c5bdcc.1914f","type":"http request","z":"5b3f8201.182d5c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":540,"y":160,"wires":[["9fd224fa.4d4628"]]},{"id":"9fd224fa.4d4628","type":"switch","z":"5b3f8201.182d5c","name":"","property":"payload.data","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":160,"wires":[[],[]]},{"id":"339ef86b.df25e8","type":"template","z":"5b3f8201.182d5c","name":"","field":"payload","fieldType":"msg","format":"json","syntax":"mustache","template":"{\"lead_name\":\"test\"}","output":"str","x":220,"y":160,"wires":[["7ae164ad.9e636c"]]},{"id":"527f55fd.153f2c","type":"function","z":"855c2bc0.26c788","name":"set pending","func":"msg.payload = msg.payload;\nvar roomID = msg.roomId;\nvar roomXD = roomID.substr(0, roomID.indexOf(':')); // \nvar data,pending;\nif(!roomID || !env.get(\"step\") || env.get(\"step\") === \"pendingstep\"){\n    node.error(\"parameter in set pending step missing\")\n    return [null,null,msg] // 3\n}else if(!env.get('value') ){\n         pending = env.get(\"step\")\n\n    node.warn(\"no value so pendingstep\")\nif(global.get(roomXD)){\n     data = global.get(roomXD);\n    data[\"pendingstep\"] = pending;\n    global.set(roomXD,data);\n     node.warn(\"set  pendingstep 1\")\n}else{\n    global.set(roomXD,{\"pendingstep\":pending});\n         node.warn(\"set  pendingstep 2\")\n\n\n}\nreturn [msg,null,null] // 1\n}else{\n         pending = env.get(\"step\")\n\n        node.warn(\"yes value so STEP\")\n       data = global.get(roomXD);\n       data[pending] = env.get('value');\n   \n        global.set(roomXD,data);\n      return [null,msg,null] // 2\n\n\n}\n\n\n","outputs":3,"noerr":0,"x":310,"y":100,"wires":[[],[],[]]},{"id":"7b901635.678668","type":"link out","z":"630c701f.59cde","name":"","links":["d99fea9.7fa0418"],"x":815,"y":860,"wires":[]},{"id":"e2dd8996.82dfd8","type":"link in","z":"630c701f.59cde","name":"","links":["b556baee.ab36e8"],"x":135,"y":800,"wires":[[]]},{"id":"fd79b8c8.6b5e28","type":"function","z":"630c701f.59cde","name":"get Subscription","func":"\nmsg.tekos = msg.payload;\nif(msg.subscription){\n    msg.sub = msg.subscription;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":140,"wires":[["280103b.45dcffc"]]},{"id":"280103b.45dcffc","type":"subflow:486d1d6e.dd5de4","z":"630c701f.59cde","name":"","env":[],"x":520,"y":140,"wires":[["8d393ef.4bb62c","82b76112.47187"],["b556baee.ab36e8"]]},{"id":"8d393ef.4bb62c","type":"link out","z":"630c701f.59cde","name":"","links":["47ae039c.4dbadc"],"x":715,"y":80,"wires":[]},{"id":"82b76112.47187","type":"debug","z":"630c701f.59cde","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":790,"y":120,"wires":[]},{"id":"47ae039c.4dbadc","type":"link in","z":"630c701f.59cde","name":"","links":["8d393ef.4bb62c"],"x":195,"y":260,"wires":[["ddb01631.747c28"]]},{"id":"ddb01631.747c28","type":"function","z":"630c701f.59cde","name":"Setup form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\nif(!msg.roomId){\n    msg.roomId = msg.payload.data[0].subscriptions.data[0].metadata.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nif(msg.sub){\n    subscriptionToken = msg.sub.id;\n    token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}else if(msg.customer){\n    subscriptionToken =  msg.customer.subscriptions.data[0].id\n     token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get(\"titleform\"),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/setup/client/\"+msg.roomId,\n    \"buttontitle\": env.get(\"buttontitle\"),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Subscription Token</div><div style='color:gray;' >Your subscription token is the unique id that identify you subscrption plan</div>\",\n        \"key\": \"subscription\",\n        \"required\":true,\n        token\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Host name</div><div style='color:gray;'>Your host name will be the subdomain of your instance client app, you can access your chat client later with the url 'mycoolapp<b>.tekos.co</b>'</div>\",\n        \"key\": \"hostname\",\n          \"maxLength\": \"20\",\n          \"required\":true,\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>App Name</div><div  style='color:gray;'>Your App name is Name of your chat client, it will figure in the browser tab</div>\",\n        \"key\": \"appname\",\n        \"required\":true,\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Logo Image Url</div><div  style='color:gray;'>Choose a logo image for your chat client. Dont worry you can change your logo later, please make sure that the url is https friendly</div>\",\n        \"key\": \"applogo\",\n        \"required\":true,\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Icon Url</div><div  style='color:gray;'>Choose an Icon image for your chat client. Dont worry you can change your logo later, please make sure that the url is https friendly</div>\",\n        \"key\": \"appicon\",\n        \"required\":true,\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Background Image Url</div><div  style='color:gray;'>Choose a Background image for your chat client. Dont worry you can change your logo later, please make sure that the url is https friendly</div>\",\n        \"key\": \"appbackground\",\n        \"required\":true,\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":350,"y":260,"wires":[["c8e45ca6.2b24"]],"icon":"node-red/debug.svg"},{"id":"c8e45ca6.2b24","type":"http request","z":"630c701f.59cde","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":520,"y":260,"wires":[["19db66d7.acc589"]]},{"id":"46391aa7.947c34","type":"http in","z":"630c701f.59cde","name":"setup instance","url":"/billing/setup/client/:roomId","method":"post","upload":false,"swaggerDoc":"","x":100,"y":380,"wires":[["c587eb62.2b9e08"]]},{"id":"502363be.aca21c","type":"http response","z":"630c701f.59cde","name":"200","statusCode":"200","headers":{},"x":450,"y":320,"wires":[]},{"id":"5be7e69c.9f4148","type":"function","z":"630c701f.59cde","name":"Analyse subscription","func":"function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nvar sub = msg.payload;\n\nif(isEmpty(sub.metadata.instance)){\n    node.warn(\"instance is empty\")\n    return [msg,null];\n}else{\n      node.warn(\"instance exist\")\n      return [null,msg]\n}\n\n","outputs":2,"noerr":0,"x":782,"y":352,"wires":[["70f3bef6.fd888"],["42ae5385.3f3aac"]]},{"id":"70f3bef6.fd888","type":"link out","z":"630c701f.59cde","name":"","links":["16c3ae7c.990352"],"x":955,"y":340,"wires":[]},{"id":"16c3ae7c.990352","type":"link in","z":"630c701f.59cde","name":"","links":["70f3bef6.fd888"],"x":260,"y":540,"wires":[["97d1efe4.2bc6f"]]},{"id":"97d1efe4.2bc6f","type":"function","z":"630c701f.59cde","name":"hard coded data","func":"msg.subdomain = msg.instance.hostname;\nmsg.login = msg.instance.username;\nmsg.pwd = msg.instance.password;\nmsg.subscription = msg.instance.subscription;\nmsg.instance = msg.instance;\nnode.warn(\"start creating client \");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":400,"y":540,"wires":[["1c0af8a2.b70677"]]},{"id":"8fb45e1d.bd09f","type":"function","z":"630c701f.59cde","name":"Update instance ","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.roomId = msg.payload.roomId\nmsg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.client.subscription;\nvar dataString = \"metadata[subdomaine]=\"+msg.subdomain+\"&metadata[RuleArn]=\"+msg.ruleArn.RuleArn+\"&metadata[targetGroupARN]=\"+msg.targetGroupARN+\"&metadata[instance]=Running&metadata[instance_id]=\"+msg.serviceArn.serviceArn;\n\nmsg.payload = dataString\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":620,"wires":[["54cc5e99.fefa8"]]},{"id":"54cc5e99.fefa8","type":"http request","z":"630c701f.59cde","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":470,"y":620,"wires":[["6ca425ef.f89ebc","6c13cd52.fe4e34"]]},{"id":"28a291e8.8d56fe","type":"link out","z":"630c701f.59cde","name":"","links":["6b29ec2f.2310e4"],"x":835,"y":540,"wires":[]},{"id":"6b29ec2f.2310e4","type":"link in","z":"630c701f.59cde","name":"","links":["28a291e8.8d56fe"],"x":135,"y":620,"wires":[["8fb45e1d.bd09f"]]},{"id":"927185a4.6341d8","type":"link out","z":"630c701f.59cde","name":"","links":["f075a012.6af48"],"x":815,"y":620,"wires":[]},{"id":"f075a012.6af48","type":"link in","z":"630c701f.59cde","name":"","links":["927185a4.6341d8"],"x":275,"y":700,"wires":[["82cdafc2.10a8e"]]},{"id":"82cdafc2.10a8e","type":"switch","z":"630c701f.59cde","name":"","property":"payload.object","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":400,"y":700,"wires":[["1bff5a94.d46685"],["35c5e6d9.f3c0da"]]},{"id":"19db66d7.acc589","type":"debug","z":"630c701f.59cde","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":260,"wires":[]},{"id":"6ca425ef.f89ebc","type":"function","z":"630c701f.59cde","name":"Fetch roomId ","func":"node.warn(\"finishing up clien\");\nnode.warn(msg);\nif(!msg.roomId){\n    msg.roomId = msg.payload.metadata.roomId;\n    msg.payload.roomId = msg.roomId;\n}\nreturn msg;","outputs":1,"noerr":0,"x":670,"y":620,"wires":[["927185a4.6341d8"]]},{"id":"c587eb62.2b9e08","type":"function","z":"630c701f.59cde","name":"Validator","func":"function validURL(str) {\n  var pattern = new RegExp('^(https?:\\\\/\\\\/)?'+ // protocol\n    '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|'+ // domain name\n    '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))'+ // OR ip (v4) address\n    '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'+ // port and path\n    '(\\\\?[;&a-z\\\\d%_.~+=-]*)?'+ // query string\n    '(\\\\#[-a-z\\\\d_]*)?$','i'); // fragment locator\n  return !!pattern.test(str);\n}\nnode.warn(msg)\nvar reponse = msg.payload\n\nformat = /[ !@#$%^&*()_+\\=\\[\\]{};':\"\\\\|,.<>\\/?]/;\n\nvar hostname = reponse.hostname;\nif(format.test(hostname) && !validURL(\"https://\"+hostname+\".tekos.co\")){\n    node.warn(\"false host\");\n   msg.payload.error = \"A hostname can only contain lower case letters, numbers and '=_-./'\"\n    \n    return[null,msg] ;\n}else if(!validURL(reponse.applogo) || !validURL(reponse.appicon) || !validURL(reponse.appbackground)){\n     node.warn(\"false media\");\n    msg.payload.error = \"Media files can only be url types\";\n    return[null,msg] ;\n}else if(reponse.applogo.indexOf(\"http://\") === 0 || reponse.appicon.indexOf(\"http://\") === 0 || reponse.appbackground.indexOf(\"http://\") === 0 ){\n      node.warn(\"false media url protocol\");\n    msg.payload.error = \"Media files must start with https protocol\";\n    return[null,msg] ;\n}\nelse{\n   node.log(\"true\")\n    msg.client = msg.payload;\n    msg.roomId = msg.req.params.roomId;\n    return[msg,null]\n}\nreturn msg;","outputs":2,"noerr":0,"x":260,"y":380,"wires":[["502363be.aca21c","cfff63a2.8155c"],["96202cf4.7fd25"]],"icon":"font-awesome/fa-check-circle"},{"id":"96202cf4.7fd25","type":"http response","z":"630c701f.59cde","name":"404","statusCode":"404","headers":{},"x":430,"y":440,"wires":[]},{"id":"cfff63a2.8155c","type":"subflow:c3e6c8de.a6ec88","z":"630c701f.59cde","name":"","env":[{"name":"update","value":"false","type":"str"}],"x":520,"y":380,"wires":[["5be7e69c.9f4148"],["fa9586e1.00b068"]]},{"id":"d99fea9.7fa0418","type":"link in","z":"630c701f.59cde","name":"","links":["7b901635.678668"],"x":155,"y":140,"wires":[["fd79b8c8.6b5e28"]]},{"id":"b556baee.ab36e8","type":"link out","z":"630c701f.59cde","name":"","links":["e2dd8996.82dfd8"],"x":700,"y":160,"wires":[]},{"id":"6da157ab.6efde8","type":"link in","z":"630c701f.59cde","name":"","links":["fa9586e1.00b068"],"x":135,"y":860,"wires":[[]]},{"id":"becaba7.2a68548","type":"link in","z":"630c701f.59cde","name":"","links":["42ae5385.3f3aac"],"x":335,"y":800,"wires":[[]]},{"id":"c4fe3545.a2f698","type":"link in","z":"630c701f.59cde","name":"","links":["9047f587.6c3cb8"],"x":335,"y":860,"wires":[[]]},{"id":"234479d9.89bc86","type":"link in","z":"630c701f.59cde","name":"","links":["10a912f5.e6009d"],"x":535,"y":800,"wires":[[]]},{"id":"a9ac189c.82a388","type":"link in","z":"630c701f.59cde","name":"","links":["35c5e6d9.f3c0da"],"x":535,"y":860,"wires":[[]]},{"id":"fa9586e1.00b068","type":"link out","z":"630c701f.59cde","name":"","links":["6da157ab.6efde8"],"x":715,"y":400,"wires":[]},{"id":"9047f587.6c3cb8","type":"link out","z":"630c701f.59cde","name":"","links":["c4fe3545.a2f698"],"x":835,"y":500,"wires":[]},{"id":"10a912f5.e6009d","type":"link out","z":"630c701f.59cde","name":"","links":["234479d9.89bc86"],"x":835,"y":580,"wires":[]},{"id":"42ae5385.3f3aac","type":"link out","z":"630c701f.59cde","name":"","links":["becaba7.2a68548"],"x":955,"y":380,"wires":[]},{"id":"1bff5a94.d46685","type":"link out","z":"630c701f.59cde","name":"","links":["7926b0ae.bf113"],"x":515,"y":680,"wires":[]},{"id":"35c5e6d9.f3c0da","type":"link out","z":"630c701f.59cde","name":"","links":["a9ac189c.82a388"],"x":515,"y":720,"wires":[]},{"id":"7926b0ae.bf113","type":"link in","z":"630c701f.59cde","name":"","links":["1bff5a94.d46685"],"x":735,"y":800,"wires":[[]]},{"id":"1c0af8a2.b70677","type":"subflow:d97495d8.5a8468","z":"630c701f.59cde","name":"","env":[],"x":660,"y":540,"wires":[["9047f587.6c3cb8"],["28a291e8.8d56fe"],["10a912f5.e6009d"]]},{"id":"dc3ad172.511d","type":"link in","z":"d97495d8.5a8468","name":"","links":["8d0e8a8d.f308d8","54edee0d.6b158","799bb4a8.80d44c","adfeb5fe.020af8","f4302bde.259cf8"],"x":95,"y":580,"wires":[[]]},{"id":"191c4fb3.3ef04","type":"link out","z":"d97495d8.5a8468","name":"","links":["76ef21ca.3eade"],"x":395,"y":100,"wires":[]},{"id":"6c13cd52.fe4e34","type":"debug","z":"630c701f.59cde","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":680,"y":680,"wires":[]},{"id":"a7dd29a5.fd4688","type":"switch","z":"d97495d8.5a8468","name":"","property":"payload.service.serviceArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1084,"y":308,"wires":[["93a235e4.537da8"],["8d0e8a8d.f308d8"]]},{"id":"8d0e8a8d.f308d8","type":"link out","z":"d97495d8.5a8468","name":"","links":["dc3ad172.511d"],"x":1181,"y":330,"wires":[]},{"id":"d23a25f2.00ecf8","type":"function","z":"ab0e04bf.0c2678","name":"get Subscription","func":"\nmsg.tekos = msg.payload;\nvar subscription = msg.req.params.id;\nmsg.roomId = msg.payload.roomId;\nvar type = msg.req.params.type;\nif(subscription ){\n    msg.sub = msg.subscription;\n    msg.payload.subscription = subscription;\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":200,"wires":[["7ed69d2a.b42fe4"]]},{"id":"291668ed.1cba08","type":"link out","z":"ab0e04bf.0c2678","name":"","links":["e7e6e399.c219f"],"x":851,"y":154,"wires":[]},{"id":"dab32643.637a58","type":"debug","z":"ab0e04bf.0c2678","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":510,"y":140,"wires":[]},{"id":"25b43fac.fc5d8","type":"link out","z":"ab0e04bf.0c2678","name":"","links":[],"x":719,"y":242,"wires":[]},{"id":"9da9a6c5.bfd798","type":"link in","z":"ab0e04bf.0c2678","name":"","links":["f8a88dab.499e3"],"x":140,"y":200,"wires":[["d23a25f2.00ecf8"]]},{"id":"492029e3.32b918","type":"link in","z":"ab0e04bf.0c2678","name":"","links":["71b38d92.7e98b4"],"x":75,"y":280,"wires":[[]]},{"id":"c0f4d029.3975e","type":"function","z":"ab0e04bf.0c2678","name":"update form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\nvar appname,logo,background,icon;\nvar tdArray = msg.payload.taskDefinition.containerDefinitions[0].environment;\nfor(let i = 0; i< tdArray.length; i++){\n    if(tdArray[i].name == \"BRANDING_BACKGROUND\"){\n        background = tdArray[i].value;\n    }\n    if(tdArray[i].name == \"BRANDING_APP_NAME\"){\n        appname =  tdArray[i].value;\n    }\n    if(tdArray[i].name == \"BRANDING_ICO_FILE\"){\n        icon =  tdArray[i].value;\n    }\n    if(tdArray[i].name == \"BRANDING_LOGO\"){\n        logo  =  tdArray[i].value;\n    }\n}\n\n\n\nif(!msg.roomId){\n    msg.roomId = msg.sub.metadata.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nvar subtoken;\nif(msg.sub){\n    subscriptionToken = msg.sub.id;\n    token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n    subtoken = {\"defaultValue\":msg.sub.metadata.subdomaine,\n         \"disabled\":true};\n \n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get(\"titleform\"),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/instance/update/chat/client/\"+msg.roomId+\"/\"+msg.payload.taskDefinition.family,\n    \"buttontitle\": env.get(\"buttontitle\"),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Subscription Token\",\n        \"key\": \"subscription\",\n        \"token\":token\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Host name\",\n        \"key\": \"hostname\",\n        \"token\":subtoken\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"App Name\",\n        \"key\": \"appname\",\n        \"defaultValue\":appname\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Logo Image\",\n        \"key\": \"applogo\",\n        \"defaultValue\":logo\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Icon Image\",\n        \"key\": \"appicon\",\n        \"defaultValue\":icon\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Background Image\",\n        \"key\": \"appbackground\",\n         \"defaultValue\":background\n      }\n    ]\n}\nif(msg.sub.metadata.hostname){\n    msg.payload.tekosform[1]\n}\nreturn msg;\n\n","outputs":1,"noerr":0,"x":576,"y":242,"wires":[["e29efad6.b1f088"]],"icon":"node-red/debug.svg"},{"id":"e29efad6.b1f088","type":"http request","z":"ab0e04bf.0c2678","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":830,"y":264,"wires":[[]]},{"id":"43f56ac3.faacf4","type":"http in","z":"ab0e04bf.0c2678","name":"update client","url":"/instance/update/client/:type/:roomId/:app","method":"post","upload":false,"swaggerDoc":"","x":114,"y":418,"wires":[["f015c53d.0f0418"]]},{"id":"38a81734.4f06e8","type":"http response","z":"ab0e04bf.0c2678","name":"200","statusCode":"200","headers":{},"x":550,"y":360,"wires":[]},{"id":"7ff5d009.d12ae","type":"function","z":"ab0e04bf.0c2678","name":"Validator","func":"function validURL(str) {\n  var pattern = new RegExp('^(https?:\\\\/\\\\/)?'+ // protocol\n    '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|'+ // domain name\n    '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))'+ // OR ip (v4) address\n    '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'+ // port and path\n    '(\\\\?[;&a-z\\\\d%_.~+=-]*)?'+ // query string\n    '(\\\\#[-a-z\\\\d_]*)?$','i'); // fragment locator\n  return !!pattern.test(str);\n}\nnode.warn(msg)\nvar reponse = msg.payload\nvar format = /[ !@#$%^&*()_+\\-=\\[\\]{};':\"\\\\|,.<>\\/?]/;\nif(!validURL(reponse.applogo) || !validURL(reponse.appicon) || !validURL(reponse.appbackground)){\n     node.warn(\"false media\");\n    msg.payload.error = \"Media files can only be url types\";\n    return[null,msg] ;\n}else if(reponse.applogo.indexOf(\"http://\") === 0 || reponse.appicon.indexOf(\"http://\") === 0 || reponse.appbackground.indexOf(\"http://\") === 0 ){\n      node.warn(\"false media url protocol\");\n    msg.payload.error = \"Media files must start with https protocol\";\n    return[null,msg] ;\n}\nelse{\n   node.log(\"true\")\n    msg.client = msg.payload;\n    msg.client.roomId = msg.req.params.roomId;\n    return[msg,null]\n}\nreturn msg;","outputs":2,"noerr":0,"x":368,"y":418,"wires":[["38a81734.4f06e8"],["943abba7.3a8398"]],"icon":"font-awesome/fa-check-circle"},{"id":"943abba7.3a8398","type":"http response","z":"ab0e04bf.0c2678","name":"404","statusCode":"404","headers":{},"x":530,"y":480,"wires":[]},{"id":"7ed69d2a.b42fe4","type":"subflow:c3e6c8de.a6ec88","z":"ab0e04bf.0c2678","name":"","env":[{"name":"update","value":"false","type":"str"}],"x":520,"y":200,"wires":[["5a807be7.68d624"],["25b43fac.fc5d8"]]},{"id":"53df2573.130dfc","type":"http in","z":"ab0e04bf.0c2678","name":"","url":"/update/plan/:type/:id/:roomId","method":"post","upload":true,"swaggerDoc":"","x":260,"y":120,"wires":[["dab32643.637a58","f8a88dab.499e3","c6a41f0b.90963"]]},{"id":"f8a88dab.499e3","type":"link out","z":"ab0e04bf.0c2678","name":"","links":["9da9a6c5.bfd798"],"x":455,"y":100,"wires":[]},{"id":"bba72e21.e5ffc","type":"switch","z":"c3e6c8de.a6ec88","name":"","property":"update","propertyType":"env","rules":[{"t":"eq","v":"true","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":842,"y":176,"wires":[["26ef034f.8ae28c"],["d52aeb54.841368"]]},{"id":"c6a41f0b.90963","type":"http response","z":"ab0e04bf.0c2678","name":"200","statusCode":"200","headers":{},"x":468,"y":44,"wires":[]},{"id":"31366499.399f9c","type":"link out","z":"52c3ea26.423dc4","name":"","links":["6541c936.61a8e8","bb3ccebb.f89e4"],"x":1035,"y":240,"wires":[]},{"id":"4e302f73.f62e1","type":"link out","z":"52c3ea26.423dc4","name":"","links":["6541c936.61a8e8"],"x":675,"y":480,"wires":[]},{"id":"d52aeb54.841368","type":"link out","z":"c3e6c8de.a6ec88","name":"","links":["6cec33c.a1c67cc"],"x":915,"y":220,"wires":[]},{"id":"6cec33c.a1c67cc","type":"link in","z":"c3e6c8de.a6ec88","name":"","links":["d52aeb54.841368"],"x":755,"y":520,"wires":[[]]},{"id":"67882b69.714db4","type":"http request","z":"85c6ed92.daf94","name":"send message","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":444.1667022705078,"y":150.0000114440918,"wires":[["6c1b08b7.06ea98"]]},{"id":"b4f347ab.b64b38","type":"function","z":"85c6ed92.daf94","name":"","func":"msg.url= env.get('url')+'/conversations/default/messages'\nmsg.payload ={\n    text: env.get('text'),\n    sender: env.get('user')\n}\nreturn msg;","outputs":1,"noerr":0,"x":264.1667022705078,"y":150.0000114440918,"wires":[["67882b69.714db4"]]},{"id":"baee8cd3.70247","type":"comment","z":"85c6ed92.daf94","name":"send message , get intent , next action","info":"url/talk\n\nDocumentation\nhttps://rasa.com/docs/rasa/api/http-api/#tag/Tracker/paths/~1conversations~1{conversation_id}~1execute/post","x":254.1667022705078,"y":70.0000114440918,"wires":[]},{"id":"8dcc1d08.15d69","type":"http request","z":"85c6ed92.daf94","name":"predict next action","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":844.1667022705078,"y":150.0000114440918,"wires":[[]]},{"id":"6c1b08b7.06ea98","type":"function","z":"85c6ed92.daf94","name":"","func":"msg.url= env.get('url')+'/conversations/default/predict'\nmsg.payload ={\n    text: env.get('text'),\n    sender: env.get('user')\n}\nreturn msg;","outputs":1,"noerr":0,"x":644.1667022705078,"y":150.0000114440918,"wires":[["8dcc1d08.15d69"]]},{"id":"21234782.c72238","type":"function","z":"941b9034.09257","name":"upload image","func":"global.set(\"msg1\", msg)\nlet roomId= msg.roomId.replace(/\\./g,'_')\nvar resultat= global.set(\"resultat\"+roomId, null)\nmsg.url = env.get('base_url')+'/_matrix/client/r0/rooms/'+msg.roomId+'/send/m.room.message?access_token='+env.get('TEKOS_BOT_TOKEN')\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintcloud\":{\n    \t\"cloudname\": env.get('cloudinary_cloud_name'),\n    \t\"uploadpreset\": env.get('cloudinary_upload_preset'),  //https://cloudinary.com/console/settings/upload\n    \t\"posturl\": env.get('flow_url')+env.get('post_url'),\n    \t\"buttontext\": env.get('button_text'),\n\t}\n}\n  \nreturn msg;","outputs":1,"noerr":0,"x":280,"y":180,"wires":[["901dc9ba.bb2268"]]},{"id":"901dc9ba.bb2268","type":"http request","z":"941b9034.09257","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","x":453.00000762939453,"y":180.00011897087097,"wires":[[]]},{"id":"1f8b4d5e.4bac63","type":"inject","z":"8059b36b.b7ac1","name":"","topic":"","payload":"Started!","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"","x":200,"y":80,"wires":[[]]},{"id":"59f3dbad.703d24","type":"function","z":"11b3cac3.191255","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n    \"body\": \"something-important.doc\",\n    \"filename\": \"something-important.doc\",\n    \"info\": {\n        \"mimetype\": \"application/msword\",\n        \"size\": 46144\n    },\n    \"msgtype\": \"m.file\",\n    \"url\": \"mxc://domain.com/FHyPlCeYUSFFxlgbQYZmoEoe\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["ccf2bb15.472ad8"]]},{"id":"ccf2bb15.472ad8","type":"http request","z":"11b3cac3.191255","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"4b6669bd.8320f8","type":"function","z":"9046be0b.a30f1","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/media/r0/upload?access_token='+env.get('TOKEN')+'&filename='+ env.get('FILE_URL')\n\nmsg.headers ={\n    \"Content-type\": +env.get('content-type')\n}\nmsg.payload={\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["319f8d6c.e498a2"]]},{"id":"319f8d6c.e498a2","type":"http request","z":"9046be0b.a30f1","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"a3929fb3.32f98","type":"function","z":"509dfe6d.39977","name":"sen file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n        \"body\": \"Test\",\n        \"info\": {\n            \"duration\": 2140786,\n            \"h\": 320,\n            \"mimetype\": \"video/mp4\",\n            \"size\": 1563685,\n        },\n        \"msgtype\": \"m.video\",\n        \"url\": \"mxc://m.tekos.co/aorJJwIuRbxgcanVFhQKemhR\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":230,"y":200,"wires":[["87b5ee2b.e9b5c"]]},{"id":"87b5ee2b.e9b5c","type":"http request","z":"509dfe6d.39977","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":440,"y":200,"wires":[[]]},{"id":"88ba0759.b20fd8","type":"function","z":"78fafaed.cd65d4","name":"send message","func":"msg.url = +env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n        \"body\": env.get('message'), //\"This is an example text message\",\n        \"msgtype\": \"m.text\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":260,"wires":[["7780caf1.a6c774"]]},{"id":"7780caf1.a6c774","type":"http request","z":"78fafaed.cd65d4","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":520,"y":260,"wires":[[]]},{"id":"3df7a186.5c2fae","type":"function","z":"4f80bedc.87cfc","name":"send message","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TEKOS_BOT_TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n        \"body\": \"Hello\",\n        \"format\": \"org.matrix.custom.html\",\n        \"formatted_body\": +env.get('message'), \n        \"msgtype\": \"m.emote\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["bc109ded.1396b"]]},{"id":"bc109ded.1396b","type":"http request","z":"4f80bedc.87cfc","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"b8e88272.6715","type":"function","z":"afeae1e.cea212","name":"notice","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n       // \"body\": \"This is an example notice\",\n        \"format\": \"org.matrix.custom.html\",\n        \"formatted_body\": \"This is an <strong>example</strong> notice\",\n        \"msgtype\": \"m.notice\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":226,"y":66,"wires":[["ec8893d0.f493a"]]},{"id":"ec8893d0.f493a","type":"http request","z":"afeae1e.cea212","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":378,"y":66,"wires":[[]]},{"id":"e8567378.843b3","type":"function","z":"3ec0df30.dbad9","name":"audio","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n        \"body\": \"Bee Gees - Stayin' Alive\",\n        \"info\": {\n            \"duration\": 2140786,\n            \"mimetype\": \"audio/mpeg\",\n            \"size\": 1563685\n        },\n        \"msgtype\": \"m.audio\",\n        \"url\": \"mxc://m.tekos.co/iDQkPIUPzFIbrZXVRwpTXEJI\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["a1f18b27.f0be08"]]},{"id":"a1f18b27.f0be08","type":"http request","z":"3ec0df30.dbad9","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":420,"y":80,"wires":[[]]},{"id":"395d4232.1bfa5e","type":"http request","z":"7c18ea50.877574","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","proxy":"","authType":"basic","x":396.0000305175781,"y":80,"wires":[["66adb20e.29aa4c"]]},{"id":"cb9e42a6.99f19","type":"function","z":"7c18ea50.877574","name":"create session","func":"\nmsg.headers ={\n    \"Authorization\" : \"Bearer \" +env.get(\"stripe_token\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n\nlet roomId = msg.roomId.replace(/\\./g,'_')\n//sk_test_fY14VeGn3yvgxSPpmsuyt5pB\n//sk_test_jHqWveQupcd4bBiapSFB3wB6\n var dataString = 'payment_method_types[]=card&line_items[][name]=Carte la story de ton voyage Ã  Paris&line_items[][description]=Carte Format A4 pliÃ©e - 21 cm x 29,7 cm. \\n Papier photo crÃ©atif 350gr. Enveloppe et envoi postal inclus &line_items[]&line_items[][amount]=800&line_items[][currency]=eur&line_items[][quantity]=1&success_url=https://ami.tekos.co/?op=1#/room/'+msg.roomId+'&cancel_url=https://ami.tekos.co/#/room/'+msg.roomId;\n    \nmsg.payload=dataString\n  \nreturn msg;","outputs":1,"noerr":0,"x":175,"y":78.00000190734863,"wires":[["395d4232.1bfa5e"]]},{"id":"abfbecb2.c52ef","type":"http request","z":"7c18ea50.877574","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","x":763,"y":80,"wires":[[]]},{"id":"66adb20e.29aa4c","type":"function","z":"7c18ea50.877574","name":"show button","func":"\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+ env.get('bot_token')\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\": +env.get('cta_message'),\n    \t\"token_stripe\": +env.get('stripe_token'),\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":574,"y":80,"wires":[["abfbecb2.c52ef"]]},{"id":"fa30f46e.d367c8","type":"http in","z":"941b9034.09257","name":"","url":"env.get('post_url')","method":"post","upload":false,"swaggerDoc":"","x":240,"y":260,"wires":[[]]},{"id":"8872f22a.57818","type":"http request","z":"2d963114.1a31fe","name":"TheMovieDB","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":120,"wires":[["5c71c65d.0b8068","70563d49.3a7014"]]},{"id":"5c71c65d.0b8068","type":"debug","z":"2d963114.1a31fe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":750,"y":100,"wires":[]},{"id":"70563d49.3a7014","type":"function","z":"2d963114.1a31fe","name":"template api","func":"var elementsY=[];\nfor (var i = 0; i < 10; i++) {\n       let movie = msg.payload.results[i];\n       elementsY.push( {\n                                  \"title\": movie.title,\n                                  \"subtitle\": movie.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + movie.backdrop_path,\n                          })\n    }\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":750,"y":180,"wires":[[]]},{"id":"917364b.589f698","type":"http request","z":"2d963114.1a31fe","name":"Get Movie Details","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":570,"y":320,"wires":[["652b3b3c.b1b854","f2370116.fa366"]]},{"id":"f2370116.fa366","type":"function","z":"2d963114.1a31fe","name":"Movie Card","func":"var elementsY=[];\n       elementsY.push( {\n                                  \"title\": msg.payload.original_title,\n                                  \"subtitle\": msg.payload.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + msg.payload.poster_path,\n\n                          })\n\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":770.0056610107422,"y":314.46020698547363,"wires":[[]]},{"id":"652b3b3c.b1b854","type":"debug","z":"2d963114.1a31fe","name":"movie details","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":768.0055923461914,"y":371.4601936340332,"wires":[]},{"id":"f66ffec2.f0aef","type":"function","z":"2d963114.1a31fe","name":"","func":"msg.url =  'https://api.themoviedb.org/3/movie/upcoming?api_key=' +env.get('movie_db_key')+ '&language=en-US&page=1'\n\nmsg.payload={\n\n}\n  \nreturn msg;","outputs":1,"noerr":0,"x":370,"y":120,"wires":[["8872f22a.57818"]]},{"id":"33d49541.ec5daa","type":"function","z":"2d963114.1a31fe","name":"","func":"msg.url =  'https://api.themoviedb.org/3/movie/upcoming?api_key=' +env.get('movie_db_key')+ '&language=en-US&page=1'\n\nmsg.payload={\n\n}\n  \nreturn msg;","outputs":1,"noerr":0,"x":350,"y":320,"wires":[["917364b.589f698"]]},{"id":"41979909.178918","type":"http request","z":"63d4d540.a3421c","name":"PipeDrive API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"f33d5103.098ba","type":"function","z":"63d4d540.a3421c","name":"request pipedrive","func":"\nmsg.url='https://api.pipedrive.com/v1/persons?api_token='+env.get('pipedrive_key')\n\nflow.set(\"info\", msg.payload.text[0])\n\nmsg.headers = {\n\"Accept\": \"application/json\"\n}\nmsg.payload = {\n    \"name\": flow.get(\"name\"),\n    \"email\": [{\n        \"value\": flow.get(\"email\"),\n        \"primary\": true\n        }],\n    \"phone\": [{\n        \"value\": flow.get(\"phone\"),\n        \"primary\": true\n        }],\n    \"fac1b8302c0d6ca20ee4d32db247f03013fba556\" : flow.get(\"info\"),\n}\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["41979909.178918"]],"info":"how to add Custom-Fields\nhttps://support.pipedrive.com/hc/en-us/articles/207228075-Custom-Fields\n\nthen get the field key and add it to the body request"},{"id":"671f57ac.046e38","type":"function","z":"d100d95f.692618","name":"authorise email button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get('API_URL')+\"/authorize/2\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":140,"wires":[["c9ee2cbb.ced2"]]},{"id":"c9ee2cbb.ced2","type":"http request","z":"d100d95f.692618","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":480,"y":140,"wires":[["b195ea58.a34668"]]},{"id":"62c95999.0e2228","type":"function","z":"d100d95f.692618","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return msg;\n","outputs":1,"noerr":0,"x":220,"y":300,"wires":[["93c03472.3a6978"]]},{"id":"93c03472.3a6978","type":"http request","z":"d100d95f.692618","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":430,"y":300,"wires":[["97b06747.e822f8","b195ea58.a34668"]]},{"id":"a7cfa0ad.e59c2","type":"function","z":"d100d95f.692618","name":"get all subscriptions ","func":"var room = msg.roomId;\nnode.warn(msg.payload);\nvar customer = msg.payload.data[0]\nvar subs = customer.subscriptions.data\nvar elementsY=[];\nif(env.get(\"service\")== \"all\"){\n\nfor (let i = 0; i < subs.length; i++) \n{\n       let plan =subs[i];\n       \n           elementsY.push\n       ({\n                \"title\": \"Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                 \"subtitle\": plan.plan.currency+\" \"+(plan.plan.amount)/100+\" per \"+plan.plan.interval  ,\n                \"buttons\": \n                [\n                    {\n                         \"type\": \"request_url_only\",\n                \"label\": env.get('callToAction'), //\"Subscribe\",\n                \"value\": \"https://\"+env.get(\"API_URL\")+\"/cancel/request/\"+plan.id,\n                \"alert\": false\n                        \n                    }\n                ]\n        })\n      \n}\n}else if(env.get(\"service\")== \"flow\" ){\n    node.warn(\"flow in\")\n    for (let i = 0; i < subs.length; i++) {\n\n       let plan = subs[i];\n       if(plan.plan.metadata.service == \"hosted_flow\"){\n               elementsY.push\n       ({\n                \"title\": \"Flow Plan : <nobr style='color:#7061e2'>\"+plan.plan.nickname+\"</nobr>\",\n                \"subtitle\": \"<div>Instance : \"+plan.metadata.instance_id+\"</div><div>instance link : https://\"+plan.metadata.subdomaine+\".tekos.co</div><div>Instance state: \"+plan.metadata.instance+\"</div><div>\"+plan.plan.currency+\" \"+(plan.plan.amount)/100+\" per \"+plan.plan.interval+\"</div>\"  ,\n                \"buttons\": \n                [\n                    {\n                         \"type\": \"request_url_only\",\n                \"label\": env.get('callToAction'), //\"Subscribe\",\n                \"value\": \"https://\"+env.get(\"API_URL\")+\"/cancel/request/\"+plan.id,\n                \"alert\": false\n                        \n                    }\n                ]\n        })\n       }\n    }\n    \n}\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":910,"y":260,"wires":[[]]},{"id":"97b06747.e822f8","type":"switch","z":"d100d95f.692618","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":590,"y":300,"wires":[["4462d4b3.0eb92c"],["8afb3375.7eddd"]]},{"id":"8afb3375.7eddd","type":"chatbot-text","z":"d100d95f.692618","name":"no stripe account","message":[{"message":"Your dont seem to have a Stripe account in the first place, please subscribe to a plan first."}],"x":910,"y":340,"wires":[[]]},{"id":"4462d4b3.0eb92c","type":"switch","z":"d100d95f.692618","name":"","property":"payload.data[0].subscriptions.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":280,"wires":[["a7cfa0ad.e59c2"],["d9dd1e2e.af604"]]},{"id":"d9dd1e2e.af604","type":"chatbot-text","z":"d100d95f.692618","name":"no subscriptions","message":[{"message":"Your dont seem to have any active purchases, please subscribe to a plan first."}],"x":900,"y":300,"wires":[[]]},{"id":"b195ea58.a34668","type":"debug","z":"d100d95f.692618","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":600,"y":380,"wires":[]},{"id":"652d121b.6677ac","type":"switch","z":"d100d95f.692618","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":430,"y":80,"wires":[["f9b039aa.d8a998"],["c158eb32.64ee08"]]},{"id":"21e90deb.8156c2","type":"http in","z":"d100d95f.692618","name":"","url":"/authorize/2","method":"post","upload":false,"swaggerDoc":"","x":210,"y":80,"wires":[["d27c372d.9d9928","652d121b.6677ac"]]},{"id":"d27c372d.9d9928","type":"http response","z":"d100d95f.692618","name":"success","statusCode":"200","headers":{},"x":440,"y":40,"wires":[]},{"id":"8d22defd.e218a","type":"chatbot-text","z":"d100d95f.692618","name":"no email","message":[{"message":"Your Tekos account is not link with a verified email. please verify your email first.ðŸ˜«"}],"x":380,"y":340,"wires":[["d3f6b29d.03494"]]},{"id":"a1fbddfd.a83b6","type":"function","z":"d100d95f.692618","name":"no email linked","func":"node.warn(\"no email found\")\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":340,"wires":[["8d22defd.e218a"]]},{"id":"f9b039aa.d8a998","type":"link out","z":"d100d95f.692618","name":"","links":["b51beb1c.312f98"],"x":555,"y":60,"wires":[]},{"id":"c158eb32.64ee08","type":"link out","z":"d100d95f.692618","name":"","links":["288688ba.62dea8"],"x":555,"y":100,"wires":[]},{"id":"b51beb1c.312f98","type":"link in","z":"d100d95f.692618","name":"","links":["f9b039aa.d8a998"],"x":75,"y":300,"wires":[["62c95999.0e2228"]]},{"id":"288688ba.62dea8","type":"link in","z":"d100d95f.692618","name":"","links":["c158eb32.64ee08"],"x":75,"y":340,"wires":[["a1fbddfd.a83b6"]]},{"id":"d3f6b29d.03494","type":"link out","z":"d100d95f.692618","name":"","links":["857696fc.882c08"],"x":475,"y":340,"wires":[]},{"id":"857696fc.882c08","type":"link in","z":"d100d95f.692618","name":"","links":["d3f6b29d.03494","ca5759c7.e5f938"],"x":995,"y":380,"wires":[[]]},{"id":"de56d311.cf615","type":"function","z":"d100d95f.692618","name":"cancel subscription","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n    node.warn(\"cancel subscription\")\n    node.warn(msg);\n    let subscription = msg.req.params.id\n    msg.roomId = msg.payload.roomId\n    msg.why = msg.payload.cancelData\n\n    \n    node.warn(subscription);\n\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+subscription\n    msg.payload = null;\n    return msg;\n","outputs":1,"noerr":0,"x":290,"y":580,"wires":[["adda6dee.4630d"]]},{"id":"adda6dee.4630d","type":"http request","z":"d100d95f.692618","name":"STRIPE API","method":"DELETE","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":470,"y":580,"wires":[["d39dd740.4f02c8","751caf3d.57a0e"]]},{"id":"d39dd740.4f02c8","type":"switch","z":"d100d95f.692618","name":"","property":"payload.status","propertyType":"msg","rules":[{"t":"eq","v":"canceled","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":630,"y":580,"wires":[["72018419.1a01bc"],["997b0072.348cf"]]},{"id":"72018419.1a01bc","type":"chatbot-text","z":"d100d95f.692618","name":"subsctription canceled","message":[{"message":"You canceled your subscription."}],"x":840,"y":560,"wires":[["ca5759c7.e5f938"]]},{"id":"997b0072.348cf","type":"chatbot-text","z":"d100d95f.692618","name":"error","message":[{"message":"No such subscription, your subscription is either canceled or didn't exist in the first place, if you think this is an error please contact support@tekos.co."}],"x":770,"y":600,"wires":[["ca5759c7.e5f938"]]},{"id":"751caf3d.57a0e","type":"debug","z":"d100d95f.692618","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650,"y":640,"wires":[]},{"id":"41ff495b.ef2128","type":"function","z":"d100d95f.692618","name":"Why cancel form ?","func":"node.warn(msg);\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.payload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nnode.warn(msg.url);\nvar subscription = msg.req.params.planId;\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':' Why do you want to cancel your subscription?',\n    \"posturl\": \"https://\"+env.get(\"API_URL\")+\"/cancel/subscription/\"+subscription,\n    \"buttontitle\": \"I want to cancel my subscription\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"send data to support@tekos.co\",\n        \"key\": \"cancelData\"\n      },\n      \n    ]\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":480,"wires":[["16ff1a45.22cd66"]]},{"id":"16ff1a45.22cd66","type":"http request","z":"d100d95f.692618","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":480,"wires":[["b195ea58.a34668"]]},{"id":"d2044b0a.3662d8","type":"http in","z":"d100d95f.692618","name":"Cancel ","url":"/cancel/subscription/:id","method":"post","upload":false,"swaggerDoc":"","x":110,"y":580,"wires":[["de56d311.cf615","fb8b2e7e.e4afc"]]},{"id":"fb8b2e7e.e4afc","type":"http response","z":"d100d95f.692618","name":"OK","statusCode":"200","headers":{},"x":230,"y":540,"wires":[]},{"id":"ca5759c7.e5f938","type":"link out","z":"d100d95f.692618","name":"","links":["857696fc.882c08"],"x":975,"y":600,"wires":[]},{"id":"38fa2813.1394b8","type":"link in","z":"d100d95f.692618","name":"","links":["dbbf06c7.265418","300b0226.72468e"],"x":75,"y":480,"wires":[["41ff495b.ef2128"]]},{"id":"336c1e4.345c0e2","type":"switch","z":"4ebcae91.b5489","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":140,"wires":[["b1c94940.c59318"],["db6aa7c1.713cf8"]]},{"id":"db6aa7c1.713cf8","type":"chatbot-text","z":"4ebcae91.b5489","name":"no stripe account","message":[{"message":"Your dont seem to have a Stripe account in the first place, please subscribe to a plan first."}],"x":670,"y":160,"wires":[[]]},{"id":"b1f24ad3.aa8f88","type":"http request","z":"4ebcae91.b5489","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":310,"y":200,"wires":[["336c1e4.345c0e2","cd10ccbb.f7104"]]},{"id":"2100de98.0f0ce2","type":"function","z":"4ebcae91.b5489","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return msg;\n","outputs":1,"noerr":0,"x":200,"y":140,"wires":[["b1f24ad3.aa8f88"]]},{"id":"cd10ccbb.f7104","type":"debug","z":"4ebcae91.b5489","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":470,"y":220,"wires":[]},{"id":"e9f4ae0b.df9f8","type":"http in","z":"4ebcae91.b5489","name":"update","url":"/billing/update/:roomId/:customer","method":"post","upload":false,"swaggerDoc":"","x":110,"y":280,"wires":[["87e47e05.3c626","7aec2593.13bd0c"]]},{"id":"f80641b9.cc5c4","type":"http response","z":"4ebcae91.b5489","name":"OK","statusCode":"200","headers":{},"x":842,"y":440,"wires":[]},{"id":"b1c94940.c59318","type":"function","z":"4ebcae91.b5489","name":"get room id","func":"node.warn(\"start creating form\")\nnode.warn(msg);\nmsg.payload.plan_id = msg.req.params.id;\nmsg.roomId = msg.roomId;\nmsg.customer = msg.payload.data[0];\nmsg.users = 1;\nmsg.trial = 0\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":650,"y":120,"wires":[["344f56fb.cca63a"]]},{"id":"344f56fb.cca63a","type":"function","z":"4ebcae91.b5489","name":"Update billing details form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\n\n\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\nvar line1, line2, country, postalcode, state, city, taxid, phone, company, name;\n\nif(customer.metadata){\n    phone = customer.metadata.phone;\n    company = customer.metadata.company;\n    name = customer.metadata.name;\n}else{\n    phone = \"\";\n    company = \"\";\n    name = \"\";\n}\n\nif(customer.address){\n line1 = customer.address.line1;\n line2 = customer.address.line2 ;\n country = customer.address.country ;\n postalcode= customer.address.postal_code; \n state = customer.address.state;\n city =  customer.address.city;\n if(customer.tax_ids.data.length  > 0){\n      taxid = customer.tax_ids.data[0].value ;\n\n }else{\n     taxid = \"\";\n }\n\n}else{\n line1 = \"\";\n line2 = \"\";\n country = \"\";\n postalcode= \"\";\n state = \"\";\n city =  \"\";\n taxid = \"\"; \n}\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Update billing details',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/update/\"+msg.roomId+\"/\"+customer.id,\n    \"buttontitle\": \"Update\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Address\",\n        \"key\": \"address\",\n        \"defaultValue\":line1\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Address 2\",\n        \"key\": \"address2\",\n        \"defaultValue\":line2\n      },\n       {\n        \"type\": \"select\",\n        \"subtype\": \"select\",\n        \"label\": \"Country\",\n        \"key\": \"country\",\n        \"defaultValue\":country,\n        \"options\":[\n           {\"value\":\"AF\",\"label\":\"Afghanistan\"},\n{\"value\":\"AX\",\"label\":\"Ã…land Islands\"},\n{\"value\":\"AL\",\"label\":\"Albania\"},\n{\"value\":\"DZ\",\"label\":\"Algeria\"},\n{\"value\":\"AS\",\"label\":\"American Samoa\"},\n{\"value\":\"AD\",\"label\":\"Andorra\"},\n{\"value\":\"AO\",\"label\":\"Angola\"},\n{\"value\":\"AI\",\"label\":\"Anguilla\"},\n{\"value\":\"AQ\",\"label\":\"Antarctica\"},\n{\"value\":\"AG\",\"label\":\"Antigua and Barbuda\"},\n{\"value\":\"AR\",\"label\":\"Argentina\"},\n{\"value\":\"AM\",\"label\":\"Armenia\"},\n{\"value\":\"AW\",\"label\":\"Aruba\"},\n{\"value\":\"AU\",\"label\":\"Australia\"},\n{\"value\":\"AT\",\"label\":\"Austria\"},\n{\"value\":\"AZ\",\"label\":\"Azerbaijan\"},\n{\"value\":\"BH\",\"label\":\"Bahrain\"},\n{\"value\":\"BS\",\"label\":\"Bahamas\"},\n{\"value\":\"BD\",\"label\":\"Bangladesh\"},\n{\"value\":\"BB\",\"label\":\"Barbados\"},\n{\"value\":\"BY\",\"label\":\"Belarus\"},\n{\"value\":\"BE\",\"label\":\"Belgium\"},\n{\"value\":\"BZ\",\"label\":\"Belize\"},\n{\"value\":\"BJ\",\"label\":\"Benin\"},\n{\"value\":\"BM\",\"label\":\"Bermuda\"},\n{\"value\":\"BT\",\"label\":\"Bhutan\"},\n{\"value\":\"BO\",\"label\":\"Bolivia, Plurinational State of\"},\n{\"value\":\"BQ\",\"label\":\"Bonaire, Sint Eustatius and Saba\"},\n{\"value\":\"BA\",\"label\":\"Bosnia and Herzegovina\"},\n{\"value\":\"BW\",\"label\":\"Botswana\"},\n{\"value\":\"BV\",\"label\":\"Bouvet Island\"},\n{\"value\":\"BR\",\"label\":\"Brazil\"},\n{\"value\":\"IO\",\"label\":\"British Indian Ocean Territory\"},\n{\"value\":\"BN\",\"label\":\"Brunei Darussalam\"},\n{\"value\":\"BG\",\"label\":\"Bulgaria\"},\n{\"value\":\"BF\",\"label\":\"Burkina Faso\"},\n{\"value\":\"BI\",\"label\":\"Burundi\"},\n{\"value\":\"KH\",\"label\":\"Cambodia\"},\n{\"value\":\"CM\",\"label\":\"Cameroon\"},\n{\"value\":\"CA\",\"label\":\"Canada\"},\n{\"value\":\"CV\",\"label\":\"Cape Verde\"},\n{\"value\":\"KY\",\"label\":\"Cayman Islands\"},\n{\"value\":\"CF\",\"label\":\"Central African Republic\"},\n{\"value\":\"TD\",\"label\":\"Chad\"},\n{\"value\":\"CL\",\"label\":\"Chile\"},\n{\"value\":\"CN\",\"label\":\"China\"},\n{\"value\":\"CX\",\"label\":\"Christmas Island\"},\n{\"value\":\"CC\",\"label\":\"Cocos (Keeling) Islands\"},\n{\"value\":\"CO\",\"label\":\"Colombia\"},\n{\"value\":\"KM\",\"label\":\"Comoros\"},\n{\"value\":\"CG\",\"label\":\"Congo\"},\n{\"value\":\"CD\",\"label\":\"Congo, the Democratic Republic of the\"},\n{\"value\":\"CK\",\"label\":\"Cook Islands\"},\n{\"value\":\"CR\",\"label\":\"Costa Rica\"},\n{\"value\":\"CI\",\"label\":\"CÃ´te d'Ivoire\"},\n{\"value\":\"HR\",\"label\":\"Croatia\"},\n{\"value\":\"CU\",\"label\":\"Cuba\"},\n{\"value\":\"CW\",\"label\":\"CuraÃ§ao\"},\n{\"value\":\"CY\",\"label\":\"Cyprus\"},\n{\"value\":\"CZ\",\"label\":\"Czech Republic\"},\n{\"value\":\"DK\",\"label\":\"Denmark\"},\n{\"value\":\"DJ\",\"label\":\"Djibouti\"},\n{\"value\":\"DM\",\"label\":\"Dominica\"},\n{\"value\":\"DO\",\"label\":\"Dominican Republic\"},\n{\"value\":\"EC\",\"label\":\"Ecuador\"},\n{\"value\":\"EG\",\"label\":\"Egypt\"},\n{\"value\":\"SV\",\"label\":\"El Salvador\"},\n{\"value\":\"GQ\",\"label\":\"Equatorial Guinea\"},\n{\"value\":\"ER\",\"label\":\"Eritrea\"},\n{\"value\":\"EE\",\"label\":\"Estonia\"},\n{\"value\":\"ET\",\"label\":\"Ethiopia\"},\n{\"value\":\"FK\",\"label\":\"Falkland Islands (Malvinas)\"},\n{\"value\":\"FO\",\"label\":\"Faroe Islands\"},\n{\"value\":\"FJ\",\"label\":\"Fiji\"},\n{\"value\":\"FI\",\"label\":\"Finland\"},\n{\"value\":\"FR\",\"label\":\"France\"},\n{\"value\":\"GF\",\"label\":\"French Guiana\"},\n{\"value\":\"PF\",\"label\":\"French Polynesia\"},\n{\"value\":\"TF\",\"label\":\"French Southern Territories\"},\n{\"value\":\"GA\",\"label\":\"Gabon\"},\n{\"value\":\"GM\",\"label\":\"Gambia\"},\n{\"value\":\"GE\",\"label\":\"Georgia\"},\n{\"value\":\"DE\",\"label\":\"Germany\"},\n{\"value\":\"GH\",\"label\":\"Ghana\"},\n{\"value\":\"GI\",\"label\":\"Gibraltar\"},\n{\"value\":\"GR\",\"label\":\"Greece\"},\n{\"value\":\"GL\",\"label\":\"Greenland\"},\n{\"value\":\"GD\",\"label\":\"Grenada\"},\n{\"value\":\"GP\",\"label\":\"Guadeloupe\"},\n{\"value\":\"GU\",\"label\":\"Guam\"},\n{\"value\":\"GT\",\"label\":\"Guatemala\"},\n{\"value\":\"GG\",\"label\":\"Guernsey\"},\n{\"value\":\"GN\",\"label\":\"Guinea\"},\n{\"value\":\"GW\",\"label\":\"Guinea-Bissau\"},\n{\"value\":\"GY\",\"label\":\"Guyana\"},\n{\"value\":\"HT\",\"label\":\"Haiti\"},\n{\"value\":\"HM\",\"label\":\"Heard Island and McDonald Islands\"},\n{\"value\":\"VA\",\"label\":\"Holy See (Vatican City State)\"},\n{\"value\":\"HN\",\"label\":\"Honduras\"},\n{\"value\":\"HK\",\"label\":\"Hong Kong\"},\n{\"value\":\"HU\",\"label\":\"Hungary\"},\n{\"value\":\"IS\",\"label\":\"Iceland\"},\n{\"value\":\"IN\",\"label\":\"India\"},\n{\"value\":\"ID\",\"label\":\"Indonesia\"},\n{\"value\":\"IR\",\"label\":\"Iran, Islamic Republic of\"},\n{\"value\":\"IQ\",\"label\":\"Iraq\"},\n{\"value\":\"IE\",\"label\":\"Ireland\"},\n{\"value\":\"IM\",\"label\":\"Isle of Man\"},\n{\"value\":\"IL\",\"label\":\"Israel\"},\n{\"value\":\"IT\",\"label\":\"Italy\"},\n{\"value\":\"JM\",\"label\":\"Jamaica\"},\n{\"value\":\"JP\",\"label\":\"Japan\"},\n{\"value\":\"JE\",\"label\":\"Jersey\"},\n{\"value\":\"JO\",\"label\":\"Jordan\"},\n{\"value\":\"KZ\",\"label\":\"Kazakhstan\"},\n{\"value\":\"KE\",\"label\":\"Kenya\"},\n{\"value\":\"KI\",\"label\":\"Kiribati\"},\n{\"value\":\"KP\",\"label\":\"Korea, Democratic People's Republic of\"},\n{\"value\":\"KR\",\"label\":\"Korea, Republic of\"},\n{\"value\":\"KW\",\"label\":\"Kuwait\"},\n{\"value\":\"KG\",\"label\":\"Kyrgyzstan\"},\n{\"value\":\"LA\",\"label\":\"Lao People's Democratic Republic\"},\n{\"value\":\"LV\",\"label\":\"Latvia\"},\n{\"value\":\"LB\",\"label\":\"Lebanon\"},\n{\"value\":\"LS\",\"label\":\"Lesotho\"},\n{\"value\":\"LR\",\"label\":\"Liberia\"},\n{\"value\":\"LY\",\"label\":\"Libya\"},\n{\"value\":\"LI\",\"label\":\"Liechtenstein\"},\n{\"value\":\"LT\",\"label\":\"Lithuania\"},\n{\"value\":\"LU\",\"label\":\"Luxembourg\"},\n{\"value\":\"MO\",\"label\":\"Macao\"},\n{\"value\":\"MK\",\"label\":\"Macedonia, the Former Yugoslav Republic of\"},\n{\"value\":\"MG\",\"label\":\"Madagascar\"},\n{\"value\":\"MW\",\"label\":\"Malawi\"},\n{\"value\":\"MY\",\"label\":\"Malaysia\"},\n{\"value\":\"MV\",\"label\":\"Maldives\"},\n{\"value\":\"ML\",\"label\":\"Mali\"},\n{\"value\":\"MT\",\"label\":\"Malta\"},\n{\"value\":\"MH\",\"label\":\"Marshall Islands\"},\n{\"value\":\"MQ\",\"label\":\"Martinique\"},\n{\"value\":\"MR\",\"label\":\"Mauritania\"},\n{\"value\":\"MU\",\"label\":\"Mauritius\"},\n{\"value\":\"YT\",\"label\":\"Mayotte\"},\n{\"value\":\"MX\",\"label\":\"Mexico\"},\n{\"value\":\"FM\",\"label\":\"Micronesia, Federated States of\"},\n{\"value\":\"MD\",\"label\":\"Moldova, Republic of\"},\n{\"value\":\"MC\",\"label\":\"Monaco\"},\n{\"value\":\"MN\",\"label\":\"Mongolia\"},\n{\"value\":\"ME\",\"label\":\"Montenegro\"},\n{\"value\":\"MS\",\"label\":\"Montserrat\"},\n{\"value\":\"MA\",\"label\":\"Morocco\"},\n{\"value\":\"MZ\",\"label\":\"Mozambique\"},\n{\"value\":\"MM\",\"label\":\"Myanmar\"},\n{\"value\":\"NA\",\"label\":\"Namibia\"},\n{\"value\":\"NR\",\"label\":\"Nauru\"},\n{\"value\":\"NP\",\"label\":\"Nepal\"},\n{\"value\":\"NL\",\"label\":\"Netherlands\"},\n{\"value\":\"NC\",\"label\":\"New Caledonia\"},\n{\"value\":\"NZ\",\"label\":\"New Zealand\"},\n{\"value\":\"NI\",\"label\":\"Nicaragua\"},\n{\"value\":\"NE\",\"label\":\"Niger\"},\n{\"value\":\"NG\",\"label\":\"Nigeria\"},\n{\"value\":\"NU\",\"label\":\"Niue\"},\n{\"value\":\"NF\",\"label\":\"Norfolk Island\"},\n{\"value\":\"MP\",\"label\":\"Northern Mariana Islands\"},\n{\"value\":\"NO\",\"label\":\"Norway\"},\n{\"value\":\"OM\",\"label\":\"Oman\"},\n{\"value\":\"PK\",\"label\":\"Pakistan\"},\n{\"value\":\"PW\",\"label\":\"Palau\"},\n{\"value\":\"PS\",\"label\":\"Palestine, State of\"},\n{\"value\":\"PA\",\"label\":\"Panama\"},\n{\"value\":\"PG\",\"label\":\"Papua New Guinea\"},\n{\"value\":\"PY\",\"label\":\"Paraguay\"},\n{\"value\":\"PE\",\"label\":\"Peru\"},\n{\"value\":\"PH\",\"label\":\"Philippines\"},\n{\"value\":\"PN\",\"label\":\"Pitcairn\"},\n{\"value\":\"PL\",\"label\":\"Poland\"},\n{\"value\":\"PT\",\"label\":\"Portugal\"},\n{\"value\":\"PR\",\"label\":\"Puerto Rico\"},\n{\"value\":\"QA\",\"label\":\"Qatar\"},\n{\"value\":\"RE\",\"label\":\"RÃ©union\"},\n{\"value\":\"RO\",\"label\":\"Romania\"},\n{\"value\":\"RU\",\"label\":\"Russian Federation\"},\n{\"value\":\"RW\",\"label\":\"Rwanda\"},\n{\"value\":\"BL\",\"label\":\"Saint BarthÃ©lemy\"},\n{\"value\":\"SH\",\"label\":\"Saint Helena, Ascension and Tristan da Cunha\"},\n{\"value\":\"KN\",\"label\":\"Saint Kitts and Nevis\"},\n{\"value\":\"LC\",\"label\":\"Saint Lucia\"},\n{\"value\":\"MF\",\"label\":\"Saint Martin (French part)\"},\n{\"value\":\"PM\",\"label\":\"Saint Pierre and Miquelon\"},\n{\"value\":\"VC\",\"label\":\"Saint Vincent and the Grenadines\"},\n{\"value\":\"WS\",\"label\":\"Samoa\"},\n{\"value\":\"SM\",\"label\":\"San Marino\"},\n{\"value\":\"ST\",\"label\":\"Sao Tome and Principe\"},\n{\"value\":\"SA\",\"label\":\"Saudi Arabia\"},\n{\"value\":\"SN\",\"label\":\"Senegal\"},\n{\"value\":\"RS\",\"label\":\"Serbia\"},\n{\"value\":\"SC\",\"label\":\"Seychelles\"},\n{\"value\":\"SL\",\"label\":\"Sierra Leone\"},\n{\"value\":\"SG\",\"label\":\"Singapore\"},\n{\"value\":\"SX\",\"label\":\"Sint Maarten (Dutch part)\"},\n{\"value\":\"SK\",\"label\":\"Slovakia\"},\n{\"value\":\"SI\",\"label\":\"Slovenia\"},\n{\"value\":\"SB\",\"label\":\"Solomon Islands\"},\n{\"value\":\"SO\",\"label\":\"Somalia\"},\n{\"value\":\"ZA\",\"label\":\"South Africa\"},\n{\"value\":\"GS\",\"label\":\"South Georgia and the South Sandwich Islands\"},\n{\"value\":\"SS\",\"label\":\"South Sudan\"},\n{\"value\":\"ES\",\"label\":\"Spain\"},\n{\"value\":\"LK\",\"label\":\"Sri Lanka\"},\n{\"value\":\"SD\",\"label\":\"Sudan\"},\n{\"value\":\"SR\",\"label\":\"Suriname\"},\n{\"value\":\"SJ\",\"label\":\"Svalbard and Jan Mayen\"},\n{\"value\":\"SZ\",\"label\":\"Swaziland\"},\n{\"value\":\"SE\",\"label\":\"Sweden\"},\n{\"value\":\"CH\",\"label\":\"Switzerland\"},\n{\"value\":\"SY\",\"label\":\"Syrian Arab Republic\"},\n{\"value\":\"TW\",\"label\":\"Taiwan, Province of China\"},\n{\"value\":\"TJ\",\"label\":\"Tajikistan\"},\n{\"value\":\"TZ\",\"label\":\"Tanzania, United Republic of\"},\n{\"value\":\"TH\",\"label\":\"Thailand\"},\n{\"value\":\"TL\",\"label\":\"Timor-Leste\"},\n{\"value\":\"TG\",\"label\":\"Togo\"},\n{\"value\":\"TK\",\"label\":\"Tokelau\"},\n{\"value\":\"TO\",\"label\":\"Tonga\"},\n{\"value\":\"TT\",\"label\":\"Trinidad and Tobago\"},\n{\"value\":\"TN\",\"label\":\"Tunisia\"},\n{\"value\":\"TR\",\"label\":\"Turkey\"},\n{\"value\":\"TM\",\"label\":\"Turkmenistan\"},\n{\"value\":\"TC\",\"label\":\"Turks and Caicos Islands\"},\n{\"value\":\"TV\",\"label\":\"Tuvalu\"},\n{\"value\":\"UG\",\"label\":\"Uganda\"},\n{\"value\":\"UA\",\"label\":\"Ukraine\"},\n{\"value\":\"AE\",\"label\":\"United Arab Emirates\"},\n{\"value\":\"GB\",\"label\":\"United Kingdom\"},\n{\"value\":\"US\",\"label\":\"United States\"},\n{\"value\":\"UM\",\"label\":\"United States Minor Outlying Islands\"},\n{\"value\":\"UY\",\"label\":\"Uruguay\"},\n{\"value\":\"UZ\",\"label\":\"Uzbekistan\"},\n{\"value\":\"VU\",\"label\":\"Vanuatu\"},\n{\"value\":\"VE\",\"label\":\"Venezuela, Bolivarian Republic of\"},\n{\"value\":\"VN\",\"label\":\"Viet Nam\"},\n{\"value\":\"VG\",\"label\":\"Virgin Islands, British\"},\n{\"value\":\"VI\",\"label\":\"Virgin Islands, U.S.\"},\n{\"value\":\"WF\",\"label\":\"Wallis and Futuna\"},\n{\"value\":\"EH\",\"label\":\"Western Sahara\"},\n{\"value\":\"YE\",\"label\":\"Yemen\"},\n{\"value\":\"ZM\",\"label\":\"Zambia\"},\n{\"value\":\"ZW\",\"label\":\"Zimbabwe\"}\n        ]\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Postal Code\",\n        \"key\": \"postalcode\",\n        \"defaultValue\":postalcode\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"State\",\n        \"key\": \"stat\",\n        \"defaultValue\":state\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"City\",\n        \"key\": \"city\",\n        \"defaultValue\":city\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Tax ID\",\n        \"key\": \"taxid\",\n        \"defaultValue\":taxid\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Phone number\",\n        \"key\": \"phone\",\n        \"defaultValue\":phone\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Company name\",\n        \"key\": \"company\",\n        \"defaultValue\":company\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Your name\",\n        \"key\": \"yourname\",\n        \"defaultValue\":name\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":850,"y":120,"wires":[["f55212f2.f59b9"]]},{"id":"87e47e05.3c626","type":"function","z":"4ebcae91.b5489","name":"update billing details","func":"  msg.roomId = msg.payload.roomId;\n  msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/customers/\"+msg.req.params.customer;\nvar dataString = \"address[state]=\"+msg.payload.stat+\"&address[line1]=\"+msg.payload.address+\"&address[city]=\"+msg.payload.city+\"&address[line2]=\"+msg.payload.address2+\"&address[country]=\"+msg.payload.country.value+\"&address[postal_code]=\"+msg.payload.postalcode;\nif(msg.payload.taxid ){\n    dataString += \"&tax_info[tax_id]=\"+msg.payload.taxid+\"&tax_info[type]=vat\";\n}\n\nmsg.payload = dataString\nreturn msg;","outputs":1,"noerr":0,"x":360,"y":340,"wires":[["4a7fd56f.a560ec"]]},{"id":"7aec2593.13bd0c","type":"debug","z":"4ebcae91.b5489","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":310,"y":380,"wires":[]},{"id":"4a7fd56f.a560ec","type":"http request","z":"4ebcae91.b5489","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":570,"y":340,"wires":[["a9261f33.c2c9","64dd490f.a50858"]]},{"id":"a9261f33.c2c9","type":"debug","z":"4ebcae91.b5489","name":"resultUpdate","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":750,"y":320,"wires":[]},{"id":"64dd490f.a50858","type":"switch","z":"4ebcae91.b5489","name":"","property":"payload.error","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":380,"wires":[["6c9b1f96.dd453","46809501.365fac"],["88f7ea8a.90bcb8","f80641b9.cc5c4"]]},{"id":"88f7ea8a.90bcb8","type":"chatbot-text","z":"4ebcae91.b5489","name":"Update done","message":[{"message":"Your Stripe billing details have been updated successuflyðŸ˜Š."}],"x":910,"y":400,"wires":[[]]},{"id":"6c9b1f96.dd453","type":"chatbot-text","z":"4ebcae91.b5489","name":"error update","message":[{"message":"ops ðŸ˜³, something went wrong, please try in a couple of minutes... "}],"x":910,"y":340,"wires":[[]]},{"id":"f55212f2.f59b9","type":"http request","z":"4ebcae91.b5489","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1040,"y":120,"wires":[[]]},{"id":"beaaaa4f.092d38","type":"switch","z":"4ebcae91.b5489","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":350,"y":80,"wires":[["e1ff35ae.074c58"],["f5008622.2a08b8"]]},{"id":"32fbcef2.d3ab62","type":"http in","z":"4ebcae91.b5489","name":"","url":"/authorize/5","method":"post","upload":false,"swaggerDoc":"","x":130,"y":80,"wires":[["5f04514.3cdecb","beaaaa4f.092d38"]]},{"id":"5f04514.3cdecb","type":"http response","z":"4ebcae91.b5489","name":"success","statusCode":"200","headers":{},"x":360,"y":40,"wires":[]},{"id":"e1ff35ae.074c58","type":"link out","z":"4ebcae91.b5489","name":"","links":["88923b39.5273a8"],"x":475,"y":60,"wires":[]},{"id":"f5008622.2a08b8","type":"link out","z":"4ebcae91.b5489","name":"","links":[],"x":475,"y":100,"wires":[]},{"id":"88923b39.5273a8","type":"link in","z":"4ebcae91.b5489","name":"","links":["e1ff35ae.074c58"],"x":60,"y":140,"wires":[["2100de98.0f0ce2"]]},{"id":"299d3ea8.f5dd72","type":"function","z":"4ebcae91.b5489","name":"authorise email button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get('API_URL')+\"/authorize/5\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":220,"y":480,"wires":[["b23a4a26.b80428"]]},{"id":"b23a4a26.b80428","type":"http request","z":"4ebcae91.b5489","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":480,"wires":[["7aec2593.13bd0c"]]},{"id":"9cf10e0f.0f7de","type":"http request","z":"5e0c13c0.29fccc","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","persist":false,"proxy":"","authType":"","x":494.99997329711914,"y":488.9999885559082,"wires":[["4184c920.8374b8","2a119870.61cf68"]]},{"id":"1328c07c.b3fd6","type":"function","z":"5e0c13c0.29fccc","name":"create session","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nnode.warn(\"### start card setup mode ###\")\nnode.warn(msg)\nvar customer = msg.payload.data[0]\n//sk_test_fY14VeGn3yvgxSPpmsuyt5pB\n//sk_test_jHqWveQupcd4bBiapSFB3wB6\n var dataString = 'setup_intent_data[metadata][customer]='+customer.id+'&setup_intent_data[metadata][intent]=ucc&mode=setup&payment_method_types[]=card&success_url='+env.get(\"CHAT_CLIENT_URL\")+'/#/room/'+msg.roomId+'&cancel_url='+env.get(\"CHAT_CLIENT_URL\")+'/#/room/'+msg.roomId;\n    \nmsg.payload=dataString\n  \nreturn msg;","outputs":1,"noerr":0,"x":304.99997329711914,"y":488.9999885559082,"wires":[["9cf10e0f.0f7de"]]},{"id":"dd4e12a5.51e86","type":"http request","z":"5e0c13c0.29fccc","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","x":844.9999732971191,"y":488.9999885559082,"wires":[[]]},{"id":"4184c920.8374b8","type":"function","z":"5e0c13c0.29fccc","name":"show button","func":"\nmsg.url = \"https://\"+env.get(\"BASE_URL\") + \"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\": env.get(\"CTA_BUTTON\"), //\"\",\n    \t\"token_stripe\": env.get(\"STRIPE_PUB_KEY\")   //STRIPE_PUB_KEY\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":674.9999732971191,"y":488.9999885559082,"wires":[["dd4e12a5.51e86"]]},{"id":"ec6218e1.64b838","type":"chatbot-text","z":"5e0c13c0.29fccc","name":"no stripe account","message":[{"message":"Your dont seem to have a Stripe account in the first place, please subscribe to a plan first."}],"x":1002.9999732971191,"y":274.00000762939453,"wires":[[]]},{"id":"94917873.5b6d08","type":"switch","z":"5e0c13c0.29fccc","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":609.9999885559082,"y":266.0000009536743,"wires":[["edcb1ac6.ea6888"],["ec6218e1.64b838","bbe5e8dc.d8fe68"]]},{"id":"4b847267.a2d8dc","type":"http request","z":"5e0c13c0.29fccc","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":469.9999885559082,"y":266.0000009536743,"wires":[["94917873.5b6d08","2ba03f6b.f2008"]]},{"id":"43e0593a.a69908","type":"function","z":"5e0c13c0.29fccc","name":"get customer account","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/customers?limit=1&email=\"+msg.payload.email\n    return msg;\n","outputs":1,"noerr":0,"x":275.9999885559082,"y":265.00000190734863,"wires":[["4b847267.a2d8dc"]]},{"id":"964fa93c.c0bcd8","type":"debug","z":"5e0c13c0.29fccc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":639.0000076293945,"y":57.00010967254639,"wires":[]},{"id":"bbe5e8dc.d8fe68","type":"link out","z":"5e0c13c0.29fccc","name":"","links":["7aad98ae.94f1c8"],"x":723.9999723434448,"y":286.0000057220459,"wires":[]},{"id":"7aad98ae.94f1c8","type":"link in","z":"5e0c13c0.29fccc","name":"link to session","links":["bbe5e8dc.d8fe68","edcb1ac6.ea6888","4bdba052.9fe15"],"x":179.99997329711914,"y":488.9999885559082,"wires":[["1328c07c.b3fd6"]]},{"id":"e78f2c4d.a6e9d","type":"switch","z":"5e0c13c0.29fccc","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":443.99998474121094,"y":156.9999942779541,"wires":[["c799d091.a84df"],["cf1aae01.0bece"]]},{"id":"87c0fe36.3c47f","type":"http in","z":"5e0c13c0.29fccc","name":"","url":"/authorize/4","method":"post","upload":false,"swaggerDoc":"","x":223.99998474121094,"y":156.9999942779541,"wires":[["8ee9ad2.3a02b5","e78f2c4d.a6e9d"]]},{"id":"8ee9ad2.3a02b5","type":"http response","z":"5e0c13c0.29fccc","name":"success","statusCode":"200","headers":{},"x":453.99998474121094,"y":116.9999942779541,"wires":[]},{"id":"c799d091.a84df","type":"link out","z":"5e0c13c0.29fccc","name":"link customer","links":["f5ace7fa.698d48"],"x":548.9999847412109,"y":136.9999942779541,"wires":[]},{"id":"cf1aae01.0bece","type":"link out","z":"5e0c13c0.29fccc","name":"error msg","links":["7665ec34.2eb104"],"x":568.9999847412109,"y":176.9999942779541,"wires":[]},{"id":"f5ace7fa.698d48","type":"link in","z":"5e0c13c0.29fccc","name":"link to customer","links":["c799d091.a84df"],"x":134.9999885559082,"y":266.0000009536743,"wires":[["43e0593a.a69908"]]},{"id":"fa533181.d077","type":"chatbot-text","z":"5e0c13c0.29fccc","name":"no email","message":[{"message":"Your Tekos account is not link with a verified email. please verify your email first.ðŸ˜«"}],"x":1223.9999542236328,"y":186.00006198883057,"wires":[["e84b4c17.ad164"]]},{"id":"95e46134.a17cb","type":"function","z":"5e0c13c0.29fccc","name":"no email linked","func":"node.warn(\"no email found\")\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":1054.9999389648438,"y":177.9999876022339,"wires":[["fa533181.d077"]]},{"id":"7665ec34.2eb104","type":"link in","z":"5e0c13c0.29fccc","name":"","links":["cf1aae01.0bece"],"x":929.9999389648438,"y":177.9999876022339,"wires":[["95e46134.a17cb"]]},{"id":"e84b4c17.ad164","type":"link out","z":"5e0c13c0.29fccc","name":"","links":[],"x":1329.9999389648438,"y":177.9999876022339,"wires":[]},{"id":"2ba03f6b.f2008","type":"debug","z":"5e0c13c0.29fccc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":569.9999885559082,"y":326.0000009536743,"wires":[]},{"id":"5e0b953c.6303dc","type":"function","z":"5e0c13c0.29fccc","name":"authorise email button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\") + \"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get('API_URL')+\"/authorize/4\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":299.00000381469727,"y":55.000006675720215,"wires":[["d0acd14a.3dd6e"]]},{"id":"d0acd14a.3dd6e","type":"http request","z":"5e0c13c0.29fccc","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":479.00000381469727,"y":55.000006675720215,"wires":[["964fa93c.c0bcd8"]]},{"id":"edcb1ac6.ea6888","type":"link out","z":"5e0c13c0.29fccc","name":"","links":["7aad98ae.94f1c8"],"x":719.9999885559082,"y":246.00000095367432,"wires":[]},{"id":"9ee16f47.6e931","type":"debug","z":"5e0c13c0.29fccc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":529.9999885559082,"y":686.0000009536743,"wires":[]},{"id":"3e60ce9b.56a482","type":"http response","z":"5e0c13c0.29fccc","name":"success","statusCode":"200","headers":{},"x":539.9999885559082,"y":726.0000009536743,"wires":[]},{"id":"aa0b7415.6aff88","type":"switch","z":"5e0c13c0.29fccc","name":"","property":"payload.data.object.metadata.intent","propertyType":"msg","rules":[{"t":"eq","v":"ucc","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":229.9999885559082,"y":766.0000009536743,"wires":[["150d7d03.b80da3"],[]]},{"id":"150d7d03.b80da3","type":"function","z":"5e0c13c0.29fccc","name":"get customer","func":"msg.intent = msg.payload;\nvar response = msg.payload.data.object;\nvar customer = response.metadata.customer;\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    node.warn(\"success email found\")\n    node.warn(msg)\n    msg.roomId = msg.payload.roomId\n    msg.url =\"https://api.stripe.com/v1/payment_methods/\"+response.payment_method+\"/attach\";\n    var dataString =\"customer=\"+customer;\n    msg.payload = dataString;\n    return msg;\n","outputs":1,"noerr":0,"x":389.9999885559082,"y":766.0000009536743,"wires":[["78311aec.ce3a34"]]},{"id":"1b1f5549.16e85b","type":"switch","z":"5e0c13c0.29fccc","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"eq","v":"0","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":709.9999885559082,"y":766.0000009536743,"wires":[["3041ea08.2650c6"],["4bdba052.9fe15"]]},{"id":"78311aec.ce3a34","type":"http request","z":"5e0c13c0.29fccc","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":569.9999885559082,"y":766.0000009536743,"wires":[["1b1f5549.16e85b","720ff813.b90f08"]]},{"id":"4bdba052.9fe15","type":"link out","z":"5e0c13c0.29fccc","name":"","links":["7aad98ae.94f1c8"],"x":814.9999885559082,"y":786.0000009536743,"wires":[]},{"id":"3041ea08.2650c6","type":"link out","z":"5e0c13c0.29fccc","name":"","links":[],"x":819.9999885559082,"y":746.0000009536743,"wires":[]},{"id":"720ff813.b90f08","type":"debug","z":"5e0c13c0.29fccc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":709.9999885559082,"y":826.0000009536743,"wires":[]},{"id":"c483010d.d5e14","type":"http in","z":"27aa6202.673c3e","name":"","url":"/pipedrive","method":"post","upload":false,"swaggerDoc":"","x":120,"y":320,"wires":[["79c4a59f.164b3c","c9b1d0ea.22a3b","69e7e5b3.bba9ac"]]},{"id":"79c4a59f.164b3c","type":"http response","z":"27aa6202.673c3e","name":"","statusCode":"200","headers":{},"x":320,"y":200,"wires":[]},{"id":"c9b1d0ea.22a3b","type":"debug","z":"27aa6202.673c3e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":330,"y":240,"wires":[]},{"id":"69e7e5b3.bba9ac","type":"switch","z":"27aa6202.673c3e","name":"Event Action","property":"payload.meta.action","propertyType":"msg","rules":[{"t":"eq","v":"added","vt":"str"},{"t":"eq","v":"updated","vt":"str"},{"t":"eq","v":"merged","vt":"str"},{"t":"eq","v":"deleted","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":330,"y":320,"wires":[["3b10e137.51f7ce"],["3b10e137.51f7ce"],["3b10e137.51f7ce"],["3b10e137.51f7ce"]]},{"id":"3b10e137.51f7ce","type":"switch","z":"27aa6202.673c3e","name":"Event Object","property":"payload.meta.object","propertyType":"msg","rules":[{"t":"eq","v":"deal","vt":"str"},{"t":"eq","v":"activity","vt":"str"},{"t":"eq","v":"activityType","vt":"str"},{"t":"eq","v":"note","vt":"str"},{"t":"eq","v":"organization","vt":"str"},{"t":"eq","v":"person","vt":"str"},{"t":"eq","v":"pipeline","vt":"str"},{"t":"eq","v":"product","vt":"str"},{"t":"eq","v":"stage","vt":"str"},{"t":"eq","v":"user","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":11,"x":550,"y":280,"wires":[["76d4b643.05a7b8"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"]]},{"id":"ee7f8179.22d99","type":"link in","z":"27aa6202.673c3e","name":"","links":["d6e2e6fb.3a6828","1bda1d39.856ed3","cf4ba897.312cc8","f1737a7c.739f38","c1ad3af3.b0d0d8","b9826a6.52a6598","87b4db0a.711288"],"x":1055,"y":360,"wires":[["6f9fa7cf.3c5638"]]},{"id":"b99522da.3abb1","type":"comment","z":"27aa6202.673c3e","name":"https://www.pipedrive.com/fr/features/slack-crm-integration","info":"","x":450,"y":120,"wires":[]},{"id":"76d4b643.05a7b8","type":"chatbot-text","z":"27aa6202.673c3e","name":"Deal","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}: ðŸ‘\n{{current.title}}\nowner: {{current.owner_name}}\nvalue: {{current.formatted_weighted_value}}\nexpected close date: {{current.expected_close_date}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":750,"y":220,"wires":[["f1737a7c.739f38"]]},{"id":"f1737a7c.739f38","type":"link out","z":"27aa6202.673c3e","name":"","links":["ee7f8179.22d99"],"x":895,"y":220,"wires":[]},{"id":"4967239e.37f16c","type":"chatbot-text","z":"27aa6202.673c3e","name":"(generic)","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}:\n{{meta.object}} : {{current.name}}\nowner: {{current.owner_name}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":740,"y":320,"wires":[["c1ad3af3.b0d0d8"]]},{"id":"c1ad3af3.b0d0d8","type":"link out","z":"27aa6202.673c3e","name":"","links":["ee7f8179.22d99"],"x":895,"y":320,"wires":[]},{"id":"6f9fa7cf.3c5638","type":"debug","z":"27aa6202.673c3e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1170,"y":280,"wires":[]},{"id":"d9f274ef.a78b28","type":"function","z":"7c9e2fef.b50e7","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TEKOS_BOT_TOKEN')\nmsg.payload={\n\n    \"body\": \"image.png\",\n    \"info\": {\n      \"size\": 6817,\n      \"mimetype\": \"image/png\",\n      \"thumbnail_info\": {\n        \"w\": 394,\n        \"h\": 75,\n        \"mimetype\": \"image/png\",\n        \"size\": 6950\n      },\n      \"w\": 394,\n      \"h\": 75,\n     // \"thumbnail_url\": \n    },\n    \"msgtype\": \"m.image\",\n    \"url\": env.get('MXC_URL')\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["c8ff8afd.5b0628"]]},{"id":"c8ff8afd.5b0628","type":"http request","z":"7c9e2fef.b50e7","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"27e0526e.b3693e","type":"link in","z":"85c6ed92.daf94","name":"","links":[],"x":168.3333282470703,"y":700,"wires":[["933646f8.c09d88"]]},{"id":"933646f8.c09d88","type":"chatbot-text","z":"85c6ed92.daf94","name":"","message":[{"message":"How would you like to name your bot ?"}],"x":293.3333282470703,"y":700,"wires":[["68b27db9.5fb444"]]},{"id":"68b27db9.5fb444","type":"link out","z":"85c6ed92.daf94","name":"","links":[],"x":428.3333282470703,"y":700,"wires":[]},{"id":"38dab587.850b7a","type":"http request","z":"85c6ed92.daf94","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":693.3333282470703,"y":820,"wires":[["f54dd37b.66f4e","dbbaeb52.1aac38","508c7aa2.31bdc4"]]},{"id":"b23eb7c4.fa70c8","type":"function","z":"85c6ed92.daf94","name":"","func":"\nvar password = Math.random().toString(36).substring(7);\nvar name = msg.payload\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/register?kind=user'\nmsg.payload = {\n    \"password\": password,\n    \"username\": name,\n    \"auth\": {\n        \"type\":\"m.login.dummy\"\n    }\n}\nmsg.roomId= msg.roomId || payload.roomId\n\nreturn msg;","outputs":1,"noerr":0,"x":503.3333282470703,"y":820,"wires":[["38dab587.850b7a"]]},{"id":"80067216.4463a","type":"link in","z":"85c6ed92.daf94","name":"","links":[],"x":368.3333282470703,"y":780,"wires":[["b23eb7c4.fa70c8"]]},{"id":"a0a69a68.02f298","type":"chatbot-text","z":"85c6ed92.daf94","name":"","message":[{"message":"Congratulations ! Your bot is successfully created !\nyou can chat with via this link https://chat.tekos.co/#/user/{{user_id}}\nYour user ID = {{user_id}}\nYour access token = {{access_token}}\n"}],"x":1083.3333282470703,"y":800,"wires":[["a5b719be.3748c8"]]},{"id":"a5b719be.3748c8","type":"link out","z":"85c6ed92.daf94","name":"","links":[],"x":1228.3333282470703,"y":820,"wires":[]},{"id":"ed54cfd0.9d488","type":"inject","z":"85c6ed92.daf94","name":"","topic":"","payload":"bottrack111","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":193.3333282470703,"y":820,"wires":[["b23eb7c4.fa70c8"]]},{"id":"f54dd37b.66f4e","type":"function","z":"85c6ed92.daf94","name":"","func":"const Analytics = global.get('analytics');\nconst client = new Analytics('vNnBOao9rVMYWaOt5KKwFP4zUoas9RPD');\n \nclient.track({\n  event: 'Create Bot',\n  userId: msg.payload.user_id\n});\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":893.3333282470703,"y":700,"wires":[[]]},{"id":"d8e9a382.087c9","type":"http request","z":"85c6ed92.daf94","name":"send message","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/messages","tls":"","proxy":"","authType":"basic","x":486.6666717529297,"y":506.6666717529297,"wires":[["4e072ef2.f99b8","697cbf81.22b7f"]]},{"id":"efcd4784.e275e8","type":"inject","z":"85c6ed92.daf94","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":156.6666717529297,"y":466.6666717529297,"wires":[["edb84c98.f731e"]]},{"id":"4e072ef2.f99b8","type":"debug","z":"85c6ed92.daf94","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":766.6666717529297,"y":486.6666717529297,"wires":[]},{"id":"edb84c98.f731e","type":"function","z":"85c6ed92.daf94","name":"","func":"msg.payload ={\n    text: \"hello\",\n    sender: \"user\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":296.6666717529297,"y":486.6666717529297,"wires":[["d8e9a382.087c9"]]},{"id":"4482bdcf.3699c4","type":"comment","z":"85c6ed92.daf94","name":"send message , get intent , next action","info":"","x":236.6666717529297,"y":426.6666717529297,"wires":[]},{"id":"697cbf81.22b7f","type":"http request","z":"85c6ed92.daf94","name":"predict next action","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/predict","tls":"","proxy":"","authType":"basic","x":706.6666717529297,"y":566.6666717529297,"wires":[["f94abda9.70074"]]},{"id":"f94abda9.70074","type":"debug","z":"85c6ed92.daf94","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":956.6666717529297,"y":566.6666717529297,"wires":[]},{"id":"72e52dc6.33ea64","type":"comment","z":"85c6ed92.daf94","name":"Predict next action ","info":"","x":706.6666717529297,"y":606.6666717529297,"wires":[]},{"id":"12449734.c44089","type":"comment","z":"85c6ed92.daf94","name":"Auth INFO + Docs","info":"http://3.121.211.150/talk\n\npassword: adminX\n\nDocumentation\nhttps://rasa.com/docs/rasa/api/http-api/#tag/Tracker/paths/~1conversations~1{conversation_id}~1execute/post","x":766.6666717529297,"y":426.6666717529297,"wires":[]},{"id":"a8b65590.870808","type":"link in","z":"85c6ed92.daf94","name":"","links":[],"x":181.6666717529297,"y":526.6666717529297,"wires":[[]]},{"id":"dbf7b4c2.2e5ea8","type":"function","z":"85c6ed92.daf94","name":"","func":"msg.payload ={\n    text: msg.payload,\n    sender: msg.senderId\n}\nreturn msg;","outputs":1,"noerr":0,"x":296.6666717529297,"y":526.6666717529297,"wires":[["d8e9a382.087c9"]]},{"id":"dbbaeb52.1aac38","type":"debug","z":"85c6ed92.daf94","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":953.3333282470703,"y":900,"wires":[]},{"id":"508c7aa2.31bdc4","type":"switch","z":"85c6ed92.daf94","name":"","property":"payload.errcode","propertyType":"msg","rules":[{"t":"eq","v":"M_USER_IN_USE","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":913.3333282470703,"y":780,"wires":[["a2ef5254.101d"],["a0a69a68.02f298"]]},{"id":"a2ef5254.101d","type":"chatbot-text","z":"85c6ed92.daf94","name":"bot exist","message":[{"message":"Bot name already taken!"}],"x":1083.3333282470703,"y":740,"wires":[["a5b719be.3748c8","c1dd2267.bb09f"]]},{"id":"c1dd2267.bb09f","type":"link out","z":"85c6ed92.daf94","name":"","links":[],"x":1228.3333282470703,"y":700,"wires":[]},{"id":"e8ec7717.d38098","type":"comment","z":"85c6ed92.daf94","name":"Under Test","info":"","x":141.66666666666666,"y":345.2777735392252,"wires":[]},{"id":"7935bea0.90c92","type":"http in","z":"b2a24cf1.c0661","name":"","url":"/zen","method":"post","upload":false,"swaggerDoc":"","x":200,"y":120,"wires":[["8275ae27.d5e91","b5f49f2c.9374d"]]},{"id":"8275ae27.d5e91","type":"debug","z":"b2a24cf1.c0661","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":410,"y":80,"wires":[]},{"id":"6d98892e.442fc8","type":"switch","z":"b2a24cf1.c0661","name":"","property":"payload.issue_event_type_name","propertyType":"msg","rules":[{"t":"eq","v":"issue_updated","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":570,"y":120,"wires":[["4e48b343.fd7e8c"],[]]},{"id":"4e48b343.fd7e8c","type":"chatbot-text","z":"b2a24cf1.c0661","name":"Update","message":[{"message":"The Jira {{issue.key}} was updated:\nhttps://tekos1.atlassian.net/browse/{{issue.key}}\n{{issue.fields.summary}} "}],"x":740,"y":100,"wires":[[]]},{"id":"b5f49f2c.9374d","type":"delay","z":"b2a24cf1.c0661","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":420,"y":120,"wires":[["6d98892e.442fc8"]],"info":"Optional"},{"id":"c317f271.942fe","type":"http request","z":"85c6ed92.daf94","name":"send message","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/messages","tls":"","proxy":"","authType":"basic","x":562.5144653320312,"y":1053.9901123046875,"wires":[["fedd2a8c.0b9bf8","1d7a71d.5f6038e"]]},{"id":"7bcfb81a.de0c48","type":"inject","z":"85c6ed92.daf94","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":182.51446533203125,"y":1053.9901123046875,"wires":[["65e16fc2.819e5"]]},{"id":"fedd2a8c.0b9bf8","type":"debug","z":"85c6ed92.daf94","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":812.5144653320312,"y":1053.9901123046875,"wires":[]},{"id":"65e16fc2.819e5","type":"function","z":"85c6ed92.daf94","name":"","func":"msg.payload ={\n    text: \"hello\",\n    sender: \"user\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":382.51446533203125,"y":1053.9901123046875,"wires":[["c317f271.942fe"]]},{"id":"ea0614e2.8a3238","type":"comment","z":"85c6ed92.daf94","name":"send message , get intent , next action","info":"","x":232.51446533203125,"y":993.9901123046875,"wires":[]},{"id":"1d7a71d.5f6038e","type":"http request","z":"85c6ed92.daf94","name":"predict next action","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/predict","tls":"","proxy":"","authType":"basic","x":432.51446533203125,"y":1233.9901123046875,"wires":[["ae2ff08c.4e3d4"]]},{"id":"ae2ff08c.4e3d4","type":"debug","z":"85c6ed92.daf94","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":742.5144653320312,"y":1233.9901123046875,"wires":[]},{"id":"30554340.2a31ac","type":"comment","z":"85c6ed92.daf94","name":"Predict next action ","info":"","x":272.51446533203125,"y":1153.9901123046875,"wires":[]},{"id":"a7cf4073.c3aaa","type":"comment","z":"85c6ed92.daf94","name":"Auth INFO + Docs","info":"http://3.121.211.150/talk\n\npassword: adminX\n\nDocumentation\nhttps://rasa.com/docs/rasa/api/http-api/#tag/Tracker/paths/~1conversations~1{conversation_id}~1execute/post","x":552.5144653320312,"y":993.9901123046875,"wires":[]},{"id":"1ce5f517.e2957b","type":"function","z":"b92299a8.9af4c8","name":"check roomId","func":"if(!msg.roomId) {\n    msg.roomId = msg.room;\n}\nreturn msg;","outputs":1,"noerr":0,"x":194.16669845581055,"y":215.00000095367432,"wires":[["2eb4b40b.9767cc"]]},{"id":"ced6eaec.292d48","type":"chatbot-text","z":"b92299a8.9af4c8","name":"Get Started","message":[{"message":"Hi, to get started, grant me permission to access your trello account."}],"x":524.1666984558105,"y":195.00000095367432,"wires":[["2721e1ea.fe0c8e","6e476944.fbc1e8"]]},{"id":"2721e1ea.fe0c8e","type":"delay","z":"b92299a8.9af4c8","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":714.1666984558105,"y":235.00000095367432,"wires":[["eb53ea05.5dd7f8"]]},{"id":"eb53ea05.5dd7f8","type":"chatbot-generic-card","z":"b92299a8.9af4c8","name":"Token card","title":"Grant Access","subtitle":"","imageUrl":"https://wpcurve.com/wp-content/uploads/2015/01/trello-feature1.png","sharable":true,"aspectRatio":"horizontal","buttons":[{"type":"url","label":"Grant Permissions","url":"https://trello.com/1/authorize?expiration=never&scope=read,write,account&name=Tekos%20Trello%20Bot&callback_method=postMessage&key=87c22e290db53e5ea47415f258ef4f45"}],"x":884.1666984558105,"y":235.00000095367432,"wires":[["49d7dad8.8a7e34","6f94bcd7.e4d784"]]},{"id":"6e476944.fbc1e8","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":780,"y":125.00000051222742,"wires":[]},{"id":"4c7a8993.9015f8","type":"link in","z":"b92299a8.9af4c8","name":"","links":["49d7dad8.8a7e34","6e476944.fbc1e8","19906c5d.d87da4","50178464.cc29cc","7298f905.c74768","c3b354b5.86d808"],"x":1025.0000505447388,"y":80,"wires":[[]]},{"id":"49d7dad8.8a7e34","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":989.1666984558105,"y":195.00000095367432,"wires":[]},{"id":"f5c1e9e0.e3aed8","type":"link out","z":"b92299a8.9af4c8","name":"","links":["3d018302.f2da7c"],"x":300,"y":85.00000051222742,"wires":[]},{"id":"3d018302.f2da7c","type":"link in","z":"b92299a8.9af4c8","name":"","links":["f5c1e9e0.e3aed8"],"x":69.16669845581055,"y":215.00000095367432,"wires":[["1ce5f517.e2957b"]]},{"id":"393f0be4.c4cbc4","type":"chatbot-generic-form","z":"b92299a8.9af4c8","name":"Trello Token","title":"Trello Token","subtitle":"","formId":"1","posturl":"https://miled.tekos.co/auth","action":"Enter","cancel":"Cancel","options":[{"label":"Your Token","value":"userToken","type":"text","list":"","required":true}],"formValue":{"userToken":""},"payload":"","topic":"","x":224.16669845581055,"y":335.0000009536743,"wires":[["19906c5d.d87da4"]]},{"id":"6f94bcd7.e4d784","type":"delay","z":"b92299a8.9af4c8","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1054.1666984558105,"y":235.00000095367432,"wires":[["5250a60a.a42438"]]},{"id":"5250a60a.a42438","type":"link out","z":"b92299a8.9af4c8","name":"","links":["65b9d6b1.95eb58"],"x":1175.000051498413,"y":229.16666793823242,"wires":[]},{"id":"65b9d6b1.95eb58","type":"link in","z":"b92299a8.9af4c8","name":"","links":["5250a60a.a42438"],"x":109.16669845581055,"y":335.0000009536743,"wires":[["393f0be4.c4cbc4"]]},{"id":"19906c5d.d87da4","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":329.16669845581055,"y":315.0000009536743,"wires":[]},{"id":"db3d634e.4e92","type":"http in","z":"b92299a8.9af4c8","name":"","url":"/auth","method":"post","upload":false,"swaggerDoc":"","x":434.16669845581055,"y":335.0000009536743,"wires":[["c73b3e0b.6565b","ca16b14f.6b7ab"]]},{"id":"c73b3e0b.6565b","type":"function","z":"b92299a8.9af4c8","name":"save token","func":"global.set(\"userToken\", msg.payload.userToken);\nreturn msg.payload;","outputs":1,"noerr":0,"x":624.1666984558105,"y":335.0000009536743,"wires":[["5f825e87.a8998"]]},{"id":"5f825e87.a8998","type":"chatbot-generic-form","z":"b92299a8.9af4c8","name":"Board Link","title":"Board Link","subtitle":"","formId":"2","posturl":"https://miled.tekos.co/board","action":"Save","cancel":"Cancel","options":[{"label":"Board Link","value":"boardUrl","type":"url","list":"","required":true}],"formValue":{"boardUrl":""},"payload":"","topic":"","x":844.1666984558105,"y":335.0000009536743,"wires":[["50178464.cc29cc"]]},{"id":"3d9bcb4b.083344","type":"http in","z":"b92299a8.9af4c8","name":"","url":"/board","method":"post","upload":false,"swaggerDoc":"","x":164.16669845581055,"y":455.0000009536743,"wires":[["acac006d.ae44e","a94b27a0.3a0068"]]},{"id":"50178464.cc29cc","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":1029.1666984558105,"y":295.0000009536743,"wires":[]},{"id":"ca16b14f.6b7ab","type":"http response","z":"b92299a8.9af4c8","name":"ok","statusCode":"200","headers":{},"x":484.16669845581055,"y":375.0000009536743,"wires":[]},{"id":"acac006d.ae44e","type":"http response","z":"b92299a8.9af4c8","name":"ok","statusCode":"200","headers":{},"x":264.16669845581055,"y":495.0000009536743,"wires":[]},{"id":"a94b27a0.3a0068","type":"function","z":"b92299a8.9af4c8","name":"save board","func":"global.set(\"boardUrl\", msg.payload.boardUrl);\nreturn msg.payload;","outputs":1,"noerr":0,"x":404.16669845581055,"y":455.0000009536743,"wires":[["594f56b9.f797c8"]]},{"id":"594f56b9.f797c8","type":"chatbot-generic-buttons","z":"b92299a8.9af4c8","name":"Actions","buttons":[{"type":"postback","label":"Add Cart","value":"Add Cart","alert":false}],"message":"choose an action","x":614.1666984558105,"y":455.0000009536743,"wires":[["7298f905.c74768"]]},{"id":"7298f905.c74768","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":729.1666984558105,"y":435.0000009536743,"wires":[]},{"id":"2eb4b40b.9767cc","type":"switch","z":"b92299a8.9af4c8","name":"","property":"messageContent","propertyType":"msg","rules":[{"t":"eq","v":"trello","vt":"str"},{"t":"eq","v":"Add Cart","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":364.16669845581055,"y":215.00000095367432,"wires":[["ced6eaec.292d48"],["e2de0f7e.01fac"]]},{"id":"e2de0f7e.01fac","type":"link out","z":"b92299a8.9af4c8","name":"","links":["ce9fe006.1bdb1"],"x":469.16669845581055,"y":255.00000095367432,"wires":[]},{"id":"ce9fe006.1bdb1","type":"link in","z":"b92299a8.9af4c8","name":"","links":["e2de0f7e.01fac"],"x":129.16669845581055,"y":595.0000009536743,"wires":[["7b434eae.8a2c3"]]},{"id":"7b434eae.8a2c3","type":"chatbot-generic-form","z":"b92299a8.9af4c8","name":"Card Content","title":"","subtitle":"","formId":"3","posturl":"https://miled.tekos.co/addCart","action":"Enter","cancel":"Cancel","options":[{"label":"Card content","value":"cardContent","type":"text","list":"","required":true}],"formValue":{"cardContent":""},"payload":"","topic":"","x":274.16669845581055,"y":595.0000009536743,"wires":[["476e7904.29ff28","c3b354b5.86d808"]]},{"id":"470381e6.77e7f","type":"http in","z":"b92299a8.9af4c8","name":"","url":"/addCart","method":"post","upload":false,"swaggerDoc":"","x":514.1666984558105,"y":595.0000009536743,"wires":[["e0bc3dba.191d4","de7824b9.b774a8"]]},{"id":"e0bc3dba.191d4","type":"http response","z":"b92299a8.9af4c8","name":"ok","statusCode":"200","headers":{},"x":604.1666984558105,"y":675.0000009536743,"wires":[]},{"id":"476e7904.29ff28","type":"debug","z":"b92299a8.9af4c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":384.16669845581055,"y":655.0000009536743,"wires":[]},{"id":"de7824b9.b774a8","type":"function","z":"b92299a8.9af4c8","name":"","func":"console.warn('something wierd is happening')\nreturn msg;","outputs":1,"noerr":0,"x":724.1666984558105,"y":595.0000009536743,"wires":[[]]},{"id":"c3b354b5.86d808","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":389.16669845581055,"y":535.0000009536743,"wires":[]},{"id":"e6a051f6.efbe","type":"comment","z":"b92299a8.9af4c8","name":"Lik to Tekos out","info":"","x":1102.5116271972656,"y":27.294567108154297,"wires":[]},{"id":"fa77cbbe.cf40c8","type":"comment","z":"b92299a8.9af4c8","name":"Libk to Tekos In","info":"","x":227.51735687255857,"y":37.29167302449544,"wires":[]},{"id":"b18a595b.0a1028","type":"http in","z":"8a95edf0.1b4f","name":"","url":"/bitbucket","method":"post","upload":false,"swaggerDoc":"","x":250,"y":260,"wires":[["1914e0a6.b99a3f","8e76b4a6.56b978"]]},{"id":"1914e0a6.b99a3f","type":"debug","z":"8a95edf0.1b4f","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":400,"y":220,"wires":[]},{"id":"d8c146e0.e69558","type":"comment","z":"8a95edf0.1b4f","name":"Attention, Changer le lien webhook vers le flow - Webhook links","info":"https://tekos1.atlassian.net/plugins/servlet/webhooks","x":380,"y":360,"wires":[]},{"id":"b623f4f0.3640e8","type":"switch","z":"8a95edf0.1b4f","name":"","property":"payload.issue_event_type_name","propertyType":"msg","rules":[{"t":"eq","v":"issue_updated","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":560,"y":260,"wires":[["6aa7b609.1fbef8"],[]]},{"id":"6aa7b609.1fbef8","type":"chatbot-text","z":"8a95edf0.1b4f","name":"Update","message":[{"message":"The Jira {{issue.key}} was updated:\nhttps://tekos1.atlassian.net/browse/{{issue.key}}\n{{issue.fields.summary}} "}],"x":730,"y":240,"wires":[["4274a848.450288"]]},{"id":"8e76b4a6.56b978","type":"delay","z":"8a95edf0.1b4f","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":410,"y":260,"wires":[["b623f4f0.3640e8"]],"info":"Optional"},{"id":"b46cb4a1.c71bc8","type":"switch","z":"8a95edf0.1b4f","name":"","property":"messageContent","propertyType":"msg","rules":[{"t":"eq","v":"config","vt":"str"}],"checkall":"true","repair":true,"outputs":1,"x":380,"y":120,"wires":[["5dae1ed0.0a59b"]]},{"id":"5dae1ed0.0a59b","type":"chatbot-text","z":"8a95edf0.1b4f","name":"","message":[{"message":"Ok, Voici le lien webhook Ã  paramÃ©trer pour ce channel:\nhttps://slim.tekosflow.xyz/bibucket"}],"x":580,"y":120,"wires":[["4274a848.450288"]]},{"id":"9dbe7ce9.5b866","type":"debug","z":"8a95edf0.1b4f","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":700,"y":400,"wires":[]},{"id":"d89dee31.433a8","type":"http response","z":"8a95edf0.1b4f","name":"","x":620,"y":480,"wires":[]},{"id":"7e02dc76.c4d534","type":"template","z":"8a95edf0.1b4f","name":"page","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head></head>\n    <body>\n        <h1>Hello {{req.params.token}}!</h1>\n    </body>\n</html>","x":460,"y":480,"wires":[["d89dee31.433a8","9dbe7ce9.5b866"]]},{"id":"1fb5ff73.3586c1","type":"http in","z":"8a95edf0.1b4f","name":"","url":"/bitbuckethook/:token","method":"post","upload":false,"swaggerDoc":"","x":280,"y":480,"wires":[["7e02dc76.c4d534"]]},{"id":"4274a848.450288","type":"link out","z":"8a95edf0.1b4f","name":"","links":[],"x":865,"y":140,"wires":[]},{"id":"7854b84b.b32e58","type":"link in","z":"8a95edf0.1b4f","name":"","links":[],"x":265,"y":120,"wires":[["b46cb4a1.c71bc8"]]},{"id":"60b060b5.c02b","type":"comment","z":"8a95edf0.1b4f","name":"tekos In","info":"","x":200,"y":80,"wires":[]},{"id":"cc92d1a9.1f77a","type":"comment","z":"8a95edf0.1b4f","name":"tekos out","info":"","x":950,"y":120,"wires":[]},{"id":"9f81da67.a6f8d8","type":"http in","z":"aab9f259.38912","name":"","url":"/jira","method":"post","upload":false,"swaggerDoc":"","x":210,"y":260,"wires":[["ccd2793f.b5e438","2ad436e.d01a1ca"]]},{"id":"ccd2793f.b5e438","type":"debug","z":"aab9f259.38912","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":380,"y":220,"wires":[]},{"id":"e455536e.295e","type":"comment","z":"aab9f259.38912","name":"Attention, Changer le lien webhook vers le flow - Webhook links","info":"https://tekos1.atlassian.net/plugins/servlet/webhooks","x":360,"y":360,"wires":[]},{"id":"127d5c76.e24754","type":"switch","z":"aab9f259.38912","name":"","property":"payload.issue_event_type_name","propertyType":"msg","rules":[{"t":"eq","v":"issue_updated","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":540,"y":260,"wires":[["a63926a0.7c6c28"],[]]},{"id":"a63926a0.7c6c28","type":"chatbot-text","z":"aab9f259.38912","name":"Update","message":[{"message":"The Jira {{issue.key}} was updated:\nhttps://tekos1.atlassian.net/browse/{{issue.key}}\n{{issue.fields.summary}} "}],"x":710,"y":240,"wires":[["5fc7802f.69c84"]]},{"id":"2ad436e.d01a1ca","type":"delay","z":"aab9f259.38912","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":390,"y":260,"wires":[["127d5c76.e24754"]],"info":"Optional"},{"id":"35854f22.ed6bf","type":"switch","z":"aab9f259.38912","name":"","property":"messageContent","propertyType":"msg","rules":[{"t":"eq","v":"config","vt":"str"}],"checkall":"true","repair":true,"outputs":1,"x":360,"y":120,"wires":[["33b2a579.86cc8a"]]},{"id":"766ad083.0f23d","type":"debug","z":"aab9f259.38912","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":700,"y":80,"wires":[]},{"id":"ca55c913.aa98e8","type":"chatbot-text","z":"aab9f259.38912","name":"","message":[{"message":"Ok, Voici le lien webhook Ã  paramÃ©trer pour ce channel:\nhttps://slim.tekosflow.xyz/hook?id={{token}}"}],"x":680,"y":120,"wires":[["e2b93c8b.91d6","5fc7802f.69c84"]]},{"id":"6d56e1a3.65f55","type":"link in","z":"aab9f259.38912","name":"","links":["e2b93c8b.91d6"],"x":770,"y":200,"wires":[[]]},{"id":"e2b93c8b.91d6","type":"link out","z":"aab9f259.38912","name":"","links":["6d56e1a3.65f55"],"x":765,"y":120,"wires":[]},{"id":"33b2a579.86cc8a","type":"function","z":"aab9f259.38912","name":"","func":"var token = Math.random().toString(8).substring(7);\n\nmsg.payload ={\n    \"token\": token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":120,"wires":[["ca55c913.aa98e8","766ad083.0f23d"]]},{"id":"7f93435d.b1d0fc","type":"debug","z":"aab9f259.38912","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":700,"y":420,"wires":[]},{"id":"e1846f5b.69da7","type":"http response","z":"aab9f259.38912","name":"","x":620,"y":500,"wires":[]},{"id":"ef367ee2.53052","type":"template","z":"aab9f259.38912","name":"page","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head></head>\n    <body>\n        <h1>Hello {{req.params.token}}!</h1>\n    </body>\n</html>","x":460,"y":500,"wires":[["e1846f5b.69da7","7f93435d.b1d0fc"]]},{"id":"a7951d52.a681f","type":"http in","z":"aab9f259.38912","name":"","url":"/hook/:token","method":"post","upload":false,"swaggerDoc":"","x":260,"y":500,"wires":[["ef367ee2.53052"]]},{"id":"5fc7802f.69c84","type":"link out","z":"aab9f259.38912","name":"","links":[],"x":970,"y":180,"wires":[]},{"id":"2ce74daa.3e7282","type":"link in","z":"aab9f259.38912","name":"","links":[],"x":205,"y":120,"wires":[["35854f22.ed6bf"]]},{"id":"bd10f19c.a2fa1","type":"comment","z":"aab9f259.38912","name":"tekos in","info":"","x":200,"y":180,"wires":[]},{"id":"7bbefbd5.165f64","type":"comment","z":"aab9f259.38912","name":"tekos out","info":"","x":1070,"y":180,"wires":[]},{"id":"8485bc84.d3254","type":"link out","z":"3ac7a168.cf0ebe","name":"","links":["8687dd17.eaedc"],"x":375,"y":140,"wires":[]},{"id":"967b6ed2.ea31","type":"link in","z":"3ac7a168.cf0ebe","name":"out","links":["1d6177b3.d549f8","ece22c8f.bf83f","208cf665.c3cdda","2fffd477.8e66fc","45ba6a77.b2f5d4","d84c4b18.1c6308"],"x":1015,"y":80,"wires":[[]]},{"id":"208cf665.c3cdda","type":"link out","z":"3ac7a168.cf0ebe","name":"","links":["967b6ed2.ea31"],"x":315,"y":340,"wires":[]},{"id":"2db39737.5af648","type":"switch","z":"3ac7a168.cf0ebe","name":"Rooter","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"latest","vt":"str"},{"t":"eq","v":"similar","vt":"str"},{"t":"eq","v":"search","vt":"str"},{"t":"eq","v":"file storage","vt":"str"},{"t":"eq","v":"expressive tts","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":6,"x":210,"y":220,"wires":[["8485bc84.d3254"],["4888dedd.2e673"],["d7c0bd68.cab24"],["a4f0c385.ff368"],[],[]]},{"id":"8687dd17.eaedc","type":"link in","z":"3ac7a168.cf0ebe","name":"","links":["8485bc84.d3254"],"x":575,"y":300,"wires":[["28fa6c86.1655b4"]]},{"id":"ece22c8f.bf83f","type":"link out","z":"3ac7a168.cf0ebe","name":"","links":["967b6ed2.ea31"],"x":895,"y":300,"wires":[]},{"id":"28fa6c86.1655b4","type":"chatbot-text","z":"3ac7a168.cf0ebe","name":"Lastest Movies","message":[{"message":"Here are the lastest movies ðŸ˜Š"}],"x":760,"y":320,"wires":[["ece22c8f.bf83f","fcde7e2b.9f8b","467c933a.204bdc"]]},{"id":"1d6177b3.d549f8","type":"link out","z":"3ac7a168.cf0ebe","name":"","links":["967b6ed2.ea31"],"x":1475,"y":360,"wires":[]},{"id":"c7aeede4.a4294","type":"comment","z":"3ac7a168.cf0ebe","name":"Smileys","info":"https://getemoji.com/","x":610,"y":260,"wires":[]},{"id":"467c933a.204bdc","type":"http request","z":"3ac7a168.cf0ebe","name":"TheMovieDB","method":"GET","ret":"obj","url":"https://api.themoviedb.org/3/movie/upcoming?api_key=e056ad6e7bd5444e2989d545d37a7003&language=en-US&page=1","tls":"","x":1030,"y":320,"wires":[["16ead02.77b793","e87e935e.f09f4","fcde7e2b.9f8b"]]},{"id":"16ead02.77b793","type":"debug","z":"3ac7a168.cf0ebe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1250,"y":300,"wires":[]},{"id":"e87e935e.f09f4","type":"function","z":"3ac7a168.cf0ebe","name":"template api","func":"var elementsY=[];\nfor (var i = 0; i < 10; i++) {\n       let movie = msg.payload.results[i];\n       elementsY.push( {\n                                  \"title\": movie.title,\n                                  \"subtitle\": movie.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + movie.backdrop_path,\n                          })\n    }\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":1290,"y":340,"wires":[["1d6177b3.d549f8"]]},{"id":"fcde7e2b.9f8b","type":"http request","z":"3ac7a168.cf0ebe","name":"Get Movie Details","method":"GET","ret":"obj","url":"https://api.themoviedb.org/3/movie/375588?api_key=e056ad6e7bd5444e2989d545d37a7003&language=en-US","tls":"","x":1010,"y":500,"wires":[["f6b4dd85.a1c9","658bcf6d.ee8d8"]]},{"id":"2fffd477.8e66fc","type":"link out","z":"3ac7a168.cf0ebe","name":"","links":["967b6ed2.ea31"],"x":1332.0056419372559,"y":494.46016216278076,"wires":[]},{"id":"658bcf6d.ee8d8","type":"function","z":"3ac7a168.cf0ebe","name":"Movie Card","func":"var elementsY=[];\n       elementsY.push( {\n                                  \"title\": msg.payload.original_title,\n                                  \"subtitle\": msg.payload.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + msg.payload.poster_path,\n\n                          })\n\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":1210.0056610107422,"y":494.46020698547363,"wires":[["2fffd477.8e66fc"]]},{"id":"51f33637.bc1cd8","type":"inject","z":"3ac7a168.cf0ebe","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":800,"y":500,"wires":[["fcde7e2b.9f8b"]]},{"id":"f6b4dd85.a1c9","type":"debug","z":"3ac7a168.cf0ebe","name":"movie details","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","x":1208.0055923461914,"y":551.4601936340332,"wires":[]},{"id":"89af5e5e.481d8","type":"comment","z":"3ac7a168.cf0ebe","name":"Get similar movies","info":"https://developers.themoviedb.org/3","x":690,"y":600,"wires":[]},{"id":"1dcfd2c6.8b0d8d","type":"inject","z":"3ac7a168.cf0ebe","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":744.4965209960938,"y":691.2152328491211,"wires":[["6309dfef.6f28a"]]},{"id":"6309dfef.6f28a","type":"http request","z":"3ac7a168.cf0ebe","name":"Get Similar Movies","method":"GET","ret":"obj","url":"https://api.themoviedb.org/3/movie/375588/similar?api_key=e056ad6e7bd5444e2989d545d37a7003&language=en-US&page=1","tls":"","x":974.4964752197266,"y":672.1299848556519,"wires":[["b0b07c1a.26d42","685fe268.2e77fc"]]},{"id":"45ba6a77.b2f5d4","type":"link out","z":"3ac7a168.cf0ebe","name":"","links":["967b6ed2.ea31"],"x":1315.999340057373,"y":669.3629179000854,"wires":[]},{"id":"4888dedd.2e673","type":"link out","z":"3ac7a168.cf0ebe","name":"","links":["dbffc1ad.bee75"],"x":375,"y":180,"wires":[]},{"id":"dbffc1ad.bee75","type":"link in","z":"3ac7a168.cf0ebe","name":"","links":["4888dedd.2e673"],"x":828.4861507415771,"y":645.7708578109741,"wires":[["6309dfef.6f28a"]]},{"id":"b0b07c1a.26d42","type":"debug","z":"3ac7a168.cf0ebe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1204.993064880371,"y":725.5728950500488,"wires":[]},{"id":"685fe268.2e77fc","type":"function","z":"3ac7a168.cf0ebe","name":"template api","func":"var elementsY=[];\nfor (var i = 0; i < 10; i++) {\n       let movie = msg.payload.results[i];\n       elementsY.push( {\n                                  \"title\": movie.original_title,\n                                  \"subtitle\": movie.overview,\n                                  \"imageUrl\": \"http://image.tmdb.org/t/p/w185//\" + movie.backdrop_path,\n                          })\n    }\n\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":1192.4965896606445,"y":659.7708559036255,"wires":[["45ba6a77.b2f5d4"]]},{"id":"52372316.5f6adc","type":"comment","z":"3ac7a168.cf0ebe","name":"Search movie","info":"https://developers.themoviedb.org/3","x":690,"y":860,"wires":[]},{"id":"1811678.d213299","type":"http request","z":"3ac7a168.cf0ebe","name":"Get Similar Movies","method":"GET","ret":"obj","url":"https://api.themoviedb.org/3/search/movie?api_key=e056ad6e7bd5444e2989d545d37a7003&language=en-US&query={{payload.text}}&page=1&include_adult=false","tls":"","x":890,"y":940,"wires":[["43ea7a06.f4cde4","207bcf32.53a68"]]},{"id":"d84c4b18.1c6308","type":"link out","z":"3ac7a168.cf0ebe","name":"","links":["967b6ed2.ea31"],"x":1144.5028648376465,"y":992.232855796814,"wires":[]},{"id":"608dc973.2163b8","type":"link in","z":"3ac7a168.cf0ebe","name":"search","links":["d7c0bd68.cab24"],"x":795,"y":860,"wires":[["f8b5acd9.458d7"]]},{"id":"207bcf32.53a68","type":"debug","z":"3ac7a168.cf0ebe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":923.4966430664062,"y":1048.4429321289062,"wires":[]},{"id":"43ea7a06.f4cde4","type":"function","z":"3ac7a168.cf0ebe","name":"template api","func":"var elementsY=[];\nif(msg.payload.results && msg.payload.results.length > 0){\n    for (var i = 0; i < msg.payload.results.length; i++) {\n       let movie = msg.payload.results[i];\n       elementsY.push( {\n                                  \"title\": movie.original_title,\n                                  \"subtitle\": movie.overview,\n                                  \"imageUrl\": movie.backdrop_path ? (\"http://image.tmdb.org/t/p/w185//\" + movie.backdrop_path) : null,\n                          })\n    }\n\n    \n    //msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\n    msg.payload = {\n                    \"type\": \"generic-template\",\n                    \"elements\": elementsY\n    \n    };    \n}else{\n    msg.payload = {\n        type: \"message\",\n        content: \"Sorry, Can't find any movie with that keyword\"\n    }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1109.0001373291016,"y":934.6407747268677,"wires":[["d84c4b18.1c6308"]]},{"id":"d7c0bd68.cab24","type":"link out","z":"3ac7a168.cf0ebe","name":"","links":["608dc973.2163b8"],"x":375,"y":220,"wires":[]},{"id":"f8b5acd9.458d7","type":"chatbot-text","z":"3ac7a168.cf0ebe","name":"keywod","message":[{"message":"please type a keyword"}],"x":910.5000305175781,"y":857.0694046020508,"wires":[["d4129ce8.8b6df"]]},{"id":"5655e6f2.eb6b98","type":"function","z":"3ac7a168.cf0ebe","name":"change this","func":"let messages = []\nfor (var i = 0; i < 1; i++) {\n    messages.push({\n        type: \"message\",\n        content: \"hello from inject 2. \"+i\n    })\n}\nmsg.payload = messages\n//msg.uid=\"1542813936173zd73vtlvx1j\"\n//msg.uid=\"1539883530157inszmh4yc3s\"\n// miled\n//msg.uid=\"15437007527274rcvkkl56ft\"\n//msg.uid=\"1542114121685ljgd3w4w4ye\"\nmsg.uid=\"1539884393820qkkd19cligp\"\n\nreturn msg;","outputs":1,"noerr":0,"x":810,"y":180,"wires":[["b2307fed.1f601"]]},{"id":"120d737a.c8ceed","type":"inject","z":"3ac7a168.cf0ebe","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":660,"y":180,"wires":[["5655e6f2.eb6b98"]]},{"id":"b2307fed.1f601","type":"split","z":"3ac7a168.cf0ebe","name":"","splt":"\\n","spltType":"str","arraySplt":1,"arraySpltType":"len","stream":false,"addname":"","x":990,"y":180,"wires":[[]]},{"id":"d4129ce8.8b6df","type":"debug","z":"3ac7a168.cf0ebe","name":"","active":false,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1050,"y":800,"wires":[]},{"id":"a4f0c385.ff368","type":"link out","z":"3ac7a168.cf0ebe","name":"tts","links":[],"x":375,"y":260,"wires":[]},{"id":"99dba1d2.d9b22","type":"link in","z":"3ac7a168.cf0ebe","name":"","links":[],"x":239.00390625,"y":2073.25390625,"wires":[["e0c3ba82.0e9908"]]},{"id":"7085649b.ebab8c","type":"http request","z":"3ac7a168.cf0ebe","name":"","method":"GET","ret":"txt","url":"","x":728.0078287124634,"y":2069.1406211853027,"wires":[[]]},{"id":"5b613d65.23b7f4","type":"comment","z":"3ac7a168.cf0ebe","name":"https://console.bluemix.net/docs/services/text-to-speech/SSML-expressive.html","info":"","x":678.003903388977,"y":2226.210931777954,"wires":[]},{"id":"fb5579a1.6715f8","type":"function","z":"3ac7a168.cf0ebe","name":"headers","func":"msg.headers = {\n//Authorization': 'simv0j6KECRZpSo07b59RHRabjb1',\n//    'Content-Type': 'application/json'\n}\nmsg.payload = {\n//    \"image\": \"https://images.fineartamerica.com/images/artworkimages/mediumlarge/1/three-sunflowers-still-life-in-black-and-white-garry-gay.jpg\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":543.5117082595825,"y":2068.519525527954,"wires":[["7085649b.ebab8c"]]},{"id":"e0c3ba82.0e9908","type":"chatbot-text","z":"3ac7a168.cf0ebe","name":"Good news","message":[{"message":"I have good news: I was able to reduce the payments on your monthly bill!"}],"x":392.00390338897705,"y":2069.457021713257,"wires":[["fb5579a1.6715f8"]]},{"id":"4c7a56b0.8cb698","type":"comment","z":"3ac7a168.cf0ebe","name":"<express-as type=\"GoodNews\">   I have good news: I was able to reduce the payments on your monthly bill! </express-as>","info":"","x":864.011715888977,"y":2185.2109298706055,"wires":[]},{"id":"c6109ed5.8c38c","type":"comment","z":"3ac7a168.cf0ebe","name":"Expressive TTS","info":"","x":366.99999713897705,"y":1991.2265548706055,"wires":[]},{"id":"75757dfe.ca6b84","type":"chatbot-generic-buttons","z":"3ac7a168.cf0ebe","name":"","buttons":[{"type":"postback","label":"Lastest Movies","value":"latest","alert":false},{"type":"postback","label":"Similar Movies","value":"similar","alert":false},{"type":"postback","label":"search for a movie","value":"search","alert":false}],"message":"I'm TekosBot, i'm here to help you. Choose an option !","x":200,"y":340,"wires":[["208cf665.c3cdda"]]},{"id":"a92ee034.ed868","type":"http request","z":"726321c4.c8126","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":508.9965515136719,"y":190.93053436279297,"wires":[[]]},{"id":"82f8f6bd.c311e8","type":"function","z":"726321c4.c8126","name":"","func":"msg.url = env.get('ERP_BASE_URL')+ '/api/resource/Lead'\nmsg.payload={\n  \"lead_name\": env.get('Lead_Name')\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":325.00001525878906,"y":200.99999618530273,"wires":[["a92ee034.ed868"]]},{"id":"4cc292ce.dc607c","type":"http request","z":"fb951c08.dec1a","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":389.9965362548828,"y":90.00000381469727,"wires":[[]]},{"id":"89bc5a8f.82f788","type":"function","z":"fb951c08.dec1a","name":"","func":"msg.url = env.get('ERP_BASE_URL')+ '/api/method/login?usr='+env.get('LOGIN') + '&pwd='+env.get('PASSWORD')\n\nmsg.headers ={\n//    \"Authorization\" : \"Bearer \" +env.get(\"token\"),\n    \"Content-type\": \"application/json\",\n    \"Accept\": \"application/json\"\n\n}\n\nmsg.payload={\n\n//  \"lead_name\": env.get('Lead_Name')\n\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":90.06946182250977,"wires":[["4cc292ce.dc607c"]]},{"id":"bf76def4.51717","type":"http in","z":"d100d95f.692618","name":"Cancel request ?","url":"/cancel/request/:planId","method":"post","upload":false,"swaggerDoc":"","x":170,"y":775.3333377838135,"wires":[["9dace557.2f47d8","300b0226.72468e","9a10e86f.d4a298"]]},{"id":"9dace557.2f47d8","type":"http response","z":"d100d95f.692618","name":"OK","statusCode":"200","headers":{},"x":450,"y":789.0000247955322,"wires":[]},{"id":"300b0226.72468e","type":"link out","z":"d100d95f.692618","name":"","links":["38fa2813.1394b8"],"x":453,"y":744.0000247955322,"wires":[]},{"id":"9a10e86f.d4a298","type":"debug","z":"d100d95f.692618","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":359,"y":842.3333129882812,"wires":[]},{"id":"29a6cb08.5141f4","type":"function","z":"b3e3278d.3ca678","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"the customer \"+msg.subscription.customer+\" had canceled his subscription \"+msg.subscription.id,\n    to:\"ayoub@tekos.co,support@tekos.co\"\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":172.00001525878906,"y":164.66667366027832,"wires":[[]]},{"id":"a5ece02d.0f484","type":"template","z":"b3e3278d.3ca678","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n    <h3>Tekos Flow Subscription Canceled</h3>\n    <p>\n      reason for cancel request : {{{payload.why}}}\n    </p>\n</body>","x":389,"y":106.66666412353516,"wires":[["29a6cb08.5141f4"]]},{"id":"9482d631.fcf348","type":"template","z":"b3e3278d.3ca678","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":249,"y":106.66666412353516,"wires":[["a5ece02d.0f484"]]},{"id":"367bb60e.f4b54a","type":"function","z":"b3e3278d.3ca678","name":"send mail","func":"msg.subscription = msg.payload;\nmsg.payload.why = msg.why\nreturn msg;","outputs":1,"noerr":0,"x":119,"y":106.66666412353516,"wires":[["9482d631.fcf348"]]},{"id":"7951f7b7.d83bf8","type":"function","z":"f05d1061.cd31d","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/profile/' + env.get('BOT')+ '/displayname?access_token='+ env.get('TOKEN')\n\n//Header\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n\n//Body\nmsg.payload={\n\n  \"displayname\": env.get('NAME')\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":81.05899620056152,"wires":[["52800a3c.025804"]]},{"id":"52800a3c.025804","type":"http request","z":"f05d1061.cd31d","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"authType":"","x":438,"y":80,"wires":[[]]},{"id":"c2339fd4.02bba","type":"function","z":"989c64eb.c70dc8","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://connect.stripe.com/oauth/token'\n\n//Header\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n\n//Body\nmsg.payload={\n\n\t\"code\" : env.get('CODE'),\n\t\"grant_type\" : \"authorization_code\"\n\t\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":81.05899620056152,"wires":[["465ad5ae.8bb57c"]]},{"id":"465ad5ae.8bb57c","type":"http request","z":"989c64eb.c70dc8","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":438,"y":80,"wires":[[]]},{"id":"54603ba0.be07b4","type":"chatbot-generic-buttons","z":"64469bd7.645c44","name":"get the code","buttons":[{"type":"url","label":"Connect with Stripe","url":"https://dashboard.stripe.com/oauth/authorize?response_type=code&client_id=ca_DJ4VOxec7Iu4aNxihrBJfdXObW7SQKmj&scope=read_write"}],"message":"To connect your Stripe Account, please follow this link and copy the Code recieved in the form below","x":418.6771059036255,"y":111.85775470733643,"wires":[["740a5acc.ed7134","bec3a53d.94e548"]]},{"id":"740a5acc.ed7134","type":"chatbot-generic-form","z":"64469bd7.645c44","name":"Fill here the received Code","title":"","subtitle":"","formId":"stripe-connect","posturl":"https://ami.tekos.co/stripe-connect","action":"Submit","cancel":"Cancel","options":[{"label":"Code","value":"stripe_code","maxLength":"","type":"text","list":"","required":true}],"formValue":{"stripe_code":""},"payload":"","topic":"","x":668.6701326370239,"y":112.78832626342773,"wires":[["c7cd15ab.6c6a28"]]},{"id":"bec3a53d.94e548","type":"link out","z":"64469bd7.645c44","name":"","links":["2c8a55b8.eeddfa"],"x":557.9999828338623,"y":66.00000381469727,"wires":[]},{"id":"55bfe93f.972718","type":"http in","z":"64469bd7.645c44","name":"","url":"/stripe-connect","method":"post","upload":false,"swaggerDoc":"","x":344.996470451355,"y":190.86139392852783,"wires":[["c3fb1012.ad39d","366493ac.a9492c","73f4c0f0.119a3"]]},{"id":"4ba44942.653d88","type":"chatbot-text","z":"64469bd7.645c44","name":"","message":[{"message":"Great! Your account is connected.\nHere Are your stripe credentials to your use as Envrionment Variables or as variables in your Flow instance:"}],"x":958.0069570541382,"y":192.94820976257324,"wires":[["bc16df5f.b1d71","4c914698.c88e88"]]},{"id":"808afd3d.a219b","type":"function","z":"4456c207.c3886c","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/lists/all/contacts/all?hapikey=\"+env.get('hubspot_api_key');\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":227,"wires":[["dc0d5e2e.6b126"]]},{"id":"dc0d5e2e.6b126","type":"http request","z":"4456c207.c3886c","name":"Get All Contacts","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":373.6666717529297,"y":227,"wires":[["d6892411.3a0e48"]]},{"id":"25d7a2f3.7a877e","type":"link out","z":"4456c207.c3886c","name":"","links":["e880da22.cc3358"],"x":468.6666717529297,"y":47,"wires":[]},{"id":"e880da22.cc3358","type":"link in","z":"4456c207.c3886c","name":"","links":["25d7a2f3.7a877e"],"x":128.6666717529297,"y":227,"wires":[["808afd3d.a219b"]]},{"id":"bf6d20e4.b5102","type":"link out","z":"4456c207.c3886c","name":"","links":["a9e716c3.2ea158"],"x":468.6666717529297,"y":127,"wires":[]},{"id":"77e61640.9fa898","type":"function","z":"4456c207.c3886c","name":"NULL","func":"msg.payload = \"No such action\";\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":287,"wires":[["d6892411.3a0e48"]]},{"id":"a9e716c3.2ea158","type":"link in","z":"4456c207.c3886c","name":"","links":["bf6d20e4.b5102"],"x":128.6666717529297,"y":287,"wires":[["77e61640.9fa898"]]},{"id":"d6892411.3a0e48","type":"debug","z":"4456c207.c3886c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":603.6666717529297,"y":287,"wires":[]},{"id":"78abb210.12d2fc","type":"function","z":"4456c207.c3886c","name":"switch","func":"var action = env.get(\"action\");\nif(action === \"all\"){\n    return[msg,null,null,null,null];\n}else if(action ===\"contact_email\"){\n    msg.email = \"ayoub@tekos.co\";\n    return[null,msg,null,null,null];\n}else if(action ===\"create_contact\"){\n    return[null,null,msg,null,null];\n}else if(action ===\"update_contact\"){\n    msg.email = \"ayoub@tekos.co\";\n    return[null,null,null,msg,null];\n}\nelse{\n    return[null,null,null,null,msg];\n}\n","outputs":5,"noerr":0,"x":263.6666717529297,"y":47,"wires":[["25d7a2f3.7a877e"],["e3dc86fd.641a28"],["81d674d5.497168"],["1f59fdbc.d4a132"],["bf6d20e4.b5102"]],"inputLabels":["env.get(\"action\")"],"outputLabels":["action","","","",""],"icon":"node-red/switch.png"},{"id":"4ff807c4.659598","type":"http request","z":"4456c207.c3886c","name":"Get Contact by Email","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":393.6666717529297,"y":347,"wires":[["d6892411.3a0e48"]]},{"id":"74dbca87.9bee14","type":"function","z":"4456c207.c3886c","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+msg.email+\"/profile?hapikey=\"+env.get('hubspot_api_key');\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":347,"wires":[["4ff807c4.659598"]]},{"id":"e9a4f9a5.24add8","type":"link in","z":"4456c207.c3886c","name":"","links":["e3dc86fd.641a28"],"x":128.6666717529297,"y":347,"wires":[["74dbca87.9bee14"]]},{"id":"e3dc86fd.641a28","type":"link out","z":"4456c207.c3886c","name":"","links":["e9a4f9a5.24add8"],"x":408.6666717529297,"y":47,"wires":[]},{"id":"c0652f94.7a466","type":"http request","z":"4456c207.c3886c","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":403.6666717529297,"y":407,"wires":[["d6892411.3a0e48"]]},{"id":"6637528b.b79cbc","type":"function","z":"4456c207.c3886c","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nvar dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": \"yamebixos@dmail1.net\"\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": \"yamebixos\"\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": \"Mott\"\n    },\n    {\n      \"property\": \"website\",\n      \"value\": \"http://hubspot.com\"\n    },\n    {\n      \"property\": \"company\",\n      \"value\": \"HubSpot\"\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": \"555-122-2323\"\n    },\n    {\n      \"property\": \"address\",\n      \"value\": \"25 First Street\"\n    },\n    {\n      \"property\": \"city\",\n      \"value\": \"Cambridge\"\n    },\n    {\n      \"property\": \"state\",\n      \"value\": \"MA\"\n    },\n    {\n      \"property\": \"zip\",\n      \"value\": \"02139\"\n    },\n     {\n      \"property\": \"cin\",\n      \"value\": \"https://kw.ambafrance.org/IMG/arton2779.jpg?1546892557\"\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":407,"wires":[["c0652f94.7a466"]]},{"id":"8d84f058.2038","type":"link in","z":"4456c207.c3886c","name":"","links":["81d674d5.497168"],"x":128.6666717529297,"y":407,"wires":[["6637528b.b79cbc"]]},{"id":"81d674d5.497168","type":"link out","z":"4456c207.c3886c","name":"","links":["8d84f058.2038"],"x":468.6666717529297,"y":87,"wires":[]},{"id":"8b03930f.171f7","type":"http request","z":"4456c207.c3886c","name":"Update Contact","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":393.6666717529297,"y":487,"wires":[["d6892411.3a0e48"]]},{"id":"30a4614.bc3eb9e","type":"function","z":"4456c207.c3886c","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+msg.email+\"/profile?hapikey=\"+env.get('hubspot_api_key');\nvar dataString = {\n  \"properties\": [\n     {\n      \"property\": \"cin\",\n      \"value\": \"https://fr.ubergizmo.com/wp-content/uploads/2017/06/ID-3D-1000x800.jpg\"\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":487,"wires":[["8b03930f.171f7"]]},{"id":"c5dcea9b.e51a18","type":"link in","z":"4456c207.c3886c","name":"","links":["1f59fdbc.d4a132"],"x":128.6666717529297,"y":487,"wires":[["30a4614.bc3eb9e"]]},{"id":"1f59fdbc.d4a132","type":"link out","z":"4456c207.c3886c","name":"","links":["c5dcea9b.e51a18"],"x":408.6666717529297,"y":87,"wires":[]},{"id":"d0efa9d.e066358","type":"change","z":"9b71ec4c.36fb6","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":600,"y":240,"wires":[[]]},{"id":"c7cd15ab.6c6a28","type":"link out","z":"64469bd7.645c44","name":"","links":["2c8a55b8.eeddfa"],"x":848.9999370574951,"y":115.55557537078857,"wires":[]},{"id":"c3fb1012.ad39d","type":"debug","z":"64469bd7.645c44","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":578.996584892273,"y":228.51751136779785,"wires":[]},{"id":"73f4c0f0.119a3","type":"function","z":"64469bd7.645c44","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://connect.stripe.com/oauth/token'\n\n//Header\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n\n//Body\nmsg.payload={\n\n\t\"code\" : msg.payload.stripe_code, //env.get('CODE'),\n\t\"grant_type\" : \"authorization_code\"\n\t\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":598.0000410079956,"y":192.55573749542236,"wires":[["907ff441.507948"]]},{"id":"907ff441.507948","type":"http request","z":"64469bd7.645c44","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":792.9999570846558,"y":191.49673748016357,"wires":[["af2d3612.bcd8b8","4ba44942.653d88"]]},{"id":"366493ac.a9492c","type":"http response","z":"64469bd7.645c44","name":"","statusCode":"200","headers":{},"x":526.9965772628784,"y":155.0591583251953,"wires":[]},{"id":"af2d3612.bcd8b8","type":"debug","z":"64469bd7.645c44","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":927.0104675292969,"y":153.18420314788818,"wires":[]},{"id":"bc8d164b.cd71d8","type":"http request","z":"64469bd7.645c44","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1322.0000381469727,"y":232.3335018157959,"wires":[["9fb99bff.a5b818"]]},{"id":"bc16df5f.b1d71","type":"function","z":"64469bd7.645c44","name":"send message","func":"node.warn(\"start sending msg\");\nnode.warn(msg);\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TEKOS_BOT_TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n    \"body\": \"Stripe access key:\" + msg.payload.access_token, \n    \"msgtype\": \"m.text\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":1141.0000305175781,"y":232.3334445953369,"wires":[["bc8d164b.cd71d8"]]},{"id":"4c914698.c88e88","type":"link out","z":"64469bd7.645c44","name":"","links":["2c8a55b8.eeddfa"],"x":1082.9999694824219,"y":135.0000762939453,"wires":[]},{"id":"2c8a55b8.eeddfa","type":"link in","z":"64469bd7.645c44","name":"","links":["bec3a53d.94e548","c7cd15ab.6c6a28","4c914698.c88e88","e931027e.6b909"],"x":1441.0279159545898,"y":51.72569942474365,"wires":[[]]},{"id":"9fb99bff.a5b818","type":"debug","z":"64469bd7.645c44","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1470.3333740234375,"y":232,"wires":[]},{"id":"a42dd62e.9855c8","type":"function","z":"4162450a.10e46c","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\n\n\n\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"Spopin\",\n    to:msg.request.email\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":1037.0000686645508,"y":372.00006580352783,"wires":[[]]},{"id":"8c569f6f.f9481","type":"template","z":"4162450a.10e46c","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{payload}}\n    </style>\n</head>\n\n\n<body>\n    <div><img style=\"width:20%\"\n            src=\"https://spopin.com/wp-content/uploads/2019/10/output-onlinepngtools-2-e1572443299181.png\" /> </div><br>\n    <p>Bonjour {{request.name}}</p>\n    <br>\n    <p>Merci d'avoir choisi SPOPIN pour votre voiture au mois sans engagement et sans apport.</p>\n    <p>Afin de valider votre r&eacute;servation, vous devez t&eacute;l&eacute;charger sur notre plateforme les documents\n        suivants:</p>\n    <p>- Votre permis de conduire (valide, et obtenu depuis plus de 2 ans)</p>\n    <p>- Votre Carte d'Identit&eacute; ou Passeport</p>\n    <p>- Votre RIB qui nous servira &agrave; &eacute;tablir la demande de pr&eacute;l&egrave;vement automatique que nous\n        vous adresserons</p>\n    <p>Pour ce faire, rien de plus simple : cliquez sur le lien suivant <a href=\"https://spopin.tekos.co?via={{request.affiliate_id}}\" target=\"_blank\" rel=\"noopener\">https://spopin.tekos.co</a>, cr&eacute;er votre compte personnel\n        Spopin, et laissez vous guider par notre bot! Vous pourrez &eacute;galement choisir vos options\n        kilom&eacute;triques.</p>\n    <p>Si vous avez la moindre question, n'h&eacute;sitez pas &agrave; nous l'adresser en r&eacute;pondant simplement\n        &agrave; ce mail. Nous vous r&eacute;pondrons dans les 24h. Bien &agrave; vous Le service commercial Spopin</p>\n    <p>&nbsp;</p>\n<div class=\"votrev\" style=\"font-size: 40px;font-family: sans-serif;color: #1E9F0D;\">Votre vÃ©hicule</div>\n<table>\n    <tr>\n        <td>\n            <img src=\"{{car.media.link}}\" style=\"width:100%\"/>\n        </td>\n        <td>\n\n            <p class=\"western\"><span style=\"font-size: medium;\">Type&nbsp;: </span><span\n                    style=\"font-size: medium;\">{{car.car_type}}</span><span style=\"font-size: medium;\"></span></p>\n     \n            <p class=\"western\"><span style=\"font-size: medium;\">V&eacute;hicule: </span><span\n                    style=\"font-size: medium;\">{{car.name}}</span><span style=\"font-size: medium;\"></span></p>\n            <p class=\"western\">{{car.petrol}}</p>\n            <p class=\"western\">{{car.gear}}</p>\n            <p class=\"western\" align=\"justify\">{{car.equipments}}</p>\n          \n        </td>\n\n    </tr>\n\n    </table>\n    <br>\n<div class=\"votrev\" style=\"font-size: 40px;font-family: sans-serif;color: #1E9F0D;\">Votre forfait LibertÃ©</div>\n<p style=\"font-size: 25px;\">{{car.price}}  â‚¬ TTC/mois</p>\n<p style=\"font-size: 25px;\">Forfait : {{request.offer}}</p>\n<p>Forfait mensuel sans engagement - 1000km/mois inclus - Assurance tout risque - Entretien - Maintenance â€“ Assistance</p>  \n<p>ModalitÃ©s de restitution: Forfait rÃ©siliable Ã  tout moment sous rÃ©serve dâ€™un prÃ©avis de 2 semaines et du respect des Conditions GÃ©nÃ©rales de Location de Spopin SAS.</p>\n<p>Options possibles :</p>\n\n    <p>â€¢ 2000km/mois (moyennÃ© sur la durÃ©e du contrat)      --------------------------->  \t+100â‚¬ TTC/mois</p>\n    <p>â€¢ 3000km/mois (moyennÃ© sur la durÃ©e du contrat)      --------------------------->  \t+200â‚¬ TTC/mois</p>\n\n<p>Prix du kilomÃ¨tre supplÃ©mentaire : 0,20 â‚¬ TTC</p>\n<p>Mode de rÃ¨glement : Paiement Ã  Ã©choir en dÃ©but de mois â€“ PremiÃ¨re Ã©chÃ©ance Ã  rÃ©gler Ã  la commande.</p>\n<p>Frais de dossier: 150â‚¬ Ã  la commande.</p>\n<p>Un dÃ©pÃ´t de garantie de 1000â‚¬ sera demandÃ© correspondant au montant de la franchise en cas de dommages.</p>\n<p>Condition de location: ÃŠtre titulaire dâ€™un permis de conduire valide dans le pays dans lequel le VÃ©hicule est louÃ©, et obtenu depuis plus de deux ans.</p>\n\n<p>Ce devis est valable pendant 6 jours, sous rÃ©serve dâ€™Ã©ligibilitÃ© de la zone de livraison et de disponibilitÃ© du vÃ©hicule </p>\n<p>Si vous souhaitez avoir plus de renseignements concernant cette offre, ou pour obtenir une offre sur d'autres vÃ©hicules ou d'autres formules, n'hÃ©sitez pas Ã  nous contacter par mail Ã  contact@spopin.com </p>\n</body>\n<br><br>\n<hr size=\"5\">\n<footer style=\"  text-align: center;\">\n    <p>SPOPIN SAS - 45 rue Manin 75019 PARIS - France</p>\n    <p>SAS AU CAPITAL DE 10 000â‚¬ - RCS PARIS 834 717 118 00022 - TVA FR45834717118</p>\n    <p>contact: bonjour@spopin.com ou 06.24.50.13.55 â€“ Toutes nos offres sur www.spopin.com</p>\n</footer>","x":844.0000953674316,"y":369.00006580352783,"wires":[["a42dd62e.9855c8"]]},{"id":"d40c97f9.1b88a8","type":"template","z":"4162450a.10e46c","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"\n.logo {\nwith:30%;\nheight:30%;\n}\n.votrev{\n    font-size: 40px;\n    font-family: sans-serif;\n    color: #1E9F0D;\n}\n\n/* Hover cell effect! */","x":720.0000877380371,"y":371.00006580352783,"wires":[["8c569f6f.f9481"]]},{"id":"721d1055.1c4ca","type":"http in","z":"4162450a.10e46c","name":"","url":"/spopin","method":"post","upload":false,"swaggerDoc":"","x":141.01736450195312,"y":116.01041841506958,"wires":[["c0cfa6cd.fc1538","67c06daa.bd4464","e84bb3c9.5e0d"]]},{"id":"c0cfa6cd.fc1538","type":"http response","z":"4162450a.10e46c","name":"","statusCode":"200","headers":{},"x":338.00347900390625,"y":115.9756851196289,"wires":[]},{"id":"67c06daa.bd4464","type":"debug","z":"4162450a.10e46c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":316.0208282470703,"y":41.96184158325195,"wires":[]},{"id":"3a3e1b3b.28c964","type":"function","z":"4162450a.10e46c","name":"get car details","func":"msg.request = msg.payload;\nmsg.payload.email = msg.request.email\nreturn msg;","outputs":1,"noerr":0,"x":342.0208206176758,"y":267.9687547683716,"wires":[["36d682d7.1adede"]]},{"id":"36d682d7.1adede","type":"http request","z":"4162450a.10e46c","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"https://spopin.com/wp-json/wp/v2/car?filter[posts_per_page]=111","tls":"","persist":false,"proxy":"","authType":"","x":591.0173187255859,"y":267.8055877685547,"wires":[["7863b48e.e755cc","7fb1f511.451f3c"]]},{"id":"e84bb3c9.5e0d","type":"link out","z":"4162450a.10e46c","name":"","links":["d707c413.5e2d28"],"x":280,"y":164,"wires":[]},{"id":"d707c413.5e2d28","type":"link in","z":"4162450a.10e46c","name":"","links":["e84bb3c9.5e0d"],"x":209,"y":266,"wires":[["3a3e1b3b.28c964"]]},{"id":"7863b48e.e755cc","type":"debug","z":"4162450a.10e46c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":761,"y":218,"wires":[]},{"id":"cad1b48.85cbc48","type":"function","z":"4162450a.10e46c","name":"filter search","func":"var allcars = msg.payload;\nvar request = msg.request;\nfor (let i = 0; i < allcars.length; i++) {\n    \n    if(request.post_id == allcars[i].id){\n        msg.payload = allcars[i];\n        msg.car = msg.payload;\n        msg.url = allcars[i]._links[\"wp:featuredmedia\"][0].href\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":324.99999618530273,"y":371.0000352859497,"wires":[["568a904.4a5e37"]]},{"id":"fb7efd1f.65526","type":"link in","z":"4162450a.10e46c","name":"","links":["7fb1f511.451f3c"],"x":194.99999618530273,"y":361.0000352859497,"wires":[["cad1b48.85cbc48"]]},{"id":"7fb1f511.451f3c","type":"link out","z":"4162450a.10e46c","name":"","links":["fb7efd1f.65526"],"x":736,"y":269,"wires":[]},{"id":"568a904.4a5e37","type":"http request","z":"4162450a.10e46c","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":515.9999961853027,"y":368.0000352859497,"wires":[["6c2fe02e.80d2c"]]},{"id":"6c2fe02e.80d2c","type":"function","z":"4162450a.10e46c","name":"get car's media","func":"msg.car.media = msg.payload;\nreturn msg;","outputs":1,"noerr":0,"x":588.4999961853027,"y":438.0000352859497,"wires":[["d40c97f9.1b88a8","71fb8632.07fbb8"]]},{"id":"71fb8632.07fbb8","type":"debug","z":"4162450a.10e46c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":758.9999961853027,"y":433.0000352859497,"wires":[]},{"id":"2a119870.61cf68","type":"debug","z":"5e0c13c0.29fccc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":692.0173072814941,"y":535.0103950500488,"wires":[]},{"id":"b14ca3d5.9bd44","type":"comment","z":"5e0c13c0.29fccc","name":"pourquoi ce lien ?","info":"","x":808.0139312744141,"y":328.88196563720703,"wires":[]},{"id":"c77bccb8.85f93","type":"link out","z":"a8e33d40.895b1","name":"","links":["b0acac1c.a1ba4"],"x":445,"y":154,"wires":[]},{"id":"ab9d6fa.124b99","type":"function","z":"a8e33d40.895b1","name":"authorise","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/authorize/hubspot/1\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":603,"y":227,"wires":[["b43c16f4.489888"]]},{"id":"b43c16f4.489888","type":"http request","z":"a8e33d40.895b1","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":763,"y":227,"wires":[[]]},{"id":"b0acac1c.a1ba4","type":"link in","z":"a8e33d40.895b1","name":"","links":["c77bccb8.85f93"],"x":339,"y":222,"wires":[["6fa516d6.fbb798"]]},{"id":"6fa516d6.fbb798","type":"switch","z":"a8e33d40.895b1","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":454,"y":222,"wires":[["2dc87fe6.558ce"],["ab9d6fa.124b99"]]},{"id":"2dc87fe6.558ce","type":"link out","z":"a8e33d40.895b1","name":"","links":["c00fc34a.80d12"],"x":578,"y":187,"wires":[]},{"id":"a6dc090.f6a36f8","type":"function","z":"a8e33d40.895b1","name":"Contact form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\n\n\n\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.payload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Tell us a little about you ?',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/hs/create/\"+msg.payload.roomId+\"/\"+msg.payload.email,\n    \"buttontitle\": \"Update\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Nom\",\n        \"key\": \"name\",\n      },\n        {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Prenom\",\n        \"key\": \"prename\",\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"NumÃ©ro de telephone\",\n        \"key\": \"phone\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Entreprise\",\n        \"key\": \"company\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Site web\",\n        \"key\": \"website\",\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":451,"y":286,"wires":[["d2ed9fea.bd78f"]]},{"id":"d2ed9fea.bd78f","type":"http request","z":"a8e33d40.895b1","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":610,"y":285,"wires":[["c1d8f2e8.57bfa"]]},{"id":"8ff238af.542508","type":"http in","z":"a8e33d40.895b1","name":"Create ?","url":"/hs/create/:roomId/:email","method":"post","upload":false,"swaggerDoc":"","x":391,"y":413,"wires":[["e846a874.642548","61c31c2a.811f94"]]},{"id":"5d92cc01.bcf904","type":"http request","z":"a8e33d40.895b1","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":733,"y":387,"wires":[["cf9f2756.eac818","c1d8f2e8.57bfa"]]},{"id":"e846a874.642548","type":"function","z":"a8e33d40.895b1","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nmsg.roomId = msg.req.params.roomId\nvar dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": msg.req.params.email\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": msg.payload.prename\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": msg.payload.name\n    },\n    {\n      \"property\": \"website\",\n      \"value\": msg.payload.website\n    },\n    {\n      \"property\": \"company\",\n      \"value\": msg.payload.company\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": msg.payload.phone\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":533,"y":387,"wires":[["5d92cc01.bcf904"]]},{"id":"c1d8f2e8.57bfa","type":"debug","z":"a8e33d40.895b1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":930,"y":292,"wires":[]},{"id":"8eeef14f.528f6","type":"link in","z":"a8e33d40.895b1","name":"","links":["2705202d.3bb7c"],"x":341,"y":286,"wires":[["a6dc090.f6a36f8"]]},{"id":"2e880ec4.4dcda2","type":"switch","z":"a8e33d40.895b1","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":703,"y":596,"wires":[["2705202d.3bb7c"],["70336d4b.ca7b94"]]},{"id":"c39f16c8.2fd3c8","type":"http in","z":"a8e33d40.895b1","name":"","url":"/authorize/hubspot/1","method":"post","upload":false,"swaggerDoc":"","x":503,"y":596,"wires":[["f2ab703f.85919","2e880ec4.4dcda2","5013aa5.69b7454"]]},{"id":"f2ab703f.85919","type":"http response","z":"a8e33d40.895b1","name":"success","statusCode":"200","headers":{},"x":713,"y":556,"wires":[]},{"id":"2705202d.3bb7c","type":"link out","z":"a8e33d40.895b1","name":"link customer","links":["8eeef14f.528f6"],"x":808,"y":576,"wires":[]},{"id":"70336d4b.ca7b94","type":"link out","z":"a8e33d40.895b1","name":"error msg","links":[],"x":828,"y":616,"wires":[]},{"id":"5013aa5.69b7454","type":"debug","z":"a8e33d40.895b1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":723,"y":636,"wires":[]},{"id":"61c31c2a.811f94","type":"http response","z":"a8e33d40.895b1","name":"success","statusCode":"200","headers":{},"x":563,"y":435,"wires":[]},{"id":"cf9f2756.eac818","type":"switch","z":"a8e33d40.895b1","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"Contact already exists","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":938,"y":347,"wires":[[],["c51a92d6.c8e2d"]]},{"id":"c51a92d6.c8e2d","type":"switch","z":"a8e33d40.895b1","name":"","property":"payload.vid","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1078,"y":367,"wires":[[],[]]},{"id":"a0351355.c1123","type":"switch","z":"a8e33d40.895b1","name":"","property":"request","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":316,"y":353,"wires":[["efa6471f.49a808"],["a6dc090.f6a36f8"]]},{"id":"c00fc34a.80d12","type":"link in","z":"a8e33d40.895b1","name":"","links":["2dc87fe6.558ce"],"x":215,"y":348,"wires":[["a0351355.c1123"]]},{"id":"efa6471f.49a808","type":"link out","z":"a8e33d40.895b1","name":"","links":["f74932fa.615b8"],"x":427,"y":357,"wires":[]},{"id":"65c36295.701eec","type":"function","z":"a8e33d40.895b1","name":"data from previous payload","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nvar request = msg.request\nvar dataString = {\n  properties: [\n    {\n      property: \"email\",\n      value: request.email\n    },\n    {\n      property: \"firstname\",\n      value: request.name\n    },\n     {\n      property: \"zip\",\n      value: request.postal_code\n    },{\n        property:\"referring_url\",\n        value:request.url\n    }\n  ]\n}\nif(request.phone){\n    dataString.properties.push({\n      property: \"phone\",\n      value: request.phone\n    })\n}\nif(request.affiliate_id){\n      dataString.properties.push({\n      property: \"affiliate\",\n      value: request.affiliate_id\n    })\n\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":616,"y":500,"wires":[["5d92cc01.bcf904"]]},{"id":"f74932fa.615b8","type":"link in","z":"a8e33d40.895b1","name":"","links":["efa6471f.49a808"],"x":442,"y":499,"wires":[["65c36295.701eec"]]},{"id":"460a19a9.b9f758","type":"function","z":"442c770f.96d248","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nvar roomId = msg.roomId\nmsg={\n    payload:msg.payload,\n    topic:\"le client \"+msg.senderId+\" a tÃ©lÃ©charger un document \",\n    to:\"ayoub@tekos.co\",\n    roomId:roomId\n   \n};\n\nreturn msg;","outputs":1,"noerr":0,"x":315.00000381469727,"y":199,"wires":[[]]},{"id":"c48b5aeb.cbc6b8","type":"template","z":"442c770f.96d248","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n    <h3>Nom Fichier : {{file}}</h3>\n    <p>\n      Fichier source : <a href=\"{{imagesrc}}\">Lien vers le fichier</a>\n    </p>\n</body>","x":531.9999885559082,"y":140.99999046325684,"wires":[["460a19a9.b9f758"]]},{"id":"88024c15.7e99f","type":"template","z":"442c770f.96d248","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":391.9999885559082,"y":140.99999046325684,"wires":[["c48b5aeb.cbc6b8"]]},{"id":"577f3838.949218","type":"function","z":"442c770f.96d248","name":"send mail","func":"msg.subscription = msg.event.event;\nmsg.file = msg.payload;\nmsg.file.name = msg.payload;\nmsg.file.sender = msg.senderId;\nmsg.roomId = msg.roomId;\nmsg.file.src = msg.imagesrc;\nreturn msg;","outputs":1,"noerr":0,"x":261.9999885559082,"y":140.99999046325684,"wires":[["88024c15.7e99f"]]},{"id":"eb24d868.c862e8","type":"function","z":"242600cf.12cc","name":"Invite operator","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+env.get('ROOM')+\"/invite?access_token=\"+env.get('TOKEN')\nmsg.payload={\n\n  \"user_id\": env.get('Operator')\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["a7b6ccea.1e6b3"]]},{"id":"a7b6ccea.1e6b3","type":"http request","z":"242600cf.12cc","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":370,"y":80,"wires":[[]]},{"id":"216cb68e.98d1ba","type":"subflow:a8e33d40.895b1","z":"85c6ed92.daf94","name":"","env":[],"x":523.6909942626953,"y":226.2083511352539,"wires":[[],[]]},{"id":"5435e1a6.8b7b6","type":"http in","z":"82767481.508078","name":"","url":"/hubspot-notif","method":"post","upload":false,"swaggerDoc":"","x":200,"y":328.0000741481781,"wires":[["53baf24e.7384bc","ed5707d5.c2d8c8"]]},{"id":"53baf24e.7384bc","type":"http response","z":"82767481.508078","name":"","statusCode":"200","headers":{},"x":518,"y":201.00001525878906,"wires":[]},{"id":"ed5707d5.c2d8c8","type":"debug","z":"82767481.508078","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":528,"y":241.00001525878906,"wires":[]},{"id":"ed1b761.6969a88","type":"switch","z":"82767481.508078","name":"Event Action","property":"payload.meta.action","propertyType":"msg","rules":[{"t":"eq","v":"added","vt":"str"},{"t":"eq","v":"updated","vt":"str"},{"t":"eq","v":"merged","vt":"str"},{"t":"eq","v":"deleted","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":528,"y":321.00001525878906,"wires":[["a137a085.c18c4"],["a137a085.c18c4"],["a137a085.c18c4"],["a137a085.c18c4"]]},{"id":"a137a085.c18c4","type":"switch","z":"82767481.508078","name":"Event Object","property":"payload.meta.object","propertyType":"msg","rules":[{"t":"eq","v":"deal","vt":"str"},{"t":"eq","v":"activity","vt":"str"},{"t":"eq","v":"activityType","vt":"str"},{"t":"eq","v":"note","vt":"str"},{"t":"eq","v":"organization","vt":"str"},{"t":"eq","v":"person","vt":"str"},{"t":"eq","v":"pipeline","vt":"str"},{"t":"eq","v":"product","vt":"str"},{"t":"eq","v":"stage","vt":"str"},{"t":"eq","v":"user","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":11,"x":748,"y":281.00001525878906,"wires":[["2d3e348d.b347cc"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"]]},{"id":"5492c7f7.947cc8","type":"link in","z":"82767481.508078","name":"","links":["985f522d.c97bf","8d4f6054.9c5a3"],"x":1253,"y":361.00001525878906,"wires":[["acf76c3d.ccc98"]]},{"id":"c89f8e7a.ac88","type":"subflow:9b782c32.24018","z":"82767481.508078","name":"","env":[{"name":"NAME","value":"My Bot","type":"str"},{"name":"AVATAR","value":"mxc://m.tekos.co/YivgXqvHlfFoojhhuJiIHUCA","type":"str"},{"name":"BOT","value":"BOT_ID","type":"str"},{"name":"TOKEN","value":"TEKOS_BOT_TOKEN","type":"env"}],"x":594.9999923706055,"y":142.00000190734863,"wires":[[]]},{"id":"a3d1cc80.15c5b","type":"comment","z":"82767481.508078","name":"https://hackernoon.com/what-are-hubspot-webhooks-and-why-are-they-useful-a0caed6d09b6","info":"","x":758.0000228881836,"y":80,"wires":[]},{"id":"2d3e348d.b347cc","type":"chatbot-text","z":"82767481.508078","name":"Deal","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}: ðŸ‘\n{{current.title}}\nowner: {{current.owner_name}}\nvalue: {{current.formatted_weighted_value}}\nexpected close date: {{current.expected_close_date}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":948,"y":221.00001525878906,"wires":[["985f522d.c97bf"]]},{"id":"985f522d.c97bf","type":"link out","z":"82767481.508078","name":"","links":["5492c7f7.947cc8"],"x":1093,"y":221.00001525878906,"wires":[]},{"id":"3f04b515.8c0d8a","type":"chatbot-text","z":"82767481.508078","name":"(generic)","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}:\n{{meta.object}} : {{current.name}}\nowner: {{current.owner_name}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":938,"y":321.00001525878906,"wires":[["8d4f6054.9c5a3"]]},{"id":"8d4f6054.9c5a3","type":"link out","z":"82767481.508078","name":"","links":["5492c7f7.947cc8"],"x":1093,"y":321.00001525878906,"wires":[]},{"id":"acf76c3d.ccc98","type":"debug","z":"82767481.508078","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1368,"y":281.00001525878906,"wires":[]},{"id":"3b6aa236.6a12ae","type":"function","z":"fde10ab5.552fe8","name":"Get members","func":"msg.url = env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/joined_members?access_token=\"+env.get('Token')\nmsg.payload={\n\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":240,"wires":[["205fbd70.641182"]]},{"id":"205fbd70.641182","type":"http request","z":"fde10ab5.552fe8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":610,"y":240,"wires":[["b8215146.7065c"]]},{"id":"b8215146.7065c","type":"function","z":"fde10ab5.552fe8","name":"calculate member's nb","func":"\nvar joined = Object.keys(msg.payload.joined).length;\n\nif(joined == 1){\n    msg.payload = msg.messageContent;\n    return [msg,null,null];\n    \n}else if(joined == 2){\n    msg.payload = msg.messageContent;\n    return [null,msg,null];\n}else{\n    return [null,null,msg];\n}\n\nreturn msg;","outputs":3,"noerr":0,"x":800,"y":240,"wires":[["23b18362.81f1cc"],["23b18362.81f1cc"],[]],"icon":"font-awesome/fa-thumbs-o-down"},{"id":"1a1a7f05.afa3f1","type":"switch","z":"fde10ab5.552fe8","name":"New Interaction ?","property":"room","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":147.99998092651367,"y":83.99998664855957,"wires":[["2bb14ec8.9fd482"],["8ff0b37c.f47e9"]],"outputLabels":["","existing interaction"]},{"id":"9ccfba7e.4cba88","type":"function","z":"fde10ab5.552fe8","name":"Set Room ID","func":"msg.roomId= msg.room\nreturn msg;","outputs":1,"noerr":0,"x":532,"y":44,"wires":[[]],"outputLabels":["new room"]},{"id":"ad7d2657.a3c398","type":"function","z":"fde10ab5.552fe8","name":"is Dierct message (@bot) ***?","func":"\nvar str = msg.event.event.content.formatted_body;\nvar strmobile = msg.event.event.content.body;\nvar bot = env.get(\"Bot\");\nvar botname = env.get(\"Bot_name\");\nvar strtxt =   msg.payload;\n\nif(str){\n    if(str.includes(bot)){\n        strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[msg,null,null]\n    }\n   \n}else if(strmobile.includes(botname)){\n     strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[null,msg,null]\n    \n}\n\nelse{\n    \n    return[null,null,msg]\n}\nreturn msg;","outputs":3,"noerr":0,"x":210,"y":220,"wires":[[],[],["3b6aa236.6a12ae"]],"icon":"node-red/switch.svg"},{"id":"8ff0b37c.f47e9","type":"switch","z":"fde10ab5.552fe8","name":"","property":"event.event.content.msgtype","propertyType":"msg","rules":[{"t":"eq","v":"m.image","vt":"str"},{"t":"eq","v":"m.file","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":160,"y":154,"wires":[[],[],["ad7d2657.a3c398"]]},{"id":"c84d65d.061f498","type":"link out","z":"fde10ab5.552fe8","name":"","links":["45bdbd8e.4d7464"],"x":1215,"y":260,"wires":[]},{"id":"45bdbd8e.4d7464","type":"link in","z":"fde10ab5.552fe8","name":"","links":["c84d65d.061f498"],"x":95,"y":320,"wires":[["3589a4fa.2c4d9c"]]},{"id":"3589a4fa.2c4d9c","type":"function","z":"fde10ab5.552fe8","name":"pending step found ! ","func":"\nvar data = global.get(msg.roomXD);\nvar pending = data.pendingstep;\n\ndata[pending] = msg.payload;\ndelete data.pendingstep;\nglobal.set(msg.roomXD,data);\n\n\nmsg.step = pending;\nmsg.stepcontent = msg.payload;\n\n\n data = global.get(msg.roomXD);\n\n \n \nif(data[\"STEP\"] && data.hasOwnProperty(data[\"STEP\"])){\n    data = global.get(msg.roomXD);\n    delete data[\"STEP\"];\n    global.set(msg.roomXD,data);\n}\n\n\n\nif(data.STEP){\n        msg.currentstep = data.STEP\n\n         return[msg,null]; // 4\n    }else{\n        return [null,msg];\n    }\n","outputs":2,"noerr":0,"x":255,"y":320,"wires":[["1f365b35.bb1455"],[]]},{"id":"a6eabfae.1652d","type":"debug","z":"fde10ab5.552fe8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":470,"y":360,"wires":[]},{"id":"23b18362.81f1cc","type":"function","z":"fde10ab5.552fe8","name":"pending step ?","func":"var roomId = msg.roomId;\nroomId= roomId.substr(0, roomId.indexOf(':'));\nif(!global.get(roomId)){\n    return[msg,null,null,null]; // 1\n}else{\n    \n    var data = global.get(roomId);\n    if(data.pendingstep){\n        msg.roomXD = roomId;\n        return [null,null,msg,null]; // 3\n    }else if(data.STEP){\n        msg.roomXD = roomId;\n        msg.currentstep = data.STEP\n         return[null,null,null,msg]; // 4\n    }else{\n   return[null,msg,null,null]; // 2\n\n    }\n}\n\nreturn msg;","outputs":4,"noerr":0,"x":1040,"y":240,"wires":[[],[],["c84d65d.061f498"],[]],"icon":"node-red/switch.svg"},{"id":"1f365b35.bb1455","type":"link out","z":"fde10ab5.552fe8","name":"","links":["d531bdd3.97c5c"],"x":415,"y":300,"wires":[]},{"id":"d531bdd3.97c5c","type":"link in","z":"fde10ab5.552fe8","name":"","links":["1f365b35.bb1455"],"x":1215,"y":380,"wires":[[]]},{"id":"971d9eba.9d1d3","type":"switch","z":"91f083d1.0d1a3","name":"","property":"payload.InstanceStatuses[0].InstanceState.Name","propertyType":"msg","rules":[{"t":"eq","v":"running","vt":"str"},{"t":"eq","v":"pending","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1070,"y":600,"wires":[["83898183.c77e3"],["8ef8af35.4a7c1"],["8ef8af35.4a7c1"]]},{"id":"83898183.c77e3","type":"link out","z":"91f083d1.0d1a3","name":"","links":[],"x":1195,"y":580,"wires":[]},{"id":"8ef8af35.4a7c1","type":"link out","z":"91f083d1.0d1a3","name":"","links":[],"x":1195,"y":620,"wires":[]},{"id":"a024cf5b.0baa1","type":"link in","z":"91f083d1.0d1a3","name":"","links":["8f42cb88.5d1448"],"x":235,"y":520,"wires":[[]]},{"id":"cffbf9c2.7f21d8","type":"delay","z":"91f083d1.0d1a3","name":"","pauseType":"delay","timeout":"2","timeoutUnits":"minutes","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":900,"y":400,"wires":[[]]},{"id":"ce906c7.5f25f9","type":"function","z":"af0345b1.7c4e78","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=incoming&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"text\": msg.payload,\n  \"userId\": msg.senderId,\n  \"platformJson\": {\n    \"displayname\": \"hey\"\n  } \n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":300,"y":120,"wires":[["96e114ac.503328"]]},{"id":"96e114ac.503328","type":"http request","z":"af0345b1.7c4e78","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":120,"wires":[["2684a379.f373bc"]]},{"id":"2684a379.f373bc","type":"debug","z":"af0345b1.7c4e78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":160,"wires":[]},{"id":"4e7c77fc.e4b3a8","type":"function","z":"45e63626.6388b8","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=outgoing&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"text\": msg.payload,\n  \"userId\": msg.senderId,\n  \"platformJson\": {\n    \"displayname\": \"hey\"\n  } \n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["2aa23085.8afea"]]},{"id":"2aa23085.8afea","type":"http request","z":"45e63626.6388b8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":430,"y":80,"wires":[[]]},{"id":"7d78bc33.d01994","type":"function","z":"491f6cec.662034","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=event&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"name\": env.get('EVENT_NAME'),\n  \"type\": \"customEvent\",\n  \"userId\": \"@miled.essaafi:m.tekos.co\", //msg.senderId,\n  \"extraInfo\": {\n    \"start\": 1500504070512,\n    \"difference\": 374,\n    \"end\": 1500504070886\n  }\n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":220,"wires":[["28b7f8ff.b20778"]]},{"id":"28b7f8ff.b20778","type":"http request","z":"491f6cec.662034","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":550,"y":220,"wires":[[]]},{"id":"81274faa.4f1bc","type":"link out","z":"c47f16f1.a03068","name":"","links":["73b3dbb4.d2bc34"],"x":475,"y":200,"wires":[]},{"id":"73b3dbb4.d2bc34","type":"link in","z":"c47f16f1.a03068","name":"","links":["81274faa.4f1bc"],"x":995,"y":500,"wires":[["4c8e1d7c.e95244"]]},{"id":"4c8e1d7c.e95244","type":"chatbot-text","z":"c47f16f1.a03068","name":"error params missing.","message":[{"message":"Error, missing params in billing details config."}],"x":1120,"y":500,"wires":[[]]},{"id":"e390c3b9.76a53","type":"debug","z":"c47f16f1.a03068","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":670,"y":160,"wires":[]},{"id":"11e8a77e.da7369","type":"http response","z":"c47f16f1.a03068","name":"OK","statusCode":"200","headers":{},"x":1194,"y":440,"wires":[]},{"id":"9a7282d0.7acbd","type":"http response","z":"c47f16f1.a03068","name":"ERROR","statusCode":"400","headers":{},"x":1226,"y":264,"wires":[]},{"id":"def790aa.fcea4","type":"link out","z":"486d1d6e.dd5de4","name":"","links":["54966e20.d225e"],"x":515,"y":180,"wires":[]},{"id":"54966e20.d225e","type":"link in","z":"486d1d6e.dd5de4","name":"","links":["def790aa.fcea4"],"x":755,"y":180,"wires":[[]]},{"id":"3ee2b369.c72ecc","type":"link out","z":"39b2c1f9.f0db8e","name":"","links":["dbd3336d.48d72"],"x":653,"y":176,"wires":[]},{"id":"8bf237c3.81cd38","type":"link out","z":"39b2c1f9.f0db8e","name":"","links":["dbd3336d.48d72"],"x":345,"y":176,"wires":[]},{"id":"66990fa7.ad0a3","type":"http request","z":"1a61712.53a9c8f","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":610,"y":160,"wires":[["5270c291.0a357c","99716f6f.f2e1b"]]},{"id":"7cc79323.dcf43c","type":"function","z":"1a61712.53a9c8f","name":"Get Subscription","func":"msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nif(env.get('id') ||msg.payload.subscription ){\n    var subscription = msg.payload.subscription || env.get('id');\n      msg.roomId =msg.req.params.roomId\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+subscription;\n    return [msg,null];\n}else{\n    return[null,msg];\n}\n  \n","outputs":1,"noerr":0,"x":390,"y":160,"wires":[["66990fa7.ad0a3"]]},{"id":"5270c291.0a357c","type":"switch","z":"1a61712.53a9c8f","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":770,"y":160,"wires":[[],[]]},{"id":"99716f6f.f2e1b","type":"debug","z":"1a61712.53a9c8f","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":780,"y":240,"wires":[]},{"id":"67b1c959.f85038","type":"function","z":"a5fd4a6.61c2bb8","name":"flow plans cards","func":"function compare( a, b ) {\n  if ( a.amount < b.amount ){\n    return -1;\n  }\n  if ( a.amount > b.amount ){\n    return 1;\n  }\n  return 0;\n}\nvar allThePlans=[];\nvar plans  = msg.payload.data;\nvar roomId = msg.event.event.room_id;\nmsg.roomId = roomId;\nlet type = env.get(\"type\");\nfor (let i = 0; i < plans.length; i++) {\nlet plan =plans[i];\nvar oneplan = {\n    amount:plan.amount,\n    title: \"Tekos \"+type+\" <nobr style='color:#7061E2'>\"+plan.nickname+\"</nobr> plan\",\n    subtitle: \"â‚¬\"+(parseInt(plan.amount)/100) +\" per \"+plan.interval, //\"7 days free! then â‚¬9.00 / month\"\n    imageUrl: env.get('Image'),\n    buttons: \n        [\n            {\n                type: \"request_url_only\",\n                label: env.get('callToAction'), //\"Subscribe\",\n                value: \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('callToActionURL')+\"/subscribe/\"+env.get('subscription')+\"/\"+plan.id,\n                alert: false\n            },\n            {\n                type: \"url\",\n                label: env.get('learnMoreLabel'), // \"See more\",\n                url: env.get('learnMoreURL'), //\"https://tekos.co/flow/\",\n                alert: false\n            }\n        ]\n};\nif(plan.trial_period_days){\n    oneplan.subtitle = plan.trial_period_days+\" days free! then \"+oneplan.subtitle;\n}\n\nallThePlans.push(oneplan);\n \n}     \n       \nallThePlans.sort(compare);  \nnode.warn(allThePlans);\n    \n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":900,"y":140,"wires":[[]]},{"id":"68af5b2d.765564","type":"function","z":"a5fd4a6.61c2bb8","name":"create get product","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar product = env.get(\"product\")\nmsg.url = \"https://api.stripe.com/v1/plans?product=\"+product;\nreturn msg;","outputs":1,"noerr":0,"x":330,"y":180,"wires":[["e7a5c5d1.8efa98"]]},{"id":"e7a5c5d1.8efa98","type":"http request","z":"a5fd4a6.61c2bb8","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":180,"wires":[["7e08a3e2.86ec9c","df5fea8e.0620f8"]]},{"id":"7e08a3e2.86ec9c","type":"debug","z":"a5fd4a6.61c2bb8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":710,"y":200,"wires":[]},{"id":"df5fea8e.0620f8","type":"switch","z":"a5fd4a6.61c2bb8","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":160,"wires":[["67b1c959.f85038"],[]]},{"id":"ed4ea298.46283","type":"function","z":"44ce6d7c.a949d4","name":"authenticate flow","func":"\nmsg.url=\"https://\"+msg.subdomain+\".tekos.co/auth/token\";\nmsg.headers ={\n    \"Content-type\": \"application/json\"\n}\nmsg.templatebody = msg.payload;\nmsg.payload= {\n    client_id:\"node-red-editor\",\n    grant_type:\"password\",\n    scope:\"*\",\n    username:msg.env.login,\n    password:msg.env.password\n}\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":486,"y":198,"wires":[["c339f7e2.8e1388"]]},{"id":"c339f7e2.8e1388","type":"http request","z":"44ce6d7c.a949d4","name":"FLOW","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":644,"y":198,"wires":[["9e81fd62.4efc2","5c219c03.d74f54"]]},{"id":"9e81fd62.4efc2","type":"debug","z":"44ce6d7c.a949d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":824,"y":198,"wires":[]},{"id":"5c219c03.d74f54","type":"switch","z":"44ce6d7c.a949d4","name":"","property":"payload.access_token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":774,"y":238,"wires":[["43588d33.c891b4"],[]]},{"id":"43588d33.c891b4","type":"link out","z":"44ce6d7c.a949d4","name":"","links":["bf55cdcf.44a49"],"x":873,"y":230,"wires":[]},{"id":"1b8c91a8.05bb8e","type":"function","z":"44ce6d7c.a949d4","name":"update flow","func":"msg.url=\"https://\"+msg.subdomain+\".tekos.co/flows\";\nmsg.headers ={\n    \"Content-type\": \"application/json\",\n    \"Node-RED-Deployment-Type\":\"full\",\n    \"Authorization\" : \"Bearer \"+msg.payload.access_token,\n\n}\nmsg.payload= msg.templatebody;\nreturn msg;","outputs":1,"noerr":0,"x":532,"y":286,"wires":[["9331a470.3e22d8"]]},{"id":"bf55cdcf.44a49","type":"link in","z":"44ce6d7c.a949d4","name":"","links":["43588d33.c891b4"],"x":407,"y":286,"wires":[["1b8c91a8.05bb8e"]]},{"id":"9331a470.3e22d8","type":"http request","z":"44ce6d7c.a949d4","name":"FLOW","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":692,"y":286,"wires":[["cc13b1c1.23893"]]},{"id":"cc13b1c1.23893","type":"debug","z":"44ce6d7c.a949d4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":832,"y":286,"wires":[]},{"id":"f86cab4e.a4b5d8","type":"subflow:afeae1e.cea212","z":"11b3cac3.191255","name":"","env":[],"x":160,"y":280,"wires":[[]]},{"id":"a0e22929.997118","type":"subflow:3ec0df30.dbad9","z":"afeae1e.cea212","name":"","env":[],"x":428,"y":132,"wires":[[]]},{"id":"a5d251fb.142d9","type":"http request","z":"9b2392b3.300b4","name":"Segment","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":360,"y":80,"wires":[[]]},{"id":"58eebebc.649af","type":"function","z":"9b2392b3.300b4","name":"","func":"msg.url = 'https://api.segment.io/v1/track'\n\n\n\nmsg.headers ={\n    \"Authorization\" : \"Basic \"+env.get('write_key'),  //RUFRU2xLV05ZNVJTMDdUeUc1N1lxeU94czVmUFJYb3Y=\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload = {\n  \"userId\": msg.payload.email,\n  \"email\": msg.payload.email,\n  \"event\": env.get('EVENT')\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["a5d251fb.142d9"]]},{"id":"19a6a411.06936c","type":"subflow:af0345b1.7c4e78","z":"491f6cec.662034","name":"","x":264,"y":374,"wires":[[]]},{"id":"7cc9d458.f1e4dc","type":"subflow:45e63626.6388b8","z":"491f6cec.662034","name":"","x":200,"y":440,"wires":[[]]},{"id":"62cd8a0f.e2c444","type":"function","z":"6ec18374.f95cdc","name":"set pending","func":"msg.payload = msg.payload;\nvar roomID = msg.roomId;\nvar roomXD = roomID.substr(0, roomID.indexOf(':')); // \nvar data,pending;\nif(!roomID || !env.get(\"step\") || env.get(\"step\") === \"pendingstep\"){\n    node.error(\"parameter in set pending step missing\")\n    return [null,null,msg] // 3\n}else if(!env.get('value') ){\n         pending = env.get(\"step\")\n\n    node.warn(\"no value so pendingstep\")\nif(global.get(roomXD)){\n     data = global.get(roomXD);\n    data[\"pendingstep\"] = pending;\n    global.set(roomXD,data);\n     node.warn(\"set  pendingstep 1\")\n}else{\n    global.set(roomXD,{\"pendingstep\":pending});\n         node.warn(\"set  pendingstep 2\")\n\n\n}\nreturn [msg,null,null] // 1\n}else{\n         pending = env.get(\"step\")\n\n        node.warn(\"yes value so STEP\")\n       data = global.get(roomXD);\n       data[pending] = env.get('value');\n   \n        global.set(roomXD,data);\n      return [null,msg,null] // 2\n\n\n}\n\n\n","outputs":3,"noerr":0,"x":310,"y":140,"wires":[[],[],[]]},{"id":"752cecd6.dc4e44","type":"function","z":"927e6891.b73778","name":"set pending","func":"msg.payload = msg.payload;\nvar roomID = msg.roomId;\nvar roomXD = roomID.substr(0, roomID.indexOf(':')); // \nvar data,pending;\nif(!roomID || !env.get(\"step\") || env.get(\"step\") === \"pendingstep\"){\n    node.error(\"parameter in set pending step missing\")\n    return [null,null,msg] // 3\n}else if(!env.get('value') ){\n         pending = env.get(\"step\")\n\n    node.warn(\"no value so pendingstep\")\nif(global.get(roomXD)){\n     data = global.get(roomXD);\n    data[\"pendingstep\"] = pending;\n    global.set(roomXD,data);\n     node.warn(\"set  pendingstep 1\")\n}else{\n    global.set(roomXD,{\"pendingstep\":pending});\n         node.warn(\"set  pendingstep 2\")\n\n\n}\nreturn [msg,null,null] // 1\n}else{\n         pending = env.get(\"step\")\n\n        node.warn(\"yes value so STEP\")\n       data = global.get(roomXD);\n       data[pending] = env.get('value');\n   \n        global.set(roomXD,data);\n      return [null,msg,null] // 2\n\n\n}\n\n\n","outputs":3,"noerr":0,"x":330,"y":160,"wires":[[],[],[]]},{"id":"67e548e0.a06658","type":"subflow:19a4ce64.de4022","z":"d5c46538.c915f8","name":"","env":[{"name":"hubspot_api_key","value":"","type":"str"}],"x":120,"y":460,"wires":[[],[]]},{"id":"702acec6.569c4","type":"http response","z":"52c3ea26.423dc4","name":"OK","statusCode":"200","headers":{},"x":870,"y":320,"wires":[]},{"id":"f9e025dc.656fd8","type":"http response","z":"52c3ea26.423dc4","name":"404","statusCode":"404","headers":{},"x":1030,"y":160,"wires":[]},{"id":"a5ed5058.aa11e","type":"function","z":"52c3ea26.423dc4","name":"error message","func":"msg.payload.error = \"Bot name already exist!\";\n\nreturn msg;","outputs":1,"noerr":0,"x":880,"y":160,"wires":[["f9e025dc.656fd8"]]},{"id":"38fd4cca.a73174","type":"function","z":"91f083d1.0d1a3","name":"AMI","func":"msg.ami = env.get(\"AMI\");\nreturn msg;","outputs":1,"noerr":0,"x":470,"y":400,"wires":[[]]},{"id":"d10c5698.66fcb8","type":"link out","z":"91f083d1.0d1a3","name":"","links":["77684427.6705bc"],"x":1095,"y":80,"wires":[]},{"id":"9db890e8.f6445","type":"debug","z":"1a282f04.66edf1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":710,"y":660,"wires":[]},{"id":"8f42cb88.5d1448","type":"link out","z":"91f083d1.0d1a3","name":"","links":["a024cf5b.0baa1"],"x":840,"y":340,"wires":[]},{"id":"7d7492df.a00d3c","type":"http response","z":"1a282f04.66edf1","name":"200","statusCode":"200","headers":{},"x":600,"y":286,"wires":[]},{"id":"d4630e4c.d5f91","type":"function","z":"19938199.71aa0e","name":"flow plans cards","func":"function compare( a, b ) {\n  if ( a.amount < b.amount ){\n    return -1;\n  }\n  if ( a.amount > b.amount ){\n    return 1;\n  }\n  return 0;\n}\nvar allThePlans=[];\nvar plans  = msg.payload.data;\n//var roomId = msg.event.event.room_id;\n//msg.roomId = roomId;\nfor (let i = 0; i < plans.length; i++) {\nlet plan =plans[i];\nif(plan.amount === null){\n    plan.amount = 0;\n}\nvar oneplan = {\n    amount:plan.amount,\n    title: \"Plan  <nobr style='color:#7061E2'>\"+plan.nickname+\"</nobr> plan\",\n    subtitle: \"â‚¬\"+(parseInt(plan.amount)/100) +\" per \"+plan.interval, //\"7 days free! then â‚¬9.00 / month\"\n    imageUrl: env.get('Image'),//\n    buttons: \n        [\n            {\n                type: \"request_url_only\",\n                label: env.get('callToAction'), //\"Subscribe\",\n                value: \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('callToActionURL')+\"/subscribetoplan/\"+plan.id,\n             \n                alert: false\n            },\n            {\n                type: \"url\",\n                label: env.get('learnMoreLabel'), // \"See more\",\n                url: env.get('learnMoreURL'), //\"https://tekos.co/flow/\",\n                alert: false\n            }\n        ]\n};\nif(plan.trial_period_days){\n    oneplan.subtitle = plan.trial_period_days+\" days free! then \"+oneplan.subtitle;\n}\n\nallThePlans.push(oneplan);\n \n}     \n       \nallThePlans.sort(compare);  \n\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\nreturn msg;","outputs":1,"noerr":0,"x":780,"y":120,"wires":[[]]},{"id":"8d5f4c49.03a97","type":"function","z":"19938199.71aa0e","name":"create get product","func":"msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nvar product = env.get(\"product\")\nmsg.url = \"https://api.stripe.com/v1/plans?product=\"+product;\nreturn msg;","outputs":1,"noerr":0,"x":210,"y":160,"wires":[["d0858313.a355d"]]},{"id":"d0858313.a355d","type":"http request","z":"19938199.71aa0e","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":410,"y":160,"wires":[["1c231884.d7cee7"]]},{"id":"1c231884.d7cee7","type":"switch","z":"19938199.71aa0e","name":"","property":"payload.data.length","propertyType":"msg","rules":[{"t":"gt","v":"0","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":590,"y":140,"wires":[["d4630e4c.d5f91"],[]]},{"id":"6d973b42.f5f5c4","type":"http in","z":"19938199.71aa0e","name":"","url":"/subscribetoplan/:plan","method":"post","upload":false,"swaggerDoc":"","x":250,"y":260,"wires":[["990283d1.d42f2"]]},{"id":"990283d1.d42f2","type":"function","z":"19938199.71aa0e","name":"create session  body","func":"msg.tekospayload = msg.payload;\nvar dataString;\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\nconst plan = msg.req.params.plan;\nmsg.payload = 'payment_method_types[]=card&success_url=https://chat.tekos.co/#/room/'+msg.tekospayload.roomId+'&mode=subscription&subscription_data[items][][plan]='+plan+'&cancel_url=https://chat.tekos.co/#/room/'+msg.tekospayload.roomId+\"&subscription_data[metadata][roomId]=\"+msg.tekospayload.roomId+\"&subscription_data[metadata][origin]=bot\";\n\nreturn msg;","outputs":1,"noerr":0,"x":460,"y":320,"wires":[["6838b339.f2aacc"]]},{"id":"6838b339.f2aacc","type":"http request","z":"19938199.71aa0e","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"https://api.stripe.com/v1/checkout/sessions","tls":"","persist":false,"proxy":"","authType":"","x":670,"y":320,"wires":[["5d941081.d3bbc"]]},{"id":"9d286cd8.8720f","type":"function","z":"19938199.71aa0e","name":"show button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nfunction percentage(num, per)\n{\n  return (num/100)*per;\n}\n\nvar result = msg.tekospayload.roomId;\nvar ammounttopay = (msg.payload.display_items[0].amount)/100 \nammounttopay = ammounttopay\nammounttopay = ammounttopay.toFixed(2);\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+result+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintapi\":{\n    \t\"sessionid\": msg.payload.id,\n    \t\"buttontext\":\"Pay â‚¬\"+ammounttopay,\n    \t\"token_stripe\": env.get(\"STRIPE_PUB_KEY\")\n\n     }\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":220,"wires":[["eb852e3d.3f91b"]]},{"id":"eb852e3d.3f91b","type":"http request","z":"19938199.71aa0e","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":1180,"y":260,"wires":[[]]},{"id":"99b6d1de.9d99d","type":"switch","z":"93dbee73.58db9","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":590,"y":300,"wires":[["610f6a15.682e74","6437d321.ac270c"],["1de08e8.d9be672"]]},{"id":"1de08e8.d9be672","type":"function","z":"93dbee73.58db9","name":"show error","func":"\n // end subsctract string code\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.tekospayload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": msg.payload.error,\n    \"msgtype\": \"m.text\",\n   \n}\n\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":264,"wires":[["1cd2b10a.57754f"]]},{"id":"1cd2b10a.57754f","type":"http request","z":"93dbee73.58db9","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":1226,"y":264,"wires":[["25d1dbae.a7c1c4"]]},{"id":"5d941081.d3bbc","type":"switch","z":"19938199.71aa0e","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":850,"y":260,"wires":[["9d286cd8.8720f","d0286247.f0614"],["ae5c4fde.87417","f5b17117.95159"]]},{"id":"ae5c4fde.87417","type":"function","z":"19938199.71aa0e","name":"show error","func":"\n // end subsctract string code\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.tekospayload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": msg.payload.error.message,\n    \"msgtype\": \"m.text\",\n   \n}\n\nreturn msg;","outputs":1,"noerr":0,"x":1010,"y":280,"wires":[["eb852e3d.3f91b"]]},{"id":"d0286247.f0614","type":"http response","z":"19938199.71aa0e","name":"","statusCode":"200","headers":{},"x":1000,"y":180,"wires":[]},{"id":"f5b17117.95159","type":"http response","z":"19938199.71aa0e","name":"","statusCode":"400","headers":{},"x":1020,"y":340,"wires":[]},{"id":"7b74e0be.604d5","type":"link out","z":"884a2e0c.927b5","name":"","links":["94fd1b08.d81308"],"x":355,"y":60,"wires":[]},{"id":"6cc1fdc4.9b9424","type":"link in","z":"884a2e0c.927b5","name":"","links":["c18c9939.e3eff8"],"x":540,"y":60,"wires":[[]]},{"id":"9dde0d15.38594","type":"function","z":"be1c0cd4.343a2","name":"start creation client","func":"node.warn(\"test env var\")\nnode.warn(msg)\n\nif((env.get(\"subdomain\")  && env.get(\"subscription\") )|| (msg.subdomain && msg.subscription)){\n    var clientname =  msg.subdomain || env.get(\"subdomain\")\n \n    var subscription = msg.subscription\n    msg.client = {};\n    msg.payload = clientname;\n    msg.clientname = clientname\n    msg.client.subscription = subscription;\n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":250,"y":80,"wires":[[],["867020aa.ac56a"]]},{"id":"4eb72780.02a6d8","type":"link in","z":"be1c0cd4.343a2","name":"","links":["15bcc60e.4f53aa"],"x":95,"y":160,"wires":[[]]},{"id":"867020aa.ac56a","type":"link out","z":"be1c0cd4.343a2","name":"","links":["1352e2de.c0241d"],"x":420,"y":100,"wires":[]},{"id":"d0ca8e30.4b10b","type":"switch","z":"be1c0cd4.343a2","name":"","property":"payload.ChangeInfo.Status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":754,"y":66,"wires":[["54c72188.343ce"],["47c96623.9ffe38"]]},{"id":"47c96623.9ffe38","type":"function","z":"be1c0cd4.343a2","name":"fail","func":"msg.payload = \"le domaine existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":908,"y":88,"wires":[["eb2f9954.bd8d28"]]},{"id":"54c72188.343ce","type":"function","z":"be1c0cd4.343a2","name":"success","func":"//msg.payload = \"le domaine \"+msg.clientname+\".tekos.co est creer\"\nmsg.payload.subdomain = msg.clientname;\nreturn msg;","outputs":1,"noerr":0,"x":896,"y":22,"wires":[["15bcc60e.4f53aa"]]},{"id":"15bcc60e.4f53aa","type":"link out","z":"be1c0cd4.343a2","name":"","links":["4eb72780.02a6d8"],"x":1005,"y":22,"wires":[]},{"id":"eb2f9954.bd8d28","type":"link out","z":"be1c0cd4.343a2","name":"","links":["1352e2de.c0241d"],"x":1005,"y":88,"wires":[]},{"id":"233cffa.3fabd","type":"switch","z":"be1c0cd4.343a2","name":"","property":"payload.TargetGroups[0].TargetGroupArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":470,"y":160,"wires":[["11299541.5e17bb"],["b32da2b4.afd38"]]},{"id":"b32da2b4.afd38","type":"function","z":"be1c0cd4.343a2","name":"fail","func":"msg.payload = \"erreur lors de la creation d'un target group : le groupe existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":610,"y":200,"wires":[["dd5648fe.c705c8"]]},{"id":"11299541.5e17bb","type":"link out","z":"be1c0cd4.343a2","name":"","links":["4cd6e8b9.45b2f8"],"x":595,"y":140,"wires":[]},{"id":"dd5648fe.c705c8","type":"link out","z":"be1c0cd4.343a2","name":"","links":["1352e2de.c0241d"],"x":735,"y":200,"wires":[]},{"id":"1f8519c.0ddbfe6","type":"link out","z":"be1c0cd4.343a2","name":"","links":["f9a8a24f.f0302"],"x":635,"y":280,"wires":[]},{"id":"1167f59c.819d5a","type":"function","z":"be1c0cd4.343a2","name":"return unique priotrity","func":"function getMissingNumber(nums) {\n    var swap = function(i, j) {\n        var tmp = nums[i];\n        nums[i] = nums[j];\n        nums[j] = tmp;\n    };\n\n    for (let i = 0; i < nums.length; i++) {\n        while (0 < nums[i] && nums[i] - 1 < nums.length && nums[i] != i + 1 && nums[i] != nums[nums[i] - 1]) {\n            swap(i, nums[i] - 1);\n        }\n    }\n\n    for (let i = 0; i < nums.length; i++) {\n        if (nums[i] != i + 1) {\n            return i + 1;\n        }\n    }\n    return nums.length + 1;\n}\n\n\nnode.warn(msg)\nmsg.subdomain = msg.subdomain\nvar allrules = msg.payload.Rules;\nvar priorities = [];\nfor(var i=0, len=allrules.length; i < len; i++){\n    let prio;\n    if(allrules[i].Priority == \"default\")\n    prio = 0\n    else\n    prio = Number(allrules[i].Priority)\n    priorities.push(prio)\n}\nvar firstMissingPositive = getMissingNumber(priorities)\nmsg.payload = firstMissingPositive\nmsg.targetgroup = msg.targetgroup;\n\nnode.warn(\"finish geting the smallest int\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":480,"y":280,"wires":[["1f8519c.0ddbfe6"]]},{"id":"4cd6e8b9.45b2f8","type":"link in","z":"be1c0cd4.343a2","name":"","links":["11299541.5e17bb"],"x":95,"y":280,"wires":[[]]},{"id":"1aa8d28f.1919ed","type":"switch","z":"be1c0cd4.343a2","name":"","property":"payload.service.serviceArn","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":460,"wires":[["555d8738.dcdac8"],["d3ec2d0b.508bd"]]},{"id":"d3ec2d0b.508bd","type":"link out","z":"be1c0cd4.343a2","name":"","links":["1352e2de.c0241d"],"x":795,"y":500,"wires":[]},{"id":"555d8738.dcdac8","type":"link out","z":"be1c0cd4.343a2","name":"","links":["c00756ae.cc6d18"],"x":795,"y":440,"wires":[]},{"id":"8b01a61b.d59d18","type":"link out","z":"be1c0cd4.343a2","name":"","links":["8413c5ed.f1ddd8"],"x":1135,"y":360,"wires":[]},{"id":"f9a8a24f.f0302","type":"link in","z":"be1c0cd4.343a2","name":"","links":["1f8519c.0ddbfe6"],"x":95,"y":360,"wires":[[]]},{"id":"8413c5ed.f1ddd8","type":"link in","z":"be1c0cd4.343a2","name":"","links":["8b01a61b.d59d18"],"x":95,"y":460,"wires":[[]]},{"id":"1352e2de.c0241d","type":"link in","z":"be1c0cd4.343a2","name":"","links":["d3ec2d0b.508bd","dd5648fe.c705c8","eb2f9954.bd8d28","867020aa.ac56a"],"x":411,"y":572,"wires":[[]]},{"id":"c00756ae.cc6d18","type":"link in","z":"be1c0cd4.343a2","name":"","links":["555d8738.dcdac8"],"x":587,"y":572,"wires":[[]]},{"id":"2d6adbe0.ddf1f4","type":"link in","z":"4f8bc972.b172e8","name":"","links":["fb1f0160.b2cb2","b077075e.d1e8c8","3160ad9c.9bfb52"],"x":345,"y":44,"wires":[[]]},{"id":"7dd51b6.6f069e4","type":"link in","z":"4f8bc972.b172e8","name":"","links":["dc56b899.4d3968"],"x":565,"y":44,"wires":[[]]},{"id":"971f697b.bacd78","type":"link out","z":"4f8bc972.b172e8","name":"","links":["f33cefa8.f74ea"],"x":389,"y":198,"wires":[]},{"id":"dc56b899.4d3968","type":"link out","z":"4f8bc972.b172e8","name":"","links":["7dd51b6.6f069e4"],"x":389,"y":242,"wires":[]},{"id":"fb1f0160.b2cb2","type":"link out","z":"4f8bc972.b172e8","name":"","links":["2d6adbe0.ddf1f4"],"x":389,"y":154,"wires":[]},{"id":"f33cefa8.f74ea","type":"link in","z":"4f8bc972.b172e8","name":"","links":["971f697b.bacd78"],"x":631,"y":198,"wires":[["4295fe96.2992e"]]},{"id":"4295fe96.2992e","type":"function","z":"4f8bc972.b172e8","name":"authorise email button","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/authorize/email/getuser\",\n\t\"data\":{data},\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":826,"y":198,"wires":[["496e99f2.463178"]]},{"id":"496e99f2.463178","type":"http request","z":"4f8bc972.b172e8","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1026,"y":198,"wires":[[]]},{"id":"8c46970f.efa468","type":"http in","z":"4f8bc972.b172e8","name":"","url":"/authorize/email/getuser","method":"post","upload":false,"swaggerDoc":"","x":142,"y":330,"wires":[["6d724951.46d7e8","8d5cc0d9.437f4"]]},{"id":"6d724951.46d7e8","type":"http response","z":"4f8bc972.b172e8","name":"OK","statusCode":"200","headers":{},"x":336,"y":374,"wires":[]},{"id":"8d5cc0d9.437f4","type":"function","z":"4f8bc972.b172e8","name":"set global data","func":"var sender = msg.payload.senderId.substring(\n    msg.payload.senderId.lastIndexOf(\"@\") + 1, \n    msg.payload.senderId.lastIndexOf(\":\")\n);\n  sender = sender.replace(\".\", \"_\");\nvar roomarray = [];\nroomarray.push(msg.payload.roomId);\nvar data = {\n    email:msg.payload.email,\n    rooms:roomarray,\n    senderId:msg.payload.senderId\n}\nmsg.tekos = data;\nmsg.tekos.sender = sender;\nglobal.set(sender,data);\nnode.warn(global.get(sender));\nreturn msg;","outputs":1,"noerr":0,"x":388,"y":330,"wires":[["35d2c5ac.c2a55a"]]},{"id":"35d2c5ac.c2a55a","type":"subflow:486d1d6e.dd5de4","z":"4f8bc972.b172e8","name":"","env":[],"x":636,"y":330,"wires":[["58495dc2.35c094","dae1ed14.e5ebb"],["a891d18a.6c6ca","dae1ed14.e5ebb"]]},{"id":"58495dc2.35c094","type":"function","z":"4f8bc972.b172e8","name":"set global data","func":"var sender = msg.tekos.sender;\nvar stripeId = msg.payload.data[0].id\nvar customer = msg.payload.data[0];\nif(customer.address){\n    if(customer.address.country){\n        global.set(sender+\".country\",customer.address.country);\n    }\n}\nglobal.set(sender+\".stripeId\",stripeId);\nmsg.payload = global.get(sender);\nreturn msg;","outputs":1,"noerr":0,"x":894,"y":308,"wires":[["b077075e.d1e8c8"]]},{"id":"a891d18a.6c6ca","type":"function","z":"4f8bc972.b172e8","name":"create customer","func":" msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nnode.warn(\"creating customer now\")  \nnode.warn(msg)\n    msg.url =\"https://api.stripe.com/v1/customers\";\n var dataString ='description=tekos account stripe customer&email='+msg.tekos.email+'&balance=0&metadata[tekos_id]='+msg.tekos.senderId+'&metadata[tekos_email]='+msg.tekos.email\n msg.payload = dataString;\n node.warn(dataString)\nreturn msg;","outputs":1,"noerr":0,"x":894,"y":352,"wires":[["b7a7f68f.465d08"]]},{"id":"b7a7f68f.465d08","type":"http request","z":"4f8bc972.b172e8","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1084,"y":352,"wires":[["4cf17a96.f61f84"]]},{"id":"b077075e.d1e8c8","type":"link out","z":"4f8bc972.b172e8","name":"","links":["2d6adbe0.ddf1f4"],"x":1049,"y":308,"wires":[]},{"id":"4cf17a96.f61f84","type":"function","z":"4f8bc972.b172e8","name":"set global data","func":"var sender = msg.tekos.sender;\nvar stripeId = msg.payload.id\nglobal.set(sender+\".stripeId\",stripeId);\nmsg.payload = global.get(sender);\nreturn msg;","outputs":1,"noerr":0,"x":1268,"y":352,"wires":[["3160ad9c.9bfb52"]]},{"id":"3160ad9c.9bfb52","type":"link out","z":"4f8bc972.b172e8","name":"","links":["2d6adbe0.ddf1f4"],"x":1401,"y":352,"wires":[]},{"id":"245928b4.6d29c8","type":"function","z":"ec000337.2949e","name":"fetch room","func":"if(!msg.roomId && msg.tekos){\n    msg.roomId = msg.tekos.rooms[msg.tekos.rooms.length -1];\n} \nreturn msg;","outputs":1,"noerr":0,"x":840,"y":286,"wires":[["3f4206cb.39764a"]]},{"id":"4dae2ab1.e19be4","type":"subflow:fde10ab5.552fe8","z":"ed261d7.da9a4e","name":"Event","env":[],"x":336,"y":198,"wires":[["69fb08ec.ad49d8"],["e96f0722.677d98"],["11bc45ba.04c3fa"],["c4e81a78.b16148"],[],[]]},{"id":"c50cad5a.322ab","type":"comment","z":"ed261d7.da9a4e","name":"Event Subscription","info":"","x":332,"y":22,"wires":[]},{"id":"d99f0aa2.a1f348","type":"http in","z":"fc68b1d2.502e3","name":"${endpoint}","url":"/env.get('endpoint')","method":"post","upload":true,"swaggerDoc":"","x":180,"y":132,"wires":[["bfc37b46.e1e208"]]},{"id":"bfc37b46.e1e208","type":"http response","z":"fc68b1d2.502e3","name":"","statusCode":"200","headers":{},"x":390,"y":88,"wires":[]},{"id":"f5cf4f27.304c3","type":"http request","z":"ed261d7.da9a4e","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":796,"y":198,"wires":[["a4cc6bf0.d2fbe8"]]},{"id":"cac1f101.d0fec","type":"function","z":"ed261d7.da9a4e","name":"","func":"msg.url = env.get('URL')\n//Header\nmsg.headers ={\n    //\"Authorization\" : \"Bearer \",\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\n//msg.payload={\n\n\n\n//}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":644,"y":198,"wires":[["f5cf4f27.304c3"]]},{"id":"41b116fe.3dbdb8","type":"link out","z":"8ba283a9.d5f58","name":"","links":["3c666965.d00e36"],"x":851,"y":154,"wires":[]},{"id":"cf510288.73f0b","type":"link out","z":"8ba283a9.d5f58","name":"","links":["3c666965.d00e36"],"x":521,"y":176,"wires":[]},{"id":"3c666965.d00e36","type":"link in","z":"8ba283a9.d5f58","name":"","links":["41b116fe.3dbdb8","cf510288.73f0b"],"x":763,"y":308,"wires":[[]]},{"id":"25d1dbae.a7c1c4","type":"debug","z":"93dbee73.58db9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1416,"y":264,"wires":[]},{"id":"20e27073.8aba6","type":"switch","z":"1df83760.b275d9","name":"","property":"serviceType","propertyType":"env","rules":[{"t":"eq","v":"chat","vt":"str"},{"t":"eq","v":"flow","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":1260,"y":110,"wires":[["6e64f222.9a23ac"],["3cfadc74.47d4a4"]]},{"id":"aa73335e.d6c0f","type":"function","z":"200a81ed.31baee","name":"get Subscription","func":"\nmsg.tekos = msg.payload;\nif(msg.subscription){\n    msg.sub = msg.subscription;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":344,"y":198,"wires":[["62aee7d1.1d1448"]]},{"id":"62aee7d1.1d1448","type":"subflow:486d1d6e.dd5de4","z":"200a81ed.31baee","name":"","env":[],"x":584,"y":198,"wires":[["1f1a69b0.709836","9f086dc5.dab25"],["64df075f.2ff218"]]},{"id":"1f1a69b0.709836","type":"link out","z":"200a81ed.31baee","name":"","links":["e4821cc9.3c2ef"],"x":779,"y":138,"wires":[]},{"id":"9f086dc5.dab25","type":"debug","z":"200a81ed.31baee","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":854,"y":178,"wires":[]},{"id":"e4821cc9.3c2ef","type":"link in","z":"200a81ed.31baee","name":"","links":["1f1a69b0.709836"],"x":259,"y":318,"wires":[["31d9f695.759aca"]]},{"id":"31d9f695.759aca","type":"function","z":"200a81ed.31baee","name":"Setup form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\nif(!msg.roomId){\n    msg.roomId = msg.payload.data[0].subscriptions.data[0].metadata.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nif(msg.sub){\n    subscriptionToken = msg.sub.id;\n    token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}else if(msg.customer){\n    subscriptionToken =  msg.customer.subscriptions.data[0].id\n     token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get(\"titleform\"),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/setup/server/\"+msg.roomId,\n    \"buttontitle\": env.get(\"buttontitle\"),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Subscription Token\",\n        \"key\": \"subscription\",\n        token\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Host name\",\n        \"key\": \"hostname\",\n          \"maxLength\": \"3\"\n      } ,\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<br><div><strong>One last step!</strong><div>In order to customize your experience, tell us a little about you</div><br><div>What is your company called?</div><div style='color:gray'>This will become the name of your first project. it will not be visible to your customers.</div></div>\",\n        \"key\": \"customize\",\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>What is your role ?<div  style='color:gray'>exp : ceo, developer, marketing, sales</div></div>\",\n        \"key\": \"role\",\n      },{\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>What are your top 3 goals for using Tekos ?<div  style='color:gray'>exp : automate workflows, create chatbots ..</div></div>\",\n        \"key\": \"gole\",\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":414,"y":318,"wires":[["30d6e3cb.e9ef7c"]],"icon":"node-red/debug.svg"},{"id":"30d6e3cb.e9ef7c","type":"http request","z":"200a81ed.31baee","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":584,"y":318,"wires":[["fe0a25fe.0c5628"]]},{"id":"fe0a25fe.0c5628","type":"debug","z":"200a81ed.31baee","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":734,"y":318,"wires":[]},{"id":"359f2ff7.517df","type":"link in","z":"200a81ed.31baee","name":"","links":["97dc2b1.72077d8"],"x":219,"y":198,"wires":[["aa73335e.d6c0f"]]},{"id":"64df075f.2ff218","type":"link out","z":"200a81ed.31baee","name":"","links":["793dee29.c4fc3"],"x":764,"y":218,"wires":[]},{"id":"97dc2b1.72077d8","type":"link out","z":"200a81ed.31baee","name":"","links":["359f2ff7.517df"],"x":301,"y":44,"wires":[]},{"id":"793dee29.c4fc3","type":"link in","z":"200a81ed.31baee","name":"","links":["64df075f.2ff218"],"x":484,"y":44,"wires":[[]]},{"id":"fb955f17.af02","type":"link in","z":"200a81ed.31baee","name":"","links":[],"x":697,"y":44,"wires":[[]]},{"id":"8ac25811.4a8e28","type":"function","z":"4f8bc972.b172e8","name":"verify payload","func":"function arrayContains(needle, arrhaystack)\n{\n    return (arrhaystack.indexOf(needle) > -1);\n}\nif(!msg.senderId && !msg.roomId){\n    node.error('senderId is missing as in params');\n    return [null,null,msg];\n}\nelse{\n     var sender = msg.senderId.substring(\n    msg.senderId.lastIndexOf(\"@\") + 1, \n    msg.senderId.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    \n\n    if(global.get(sender)){\n        if(msg.event){\n      var currentroom = msg.event.event.room_id;\n       global.set(sender+'.roomId',currentroom);\n       msg.roomId = currentroom;\n    }\n        node.warn('global found for this user')\n        var rooms = global.get(sender).rooms;\n        if(!arrayContains(msg.roomId,rooms)){\n            rooms.push(msg.roomId);\n            global.set(sender+'.rooms',rooms);\n        }\n        node.warn(global.get(sender));\n        msg.payload = global.get(sender);\n        msg.tekos = msg.payload;\n     \n        \n        return [msg,null,null];\n\n    }else{\n        node.warn(\"no global for this user found\");\n        return [null,msg,null];\n\n    }\n    \n}\n","outputs":3,"noerr":0,"x":234,"y":198,"wires":[["fb1f0160.b2cb2"],["971f697b.bacd78"],["dc56b899.4d3968"]]},{"id":"75bb4ed.11bb0b","type":"function","z":"2e62cdcc.f5cc32","name":"fetch room from metadata","func":"msg.roomId = msg.intent.data.object.metadata.roomId;\nreturn msg;","outputs":1,"noerr":0,"x":792,"y":352,"wires":[["5a8262fe.8875ac"]]},{"id":"710333f9.c4305c","type":"link out","z":"ec000337.2949e","name":"","links":["a85441bc.71a6f"],"x":1115,"y":198,"wires":[]},{"id":"a85441bc.71a6f","type":"link in","z":"ec000337.2949e","name":"","links":["710333f9.c4305c"],"x":220,"y":440,"wires":[["1ef24390.2bc84c"]]},{"id":"1ef24390.2bc84c","type":"switch","z":"ec000337.2949e","name":"","property":"service","propertyType":"env","rules":[{"t":"eq","v":"chat","vt":"str"},{"t":"eq","v":"flow","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":352,"y":440,"wires":[["acb4a834.792df8","d21c316f.df956"],["9f705f1c.009c7","8d55f179.a12ae"]]},{"id":"acb4a834.792df8","type":"chatbot-text","z":"ec000337.2949e","name":"no subscriptions","message":[{"message":"You have no active instances under this plan."}],"x":520,"y":418,"wires":[["69faaf85.f4703"]]},{"id":"7e1676c.47ca488","type":"chatbot-generic-buttons","z":"ec000337.2949e","name":"","buttons":[{"type":"postback","label":"Subscribe to chat client","value":"chat plans","alert":false}],"message":"Do you want to subscribe? ","x":654,"y":462,"wires":[["69faaf85.f4703"]]},{"id":"69faaf85.f4703","type":"link out","z":"ec000337.2949e","name":"","links":["c3e74c5.3ed7fb"],"x":785,"y":418,"wires":[]},{"id":"c3e74c5.3ed7fb","type":"link in","z":"ec000337.2949e","name":"","links":["69faaf85.f4703"],"x":1078,"y":352,"wires":[[]]},{"id":"d21c316f.df956","type":"delay","z":"ec000337.2949e","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":500,"y":462,"wires":[["7e1676c.47ca488"]]},{"id":"bbf2dccb.e5f9a","type":"function","z":"884a2e0c.927b5","name":"get Subscription","func":"node.warn(\"start constat\");\nmsg.tekos = msg.payload;\nif(msg.subscription){\n    msg.sub = msg.subscription;\n}\n\n\nreturn msg;","outputs":1,"noerr":0,"x":278,"y":198,"wires":[["ee95330f.093fb"]]},{"id":"ee95330f.093fb","type":"subflow:486d1d6e.dd5de4","z":"884a2e0c.927b5","name":"","env":[],"x":518,"y":198,"wires":[["7a656c5e.8aecb4","b639b645.dd0d28"],["8e6c3b5a.11f6f8"]]},{"id":"7a656c5e.8aecb4","type":"link out","z":"884a2e0c.927b5","name":"","links":["9c9b46a1.f35a28"],"x":713,"y":138,"wires":[]},{"id":"b639b645.dd0d28","type":"debug","z":"884a2e0c.927b5","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":788,"y":178,"wires":[]},{"id":"9c9b46a1.f35a28","type":"link in","z":"884a2e0c.927b5","name":"","links":["7a656c5e.8aecb4"],"x":193,"y":318,"wires":[["2596f01f.42942"]]},{"id":"2596f01f.42942","type":"function","z":"884a2e0c.927b5","name":"Setup form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\nmsg.payload = msg.payload;\nif(!msg.roomId){\n    msg.roomId = msg.payload.data[0].subscriptions.data[0].metadata.roomId;\n}\nvar subscriptionToken = \"\";\nvar token ={};\nif(msg.sub){\n    subscriptionToken = msg.sub.id;\n    token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}else if(msg.customer){\n    subscriptionToken =  msg.customer.subscriptions.data[0].id\n     token = {\n         \"defaultValue\":subscriptionToken,\n         \"disabled\":true\n    }\n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':env.get(\"titleform\"),\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/billing/setup/server/\"+msg.roomId,\n    \"buttontitle\": env.get(\"buttontitle\"),\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Subscription Token</div><div style='color:gray;' >Your subscription token is the unique id that identify you subscrption plan</div>\",\n        \"key\": \"subscription\",\n        \"required\":true,\n        token\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"<div>Host name</div><div style='color:gray;'>Your host name will be the subdomain of your instance client app, you can access your chat client later with the url 'mycoolapp<b>.tekos.co</b>'</div>\",\n        \"key\": \"hostname\",\n         \"maxLength\": \"3\",\n         \"required\":true,\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":348,"y":318,"wires":[["34cb171c.592f38"]],"icon":"node-red/debug.svg"},{"id":"34cb171c.592f38","type":"http request","z":"884a2e0c.927b5","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":518,"y":318,"wires":[["24008c6b.96c704"]]},{"id":"24008c6b.96c704","type":"debug","z":"884a2e0c.927b5","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":668,"y":318,"wires":[]},{"id":"94fd1b08.d81308","type":"link in","z":"884a2e0c.927b5","name":"","links":["7b74e0be.604d5"],"x":153,"y":198,"wires":[["bbf2dccb.e5f9a"]]},{"id":"5199c9c3.767428","type":"link out","z":"884a2e0c.927b5","name":"","links":["fcdadb4c.375ca8"],"x":829,"y":242,"wires":[]},{"id":"8b44dc9c.b595","type":"http in","z":"884a2e0c.927b5","name":"setup instance","url":"/billing/setup/server/:roomId","method":"post","upload":false,"swaggerDoc":"","x":158,"y":440,"wires":[["1811afb6.1069c"]]},{"id":"cfbed464.6c9798","type":"http response","z":"884a2e0c.927b5","name":"200","statusCode":"200","headers":{},"x":490,"y":374,"wires":[]},{"id":"ece1dd5b.7f37d","type":"function","z":"884a2e0c.927b5","name":"Analyse subscription","func":"function isEmpty(obj) {\n    for(var key in obj) {\n        if(obj.hasOwnProperty(key))\n            return false;\n    }\n    return true;\n}\nvar sub = msg.payload;\n\nif(isEmpty(sub.metadata.instance)){\n    node.warn(\"instance is empty\")\n   msg.client.sub = msg.payload;\n    return [msg,null];\n}else{\n      node.warn(\"instance exist\")\n      msg.payload=401;\n  \n      return [null,msg]\n}\n\n","outputs":2,"noerr":0,"x":858,"y":420,"wires":[["2e642e1b.480932","69b4f608.1d6668"],["ec5eb621.de2ae8"]]},{"id":"2e642e1b.480932","type":"link out","z":"884a2e0c.927b5","name":"","links":["b3bc3168.1182a","edb40d19.02d98"],"x":1027,"y":396,"wires":[]},{"id":"1811afb6.1069c","type":"function","z":"884a2e0c.927b5","name":"Validator","func":"function validURL(str) {\n  var pattern = new RegExp('^(https?:\\\\/\\\\/)?'+ // protocol\n    '((([a-z\\\\d]([a-z\\\\d-]*[a-z\\\\d])*)\\\\.)+[a-z]{2,}|'+ // domain name\n    '((\\\\d{1,3}\\\\.){3}\\\\d{1,3}))'+ // OR ip (v4) address\n    '(\\\\:\\\\d+)?(\\\\/[-a-z\\\\d%_.~+]*)*'+ // port and path\n    '(\\\\?[;&a-z\\\\d%_.~+=-]*)?'+ // query string\n    '(\\\\#[-a-z\\\\d_]*)?$','i'); // fragment locator\n  return !!pattern.test(str);\n}\nnode.warn(msg)\nvar reponse = msg.payload\nformat = /[ !@#$%^&*()_+\\=\\[\\]{};':\"\\\\|,.<>\\/?]/;\nvar hostname = reponse.hostname;\nif(format.test(hostname) && !validURL(\"https://\"+hostname+\".tekos.co\")){\n    node.warn(\"false host\");\n   msg.payload.error = \"A hostname can only contain lower case letters, numbers and '=_-./'\"\n    \n    return[null,msg] ;\n}\nelse{\n   node.log(\"true\")\n    msg.client = msg.payload;\n    return[msg,null]\n}\nreturn msg;","outputs":2,"noerr":0,"x":318,"y":440,"wires":[["a56df99a.775718","cfbed464.6c9798"],["7072008c.9ec23"]],"icon":"font-awesome/fa-check-circle"},{"id":"7072008c.9ec23","type":"http response","z":"884a2e0c.927b5","name":"404","statusCode":"404","headers":{},"x":488,"y":500,"wires":[]},{"id":"a56df99a.775718","type":"subflow:c3e6c8de.a6ec88","z":"884a2e0c.927b5","name":"","env":[{"name":"update","value":"false","type":"str"}],"x":578,"y":440,"wires":[["ece1dd5b.7f37d"],["cc6d7833.196988"]]},{"id":"cc6d7833.196988","type":"link out","z":"884a2e0c.927b5","name":"","links":["fcdadb4c.375ca8"],"x":773,"y":460,"wires":[]},{"id":"96ad95ff.c39428","type":"link out","z":"884a2e0c.927b5","name":"","links":["fcdadb4c.375ca8"],"x":1115,"y":506,"wires":[]},{"id":"fcdadb4c.375ca8","type":"link in","z":"884a2e0c.927b5","name":"","links":["cc6d7833.196988","96ad95ff.c39428","5199c9c3.767428","297889d5.f0a776"],"x":543,"y":110,"wires":[[]]},{"id":"69b4f608.1d6668","type":"debug","z":"884a2e0c.927b5","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":996,"y":330,"wires":[]},{"id":"e1cdd6e9.659438","type":"function","z":"884a2e0c.927b5","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"the customer \"+msg.client.sub.customer+\" had requested a new HomeServer Instant\",\n    to:env.get(\"emailTo\")\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":542,"y":594,"wires":[[]]},{"id":"8c26d809.3352e8","type":"template","z":"884a2e0c.927b5","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{payload.style}}\n    </style>\n</head>\n\n\n<body>\n    <h3>Tekos Hosted HomeServer Subscription Request</h3>\n    <p>Client : {{client.senderId}}</p>\n    <p>Stripe Account : {{payload.customer}}</p>\n    <p>hostname requested : {{client.hostname}}</p>\n    <p>Room ID: {{client.roomId}}</p>\n    <p>Subscription ID: {{client.subscription}}</p>\n    <p>Company Name: {{client.customize}}</p>\n    <p>Role: {{client.role}}</p>\n    <p>Gole: {{client.gole}}</p>\n</body>","x":372,"y":594,"wires":[["e1cdd6e9.659438"]]},{"id":"edeaa300.154bc","type":"template","z":"884a2e0c.927b5","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":232,"y":594,"wires":[["8c26d809.3352e8"]]},{"id":"edb40d19.02d98","type":"link in","z":"884a2e0c.927b5","name":"","links":["2e642e1b.480932"],"x":125,"y":594,"wires":[["edeaa300.154bc"]]},{"id":"b3bc3168.1182a","type":"link in","z":"884a2e0c.927b5","name":"","links":["2e642e1b.480932"],"x":125,"y":682,"wires":[["caf0d92a.26a418"]]},{"id":"caf0d92a.26a418","type":"function","z":"884a2e0c.927b5","name":"update Subscription metadata","func":"msg.headers ={\n    \"Authorization\" : \"Bearer sk_test_fY14VeGn3yvgxSPpmsuyt5pB\",\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n    msg.url =\"https://api.stripe.com/v1/subscriptions/\"+msg.payload.id\n    var dataString = \"metadata[subdomaine]=\"+msg.client.hostname+\"&metadata[instance]=starting&metadata[company]=\"+msg.client.customize+\"&metadata[role]=\"+msg.client.role+\"&metadata[gole]=\"+msg.client.gole;\n   msg.payload = dataString;\n    return msg;\n","outputs":1,"noerr":0,"x":300,"y":682,"wires":[["506bac52.fe8564"]]},{"id":"506bac52.fe8564","type":"http request","z":"884a2e0c.927b5","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"bearer","x":540,"y":682,"wires":[["72d7b7d1.264828","cef98959.c77078"]]},{"id":"72d7b7d1.264828","type":"debug","z":"884a2e0c.927b5","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":710,"y":682,"wires":[]},{"id":"8e6c3b5a.11f6f8","type":"change","z":"884a2e0c.927b5","name":"402","rules":[{"t":"set","p":"payload","pt":"msg","to":"402","tot":"num"}],"action":"","property":"","from":"","to":"","reg":false,"x":732,"y":242,"wires":[["5199c9c3.767428"]]},{"id":"ec5eb621.de2ae8","type":"change","z":"884a2e0c.927b5","name":"401","rules":[{"t":"set","p":"payload","pt":"msg","to":"401","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1018,"y":506,"wires":[["96ad95ff.c39428"]]},{"id":"cef98959.c77078","type":"switch","z":"884a2e0c.927b5","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":726,"y":748,"wires":[["84363cda.007a4"],["5f2768fb.a16658"]]},{"id":"5f2768fb.a16658","type":"change","z":"884a2e0c.927b5","name":"404","rules":[{"t":"set","p":"payload","pt":"msg","to":"404","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":864,"y":792,"wires":[["297889d5.f0a776"]]},{"id":"2796128.4d178ee","type":"change","z":"884a2e0c.927b5","name":"200","rules":[{"t":"set","p":"payload","pt":"msg","to":"401","tot":"str"}],"action":"","property":"","from":"","to":"","reg":false,"x":1040,"y":726,"wires":[["c18c9939.e3eff8"]]},{"id":"c18c9939.e3eff8","type":"link out","z":"884a2e0c.927b5","name":"","links":["6cc1fdc4.9b9424"],"x":1137,"y":726,"wires":[]},{"id":"297889d5.f0a776","type":"link out","z":"884a2e0c.927b5","name":"","links":["fcdadb4c.375ca8"],"x":983,"y":792,"wires":[]},{"id":"84363cda.007a4","type":"function","z":"884a2e0c.927b5","name":"fetch roomId","func":"if(msg.payload.metadata.roomId){\n    msg.roomId = msg.payload.metadata.roomId;\n}\nreturn msg;","outputs":1,"noerr":0,"x":884,"y":726,"wires":[["2796128.4d178ee"]]},{"id":"dbf8ceed.9061f","type":"subflow:8ba283a9.d5f58","z":"1a282f04.66edf1","name":"","env":[],"x":494,"y":88,"wires":[["dbeab1dc.4ab4b","3bc33444.a7465c"],[]]},{"id":"7dcdc844.885d78","type":"http request","z":"52c3ea26.423dc4","name":"TEKOS API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":642,"y":66,"wires":[["12e3f4f.35a780b"]]},{"id":"12e3f4f.35a780b","type":"debug","z":"52c3ea26.423dc4","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":798,"y":66,"wires":[]},{"id":"e7cb6f36.69812","type":"http response","z":"52c3ea26.423dc4","name":"404","statusCode":"404","headers":{},"x":380,"y":528,"wires":[]},{"id":"bb3ccebb.f89e4","type":"link in","z":"52c3ea26.423dc4","name":"","links":["31366499.399f9c"],"x":279,"y":110,"wires":[[]]},{"id":"a4cc6bf0.d2fbe8","type":"debug","z":"ed261d7.da9a4e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":950,"y":198,"wires":[]},{"id":"69fb08ec.ad49d8","type":"switch","z":"ed261d7.da9a4e","name":"","property":"new_interaction","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":110,"wires":[["cac1f101.d0fec"]]},{"id":"11bc45ba.04c3fa","type":"switch","z":"ed261d7.da9a4e","name":"","property":"direct_message","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":198,"wires":[["cac1f101.d0fec"]]},{"id":"e96f0722.677d98","type":"switch","z":"ed261d7.da9a4e","name":"","property":"public_message","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":154,"wires":[["cac1f101.d0fec"]]},{"id":"c4e81a78.b16148","type":"switch","z":"ed261d7.da9a4e","name":"","property":"file","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":242,"wires":[["cac1f101.d0fec"]]},{"id":"3d5b3022.7b1be","type":"http request","z":"c47f16f1.a03068","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":1324,"y":44,"wires":[["ae3708a9.27f3b8"]]},{"id":"c6ad4c7e.75889","type":"function","z":"c47f16f1.a03068","name":"get country","func":"msg.url = \"https://restcountries.eu/rest/v2/alpha/\"+msg.customer.address.country\nreturn msg;","outputs":1,"noerr":0,"x":1170,"y":44,"wires":[["3d5b3022.7b1be"]]},{"id":"ef6e2c29.40ed4","type":"link out","z":"c47f16f1.a03068","name":"","links":["a6dae51e.8c4838"],"x":1753,"y":44,"wires":[]},{"id":"a6dae51e.8c4838","type":"link in","z":"c47f16f1.a03068","name":"","links":["75f2bc79.16b0b4","9ff5a17d.38d57","ef6e2c29.40ed4"],"x":902,"y":572,"wires":[["35ce43d.61c30bc"]]},{"id":"75f2bc79.16b0b4","type":"link out","z":"c47f16f1.a03068","name":"","links":["a6dae51e.8c4838"],"x":1115,"y":88,"wires":[]},{"id":"8faedcb9.7e29c","type":"function","z":"c47f16f1.a03068","name":"set country","func":"var count = msg.payload.name\nmsg.customer.address.country = count;\nreturn msg;","outputs":1,"noerr":0,"x":1632,"y":44,"wires":[["ef6e2c29.40ed4"]]},{"id":"ae3708a9.27f3b8","type":"switch","z":"c47f16f1.a03068","name":"","property":"payload.name","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1480,"y":44,"wires":[["8faedcb9.7e29c"],["9ff5a17d.38d57"]]},{"id":"9ff5a17d.38d57","type":"link out","z":"c47f16f1.a03068","name":"","links":["a6dae51e.8c4838"],"x":1555,"y":88,"wires":[]},{"id":"8d55f179.a12ae","type":"chatbot-text","z":"ec000337.2949e","name":"no subscriptions","message":[{"message":"You have no active flow instances."}],"x":520,"y":506,"wires":[["69faaf85.f4703"]]},{"id":"9f705f1c.009c7","type":"delay","z":"ec000337.2949e","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":478,"y":550,"wires":[["bb2c3f52.5803c"]]},{"id":"bb2c3f52.5803c","type":"chatbot-generic-buttons","z":"ec000337.2949e","name":"","buttons":[{"type":"postback","label":"subscribe to flow","value":"subscribe to flow","alert":false}],"message":"Do you want to subscribe? ","x":632,"y":550,"wires":[["69faaf85.f4703"]]},{"id":"e9a1f99c.1175a8","type":"switch","z":"d97495d8.5a8468","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":330,"wires":[[],["54edee0d.6b158"]]},{"id":"54edee0d.6b158","type":"link out","z":"d97495d8.5a8468","name":"","links":["dc3ad172.511d"],"x":499,"y":352,"wires":[]},{"id":"7e8b7788.0ff1c8","type":"switch","z":"d97495d8.5a8468","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":754,"y":308,"wires":[[],["799bb4a8.80d44c"]]},{"id":"799bb4a8.80d44c","type":"link out","z":"d97495d8.5a8468","name":"","links":["dc3ad172.511d"],"x":851,"y":352,"wires":[]},{"id":"89fc5d1e.4f3ef","type":"link out","z":"6b38c6c9.48c0b8","name":"","links":[],"x":418,"y":66,"wires":[]},{"id":"531cd547.a36cfc","type":"function","z":"6b38c6c9.48c0b8","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\n\nnode.warn(env.get(\"host\"));\nnode.warn(env.get(\"username\"));\nnode.warn(env.get(\"port\"));\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nmsg={\n    payload:msg.payload,\n    topic:\"the customer \"+msg.subscription.customer+\" had canceled his subscription \"+msg.subscription.id,\n    to:\"ayoub@tekos.co,support@tekos.co\"\n   \n};\n\n\nreturn msg;","outputs":1,"noerr":0,"x":472.00000381469727,"y":242,"wires":[[]]},{"id":"41656937.c9b2a8","type":"template","z":"6b38c6c9.48c0b8","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n    <h3>An error has occured while creating an instance</h3>\n    <p>Type:: </p>\n    <p>Customer Tekos ID:</p>\n    <p>Customer Stripe ID:</p>\n    <p>Instance Type:</p>\n    <p>Subscription ID:</p>\n    <p>\n      Technincal aws error:\n    </p>\n</body>","x":688.9999885559082,"y":183.99999046325684,"wires":[["531cd547.a36cfc"]]},{"id":"f28307c2.02e228","type":"template","z":"6b38c6c9.48c0b8","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":548.9999885559082,"y":183.99999046325684,"wires":[["41656937.c9b2a8"]]},{"id":"31f2e704.f7ad88","type":"function","z":"6b38c6c9.48c0b8","name":"send mail","func":"msg.subscription = msg.payload;\nmsg.payload.why = msg.why\nreturn msg;","outputs":1,"noerr":0,"x":418.9999885559082,"y":183.99999046325684,"wires":[["f28307c2.02e228"]]},{"id":"77682368.bbdc0c","type":"link in","z":"6b38c6c9.48c0b8","name":"","links":[],"x":279,"y":176,"wires":[["31f2e704.f7ad88"]]},{"id":"6a319e59.ecc12","type":"function","z":"9ba31db0.f17c6","name":"get github repo","func":"node.warn(\"start deploying process\");\nvar username,repo\nif(!msg.repo && !msg.username){\n   var gitrepo = msg.payload.split(' ')[2];\n username =  gitrepo.split('/')[3];\n repo = gitrepo.split('/')[4];\nmsg.repo = repo;\nmsg.username = username;\nnode.warn(gitrepo);\nnode.warn(username);\nnode.warn(repo); \n}else{\n    repo = msg.repo;\n    username = msg.username;\n}\n\nif(username && repo ){\n    msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\n    msg.url = \"https://api.github.com/repos/\"+username+\"/\"+repo+\"/contents\"\n    return [msg,null];\n}else{\n    return[null,msg]\n}\n//if(repo.includes(\"\"))\n","outputs":2,"noerr":0,"x":366,"y":110,"wires":[["630dbafd.450534"],["54a171f5.2537b"]]},{"id":"630dbafd.450534","type":"http request","z":"9ba31db0.f17c6","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":554,"y":88,"wires":[["2d638e16.372f72","87b998ce.d100f8"]]},{"id":"dded6fa9.c4b1a","type":"link in","z":"9ba31db0.f17c6","name":"","links":["efae0b9f.584258"],"x":785,"y":418,"wires":[[]]},{"id":"7370a59b.acee6c","type":"link in","z":"9ba31db0.f17c6","name":"","links":["54a171f5.2537b","aa58f1b9.d4e79","b94401b.f64ef","5419c487.018ffc"],"x":946,"y":418,"wires":[[]]},{"id":"54a171f5.2537b","type":"link out","z":"9ba31db0.f17c6","name":"","links":["7370a59b.acee6c"],"x":521,"y":176,"wires":[]},{"id":"2d638e16.372f72","type":"switch","z":"9ba31db0.f17c6","name":"","property":"payload[0].name","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":710,"y":88,"wires":[["f00c9513.ac9f98"],["b94401b.f64ef"]]},{"id":"f00c9513.ac9f98","type":"function","z":"9ba31db0.f17c6","name":"parse data","func":"msg.gitrepo = msg.payload;\nlet tekosapp = false;\nfor(let i=0;i<msg.payload.length;i++){\n    if(msg.payload[i].name == \"tekos-app.json\"){\n       tekosapp = true\n   }\n}\nif(tekosapp){\n    node.warn(\"success file found\");\n    return [msg,null];\n}else{\n    node.warn(\"failed file found\");\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":862,"y":66,"wires":[["c1905e0d.20e69"],["aa58f1b9.d4e79"]]},{"id":"aa58f1b9.d4e79","type":"link out","z":"9ba31db0.f17c6","name":"","links":["7370a59b.acee6c"],"x":983,"y":88,"wires":[]},{"id":"b94401b.f64ef","type":"link out","z":"9ba31db0.f17c6","name":"","links":["7370a59b.acee6c"],"x":807,"y":110,"wires":[]},{"id":"3040a923.e85016","type":"function","z":"9ba31db0.f17c6","name":"get tekos-app.json","func":"\nvar tekosapp = msg.gitrepo.filter(obj => {\n  return obj.name === \"tekos-app.json\"\n})\nmsg.tekosApp = tekosapp[0];\nnode.warn(tekosapp);\n    msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\nmsg.url = tekosapp[0].download_url;\n\nreturn msg;","outputs":1,"noerr":0,"x":332,"y":264,"wires":[["5ebae68.ae9e018"]]},{"id":"f7a1af98.f314d","type":"link in","z":"9ba31db0.f17c6","name":"","links":["c1905e0d.20e69"],"x":191,"y":264,"wires":[["3040a923.e85016"]]},{"id":"c1905e0d.20e69","type":"link out","z":"9ba31db0.f17c6","name":"","links":["f7a1af98.f314d"],"x":983,"y":44,"wires":[]},{"id":"5ebae68.ae9e018","type":"http request","z":"9ba31db0.f17c6","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":532,"y":264,"wires":[["25e64dc4.15d8d2","72f9d571.f0f28c"]]},{"id":"25e64dc4.15d8d2","type":"function","z":"9ba31db0.f17c6","name":"get card","func":"\n\nvar elementsY = [];\nvar filefound = false;\nfor(let i=0;i<msg.payload.length;i++){\n    for(let j = 0;j<msg.gitrepo.length;j++){\n        if(msg.payload[i]['flow-file'] == msg.gitrepo[j].name){\n            filefound = true\n            node.warn(\"yes file found\");\n            break;\n        }else{\n            filefound = false;\n        }\n    }\n   \n    var template = msg.payload[i];\n    var keywords =\"\";\nif(template.keywords){\n    for(let i=0;i<template.keywords.length;i++){\n        keywords += \"<div style='display: inline-block;min-width: .5rem;padding: 2px 10px;border-radius: 10px;text-align: center;background: #f2f5f8;color: gray;margin-top:5px;margin-right:5px'>\"+template.keywords[i]+\"</div>\";\n    }\n}\n\nkeywords = \"<div style='display: flex;font-size:10px; flex-wrap: wrap;'>\"+keywords+\"</div>\";\nvar card = {\n    \"title\": template.name,\n    \"subtitle\":\"<div>\"+template.description+\"</div>\"+keywords,\n    \"buttons\": \n        [\n            {\n                \"type\": \"url\",\n                \"label\": \"Learn More\",\n                \"url\":   template.website,\n                \"alert\": false\n            },\n            /*{\n                \"type\": \"request_url_only\",\n                \"label\": \"Deploy to an existing instance\",\n                \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/github/deploy/existing/\"+msg.username+\"/\"+msg.repo+\"/\"+template['flow-file']+\"/\"+template.name,\n                \"alert\": false\n            },*/\n            {\n                \"type\": \"request_url_only\",\n                \"label\": \"Deploy to a new instance\",\n                \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/github/deploy/new/\"+msg.username+\"/\"+msg.repo+\"/\"+template['flow-file']+\"/\"+template.name,\n                \"alert\": false\n            }\n        ]\n    }\n    elementsY.push(card);\n\n}\nif(!filefound){\n    node.warn(\"no file found\");\n    return[null,msg]\n}else{\n    node.warn(\"file found\");\n    msg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn [msg,null];\n}\n\n","outputs":2,"noerr":0,"x":720,"y":264,"wires":[["efae0b9f.584258","28bd67f7.11e788"],["5419c487.018ffc","28bd67f7.11e788"]]},{"id":"efae0b9f.584258","type":"link out","z":"9ba31db0.f17c6","name":"","links":["dded6fa9.c4b1a"],"x":851,"y":220,"wires":[]},{"id":"72f9d571.f0f28c","type":"debug","z":"9ba31db0.f17c6","name":"raw data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":698,"y":330,"wires":[]},{"id":"cff6b2a5.724f4","type":"function","z":"1a282f04.66edf1","name":"Template ?","func":"var data;\nif(msg.tekos){\n    if(msg.tekos.sender){\n        \n         data = global.get(msg.tekos.sender);\n        if(data.template){\n            msg.form = msg.payload;\n            msg.repo = data.template.repo;\n            msg.username = data.template.user;\n            msg.templateName = data.template.name;\n        return[msg,null]\n\n        }else{\n            return [null,msg];\n        }\n    \n    }else if(msg.tekos.metadata.tekos_id){\n        let tekosid =  msg.tekos.metadata.tekos_id\n        var sender = tekosid.substring(\n        tekosid.lastIndexOf(\"@\") + 1, \n        tekosid.lastIndexOf(\":\")\n        );\n        sender = sender.replace(\".\", \"_\");\n        data = global.get(sender);\n        if(data.template){\n            msg.form = msg.payload;\n            msg.repo = data.template.repo;\n            msg.username = data.template.user;\n            msg.templateName = data.template.name;\n        return[msg,null]\n\n        }else{\n            return [null,msg];\n        }\n    }else{\n        return [null,msg];\n    }\n}else{\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":510,"y":220,"wires":[["481723ea.e81dec"],["ddca597b.a2c8b8"]]},{"id":"481723ea.e81dec","type":"subflow:9ba31db0.f17c6","z":"1a282f04.66edf1","name":"","env":[],"x":748,"y":198,"wires":[[],[],["676025c1.9c8eac"]]},{"id":"676025c1.9c8eac","type":"function","z":"1a282f04.66edf1","name":"update template","func":"var alltemplates = msg.payload;\nmsg.payload = msg.form;\nvar chosentemplate = { \n    \n        \"type\": \"select\",\n        \"subtype\": \"select\",\n        \"label\": \"<div>Flow template</div><div style='color:gray;'>Choose one of the default template that comes with the tekos flow instance, if you have already selected a third party template then leave this select box empty</div>\",\n        \"key\": \"template\",\n        \"required\":true,\n        \"options\":[]\n    \n}\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nfor(let i=0;i<alltemplates.length;i++){\n   var repository = alltemplates[i].repository.split(/[//]/);\n    let repo = repository[4];\n    let user = repository[3];\n    let template = alltemplates[i]['flow-file'];\n    let alltemp = {}\n    alltemp.user = user;\n    alltemp.repo = repo;\n    alltemp.template = template;\n    alltemp.name = alltemplates[i].name.trim()\n    chosentemplate.options.push({\n        \"value\":alltemp,\n        \"label\":alltemplates[i].name.trim(),\n    })\n}\nmsg.payload.tekosform.push(chosentemplate);\n\nreturn msg;","outputs":1,"noerr":0,"x":982,"y":198,"wires":[["68c29a90.025364","908a8311.1dbba"]]},{"id":"68c29a90.025364","type":"debug","z":"1a282f04.66edf1","name":"choosen template","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1102,"y":242,"wires":[]},{"id":"701f3700.0afdb8","type":"link in","z":"1a282f04.66edf1","name":"","links":["908a8311.1dbba"],"x":851,"y":308,"wires":[["26003965.7bda16"]]},{"id":"908a8311.1dbba","type":"link out","z":"1a282f04.66edf1","name":"","links":["701f3700.0afdb8"],"x":1122,"y":154,"wires":[]},{"id":"87b998ce.d100f8","type":"debug","z":"9ba31db0.f17c6","name":"raw data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":720,"y":154,"wires":[]},{"id":"5419c487.018ffc","type":"link out","z":"9ba31db0.f17c6","name":"","links":["7370a59b.acee6c"],"x":829,"y":286,"wires":[]},{"id":"28bd67f7.11e788","type":"debug","z":"9ba31db0.f17c6","name":"raw data","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":962,"y":264,"wires":[]},{"id":"dbef7d4e.bbd14","type":"function","z":"5f9338e7.a36538","name":"start creation flow","func":"node.warn(\"test env var\")\nnode.warn(msg)\n\n\nif(env.get(\"subdomain\")&& env.get(\"subscription\") || (msg.subdomain   && msg.subscription)){\n    var clientname = env.get(\"subdomain\") || msg.subdomain\n   \n    var subscription = msg.subscription\n    msg.payload = clientname;\n    msg.clientname = clientname\n    msg.subscription  =subscription\n\n    return [msg,null];\n}else{\n    node.warn(\"step 1 failed\");\n    msg.payload = \"one or more required parameters is/are missing!\";\n    return [null,msg];\n}\n","outputs":2,"noerr":0,"x":222,"y":110,"wires":[[],["d1e39e6d.3ebe3"]]},{"id":"5634b74b.777418","type":"switch","z":"5f9338e7.a36538","name":"","property":"payload.ChangeInfo.Status","propertyType":"msg","rules":[{"t":"eq","v":"PENDING","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":702,"y":70,"wires":[["525ca40a.00759c"],["c1511b.34fa6ee8"]]},{"id":"c1511b.34fa6ee8","type":"function","z":"5f9338e7.a36538","name":"fail","func":"msg.payload = \"le domaine existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":864,"y":110,"wires":[[]]},{"id":"525ca40a.00759c","type":"function","z":"5f9338e7.a36538","name":"success","func":"//msg.payload = \"le domaine \"+msg.clientname+\".tekos.co est creer\"\nmsg.payload.subdomain = msg.clientname;\nreturn msg;","outputs":1,"noerr":0,"x":852,"y":50,"wires":[["77e72e4b.7dfcd"]]},{"id":"77e72e4b.7dfcd","type":"link out","z":"5f9338e7.a36538","name":"","links":["62c1c68f.91fa48"],"x":947,"y":50,"wires":[]},{"id":"62c1c68f.91fa48","type":"link in","z":"5f9338e7.a36538","name":"","links":["77e72e4b.7dfcd"],"x":87,"y":210,"wires":[[]]},{"id":"a56ea560.eb1fa8","type":"switch","z":"5f9338e7.a36538","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":482,"y":210,"wires":[["b4c31c1d.c598c"],["1f10c9b2.608276"]]},{"id":"1f10c9b2.608276","type":"function","z":"5f9338e7.a36538","name":"fail","func":"msg.payload = \"erreur lors de la creation d'un target group : le groupe existe deja ðŸ˜“\"\nreturn msg;","outputs":1,"noerr":0,"x":622,"y":230,"wires":[["47fcf556.98fc4c"]]},{"id":"b4c31c1d.c598c","type":"link out","z":"5f9338e7.a36538","name":"","links":["6a1d1d84.331eb4"],"x":607,"y":170,"wires":[]},{"id":"6a1d1d84.331eb4","type":"link in","z":"5f9338e7.a36538","name":"","links":["b4c31c1d.c598c"],"x":87,"y":270,"wires":[[]]},{"id":"16368792.bb9c68","type":"function","z":"5f9338e7.a36538","name":"return unique priotrity","func":"function getMissingNumber(nums) {\n    var swap = function(i, j) {\n        var tmp = nums[i];\n        nums[i] = nums[j];\n        nums[j] = tmp;\n    };\n\n    for (let i = 0; i < nums.length; i++) {\n        while (0 < nums[i] && nums[i] - 1 < nums.length && nums[i] != i + 1 && nums[i] != nums[nums[i] - 1]) {\n            swap(i, nums[i] - 1);\n        }\n    }\n\n    for (let i = 0; i < nums.length; i++) {\n        if (nums[i] != i + 1) {\n            return i + 1;\n        }\n    }\n    return nums.length + 1;\n}\n\n\nnode.warn(msg)\nmsg.subdomain = msg.subdomain\nvar allrules = msg.payload.Rules;\nvar priorities = [];\nfor(var i=0, len=allrules.length; i < len; i++){\n    let prio;\n    if(allrules[i].Priority == \"default\")\n    prio = 0\n    else\n    prio = Number(allrules[i].Priority)\n    priorities.push(prio)\n}\nvar firstMissingPositive = getMissingNumber(priorities)\nmsg.payload = firstMissingPositive\nmsg.targetgroup = msg.targetgroup;\n\nnode.warn(\"finish geting the smallest int\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":606,"y":264,"wires":[["d778e1a0.06dc6"]]},{"id":"ea140e6.07287f","type":"link in","z":"5f9338e7.a36538","name":"","links":["d778e1a0.06dc6"],"x":81,"y":352,"wires":[[]]},{"id":"d778e1a0.06dc6","type":"link out","z":"5f9338e7.a36538","name":"","links":["ea140e6.07287f"],"x":761,"y":286,"wires":[]},{"id":"4d9bb729.375958","type":"function","z":"5f9338e7.a36538","name":"Base64 script converter","func":"    function utf8encode (string) {\n    string = string.replace(/\\r\\n/g,\"\\n\");\n    var utftext = \"\";\n\n    for (var n = 0; n < string.length; n++) {\n\n        var c = string.charCodeAt(n);\n\n        if (c < 128) {\n            utftext += String.fromCharCode(c);\n        }\n        else if((c > 127) && (c < 2048)) {\n            utftext += String.fromCharCode((c >> 6) | 192);\n            utftext += String.fromCharCode((c & 63) | 128);\n        }\n        else {\n            utftext += String.fromCharCode((c >> 12) | 224);\n            utftext += String.fromCharCode(((c >> 6) & 63) | 128);\n            utftext += String.fromCharCode((c & 63) | 128);\n        }\n\n    }\n\n    return utftext;\n}\n function encode (input) {\n    var keyStr = \"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=\";\n    var output = \"\";\n    var chr1, chr2, chr3, enc1, enc2, enc3, enc4;\n    var i = 0;\n\n    input = utf8encode(input);\n\n    while (i < input.length) {\n\n        chr1 = input.charCodeAt(i++);\n        chr2 = input.charCodeAt(i++);\n        chr3 = input.charCodeAt(i++);\n\n        enc1 = chr1 >> 2;\n        enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);\n        enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);\n        enc4 = chr3 & 63;\n\n        if (isNaN(chr2)) {\n            enc3 = enc4 = 64;\n        } else if (isNaN(chr3)) {\n            enc4 = 64;\n        }\n\n        output = output +\n        keyStr.charAt(enc1) + keyStr.charAt(enc2) +\n        keyStr.charAt(enc3) + keyStr.charAt(enc4);\n\n    }\n\n    return output;\n}\n\nvar script = \"#!/bin/bash \\nsed -i -e 's/tekos-user-readonly/\"+msg.login+\"/g' /home/ubuntu/.node-red/settings.js \\nhashed_password=$(node -e \\\"console.log(require('/home/ubuntu/.node-red/node_modules/bcryptjs').hashSync(process.argv[1], 8));\\\" \"+msg.pwd+\") \\nsed -i -e 's|tekosuser_pass_readonly|'$hashed_password'|g' /home/ubuntu/.node-red/settings.js \\nsed -i -e 's/instance-environment/prod/g' /home/ubuntu/.node-red/settings.js \\nreboot\"\n\nmsg.payload = msg.payload;\nmsg.script = encode(script);\nmsg.ami = env.get(\"AMI\");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":702,"y":670,"wires":[[]]},{"id":"a0974875.480ff8","type":"link in","z":"5f9338e7.a36538","name":"","links":["47fcf556.98fc4c","d1e39e6d.3ebe3","40f139.f9f6aec8","d64ba945.18aa78","ece6cfa0.7dd97","8f06cbe4.ed40d8"],"x":67,"y":470,"wires":[[]]},{"id":"47fcf556.98fc4c","type":"link out","z":"5f9338e7.a36538","name":"","links":["a0974875.480ff8"],"x":747,"y":230,"wires":[]},{"id":"d1e39e6d.3ebe3","type":"link out","z":"5f9338e7.a36538","name":"","links":["a0974875.480ff8"],"x":367,"y":130,"wires":[]},{"id":"35a33f48.429b4","type":"http in","z":"5f9338e7.a36538","name":"After Payment ","url":"/setup/homeserver/2/:roomId","method":"post","upload":false,"swaggerDoc":"","x":142,"y":590,"wires":[["a889fa99.e9c938","d88c9a8b.739738","7d5bd53d.79ad9c"]]},{"id":"a889fa99.e9c938","type":"http response","z":"5f9338e7.a36538","name":"","statusCode":"200","headers":{},"x":332,"y":550,"wires":[]},{"id":"d88c9a8b.739738","type":"function","z":"5f9338e7.a36538","name":" coded data","func":"msg.subdomain = msg.payload.hostname;\nmsg.login = msg.payload.login;\nmsg.pwd = msg.payload.pwd\nmsg.email = \"ayoub@tekos.co\"\nmsg.roomId = msg.req.params.roomId\nreturn msg;","outputs":1,"noerr":0,"x":342,"y":590,"wires":[["3bacba98.1818a6"]]},{"id":"3bacba98.1818a6","type":"link out","z":"5f9338e7.a36538","name":"","links":["9f8d23b3.5551d"],"x":467,"y":590,"wires":[]},{"id":"7d5bd53d.79ad9c","type":"debug","z":"5f9338e7.a36538","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":312,"y":650,"wires":[]},{"id":"9f8d23b3.5551d","type":"link in","z":"5f9338e7.a36538","name":"","links":["3bacba98.1818a6"],"x":67,"y":50,"wires":[["dbef7d4e.bbd14"]]},{"id":"8d0278e0.1cfbb8","type":"switch","z":"5f9338e7.a36538","name":"","property":"payload.InstanceStatuses[0].InstanceState.Name","propertyType":"msg","rules":[{"t":"eq","v":"running","vt":"str"},{"t":"eq","v":"pending","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":902,"y":610,"wires":[["9d6dcf20.27cc5"],["11519003.6b0e1"],["11519003.6b0e1"]]},{"id":"9d6dcf20.27cc5","type":"link out","z":"5f9338e7.a36538","name":"","links":[],"x":1027,"y":590,"wires":[]},{"id":"11519003.6b0e1","type":"link out","z":"5f9338e7.a36538","name":"","links":[],"x":1027,"y":630,"wires":[]},{"id":"91a9983b.9958d8","type":"link in","z":"5f9338e7.a36538","name":"","links":["67c84dce.f84304"],"x":67,"y":530,"wires":[[]]},{"id":"67c84dce.f84304","type":"link out","z":"5f9338e7.a36538","name":"","links":["91a9983b.9958d8"],"x":1225,"y":330,"wires":[]},{"id":"80a7d4ee.0c4c88","type":"subflow:5f9338e7.a36538","z":"1a282f04.66edf1","name":"","env":[],"x":726,"y":528,"wires":[[],["d03a56d3.5643d8"],[]]},{"id":"bae8c2bb.53675","type":"function","z":"44ce6d7c.a949d4","name":"get sender","func":"var sender = msg.senderId.substring(\n    msg.senderId.lastIndexOf(\"@\") + 1, \n    msg.senderId.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    msg.senderABV = sender;\nif(global.get(sender)){\n    \n    if(global.get(sender).template){\n        msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\n        var template = global.get(sender).template;\n        msg.body = template;\n        msg.url = \"https://raw.githubusercontent.com/\"+template.user+\"/\"+template.repo+\"/master/tekos-app.json\"\n        return[msg,null]\n    }else{\n        return[null,msg]\n    }\n}else{\n    return[null,msg]\n}\n","outputs":2,"noerr":0,"x":268,"y":88,"wires":[["56e856d9.f7d2a8"],[]]},{"id":"56e856d9.f7d2a8","type":"http request","z":"44ce6d7c.a949d4","name":"Github","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":424,"y":44,"wires":[["8fcf80c8.0ef5e","f57dc546.91ec18"]],"icon":"node-red-contrib-github/github.png"},{"id":"8fcf80c8.0ef5e","type":"switch","z":"44ce6d7c.a949d4","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gte","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":534,"y":88,"wires":[["c68b5e3f.933dc"],[]]},{"id":"c68b5e3f.933dc","type":"function","z":"44ce6d7c.a949d4","name":"get flow","func":"\nvar tekosapp;\nfor(let i=0;i<msg.payload.length;i++){\n    if(msg.payload[i].name.trim() == msg.template){\n        tekosapp = msg.payload[i]['flow-file'];\n    }else if(msg.payload[i].name.trim() == msg.template.value){\n        tekosapp = msg.payload[i]['flow-file'];\n    }else if(msg.payload[i].name.trim() == msg.template.name){\n          tekosapp = msg.payload[i]['flow-file'];\n    }\n}\n msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\n msg.url = \"https://raw.githubusercontent.com/\"+msg.body.user+\"/\"+msg.body.repo+\"/master/\"+tekosapp;\n\nreturn msg;\n","outputs":1,"noerr":0,"x":676,"y":66,"wires":[["ecf9cd4b.8d747"]]},{"id":"ecf9cd4b.8d747","type":"http request","z":"44ce6d7c.a949d4","name":"Github","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":820,"y":66,"wires":[["d6d571f9.7919a","ec40a333.c0af4"]],"icon":"node-red-contrib-github/github.png"},{"id":"d6d571f9.7919a","type":"link out","z":"44ce6d7c.a949d4","name":"","links":["80eb2b76.0e2a98"],"x":917,"y":66,"wires":[]},{"id":"80eb2b76.0e2a98","type":"link in","z":"44ce6d7c.a949d4","name":"","links":["d6d571f9.7919a"],"x":345,"y":198,"wires":[["ed4ea298.46283"]]},{"id":"f57dc546.91ec18","type":"debug","z":"44ce6d7c.a949d4","name":"first github","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":576,"y":22,"wires":[]},{"id":"ec40a333.c0af4","type":"debug","z":"44ce6d7c.a949d4","name":"second github","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":960,"y":22,"wires":[]},{"id":"d2720996.cc5478","type":"template","z":"1a282f04.66edf1","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"your login can only contain lower case letters, numbers and '_'","output":"str","x":544,"y":462,"wires":[["25ec4238.98032e"]]},{"id":"25ec4238.98032e","type":"http response","z":"1a282f04.66edf1","name":"404","statusCode":"404","headers":{"msg":"A hostname can only contain lower case letters, numbers and '=_-./'"},"x":688,"y":462,"wires":[]},{"id":"73e87509.78a25c","type":"link in","z":"1a282f04.66edf1","name":"","links":["435c2734.0dc798","5974bd25.4086c4","31e3665.7aabb9a","51618d78.0b8164"],"x":213,"y":748,"wires":[["d2da1ed7.b21c4"]]},{"id":"4a87e839.bd6048","type":"link in","z":"1cd6648d.066dfb","name":"","links":[],"x":191,"y":242,"wires":[["7349a4d3.d6c1fc"]]},{"id":"5a77a8c6.d5daf8","type":"link in","z":"1cd6648d.066dfb","name":"","links":[],"x":265,"y":142,"wires":[["409b04a1.95fd5c"]]},{"id":"409b04a1.95fd5c","type":"switch","z":"1cd6648d.066dfb","name":"","property":"payload.object","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":390,"y":142,"wires":[[],[]]},{"id":"7349a4d3.d6c1fc","type":"function","z":"1cd6648d.066dfb","name":"get sender","func":"var sender = msg.senderId.substring(\n    msg.senderId.lastIndexOf(\"@\") + 1, \n    msg.senderId.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    msg.senderABV = sender;\nif(global.get(sender)){\n    \n    if(global.get(sender).template){\n        msg.headers = {\n    'User-Agent': 'AyoubGhaddab',\n    'Token': '3e4867333e0e4dcef96d2b69f9c604446cfc42e9'\n}\n        var template = global.get(sender).template;\n        msg.body = template;\n        msg.url = \"https://raw.githubusercontent.com/\"+template.user+\"/\"+template.repo+\"/master/tekos-app.json\"\n        return[msg,null]\n    }else{\n        return[null,msg]\n    }\n}else{\n    return[null,msg]\n}\n","outputs":2,"noerr":0,"x":334,"y":242,"wires":[["8ee9257a.e850c8"],["d4d31811.3ae718"]]},{"id":"8ee9257a.e850c8","type":"http request","z":"1cd6648d.066dfb","name":"Github","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":490,"y":220,"wires":[["152135bb.b5300a","ab9eb90f.615138"]],"icon":"node-red-contrib-github/github.png"},{"id":"152135bb.b5300a","type":"debug","z":"1cd6648d.066dfb","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":664,"y":286,"wires":[]},{"id":"ab9eb90f.615138","type":"switch","z":"1cd6648d.066dfb","name":"","property":"payload.length","propertyType":"msg","rules":[{"t":"gte","v":"1","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":644,"y":220,"wires":[["7a78ab8a.1477e4"],[]]},{"id":"7a78ab8a.1477e4","type":"function","z":"1cd6648d.066dfb","name":"get flow","func":"\nvar botexist;\nfor(let i=0;i<msg.payload.length;i++){\n    if(msg.payload[i].name.trim() == msg.template){\n        botexist = msg.payload[i]['tekos-bot-required'];\n    }else if(msg.payload[i].name.trim() == msg.template.value){\n        botexist = msg.payload[i]['tekos-bot-required'];\n    }\n}\nmsg.botexist = botexist;\nnode.warn(\"bot exist data\");\nnode.warn(botexist)\n\n    if(botexist){\n        msg.botexist = true;\n        return[msg,null];\n    }else{\n        msg.botexist = false;\n          return[null,msg];\n    }\n","outputs":2,"noerr":0,"x":786,"y":176,"wires":[["e2483a67.7a37d8"],["3e1c914d.1a7c6e"]]},{"id":"e2483a67.7a37d8","type":"link out","z":"1cd6648d.066dfb","name":"","links":[],"x":902,"y":132,"wires":[]},{"id":"3e1c914d.1a7c6e","type":"link out","z":"1cd6648d.066dfb","name":"","links":[],"x":895,"y":176,"wires":[]},{"id":"d4d31811.3ae718","type":"link out","z":"1cd6648d.066dfb","name":"","links":[],"x":455,"y":286,"wires":[]},{"id":"51618d78.0b8164","type":"link out","z":"1a282f04.66edf1","name":"","links":["73e87509.78a25c"],"x":1049,"y":352,"wires":[]},{"id":"d8fd20ba.c6f1","type":"function","z":"1a282f04.66edf1","name":"Preapare Bot","func":"\nvar password = Math.random().toString(36).substring(7);\nnode.warn(msg.payload);\nvar name = msg.instance.hostname;\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/register?kind=user'\nmsg.roomId= msg.req.params.roomId;\n\nmsg.payload = {\n    \"password\": password,\n    \"username\": name,\n    \"auth\": {\n        \"type\":\"m.login.dummy\"\n    }\n}\n\n\nnode.warn(\"is there any room id\");\nnode.warn(msg)\nreturn msg;","outputs":1,"noerr":0,"x":554,"y":726,"wires":[["4a2a0898.db0938"]]},{"id":"9d75862a.3568a8","type":"switch","z":"1a282f04.66edf1","name":"","property":"payload.errcode","propertyType":"msg","rules":[{"t":"eq","v":"M_USER_IN_USE","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":886,"y":726,"wires":[[],["7102bf62.dcafe"]]},{"id":"13a330ad.43c67f","type":"link out","z":"1a282f04.66edf1","name":"","links":["d38736ba.d00768"],"x":1137,"y":770,"wires":[]},{"id":"d38736ba.d00768","type":"link in","z":"1a282f04.66edf1","name":"","links":["13a330ad.43c67f"],"x":565,"y":528,"wires":[["80a7d4ee.0c4c88"]]},{"id":"7102bf62.dcafe","type":"change","z":"1a282f04.66edf1","name":"","rules":[{"t":"set","p":"bot","pt":"msg","to":"payload","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1016,"y":770,"wires":[["13a330ad.43c67f","deb4b0f8.841c4"]]},{"id":"deb4b0f8.841c4","type":"debug","z":"1a282f04.66edf1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1128,"y":704,"wires":[]},{"id":"d88c22ee.9c691","type":"http request","z":"52c3ea26.423dc4","name":"TEKOS API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":466,"y":264,"wires":[["587f9096.69369","fea10712.42de28","62be5d6e.7addf4"]]},{"id":"4a2a0898.db0938","type":"http request","z":"1a282f04.66edf1","name":"TEKOS API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":730,"y":726,"wires":[["e3cb8ce2.f8141","9d75862a.3568a8"]]},{"id":"e3cb8ce2.f8141","type":"debug","z":"1a282f04.66edf1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":864,"y":792,"wires":[]},{"id":"5a807be7.68d624","type":"switch","z":"ab0e04bf.0c2678","name":"","property":"payload.metadata.type","propertyType":"msg","rules":[{"t":"eq","v":"flow","vt":"str"},{"t":"eq","v":"chat","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":754,"y":176,"wires":[["291668ed.1cba08"],["71b38d92.7e98b4"]]},{"id":"71b38d92.7e98b4","type":"link out","z":"ab0e04bf.0c2678","name":"","links":["492029e3.32b918"],"x":851,"y":198,"wires":[]},{"id":"e7e6e399.c219f","type":"link in","z":"ab0e04bf.0c2678","name":"","links":["291668ed.1cba08"],"x":81,"y":726,"wires":[[]]},{"id":"62b499ea.60c548","type":"function","z":"ab0e04bf.0c2678","name":"update form","func":"\n\nvar tdArray = msg.payload.taskDefinition.containerDefinitions[0].environment;\ntdArray = JSON.stringify(tdArray);\nvar subscriptionToken = \"\";\nnode.warn(\"describe\");\nnode.warn(msg);\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':\"Update Service Environment Variables\",\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/instance/update/client/flow/\"+msg.roomId+\"/\"+msg.payload.taskDefinition.family,\n    \"buttontitle\": \"Update Environment Variables\",\n    \"tekosform\": [\n      {\n        \"type\": \"editor\",\n        \"subtype\": \"editor\",\n        \"label\": \"\",\n        \"key\": \"varenv\",\n        \"defaultValue\":tdArray\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":620,"y":726,"wires":[["cdee714.0ce0b9"]],"icon":"node-red/debug.svg"},{"id":"cdee714.0ce0b9","type":"http request","z":"ab0e04bf.0c2678","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":786,"y":726,"wires":[[]]},{"id":"f015c53d.0f0418","type":"switch","z":"ab0e04bf.0c2678","name":"","property":"req.params.type","propertyType":"msg","rules":[{"t":"eq","v":"chat","vt":"str"},{"t":"eq","v":"flow","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":204,"y":484,"wires":[["7ff5d009.d12ae"],["cce46a60.9187b8"]]},{"id":"cce46a60.9187b8","type":"function","z":"ab0e04bf.0c2678","name":"Validator","func":"function IsJsonString(str) {\n    try {\n        JSON.parse(str);\n    } catch (e) {\n        return false;\n    }\n    return true;\n}\n\nif(IsJsonString(msg.payload.varenv)){\n    node.warn(\"json is valid\");\n    node.warn(msg);\n    msg.roomId = msg.payload.roomId;\n    return[msg,null];\n}else{\n    msg.payload.error = \"Json body is not valid\";\n    return[null,msg];\n}\n","outputs":2,"noerr":0,"x":280,"y":572,"wires":[["69625260.4ecdfc"],["8a5a036d.cd0af"]],"icon":"font-awesome/fa-check-circle"},{"id":"8a5a036d.cd0af","type":"http response","z":"ab0e04bf.0c2678","name":"404","statusCode":"404","headers":{},"x":490,"y":616,"wires":[]},{"id":"69625260.4ecdfc","type":"http response","z":"ab0e04bf.0c2678","name":"200","statusCode":"200","headers":{},"x":490,"y":528,"wires":[]},{"id":"22e9ad84.8030b2","type":"switch","z":"ab0e04bf.0c2678","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1106,"y":550,"wires":[[],[]]},{"id":"3e9dfeea.edabf2","type":"switch","z":"ab0e04bf.0c2678","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1436,"y":528,"wires":[[],[]]},{"id":"3a37dc4d.4cca44","type":"debug","z":"c47f16f1.a03068","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":732,"y":418,"wires":[]},{"id":"edd181d3.0970d","type":"debug","z":"c47f16f1.a03068","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":490,"y":418,"wires":[]},{"id":"3d87b3d5.85834c","type":"switch","z":"c47f16f1.a03068","name":"","property":"customer.address.country","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1018,"y":66,"wires":[["c6ad4c7e.75889"],["75f2bc79.16b0b4"]]},{"id":"e5be406b.ea765","type":"debug","z":"c47f16f1.a03068","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1656,"y":572,"wires":[]},{"id":"a00b2ef0.c557a","type":"subflow:ec000337.2949e","z":"1df83760.b275d9","name":"get flow subscriptions","env":[{"name":"stripe_test_key","value":"sk_test_fY14VeGn3yvgxSPpmsuyt5pB","type":"str"}],"x":1860,"y":132,"wires":[["9824156c.cd8628"]]},{"id":"2db198d0.dbf7d8","type":"subflow:4f8bc972.b172e8","z":"1df83760.b275d9","name":"","env":[],"x":1644,"y":132,"wires":[["a00b2ef0.c557a"],[]]},{"id":"5d7bdba2.24dac4","type":"debug","z":"93dbee73.58db9","name":"Create Session  log","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":398,"y":308,"wires":[]},{"id":"c1467f63.56c24","type":"switch","z":"5f9338e7.a36538","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":424,"y":286,"wires":[["16368792.bb9c68"],["40f139.f9f6aec8"]]},{"id":"40f139.f9f6aec8","type":"link out","z":"5f9338e7.a36538","name":"","links":["a0974875.480ff8"],"x":543,"y":308,"wires":[]},{"id":"747c196b.817348","type":"switch","z":"5f9338e7.a36538","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":424,"y":352,"wires":[[],["d64ba945.18aa78"]]},{"id":"d64ba945.18aa78","type":"link out","z":"5f9338e7.a36538","name":"","links":["a0974875.480ff8"],"x":521,"y":396,"wires":[]},{"id":"ea981891.755b08","type":"switch","z":"5f9338e7.a36538","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":798,"y":352,"wires":[[],["ece6cfa0.7dd97"]]},{"id":"ece6cfa0.7dd97","type":"link out","z":"5f9338e7.a36538","name":"","links":["a0974875.480ff8"],"x":895,"y":396,"wires":[]},{"id":"91de192f.afbc18","type":"switch","z":"5f9338e7.a36538","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1106,"y":352,"wires":[["67c84dce.f84304"],["8f06cbe4.ed40d8"]]},{"id":"8f06cbe4.ed40d8","type":"link out","z":"5f9338e7.a36538","name":"","links":["a0974875.480ff8"],"x":1203,"y":396,"wires":[]},{"id":"943a0b16.317318","type":"switch","z":"d97495d8.5a8468","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":402,"y":242,"wires":[["6241fbac.d82644"],["f4302bde.259cf8"]]},{"id":"f4302bde.259cf8","type":"link out","z":"d97495d8.5a8468","name":"","links":["dc3ad172.511d"],"x":477,"y":286,"wires":[]},{"id":"ddca597b.a2c8b8","type":"function","z":"1a282f04.66edf1","name":"default","func":" msg.form = msg.payload;\nmsg.repo = \"boilerplate\";\nmsg.username = \"myled\";\n msg.templateName = \"Tekos boilerplate Template\";\nreturn msg;","outputs":1,"noerr":0,"x":644,"y":264,"wires":[["481723ea.e81dec"]]},{"id":"fcf999aa.0b05e8","type":"debug","z":"39b2c1f9.f0db8e","name":"subscription?","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":374,"y":88,"wires":[]},{"id":"4cdec8dc.8d5288","type":"debug","z":"39b2c1f9.f0db8e","name":"getcustomerbyid","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":652,"y":44,"wires":[]},{"id":"1c5f6b59.d464e5","type":"debug","z":"39b2c1f9.f0db8e","name":"getcountry","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":1016,"y":22,"wires":[]},{"id":"dae1ed14.e5ebb","type":"debug","z":"4f8bc972.b172e8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":816,"y":242,"wires":[]},{"id":"46809501.365fac","type":"http response","z":"4ebcae91.b5489","name":"ERROR","statusCode":"400","headers":{},"x":918,"y":264,"wires":[]},{"id":"1c983f02.d57a21","type":"debug","z":"c47f16f1.a03068","name":"resultUpdate","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":928,"y":396,"wires":[]},{"id":"fae4bb41.fd93d8","type":"function","z":"c47f16f1.a03068","name":"Update global user","func":"if(msg.payload.metadata.tekos_id && msg.payload.address.country){\n    var sender = msg.payload.metadata.tekos_id.substring(\n    msg.payload.metadata.tekos_id.lastIndexOf(\"@\") + 1, \n    msg.payload.metadata.tekos_id.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    if(global.get(sender)){\n        \n        \n    global.set(sender+\".country\",msg.payload.address.country);\n\n    }\n}\nreturn msg;","outputs":1,"noerr":0,"x":1234,"y":374,"wires":[["c9041b65.cbff18"]]},{"id":"54a88566.543bbc","type":"subflow:8ba283a9.d5f58","z":"39b2c1f9.f0db8e","name":"","env":[],"x":648,"y":484,"wires":[[],[]]},{"id":"ad4eb206.58677","type":"function","z":"39b2c1f9.f0db8e","name":"get sender","func":"\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nif(msg.subscription.metadata.user){\n    let userid = msg.subscription.metadata.user;\n     var sender = userid.substring(\n    userid.lastIndexOf(\"@\") + 1, \n    userid.lastIndexOf(\":\")\n    );\n    sender = sender.replace(\".\", \"_\");\n    if(global.get(sender)){\n        if(global.get(sender).country){\n            msg.customer = global.get(sender);\n            return[msg,null,null];\n            \n        }else{\n             msg.customer = global.get(sender);\n            msg.defaulttaxrate=env.get(\"TaxRateDefault\");\n\n             return[null,msg,null];\n        }\n    }else{\n        \n        msg.defaulttaxrate=env.get(\"TaxRateDefault\");\n\n        return[null,msg,null];\n    }\n    \n}else{\n    return [null,null,msg];\n}\n","outputs":3,"noerr":0,"x":444,"y":132,"wires":[["e5bb8eea.4f99a","4cdec8dc.8d5288","6e2aa141.94fb2"],["e51a1a3a.1388e8","6e2aa141.94fb2"],["3ee2b369.c72ecc","6e2aa141.94fb2"]]},{"id":"e51a1a3a.1388e8","type":"link out","z":"39b2c1f9.f0db8e","name":"","links":["4b725f60.00de4"],"x":653,"y":132,"wires":[]},{"id":"2bb14ec8.9fd482","type":"switch","z":"fde10ab5.552fe8","name":"","property":"event.event.unsigned.prev_content","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":44,"wires":[["9ccfba7e.4cba88"],[]]},{"id":"6e2aa141.94fb2","type":"debug","z":"39b2c1f9.f0db8e","name":"getsender?","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":708,"y":242,"wires":[]},{"id":"e8f45d5a.f62bb","type":"subflow:be1c0cd4.343a2","z":"884a2e0c.927b5","name":"","env":[],"x":396,"y":770,"wires":[[],[]]},{"id":"56e5a5a1.1f502c","type":"debug","z":"be1c0cd4.343a2","name":"td","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":442,"y":418,"wires":[]},{"id":"9ddf6047.ffafe","type":"http in","z":"1a407cf6.6df0d3","name":"Redeem","url":"/redeem/code/:roomId/:customerId","method":"post","upload":false,"swaggerDoc":"","x":390,"y":88,"wires":[["ff678668.bae4d8","fa5d1531.d127d8"]]},{"id":"ff678668.bae4d8","type":"debug","z":"1a407cf6.6df0d3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":490,"y":22,"wires":[]},{"id":"fa5d1531.d127d8","type":"function","z":"1a407cf6.6df0d3","name":"get coupon Code","func":"msg.tekos = {};\nmsg.tekos.roomId = msg.req.params.roomId;\nmsg.tekos.customer = msg.req.params.customerId;\nmsg.tekos.code = msg.payload.code\n msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/coupons/\"+msg.payload.code;\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":618,"y":88,"wires":[["ac4c4319.c8937"]]},{"id":"daab29bf.48c558","type":"debug","z":"1a407cf6.6df0d3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":974,"y":88,"wires":[]},{"id":"ac4c4319.c8937","type":"http request","z":"1a407cf6.6df0d3","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":818,"y":88,"wires":[["daab29bf.48c558","ec012114.0ec49"]]},{"id":"43004d6.351fcb4","type":"switch","z":"1a407cf6.6df0d3","name":"","property":"payload.error","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":248,"y":286,"wires":[["bff497bb.c0da88"],["4affb762.035258"]]},{"id":"61cc75fe.1f23ec","type":"link in","z":"1a407cf6.6df0d3","name":"","links":["ec012114.0ec49"],"x":154,"y":286,"wires":[["43004d6.351fcb4"]]},{"id":"ec012114.0ec49","type":"link out","z":"1a407cf6.6df0d3","name":"","links":["61cc75fe.1f23ec"],"x":961,"y":44,"wires":[]},{"id":"8e35e008.63ae8","type":"http response","z":"1a407cf6.6df0d3","name":"OK","statusCode":"200","headers":{},"x":732,"y":484,"wires":[]},{"id":"bff497bb.c0da88","type":"template","z":"1a407cf6.6df0d3","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"No such coupon !","output":"str","x":346,"y":198,"wires":[["45ac74e9.948abc"]]},{"id":"45ac74e9.948abc","type":"http response","z":"1a407cf6.6df0d3","name":"404","statusCode":"404","headers":{"msg":"no such coupon"},"x":490,"y":198,"wires":[]},{"id":"4affb762.035258","type":"switch","z":"1a407cf6.6df0d3","name":"","property":"payload.metadata.elligible_subscription","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":402,"y":308,"wires":[["73794cf8.e19844"],["ef15edfa.79178"]]},{"id":"73794cf8.e19844","type":"template","z":"1a407cf6.6df0d3","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"Sorry, but no elligible product linked to this coupon code !","output":"str","x":544,"y":264,"wires":[["6158beb2.5b5b2"]]},{"id":"6158beb2.5b5b2","type":"http response","z":"1a407cf6.6df0d3","name":"404","statusCode":"404","headers":{"msg":"no such coupon"},"x":688,"y":264,"wires":[]},{"id":"ef15edfa.79178","type":"function","z":"1a407cf6.6df0d3","name":"get plan from metadata","func":"msg.coupon = msg.payload;\n msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/plans/\"+msg.payload.metadata.elligible_subscription;\nmsg.payload = {};\n\nreturn msg;","outputs":1,"noerr":0,"x":528,"y":418,"wires":[["fcfb303.f57eed","8e35e008.63ae8"]]},{"id":"fcfb303.f57eed","type":"http request","z":"1a407cf6.6df0d3","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":752,"y":418,"wires":[["9d4c4cfb.8f788","69cf1ea6.cad36"]]},{"id":"9d4c4cfb.8f788","type":"switch","z":"1a407cf6.6df0d3","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":908,"y":418,"wires":[["5ac69d91.2f8f74"],["c0fa14c0.6644a8"]]},{"id":"5ac69d91.2f8f74","type":"template","z":"1a407cf6.6df0d3","name":"","field":"payload.error","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"No product found under this coupon code.","output":"str","x":1050,"y":352,"wires":[["fa2f467b.51ba38"]]},{"id":"fa2f467b.51ba38","type":"http response","z":"1a407cf6.6df0d3","name":"404","statusCode":"404","headers":{"msg":"no such coupon"},"x":1194,"y":352,"wires":[]},{"id":"c0fa14c0.6644a8","type":"function","z":"1a407cf6.6df0d3","name":"Create Card","func":"\nelementsY = [];\nmsg.roomId = msg.tekos.roomId;\nelementsY.push\n       ({\n                \"title\": \"Plan : <nobr style='color:#7061e2'>\"+msg.payload.nickname+\"</nobr>\",\n                \"subtitle\": \"<div><ul><li>Subtotal:â‚¬\"+(msg.payload.amount/100)+\"</li><li>\"+msg.coupon.name+\"(\"+msg.coupon.percent_off+\")% off : -â‚¬\"+(((msg.payload.amount)/100)*msg.coupon.percent_off)/100+\"</li><li>Total : â‚¬\"+((msg.payload.amount -((msg.payload.amount)/100)*msg.coupon.percent_off))/100+\"</li></ul></div>\",\n                \"buttons\": [\n                    {\n                        \"type\": \"request_url_only\",\n                        \"label\": \"Subscribe\",\n                        \"value\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/redeem/subscribe/\"+msg.tekos.roomId+\"/\"+msg.tekos.customer+\"/\"+msg.payload.id+\"/\"+msg.coupon.id,\n                        \"alert\": false\n                    }\n                ]\n                \n        })\nmsg.payload = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": elementsY,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\nreturn msg;","outputs":1,"noerr":0,"x":1098,"y":440,"wires":[[]]},{"id":"69cf1ea6.cad36","type":"debug","z":"1a407cf6.6df0d3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":886,"y":352,"wires":[]},{"id":"fae04aa7.af4838","type":"http in","z":"1a407cf6.6df0d3","name":"Subscribe","url":"/redeem/subscribe/:roomId/:customerId/:planId/:couponId","method":"post","upload":false,"swaggerDoc":"","x":236,"y":594,"wires":[["7b5a3bd1.6ef2b4","6ba629d4.cc8a98","b7063950.3d4018"]]},{"id":"7b5a3bd1.6ef2b4","type":"debug","z":"1a407cf6.6df0d3","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":402,"y":594,"wires":[]},{"id":"6ba629d4.cc8a98","type":"http response","z":"1a407cf6.6df0d3","name":"OK","statusCode":"200","headers":{},"x":402,"y":528,"wires":[]},{"id":"b7063950.3d4018","type":"function","z":"1a407cf6.6df0d3","name":"get coupon Code","func":"\n msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\nmsg.url =\"https://api.stripe.com/v1/subscriptions\";\nmsg.payload = 'customer='+msg.req.params.customerId+\"&collection_method=charge_automatically&coupon=\"+msg.req.params.couponId+\"&items[0][plan]=\"+msg.req.params.planId+\"&metadata[roomId]=\"+msg.req.params.roomId+\"&items[0][metadata][roomId]=\"+msg.req.params.roomId;\nnode.warn(\"verify\");\nnode.warn(msg);\nreturn msg;","outputs":1,"noerr":0,"x":442,"y":660,"wires":[["5aad7b0c.bf5e54"]]},{"id":"5aad7b0c.bf5e54","type":"http request","z":"1a407cf6.6df0d3","name":"STRIPE API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":642,"y":660,"wires":[["641a5d13.feb8c4","c1e6c9fe.e1fa78"]]},{"id":"641a5d13.feb8c4","type":"debug","z":"1a407cf6.6df0d3","name":"oneSub","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":896,"y":638,"wires":[]},{"id":"c1e6c9fe.e1fa78","type":"switch","z":"1a407cf6.6df0d3","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":842,"y":682,"wires":[["c8f74eda.4e1aa"],[]]},{"id":"c8f74eda.4e1aa","type":"change","z":"1a407cf6.6df0d3","name":"","rules":[{"t":"set","p":"roomId","pt":"msg","to":"payload.metadata.roomId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":916,"y":572,"wires":[[]]},{"id":"cfcff58d.ed1c28","type":"delay","z":"c47f16f1.a03068","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1072,"y":440,"wires":[["11e8a77e.da7369"]]},{"id":"567286a3.3e0a28","type":"delay","z":"c47f16f1.a03068","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1072,"y":264,"wires":[["9a7282d0.7acbd"]]},{"id":"a04bde74.4d774","type":"delay","z":"1a282f04.66edf1","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":456,"y":286,"wires":[["7d7492df.a00d3c"]]},{"id":"ba06fe98.c5b3f","type":"switch","z":"ab0e04bf.0c2678","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":732,"y":572,"wires":[[],[]]},{"id":"78f363c.7ca879c","type":"switch","z":"ab0e04bf.0c2678","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":424,"y":286,"wires":[["c0f4d029.3975e"],["65f42fb1.957f7"]]},{"id":"65f42fb1.957f7","type":"link out","z":"ab0e04bf.0c2678","name":"","links":["3b6824b2.eab00c"],"x":550,"y":308,"wires":[]},{"id":"3b6824b2.eab00c","type":"link in","z":"ab0e04bf.0c2678","name":"","links":["65f42fb1.957f7","c2cd55d9.9d6998"],"x":858,"y":638,"wires":[[]]},{"id":"93d0859b.057328","type":"debug","z":"ab0e04bf.0c2678","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":446,"y":330,"wires":[]},{"id":"bdaddc2a.6ca51","type":"switch","z":"ab0e04bf.0c2678","name":"","property":"success","propertyType":"msg","rules":[{"t":"true"},{"t":"false"}],"checkall":"true","repair":false,"outputs":2,"x":468,"y":726,"wires":[["62b499ea.60c548"],["c2cd55d9.9d6998"]]},{"id":"c2cd55d9.9d6998","type":"link out","z":"ab0e04bf.0c2678","name":"","links":["3b6824b2.eab00c"],"x":565,"y":770,"wires":[]},{"id":"6e64f222.9a23ac","type":"change","z":"1df83760.b275d9","name":"","rules":[{"t":"set","p":"senderId","pt":"msg","to":"client.senderId","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1454,"y":66,"wires":[["417c1ddc.6a5cb4"]]},{"id":"417c1ddc.6a5cb4","type":"subflow:4f8bc972.b172e8","z":"1df83760.b275d9","name":"","env":[],"x":1666,"y":66,"wires":[["6f6aca81.74faf4"],[]]},{"id":"6f6aca81.74faf4","type":"subflow:ec000337.2949e","z":"1df83760.b275d9","name":"get chat subscriptions","env":[{"name":"service","value":"chat","type":"str"},{"name":"stripe_test_key","value":"sk_test_fY14VeGn3yvgxSPpmsuyt5pB","type":"str"}],"x":1860,"y":66,"wires":[["9824156c.cd8628"]]},{"id":"9824156c.cd8628","type":"link out","z":"1df83760.b275d9","name":"","links":["cd405a74.50bbd8"],"x":2046,"y":110,"wires":[]},{"id":"cd405a74.50bbd8","type":"link in","z":"1df83760.b275d9","name":"","links":["fedb2d73.490c","69e9038b.ea288c","2e91fec2.d7afe2","82d2a3af.eab9c","9824156c.cd8628","3f29fed0.8a91e2","a8646159.22336"],"x":2171,"y":110,"wires":[[]]},{"id":"82d2a3af.eab9c","type":"link out","z":"1df83760.b275d9","name":"","links":["cd405a74.50bbd8"],"x":308,"y":88,"wires":[]},{"id":"2e91fec2.d7afe2","type":"link out","z":"1df83760.b275d9","name":"","links":["cd405a74.50bbd8"],"x":543,"y":88,"wires":[]},{"id":"69e9038b.ea288c","type":"link out","z":"1df83760.b275d9","name":"","links":["cd405a74.50bbd8"],"x":851,"y":88,"wires":[]},{"id":"fedb2d73.490c","type":"link out","z":"1df83760.b275d9","name":"","links":["cd405a74.50bbd8"],"x":1159,"y":66,"wires":[]},{"id":"95b0ec05.6f61c","type":"http in","z":"5e0c13c0.29fccc","name":"intent success","url":"/setup_intent","method":"post","upload":false,"swaggerDoc":"","x":239.9999885559082,"y":686.0000009536743,"wires":[[]]},{"id":"610f6a15.682e74","type":"function","z":"93dbee73.58db9","name":"you will directed to Stripe secured payment system","func":"\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\") \n\nmsg.payload={\n    \"body\": \"You will be redirected to Stripe secured payment page.\",\n    \"msgtype\": \"m.text\",\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":960,"y":176,"wires":[["1cd2b10a.57754f"]]},{"id":"6437d321.ac270c","type":"delay","z":"93dbee73.58db9","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":852,"y":220,"wires":[["971036e8.c62c28"]]},{"id":"3cfadc74.47d4a4","type":"chatbot-text","z":"1df83760.b275d9","name":"ready","message":[{"message":"Your service is now ready, i have created the sample Bot Application to start with, it is already deployed, you just need to customize it."}],"x":1370,"y":132,"wires":[["3f29fed0.8a91e2","6aff569e.479588","6efe7e3e.aec26"]]},{"id":"3f29fed0.8a91e2","type":"link out","z":"1df83760.b275d9","name":"","links":["cd405a74.50bbd8"],"x":1467,"y":110,"wires":[]},{"id":"1b0ff032.9e96e","type":"chatbot-text","z":"1df83760.b275d9","name":"need assistance","message":[{"message":"If you need a human assistance, just tell me 'talk to a human', i'll invite my collegue to our chat."}],"x":1554,"y":220,"wires":[["a8646159.22336","2db198d0.dbf7d8"]]},{"id":"6aff569e.479588","type":"subflow:8e8615b6.018d08","z":"1df83760.b275d9","name":"..","env":[],"x":1480,"y":176,"wires":[["1b0ff032.9e96e"]]},{"id":"6efe7e3e.aec26","type":"delay","z":"1df83760.b275d9","name":"2s","pauseType":"delay","timeout":"2","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1370,"y":220,"wires":[["1b0ff032.9e96e"]]},{"id":"a8646159.22336","type":"link out","z":"1df83760.b275d9","name":"","links":["cd405a74.50bbd8"],"x":1709,"y":198,"wires":[]},{"id":"79c985f1.dee81c","type":"e-mail","z":"30517ddd.9e4af2","server":"${host}","port":"${port}","secure":true,"tls":false,"name":"","dname":"Send Subscription Token","x":748,"y":220,"wires":[]},{"id":"5d5d93a2.79543c","type":"function","z":"30517ddd.9e4af2","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\nvar email;\nif(msg.payload.email){\n    email = msg.payload.email;\n}else if(msg.email){\n    email = msg.email;\n}else{\n    email = env.get(\"email_to\")\n}\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nvar roomId = msg.roomId\nmsg={\n    payload:msg.payload,\n    topic:msg.topic,\n    to:email,\n \n   \n};\n\nreturn msg;","outputs":1,"noerr":0,"x":494.00000381469727,"y":220,"wires":[["79c985f1.dee81c"]]},{"id":"bf71b538.0bf0b8","type":"template","z":"30517ddd.9e4af2","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{payload.style}}\n    </style>\n</head>\n\n\n<body>\n   <p>{{text}}</p>\n</body>","x":710.9999885559082,"y":161.99999046325684,"wires":[["5d5d93a2.79543c"]]},{"id":"73982323.f550ec","type":"template","z":"30517ddd.9e4af2","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":570.9999885559082,"y":161.99999046325684,"wires":[["bf71b538.0bf0b8"]]},{"id":"8c7f6e81.a0be8","type":"function","z":"30517ddd.9e4af2","name":"send mail","func":"\nif(!msg.body){\n    msg.body = env.get(\"body\")\n}\nif(!msg.topic){\nmsg.topic = env.get(\"topic\");   \n}\n\nreturn msg;","outputs":1,"noerr":0,"x":440.9999885559082,"y":161.99999046325684,"wires":[["73982323.f550ec"]]},{"id":"4e7ba963.eaba78","type":"subflow:ac552099.592a9","z":"b7373e2f.2c979","name":"Event","env":[],"x":336,"y":198,"wires":[["2ee639c9.919e46"],["bbbfa3ed.39a85"],["63230f25.eb084"],["be62b8ce.3e8e08"],[],[]]},{"id":"a0ddaac6.113ab8","type":"comment","z":"b7373e2f.2c979","name":"Event Subscription","info":"","x":332,"y":22,"wires":[]},{"id":"f33e1c4.1bf64e","type":"http request","z":"b7373e2f.2c979","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":796,"y":198,"wires":[["df625b8b.8c8248"]]},{"id":"15e44574.fecebb","type":"function","z":"b7373e2f.2c979","name":"","func":"msg.url = env.get('URL')\n//Header\nmsg.headers ={\n    //\"Authorization\" : \"Bearer \",\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\n//msg.payload={\n\n\n\n//}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":644,"y":198,"wires":[["f33e1c4.1bf64e"]]},{"id":"df625b8b.8c8248","type":"debug","z":"b7373e2f.2c979","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":950,"y":198,"wires":[]},{"id":"2ee639c9.919e46","type":"switch","z":"b7373e2f.2c979","name":"","property":"new_interaction","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":110,"wires":[["15e44574.fecebb"]]},{"id":"63230f25.eb084","type":"switch","z":"b7373e2f.2c979","name":"","property":"direct_message","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":198,"wires":[["15e44574.fecebb"]]},{"id":"bbbfa3ed.39a85","type":"switch","z":"b7373e2f.2c979","name":"","property":"public_message","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":154,"wires":[["15e44574.fecebb"]]},{"id":"be62b8ce.3e8e08","type":"switch","z":"b7373e2f.2c979","name":"","property":"file","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":242,"wires":[["15e44574.fecebb"]]},{"id":"b54cbd61.6dfc4","type":"function","z":"bc6f16b.09d1fe8","name":"Invite operator","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.payload+\"/invite?access_token=\"+env.get('TOKEN')\nmsg.payload={\n\n  \"user_id\": msg.sender\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":88,"wires":[["75128efd.040b4"]]},{"id":"75128efd.040b4","type":"http request","z":"bc6f16b.09d1fe8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":360,"y":88,"wires":[[]]},{"id":"2b03c3d7.901d2c","type":"function","z":"a4d54f7c.548f2","name":"notice","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n       // \"body\": \"This is an example notice\",\n        \"format\": \"org.matrix.custom.html\",\n        \"formatted_body\": \"This is an <strong>example</strong> notice\",\n        \"msgtype\": \"m.notice\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":226,"y":66,"wires":[["28e4ceee.c274b2"]]},{"id":"28e4ceee.c274b2","type":"http request","z":"a4d54f7c.548f2","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":378,"y":66,"wires":[[]]},{"id":"8fc11918.bc6a98","type":"subflow:3ec0df30.dbad9","z":"a4d54f7c.548f2","name":"","env":[],"x":428,"y":132,"wires":[[]]},{"id":"9b4cf5e.18e1608","type":"http request","z":"bb6828.189d77d8","name":"STRIPE API","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":570,"y":140,"wires":[["1383a220.9cd8ee","6b0d6cdb.57f434"]]},{"id":"15ef4d28.1fc163","type":"function","z":"bb6828.189d77d8","name":"Get Customers","func":"   \nif(env.get(\"id\") || msg.payload.id || msg.subscribtion || msg.payload.stripeId){\n    \n    msg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n    }\n    var customer;\n    if(msg.subscription){\n       customer =  msg.subscription.customer\n    }else if(env.get('id')){\n       customer =  env.get('id')\n    }else if(msg.payload.id){\n       customer =  msg.payload.id;\n    }else if(msg.payload.stripeId){\n        customer =  msg.payload.stripeId;\n    }\n    msg.url =\"https://api.stripe.com/v1/customers/\"+customer;\n    return [msg,null];\n}else{\n    msg.payload = \"missing params\";\n    return[null,msg]\n}\n   \n","outputs":2,"noerr":0,"x":380,"y":140,"wires":[["9b4cf5e.18e1608","ae8a57ac.5ac008"],["a7500ea7.44945"]]},{"id":"1383a220.9cd8ee","type":"switch","z":"bb6828.189d77d8","name":"","property":"payload.id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":730,"y":140,"wires":[[],["5aafd13e.f6617"]]},{"id":"6b0d6cdb.57f434","type":"debug","z":"bb6828.189d77d8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":710,"y":200,"wires":[]},{"id":"ae8a57ac.5ac008","type":"debug","z":"bb6828.189d77d8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":556,"y":88,"wires":[]},{"id":"5aafd13e.f6617","type":"link out","z":"bb6828.189d77d8","name":"","links":["2f3d89a6.551446"],"x":851,"y":154,"wires":[]},{"id":"a7500ea7.44945","type":"link out","z":"bb6828.189d77d8","name":"","links":["2f3d89a6.551446"],"x":521,"y":176,"wires":[]},{"id":"2f3d89a6.551446","type":"link in","z":"bb6828.189d77d8","name":"","links":["5aafd13e.f6617","a7500ea7.44945"],"x":763,"y":308,"wires":[[]]},{"id":"28d22742.56f6c8","type":"function","z":"ac552099.592a9","name":"Get members","func":"msg.url = env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/joined_members?access_token=\"+env.get('Token')\nmsg.payload={\n\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":240,"wires":[["96456323.bf571"]]},{"id":"96456323.bf571","type":"http request","z":"ac552099.592a9","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":610,"y":240,"wires":[["aed11e20.dd393"]]},{"id":"aed11e20.dd393","type":"function","z":"ac552099.592a9","name":"calculate member's nb","func":"\nvar joined = Object.keys(msg.payload.joined).length;\n\nif(joined == 1){\n    msg.payload = msg.messageContent;\n    return [msg,null,null];\n    \n}else if(joined == 2){\n    msg.payload = msg.messageContent;\n    return [null,msg,null];\n}else{\n    return [null,null,msg];\n}\n\nreturn msg;","outputs":3,"noerr":0,"x":800,"y":240,"wires":[["e81ac4d8.35d6f8"],["e81ac4d8.35d6f8"],[]],"icon":"font-awesome/fa-thumbs-o-down"},{"id":"ab655128.36fb3","type":"switch","z":"ac552099.592a9","name":"New Interaction ?","property":"room","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":147.99998092651367,"y":83.99998664855957,"wires":[["6346f6d5.5bf068"],["d4d94fb6.9eff5"]],"outputLabels":["","existing interaction"]},{"id":"aab8ef5e.6e8c6","type":"function","z":"ac552099.592a9","name":"Set Room ID","func":"msg.roomId= msg.room\nreturn msg;","outputs":1,"noerr":0,"x":532,"y":44,"wires":[[]],"outputLabels":["new room"]},{"id":"6daaded9.8115e","type":"function","z":"ac552099.592a9","name":"is Dierct message (@bot) ***?","func":"\nvar str = msg.event.event.content.formatted_body;\nvar strmobile = msg.event.event.content.body;\nvar bot = env.get(\"Bot\");\nvar botname = env.get(\"Bot_name\");\nvar strtxt =   msg.payload;\n\nif(str){\n    if(str.includes(bot)){\n        strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[msg,null,null]\n    }\n   \n}else if(strmobile.includes(botname)){\n     strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[null,msg,null]\n    \n}\n\nelse{\n    \n    return[null,null,msg]\n}\nreturn msg;","outputs":3,"noerr":0,"x":210,"y":220,"wires":[[],[],["28d22742.56f6c8"]],"icon":"node-red/switch.svg"},{"id":"d4d94fb6.9eff5","type":"switch","z":"ac552099.592a9","name":"","property":"event.event.content.msgtype","propertyType":"msg","rules":[{"t":"eq","v":"m.image","vt":"str"},{"t":"eq","v":"m.file","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":160,"y":154,"wires":[[],[],["6daaded9.8115e"]]},{"id":"1f2049bb.03a346","type":"link out","z":"ac552099.592a9","name":"","links":["80911a97.5061a8"],"x":1215,"y":260,"wires":[]},{"id":"80911a97.5061a8","type":"link in","z":"ac552099.592a9","name":"","links":["1f2049bb.03a346"],"x":95,"y":320,"wires":[["818a923c.f5934"]]},{"id":"818a923c.f5934","type":"function","z":"ac552099.592a9","name":"pending step found ! ","func":"\nvar data = global.get(msg.roomXD);\nvar pending = data.pendingstep;\n\ndata[pending] = msg.payload;\ndelete data.pendingstep;\nglobal.set(msg.roomXD,data);\n\n\nmsg.step = pending;\nmsg.stepcontent = msg.payload;\n\n\n data = global.get(msg.roomXD);\n\n \n \nif(data[\"STEP\"] && data.hasOwnProperty(data[\"STEP\"])){\n    data = global.get(msg.roomXD);\n    delete data[\"STEP\"];\n    global.set(msg.roomXD,data);\n}\n\n\n\nif(data.STEP){\n        msg.currentstep = data.STEP\n\n         return[msg,null]; // 4\n    }else{\n        return [null,msg];\n    }\n","outputs":2,"noerr":0,"x":255,"y":320,"wires":[["e7405015.a0dc2"],[]]},{"id":"59eec0a.052924","type":"debug","z":"ac552099.592a9","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":470,"y":360,"wires":[]},{"id":"e81ac4d8.35d6f8","type":"function","z":"ac552099.592a9","name":"pending step ?","func":"var roomId = msg.roomId;\nroomId= roomId.substr(0, roomId.indexOf(':'));\nif(!global.get(roomId)){\n    return[msg,null,null,null]; // 1\n}else{\n    \n    var data = global.get(roomId);\n    if(data.pendingstep){\n        msg.roomXD = roomId;\n        return [null,null,msg,null]; // 3\n    }else if(data.STEP){\n        msg.roomXD = roomId;\n        msg.currentstep = data.STEP\n         return[null,null,null,msg]; // 4\n    }else{\n   return[null,msg,null,null]; // 2\n\n    }\n}\n\nreturn msg;","outputs":4,"noerr":0,"x":1040,"y":240,"wires":[[],[],["1f2049bb.03a346"],[]],"icon":"node-red/switch.svg"},{"id":"e7405015.a0dc2","type":"link out","z":"ac552099.592a9","name":"","links":["ee5939c2.18fbf8"],"x":415,"y":300,"wires":[]},{"id":"ee5939c2.18fbf8","type":"link in","z":"ac552099.592a9","name":"","links":["e7405015.a0dc2"],"x":1215,"y":380,"wires":[[]]},{"id":"6346f6d5.5bf068","type":"switch","z":"ac552099.592a9","name":"","property":"event.event.unsigned.prev_content","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":44,"wires":[["aab8ef5e.6e8c6"],[]]},{"id":"82acc61f.e3f268","type":"function","z":"1c882a73.955f76","name":"send message","func":"msg.url = +env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +env.get('ROOM_ID')+ '/send/m.room.message?access_token='+env.get('TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n        \"body\": env.get('message'), //\"This is an example text message\",\n        \"msgtype\": \"m.text\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":260,"wires":[["500a0b64.708ce4"]]},{"id":"500a0b64.708ce4","type":"http request","z":"1c882a73.955f76","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":520,"y":260,"wires":[[]]},{"id":"761fef49.fc76f","type":"http request","z":"fc05d259.ac9b1","name":"Get Contact by Email","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":320,"y":120,"wires":[["20b96949.e849a6"]]},{"id":"f22245a8.7d42d8","type":"function","z":"fc05d259.ac9b1","name":"API","func":"node.warn(\"start hubspot get contact\");\nnode.warn(msg);\nnode.warn(email);\n\nif(!msg.key){\n    msg.key = env.get('hubspot_api_key');\n}\nvar email;\nif(msg.email){\n   email = msg.email.split(' ')[1]; \n}else{\n    email = env.get(\"email\");\n}\nmsg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+email+\"/profile?hapikey=\"+msg.key ;\n\nreturn msg;\n","outputs":1,"noerr":0,"x":150,"y":120,"wires":[["761fef49.fc76f"]]},{"id":"20b96949.e849a6","type":"switch","z":"fc05d259.ac9b1","name":"","property":"payload.profile-token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":120,"wires":[["86c7f2a9.32a62"],["5ce7bff5.d6065"]]},{"id":"86c7f2a9.32a62","type":"link out","z":"fc05d259.ac9b1","name":"","links":["8cda05f7.1fd9c8"],"x":620,"y":100,"wires":[]},{"id":"5ce7bff5.d6065","type":"link out","z":"fc05d259.ac9b1","name":"","links":["9473632c.e28ff"],"x":620,"y":160,"wires":[]},{"id":"5f68010b.30daa","type":"link in","z":"fc05d259.ac9b1","name":"","links":["7eafa2ab.20deec"],"x":535,"y":40,"wires":[[]]},{"id":"5d20e2be.019a3c","type":"switch","z":"fc05d259.ac9b1","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"contact does not exist","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":200,"wires":[["d0b61233.fb384"],[]]},{"id":"9473632c.e28ff","type":"link in","z":"fc05d259.ac9b1","name":"","links":["5ce7bff5.d6065"],"x":155,"y":200,"wires":[["5d20e2be.019a3c"]]},{"id":"d0b61233.fb384","type":"link out","z":"fc05d259.ac9b1","name":"","links":[],"x":395,"y":160,"wires":[]},{"id":"a73a75c8.571298","type":"function","z":"fc05d259.ac9b1","name":"display","func":"var data;\nnode.warn(msg.payload);\nif(env.get(\"display_data\")===\"text\"){\n    data = msg.payload;\n}else if(env.get(\"display_data\")===\"card\"){\n    var response = msg.payload;\nvar allThePlans = [];\nvar contact = {\n    title: response.properties.email.value,\n    subtitle:  response.properties.firstname.value +\" \"+response.properties.lastname.value,\n    img:\"https://i0.pngocean.com/files/281/858/545/logo-hubspot-inc-marketing-asg-capital-group-pty-ltd-brand-marketing.jpg\",\n    buttons: \n        [\n            {\n                type: \"url\",\n                label: \"Voir fiche\" ,// \"See more\",\n                url: response[\"profile-url\"],\n                alert: false\n            }\n        ]\n};\n\n    allThePlans.push(contact);\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\ndata = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\n}else{\n    data=msg.payload;\n}\nmsg.payload = data;\nreturn msg;\n","outputs":1,"noerr":0,"x":270,"y":300,"wires":[["7eafa2ab.20deec"]]},{"id":"8cda05f7.1fd9c8","type":"link in","z":"fc05d259.ac9b1","name":"","links":["86c7f2a9.32a62"],"x":155,"y":300,"wires":[["a73a75c8.571298"]]},{"id":"7eafa2ab.20deec","type":"link out","z":"fc05d259.ac9b1","name":"","links":["5f68010b.30daa"],"x":375,"y":300,"wires":[]},{"id":"9842aad4.d6a6a8","type":"http request","z":"468ab68b.786be8","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":550,"y":220,"wires":[["e7dfcf35.0f3a4"]]},{"id":"e5e6d606.317378","type":"function","z":"468ab68b.786be8","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nmsg.roomId = msg.req.params.roomId\nvar load = msg.payload;\nif(load.email && load.firstname && load.lastname){\n  var dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": msg.payload.email\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": msg.payload.firstname\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": msg.payload.lastname\n    },\n    {\n      \"property\": \"website\",\n      \"value\": msg.payload.website\n    },\n    {\n      \"property\": \"company\",\n      \"value\": msg.payload.company\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": msg.payload.phone\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn [msg,null];  \n}else{\n    return[null,msg];\n}\n\n","outputs":2,"noerr":0,"x":351,"y":229,"wires":[["9842aad4.d6a6a8"],["71a3c84b.620f08"]]},{"id":"e7dfcf35.0f3a4","type":"switch","z":"468ab68b.786be8","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"Contact already exists","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":777,"y":224,"wires":[[],["1b020433.5b363c"]]},{"id":"1b020433.5b363c","type":"switch","z":"468ab68b.786be8","name":"","property":"payload.vid","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":917,"y":244,"wires":[[],[]]},{"id":"4fc83f66.db4bd","type":"link in","z":"468ab68b.786be8","name":"","links":["ec720a64.e51c98","71a3c84b.620f08"],"x":939,"y":141,"wires":[[]]},{"id":"71a3c84b.620f08","type":"link out","z":"468ab68b.786be8","name":"","links":["4fc83f66.db4bd"],"x":455,"y":264,"wires":[]},{"id":"a49c0336.4b3a6","type":"http request","z":"6cd522e2.9c8dbc","name":"send message","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":444.1667022705078,"y":150.0000114440918,"wires":[["1a8064d4.45d81b"]]},{"id":"178b6186.51f52e","type":"function","z":"6cd522e2.9c8dbc","name":"","func":"msg.url= env.get('url')+'/conversations/default/messages'\nmsg.payload ={\n    text: env.get('text'),\n    sender: env.get('user')\n}\nreturn msg;","outputs":1,"noerr":0,"x":264.1667022705078,"y":150.0000114440918,"wires":[["a49c0336.4b3a6"]]},{"id":"550bf3cc.e485ec","type":"comment","z":"6cd522e2.9c8dbc","name":"send message , get intent , next action","info":"url/talk\n\nDocumentation\nhttps://rasa.com/docs/rasa/api/http-api/#tag/Tracker/paths/~1conversations~1{conversation_id}~1execute/post","x":254.1667022705078,"y":70.0000114440918,"wires":[]},{"id":"263b82ca.50281e","type":"http request","z":"6cd522e2.9c8dbc","name":"predict next action","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"basic","x":844.1667022705078,"y":150.0000114440918,"wires":[[]]},{"id":"1a8064d4.45d81b","type":"function","z":"6cd522e2.9c8dbc","name":"","func":"msg.url= env.get('url')+'/conversations/default/predict'\nmsg.payload ={\n    text: env.get('text'),\n    sender: env.get('user')\n}\nreturn msg;","outputs":1,"noerr":0,"x":644.1667022705078,"y":150.0000114440918,"wires":[["263b82ca.50281e"]]},{"id":"b134b91b.6d4df8","type":"link in","z":"6cd522e2.9c8dbc","name":"","links":[],"x":168.3333282470703,"y":700,"wires":[["652b3d9d.da4004"]]},{"id":"652b3d9d.da4004","type":"chatbot-text","z":"6cd522e2.9c8dbc","name":"","message":[{"message":"How would you like to name your bot ?"}],"x":293.3333282470703,"y":700,"wires":[["2a81d9fe.11ecf6"]]},{"id":"2a81d9fe.11ecf6","type":"link out","z":"6cd522e2.9c8dbc","name":"","links":[],"x":428.3333282470703,"y":700,"wires":[]},{"id":"90b995be.95f268","type":"http request","z":"6cd522e2.9c8dbc","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":693.3333282470703,"y":820,"wires":[["c39a45d8.468118","d556e189.6407c","a7628892.d6cde8"]]},{"id":"8de51c70.2c35","type":"function","z":"6cd522e2.9c8dbc","name":"","func":"\nvar password = Math.random().toString(36).substring(7);\nvar name = msg.payload\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/register?kind=user'\nmsg.payload = {\n    \"password\": password,\n    \"username\": name,\n    \"auth\": {\n        \"type\":\"m.login.dummy\"\n    }\n}\nmsg.roomId= msg.roomId || payload.roomId\n\nreturn msg;","outputs":1,"noerr":0,"x":503.3333282470703,"y":820,"wires":[["90b995be.95f268"]]},{"id":"6b8ee8ee.395078","type":"link in","z":"6cd522e2.9c8dbc","name":"","links":[],"x":368.3333282470703,"y":780,"wires":[["8de51c70.2c35"]]},{"id":"4b39d35b.59700c","type":"chatbot-text","z":"6cd522e2.9c8dbc","name":"","message":[{"message":"Congratulations ! Your bot is successfully created !\nyou can chat with via this link https://chat.tekos.co/#/user/{{user_id}}\nYour user ID = {{user_id}}\nYour access token = {{access_token}}\n"}],"x":1083.3333282470703,"y":800,"wires":[["82035545.e6fa18"]]},{"id":"82035545.e6fa18","type":"link out","z":"6cd522e2.9c8dbc","name":"","links":[],"x":1228.3333282470703,"y":820,"wires":[]},{"id":"ad9c0ac9.a034c8","type":"inject","z":"6cd522e2.9c8dbc","name":"","topic":"","payload":"bottrack111","payloadType":"str","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":193.3333282470703,"y":820,"wires":[["8de51c70.2c35"]]},{"id":"c39a45d8.468118","type":"function","z":"6cd522e2.9c8dbc","name":"","func":"const Analytics = global.get('analytics');\nconst client = new Analytics('vNnBOao9rVMYWaOt5KKwFP4zUoas9RPD');\n \nclient.track({\n  event: 'Create Bot',\n  userId: msg.payload.user_id\n});\n\n\n\nreturn msg;","outputs":1,"noerr":0,"x":893.3333282470703,"y":700,"wires":[[]]},{"id":"9caf1de5.b61c6","type":"http request","z":"6cd522e2.9c8dbc","name":"send message","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/messages","tls":"","proxy":"","authType":"basic","x":486.6666717529297,"y":506.6666717529297,"wires":[["b2a9969b.612778","f74406b4.064a88"]]},{"id":"638f1c7a.1148d4","type":"inject","z":"6cd522e2.9c8dbc","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":156.6666717529297,"y":466.6666717529297,"wires":[["9aeac497.fd62c8"]]},{"id":"b2a9969b.612778","type":"debug","z":"6cd522e2.9c8dbc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":766.6666717529297,"y":486.6666717529297,"wires":[]},{"id":"9aeac497.fd62c8","type":"function","z":"6cd522e2.9c8dbc","name":"","func":"msg.payload ={\n    text: \"hello\",\n    sender: \"user\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":296.6666717529297,"y":486.6666717529297,"wires":[["9caf1de5.b61c6"]]},{"id":"34505238.f1d80e","type":"comment","z":"6cd522e2.9c8dbc","name":"send message , get intent , next action","info":"","x":236.6666717529297,"y":426.6666717529297,"wires":[]},{"id":"f74406b4.064a88","type":"http request","z":"6cd522e2.9c8dbc","name":"predict next action","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/predict","tls":"","proxy":"","authType":"basic","x":706.6666717529297,"y":566.6666717529297,"wires":[["be56992.d6d3e68"]]},{"id":"be56992.d6d3e68","type":"debug","z":"6cd522e2.9c8dbc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":956.6666717529297,"y":566.6666717529297,"wires":[]},{"id":"20b03bb9.01a554","type":"comment","z":"6cd522e2.9c8dbc","name":"Predict next action ","info":"","x":706.6666717529297,"y":606.6666717529297,"wires":[]},{"id":"e4b144b.2e5c6b8","type":"comment","z":"6cd522e2.9c8dbc","name":"Auth INFO + Docs","info":"http://3.121.211.150/talk\n\npassword: adminX\n\nDocumentation\nhttps://rasa.com/docs/rasa/api/http-api/#tag/Tracker/paths/~1conversations~1{conversation_id}~1execute/post","x":766.6666717529297,"y":426.6666717529297,"wires":[]},{"id":"2ac14009.4a2fc","type":"link in","z":"6cd522e2.9c8dbc","name":"","links":[],"x":181.6666717529297,"y":526.6666717529297,"wires":[[]]},{"id":"3b0b063f.c7755a","type":"function","z":"6cd522e2.9c8dbc","name":"","func":"msg.payload ={\n    text: msg.payload,\n    sender: msg.senderId\n}\nreturn msg;","outputs":1,"noerr":0,"x":296.6666717529297,"y":526.6666717529297,"wires":[["9caf1de5.b61c6"]]},{"id":"d556e189.6407c","type":"debug","z":"6cd522e2.9c8dbc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":953.3333282470703,"y":900,"wires":[]},{"id":"a7628892.d6cde8","type":"switch","z":"6cd522e2.9c8dbc","name":"","property":"payload.errcode","propertyType":"msg","rules":[{"t":"eq","v":"M_USER_IN_USE","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":913.3333282470703,"y":780,"wires":[["4c8a3c7e.304e64"],["4b39d35b.59700c"]]},{"id":"4c8a3c7e.304e64","type":"chatbot-text","z":"6cd522e2.9c8dbc","name":"bot exist","message":[{"message":"Bot name already taken!"}],"x":1083.3333282470703,"y":740,"wires":[["82035545.e6fa18","950ab0fe.2fd93"]]},{"id":"950ab0fe.2fd93","type":"link out","z":"6cd522e2.9c8dbc","name":"","links":[],"x":1228.3333282470703,"y":700,"wires":[]},{"id":"85eaf2b9.4e3ac","type":"comment","z":"6cd522e2.9c8dbc","name":"Under Test","info":"","x":141.66666666666666,"y":345.2777735392252,"wires":[]},{"id":"2cc9f279.26a6de","type":"http request","z":"6cd522e2.9c8dbc","name":"send message","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/messages","tls":"","proxy":"","authType":"basic","x":562.5144653320312,"y":1053.9901123046875,"wires":[["6b5e0fff.93e52","abcb2043.e529e"]]},{"id":"b8e81623.dd9cd8","type":"inject","z":"6cd522e2.9c8dbc","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":182.51446533203125,"y":1053.9901123046875,"wires":[["43fcd521.514d9c"]]},{"id":"6b5e0fff.93e52","type":"debug","z":"6cd522e2.9c8dbc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":812.5144653320312,"y":1053.9901123046875,"wires":[]},{"id":"43fcd521.514d9c","type":"function","z":"6cd522e2.9c8dbc","name":"","func":"msg.payload ={\n    text: \"hello\",\n    sender: \"user\"\n}\nreturn msg;","outputs":1,"noerr":0,"x":382.51446533203125,"y":1053.9901123046875,"wires":[["2cc9f279.26a6de"]]},{"id":"a0561d30.3f579","type":"comment","z":"6cd522e2.9c8dbc","name":"send message , get intent , next action","info":"","x":232.51446533203125,"y":993.9901123046875,"wires":[]},{"id":"abcb2043.e529e","type":"http request","z":"6cd522e2.9c8dbc","name":"predict next action","method":"POST","ret":"obj","paytoqs":false,"url":"http://3.121.211.150:5005/conversations/default/predict","tls":"","proxy":"","authType":"basic","x":432.51446533203125,"y":1233.9901123046875,"wires":[["63e892d1.876c1c"]]},{"id":"63e892d1.876c1c","type":"debug","z":"6cd522e2.9c8dbc","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":742.5144653320312,"y":1233.9901123046875,"wires":[]},{"id":"88e9b282.0bde8","type":"comment","z":"6cd522e2.9c8dbc","name":"Predict next action ","info":"","x":272.51446533203125,"y":1153.9901123046875,"wires":[]},{"id":"6694d11b.c475","type":"comment","z":"6cd522e2.9c8dbc","name":"Auth INFO + Docs","info":"http://3.121.211.150/talk\n\npassword: adminX\n\nDocumentation\nhttps://rasa.com/docs/rasa/api/http-api/#tag/Tracker/paths/~1conversations~1{conversation_id}~1execute/post","x":552.5144653320312,"y":993.9901123046875,"wires":[]},{"id":"6a8f810a.7a9be","type":"subflow:468ab68b.786be8","z":"6cd522e2.9c8dbc","name":"","env":[],"x":523.6909942626953,"y":226.2083511352539,"wires":[[],[]]},{"id":"9bcff59e.d53358","type":"function","z":"9bb5c266.46852","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=event&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"name\": env.get('EVENT_NAME'),\n  \"type\": \"customEvent\",\n  \"userId\": \"@miled.essaafi:m.tekos.co\", //msg.senderId,\n  \"extraInfo\": {\n    \"start\": 1500504070512,\n    \"difference\": 374,\n    \"end\": 1500504070886\n  }\n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":220,"wires":[["227a71f9.71414e"]]},{"id":"227a71f9.71414e","type":"http request","z":"9bb5c266.46852","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":550,"y":220,"wires":[[]]},{"id":"4ba0e7e4.deddb8","type":"subflow:bed1da1b.ae0d78","z":"9bb5c266.46852","name":"","x":264,"y":374,"wires":[[]]},{"id":"5ea6a46f.99666c","type":"subflow:dc10e8d0.e82a98","z":"9bb5c266.46852","name":"","x":200,"y":440,"wires":[[]]},{"id":"f98da3d9.1e47e","type":"function","z":"dc10e8d0.e82a98","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=outgoing&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"text\": msg.payload,\n  \"userId\": msg.senderId,\n  \"platformJson\": {\n    \"roomid\": msg.roomId\n  } \n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["35268b24.e697e4"]]},{"id":"35268b24.e697e4","type":"http request","z":"dc10e8d0.e82a98","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":430,"y":80,"wires":[[]]},{"id":"6ff20347.42a9bc","type":"function","z":"bed1da1b.ae0d78","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=11.1.0-rest&type=incoming&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"text\": msg.payload,\n  \"userId\": msg.senderId,\n  \"platformJson\": {\n    \"roomid\": msg.roomId\n  } \n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":300,"y":120,"wires":[["ea6f3361.8cbdb"]]},{"id":"ea6f3361.8cbdb","type":"http request","z":"bed1da1b.ae0d78","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":120,"wires":[["6e0bfbd7.bf0604"]]},{"id":"6e0bfbd7.bf0604","type":"debug","z":"bed1da1b.ae0d78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":160,"wires":[]},{"id":"6be03d85.45c5a4","type":"function","z":"d8e00d64.8e54c","name":"Invite operator","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/invite?access_token=\"+env.get('TOKEN')\nmsg.payload={\n\n  \"user_id\": env.get('Operator')\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["c7b4251.e4577d8"]]},{"id":"c7b4251.e4577d8","type":"http request","z":"d8e00d64.8e54c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":370,"y":80,"wires":[[]]},{"id":"db8bd978.459ee8","type":"link in","z":"9c8fbc42.476be","name":"","links":["7129bcbb.f56c34","c476caba.03dec8","3e803112.4ad10e","d6f8779d.3b3c08","26f871a0.d51a3e"],"x":835,"y":80,"wires":[["de179e1a.df878"]]},{"id":"f8650e5f.33986","type":"Tekos out","z":"9c8fbc42.476be","name":"","bot":"e65bbf12.d7e23","x":460,"y":120,"wires":[]},{"id":"92e47762.827e98","type":"link out","z":"9c8fbc42.476be","name":"","links":["b24489b5.5c1268"],"x":265,"y":123,"wires":[]},{"id":"8e879bc8.7f2788","type":"link out","z":"9c8fbc42.476be","name":"start","links":["fb6d19ce.2289c8"],"x":349,"y":195,"wires":[],"info":"Link to onbording interaction"},{"id":"fb6d19ce.2289c8","type":"link in","z":"9c8fbc42.476be","name":"","links":["8e879bc8.7f2788","55b9255f.498e4c"],"x":615,"y":220,"wires":[["a529dfcb.5376e"]]},{"id":"4e930477.a4e66c","type":"chatbot-text","z":"9c8fbc42.476be","name":"Onbording","message":[{"message":"Hello, Welcome. My Name is Teksa, I'm asked my collegue Miled, a human, to join our conversation ðŸ˜ƒ "}],"x":874,"y":220,"wires":[["3301f50e.cc62ba","aff23b44.afa338"]]},{"id":"3301f50e.cc62ba","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298","4b5a232d.4e28fc"],"x":1001,"y":198,"wires":[]},{"id":"56165057.b3298","type":"link in","z":"9c8fbc42.476be","name":"TekosOut","links":["ba7ce9c5.aace78","a6129d24.0da04","cb322ea0.3631e","79844ae8.305824","3301f50e.cc62ba","48323382.384d2c","80533fcd.c4ae","2e1a67fc.b5ab68","efb78ffa.795f8","9780b1b7.e2d35","8e9b8033.42b7c","7b50f906.830de8","6019764.b9ad088","8b833035.834ae","700965d3.e3fc2c","76c70e2e.71396","4a48a08.e900e6","3b135afa.ba9bf6","24642811.787118","26d91ab7.570356","20f06907.6962d6","65c21c4.f4044e4","8ac227d9.f65d88","13e693de.0ee42c","9f869059.7c014","346e2f7.6bf54d","3db9cb7.b2f4634","713a3fcd.c7fc7","ab6c884f.043998","7252c493.fa00ac","423e6837.667528","15c7555f.ea072b","8799b02c.bda23","e53db452.889128","45d8540d.9a258c","6ca1f2b4.965cdc","51c72751.af9c98","ef8cca20.204848","b6e1939b.f46d7","f562994f.47a488","b25dd224.8228d","848f70f5.b68ac","a753e9ea.8444c8","ef358403.c9b3e8","7099eedf.f10f8","bc08308.6e726d","c9ea4cfb.7ba2f","5e9741e3.6dba6","5ca430e.c5866d","7aa2a2d8.8f825c","c4b32145.88b71","bdb94b32.4b2fb8","6e187b08.3be594","c5beba23.690178","916779f.feda788","21467d5e.ba91c2","59272024.cd32d","e2f3679e.be80f8","bd82a545.71abd8","4a9437e7.f8a038","51a60ec1.588d9","48bfa5f4.246bac","4687b71b.7fa6c8","b597d08e.b0c7b","7929bcde.f77764","5f599e01.38c13","4e83ab52.51dc84","c1ea86ab.91c628","44e53416.2e89ac","5d5fa886.29ed58","cc222265.74ade","4e19994d.993458","6984a4b2.93847c","ab4f8c9e.bed59","ead22a8f.61ee18","70a1a76a.2b8798","7cdc912b.354f7","50c864e9.ce303c","e8cbf7c5.403728","cc443cb8.660f4","e4c49a5c.8a3048","6b94e86b.aeafe8","6daca5bf.0593ec","87197028.d636e","df8e0a7e.4bb988","5e47bffc.f3b84","c03ca3ea.235ab","ae2c2da.9b56bd","254660ac.f08bf","fccb2d1f.89853","3f1936ea.e961ca","37b977be.ac61d8","6c0d248.5f710dc","e4b18a65.639fa8","bf5b5b0c.3b48c8","257530a7.5055c","a4935bf1.708638"],"x":349,"y":122,"wires":[["f8650e5f.33986"]]},{"id":"cd248150.9908a","type":"chatbot-generic-buttons","z":"9c8fbc42.476be","name":"Menu","buttons":[{"type":"postback","label":"Action 1","value":"action 1","alert":false},{"type":"url","label":"Visit Support Center","url":"https://tekos.freshdesk.com/a/solutions/articles/43000542170"}],"message":"Plans: ","x":1170,"y":80,"wires":[["cb322ea0.3631e","9725b9c9.f51148"]]},{"id":"cb322ea0.3631e","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":1255,"y":40,"wires":[]},{"id":"fb873ffb.279f2","type":"switch","z":"9c8fbc42.476be","name":"onbording","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"menu","vt":"str"},{"t":"eq","v":"services","vt":"str"},{"t":"eq","v":"start","vt":"str"},{"t":"eq","v":"talk to human","vt":"str"},{"t":"eq","v":"Contact Support","vt":"str"},{"t":"cont","v":"deploy template","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":7,"x":332,"y":836,"wires":[["c476caba.03dec8"],["c476caba.03dec8"],["55b9255f.498e4c"],["91f10d1e.8e601"],["91f10d1e.8e601"],["e1ed7b8f.04fc28"],["d90fea52.ce36d8"]]},{"id":"279d002f.28752","type":"link in","z":"9c8fbc42.476be","name":"","links":["5893370.a6ee9c8"],"x":695,"y":860,"wires":[["10565f99.87c63"]]},{"id":"10565f99.87c63","type":"chatbot-text","z":"9c8fbc42.476be","name":"Fallback","message":[{"message":"DÃ©solÃ© je n'ai pas compris votre message ðŸ˜ƒ"},{"message":"Je suis encore un bot"}],"x":806,"y":858,"wires":[["a6129d24.0da04"]]},{"id":"a6129d24.0da04","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":910.0000286102295,"y":858.0000896453857,"wires":[]},{"id":"3e803112.4ad10e","type":"link out","z":"9c8fbc42.476be","name":"","links":["db8bd978.459ee8"],"x":895,"y":120,"wires":[]},{"id":"c476caba.03dec8","type":"link out","z":"9c8fbc42.476be","name":"","links":["db8bd978.459ee8"],"x":551,"y":755,"wires":[]},{"id":"55b9255f.498e4c","type":"link out","z":"9c8fbc42.476be","name":"","links":["fb6d19ce.2289c8"],"x":551,"y":795,"wires":[]},{"id":"4b580fb5.e3f93","type":"link out","z":"9c8fbc42.476be","name":"","links":["83b71f9e.f5496"],"x":551,"y":1034,"wires":[]},{"id":"91f10d1e.8e601","type":"link out","z":"9c8fbc42.476be","name":"","links":["74712369.9a7b1c","146071e.c8df58e","2fceaeb5.3c97f2"],"x":551,"y":836,"wires":[]},{"id":"85b478be.b47a48","type":"switch","z":"9c8fbc42.476be","name":"actions","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"action 1","vt":"str"},{"t":"eq","v":"action 2","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":340,"y":1100,"wires":[["4b580fb5.e3f93"],["ce41a7b4.3b6e78"],["4122874.51f9278"]]},{"id":"ce41a7b4.3b6e78","type":"link out","z":"9c8fbc42.476be","name":"","links":["83d73190.c1bf7"],"x":551,"y":1078,"wires":[]},{"id":"83d73190.c1bf7","type":"link in","z":"9c8fbc42.476be","name":"","links":["ce41a7b4.3b6e78"],"x":695,"y":1060,"wires":[[]]},{"id":"6d3eb641.e2ce58","type":"chatbot-text","z":"9c8fbc42.476be","name":"capabilites","message":[{"message":"How can I help you today ?"}],"x":822,"y":278,"wires":[["ef358403.c9b3e8","37f8b278.71f27e"]]},{"id":"ef358403.c9b3e8","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":967,"y":238,"wires":[]},{"id":"f62c2ee8.588ef","type":"Tekos in","z":"9c8fbc42.476be","name":"","bot":"e65bbf12.d7e23","x":170,"y":123,"wires":[["92e47762.827e98"]]},{"id":"1be0dc06.d713d4","type":"chatbot-text","z":"9c8fbc42.476be","name":"will connect ","message":[{"message":"ok, i'll try to find a human connected. \nYou can also rise a support ticket here: https://tekos.freshdesk.com/support/tickets/new\n\n"}],"x":816,"y":948,"wires":[["6e187b08.3be594","470d380e.708d78"]]},{"id":"6e187b08.3be594","type":"link out","z":"9c8fbc42.476be","name":"","links":["677b0cc5.72afa4","ae715241.a6aa1","56165057.b3298"],"x":937,"y":904,"wires":[]},{"id":"2fceaeb5.3c97f2","type":"link in","z":"9c8fbc42.476be","name":"","links":["60628679.a9a3b8","91f10d1e.8e601","cb5f2660.8441d8"],"x":696.9999713897705,"y":947.9999103546143,"wires":[["1be0dc06.d713d4"]]},{"id":"470d380e.708d78","type":"subflow:d8e00d64.8e54c","z":"9c8fbc42.476be","name":"","env":[{"name":"Operator","value":"@miled.essaafi:m.tekos.co","type":"str"},{"name":"Opretaor","value":"@miled.essaafi:m.tekos.co","type":"str"}],"x":1016,"y":948,"wires":[[]]},{"id":"b24489b5.5c1268","type":"link in","z":"9c8fbc42.476be","name":"","links":["92e47762.827e98"],"x":129,"y":239,"wires":[["c5191aa9.0f3938"]]},{"id":"fecf3017.0f271","type":"inject","z":"9c8fbc42.476be","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":140,"y":53,"wires":[["c830ce4.e9b8d3"]]},{"id":"83b71f9e.f5496","type":"link in","z":"9c8fbc42.476be","name":"","links":["4b580fb5.e3f93","c939c4e7.7e3238","9e9ce9fa.f46ae8","87fec19b.2393a","f860a85e.919d08"],"x":695,"y":1000,"wires":[[]]},{"id":"c830ce4.e9b8d3","type":"subflow:9b782c32.24018","z":"9c8fbc42.476be","name":"","env":[{"name":"NAME","value":"Tekos Test","type":"str"},{"name":"AVATAR","value":"mxc://m.tekos.co/PcQNEQaOanMsjrvSTnZtOLKG","type":"str"}],"x":382,"y":54,"wires":[[]]},{"id":"7bc811ea.7cc2","type":"comment","z":"9c8fbc42.476be","name":"go to step: name","info":"","x":680,"y":80,"wires":[]},{"id":"6113902d.5059a","type":"link in","z":"9c8fbc42.476be","name":"","links":["ac637e20.539e","4122874.51f9278"],"x":75,"y":420,"wires":[["efb22fd9.68d69"]]},{"id":"914fa117.970ba","type":"debug","z":"9c8fbc42.476be","name":"Response","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"_dialogflow","targetType":"msg","x":1014,"y":594,"wires":[]},{"id":"d90fea52.ce36d8","type":"link out","z":"9c8fbc42.476be","name":"","links":["59ab4824.7ca398"],"x":551,"y":915,"wires":[]},{"id":"59ab4824.7ca398","type":"link in","z":"9c8fbc42.476be","name":"","links":["d90fea52.ce36d8"],"x":215,"y":1100,"wires":[["85b478be.b47a48"]]},{"id":"4a4880d3.2a512","type":"link out","z":"9c8fbc42.476be","name":"","links":["77f1b3ca.4d21ac"],"x":349,"y":239,"wires":[]},{"id":"77f1b3ca.4d21ac","type":"link in","z":"9c8fbc42.476be","name":"","links":["4a4880d3.2a512","aaac7a2a.fe3f58"],"x":199,"y":845,"wires":[["fb873ffb.279f2"]]},{"id":"4122874.51f9278","type":"link out","z":"9c8fbc42.476be","name":"","links":["b1200440.54a4e8","6113902d.5059a"],"x":555,"y":1160,"wires":[]},{"id":"9725b9c9.f51148","type":"chatbot-generic-buttons","z":"9c8fbc42.476be","name":"Menu","buttons":[{"type":"postback","label":"Talk to our team","value":"talk to human","alert":false},{"type":"postback","label":"create your action","value":"action 2","alert":false}],"message":"Account","x":1310,"y":80,"wires":[["87197028.d636e"]]},{"id":"87197028.d636e","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":1395,"y":220,"wires":[]},{"id":"e4cc2be9.fd0838","type":"switch","z":"9c8fbc42.476be","name":"action","property":"_dialogflow.action","propertyType":"msg","rules":[{"t":"eq","v":"action 1","vt":"str"},{"t":"eq","v":"give_capabilities","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":1062,"y":752,"wires":[["9e9ce9fa.f46ae8"],["8dbc066a.1ddb08"],["117fccd7.4ce7c3"]]},{"id":"9e9ce9fa.f46ae8","type":"link out","z":"9c8fbc42.476be","name":"","links":["83b71f9e.f5496"],"x":1215,"y":580,"wires":[]},{"id":"117fccd7.4ce7c3","type":"change","z":"9c8fbc42.476be","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"_dialogflow.fulfillmentMessages[0].text.text[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":1280,"y":720,"wires":[["1b465d2a.2f3983"]]},{"id":"1b465d2a.2f3983","type":"chatbot-text","z":"9c8fbc42.476be","name":"fullfillment message","message":[{"message":""}],"x":1510,"y":720,"wires":[["257530a7.5055c"]]},{"id":"169baa3a.2de206","type":"link in","z":"9c8fbc42.476be","name":"","links":["aff23b44.afa338","8dbc066a.1ddb08"],"x":716,"y":279,"wires":[["6d3eb641.e2ce58"]]},{"id":"aff23b44.afa338","type":"link out","z":"9c8fbc42.476be","name":"","links":["169baa3a.2de206"],"x":1045,"y":220,"wires":[]},{"id":"8dbc066a.1ddb08","type":"link out","z":"9c8fbc42.476be","name":"","links":["bafe1309.ead79","169baa3a.2de206"],"x":1215,"y":620,"wires":[]},{"id":"fbe227b3.5c3508","type":"chatbot-generic-buttons","z":"9c8fbc42.476be","name":"handover ?","buttons":[{"type":"postback","label":"Talk to human","value":"Talk to human","alert":false}],"message":"Do you need to talk to a human ?","x":1316,"y":814,"wires":[[]]},{"id":"9aacee.88d1931","type":"link in","z":"9c8fbc42.476be","name":"","links":[],"x":1211,"y":814,"wires":[["fbe227b3.5c3508"]]},{"id":"cb5f2660.8441d8","type":"link out","z":"9c8fbc42.476be","name":"","links":["2fceaeb5.3c97f2"],"x":1215,"y":660,"wires":[]},{"id":"edc13a4c.1be8e8","type":"link in","z":"9c8fbc42.476be","name":"","links":["293a37c5.1ff7a8"],"x":695,"y":1120,"wires":[[]]},{"id":"e1ed7b8f.04fc28","type":"link out","z":"9c8fbc42.476be","name":"","links":["51848f1c.38d28"],"x":551,"y":880,"wires":[]},{"id":"37f8b278.71f27e","type":"chatbot-text","z":"9c8fbc42.476be","name":"emoji","message":[{"message":"ðŸ¤—"}],"x":1012,"y":278,"wires":[["e4b18a65.639fa8","5014def6.b4e4d"]]},{"id":"e4b18a65.639fa8","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":1107,"y":238,"wires":[]},{"id":"de179e1a.df878","type":"chatbot-text","z":"9c8fbc42.476be","name":"","message":[{"message":"This is the main Menu ðŸ˜Ž "}],"x":960,"y":80,"wires":[["cd248150.9908a","bf5b5b0c.3b48c8"]]},{"id":"bf5b5b0c.3b48c8","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298","4b5a232d.4e28fc"],"x":1055,"y":60,"wires":[]},{"id":"c249a546.485808","type":"comment","z":"9c8fbc42.476be","name":"Use NLP service","info":"","x":400,"y":1160,"wires":[]},{"id":"b4064b92.751078","type":"comment","z":"9c8fbc42.476be","name":"See here","info":"","x":792,"y":772,"wires":[]},{"id":"257530a7.5055c","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":1655,"y":720,"wires":[]},{"id":"c5191aa9.0f3938","type":"subflow:fde10ab5.552fe8","z":"9c8fbc42.476be","name":"interaction","env":[],"x":242,"y":254,"wires":[["8e879bc8.7f2788"],["4a4880d3.2a512"],["4a4880d3.2a512"],[],[],[]]},{"id":"5d27b77b.3ab328","type":"function","z":"c8082d07.b6dbe","name":"typing status","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/typing/' +env.get('TEKOS_BOT_ID')+ '?access_token=' + env.get('TEKOS_BOT_TOKEN')\n\nmsg.headers ={\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload={\n  \"typing\": true,\n  \"timeout\": 3000\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":410,"y":80,"wires":[["627365f5.3894ec"]]},{"id":"627365f5.3894ec","type":"http request","z":"c8082d07.b6dbe","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":610,"y":80,"wires":[["ce6ac7e2.adaae8"]]},{"id":"ce6ac7e2.adaae8","type":"delay","z":"c8082d07.b6dbe","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":780,"y":80,"wires":[[]]},{"id":"8e3f6844.bef968","type":"delay","z":"c8082d07.b6dbe","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":240,"y":80,"wires":[["5d27b77b.3ab328"]]},{"id":"a529dfcb.5376e","type":"subflow:c8082d07.b6dbe","z":"9c8fbc42.476be","name":"","env":[],"x":730,"y":220,"wires":[["4e930477.a4e66c"]]},{"id":"5014def6.b4e4d","type":"subflow:d8e00d64.8e54c","z":"9c8fbc42.476be","name":"","env":[{"name":"Operator","value":"@miled.essaafi:m.tekos.co","type":"str"}],"x":1090,"y":340,"wires":[["567c2147.2c39c"]]},{"id":"567c2147.2c39c","type":"debug","z":"9c8fbc42.476be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1270,"y":300,"wires":[]},{"id":"6364faca.b4a7b4","type":"link in","z":"9c8fbc42.476be","name":"","links":["5893370.a6ee9c8"],"x":75,"y":540,"wires":[["441504e2.d776ec"]]},{"id":"441504e2.d776ec","type":"chatbot-text","z":"9c8fbc42.476be","name":"Fallback","message":[{"message":"DÃ©solÃ© je n'ai pas compris votre message ðŸ˜ƒ"},{"message":"Je suis encore un bot"}],"x":186,"y":538,"wires":[["470b6ec1.adfb1"]]},{"id":"470b6ec1.adfb1","type":"link out","z":"9c8fbc42.476be","name":"","links":["bbf29bc7.eb9a88"],"x":290.0000286102295,"y":538.0000896453857,"wires":[]},{"id":"efb22fd9.68d69","type":"dialogflowv2","z":"9c8fbc42.476be","dialogflow":"4fe304a9.fffffc","language":"en","debug":false,"variable":"topic","x":200,"y":440,"wires":[["a11c0813.a91ec8","4d9a5ce5.eca8d4"]]},{"id":"a11c0813.a91ec8","type":"debug","z":"9c8fbc42.476be","name":"Response","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"_dialogflow","targetType":"msg","x":406,"y":386,"wires":[]},{"id":"bbed75ea.cafd38","type":"switch","z":"9c8fbc42.476be","name":"action","property":"_dialogflow.action","propertyType":"msg","rules":[{"t":"eq","v":"create_flow","vt":"str"},{"t":"eq","v":"my_flows","vt":"str"},{"t":"eq","v":"update_card","vt":"str"},{"t":"eq","v":"show_menu","vt":"str"},{"t":"eq","v":"give_capabilities","vt":"str"},{"t":"eq","v":"handover_request","vt":"str"},{"t":"eq","v":"update_billing","vt":"str"},{"t":"eq","v":"my_subscriptions","vt":"str"},{"t":"eq","v":"invite_to_room","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":10,"x":440,"y":474,"wires":[["fb4cddc3.800df"],["5ba41a36.af80c4"],["92d576ec.064d08"],["abd2390b.c9db58"],["fc6c018a.da398"],["cc0d0f37.9a2b9"],["11c35644.32be9a"],["cebfa427.1467b8"],["c78dc032.1b2df"],["bcbd8e38.ed75c"]]},{"id":"fb4cddc3.800df","type":"link out","z":"9c8fbc42.476be","name":"","links":["a8c6a287.a121e"],"x":705,"y":356,"wires":[]},{"id":"5ba41a36.af80c4","type":"link out","z":"9c8fbc42.476be","name":"","links":["1dab6e99.8144a1"],"x":705,"y":400,"wires":[]},{"id":"bcbd8e38.ed75c","type":"change","z":"9c8fbc42.476be","name":"","rules":[{"t":"set","p":"payload","pt":"msg","to":"_dialogflow.fulfillmentMessages[0].text.text[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":660,"y":540,"wires":[["9b943925.b11ef8"]]},{"id":"92d576ec.064d08","type":"link out","z":"9c8fbc42.476be","name":"","links":["7cf2f0f0.fb55e"],"x":705,"y":444,"wires":[]},{"id":"abd2390b.c9db58","type":"link out","z":"9c8fbc42.476be","name":"","links":["eefdb4c9.9bd638"],"x":625,"y":408,"wires":[]},{"id":"fc6c018a.da398","type":"link out","z":"9c8fbc42.476be","name":"","links":["bafe1309.ead79","fcda4a3b.dab258"],"x":625,"y":452,"wires":[]},{"id":"cc0d0f37.9a2b9","type":"link out","z":"9c8fbc42.476be","name":"","links":["307a2e8c.dc52b2"],"x":625,"y":474,"wires":[]},{"id":"11c35644.32be9a","type":"link out","z":"9c8fbc42.476be","name":"","links":["5dc70f13.28596"],"x":625,"y":496,"wires":[]},{"id":"cebfa427.1467b8","type":"link out","z":"9c8fbc42.476be","name":"","links":["4f21af6c.ecdc4"],"x":676,"y":496,"wires":[]},{"id":"c78dc032.1b2df","type":"link out","z":"9c8fbc42.476be","name":"","links":["b3cc5e8b.75542"],"x":713,"y":474,"wires":[]},{"id":"9b943925.b11ef8","type":"chatbot-text","z":"9c8fbc42.476be","name":"fullfillment message","message":[{"message":""}],"x":910,"y":540,"wires":[["a4935bf1.708638"]]},{"id":"a4935bf1.708638","type":"link out","z":"9c8fbc42.476be","name":"","links":["bbf29bc7.eb9a88","56165057.b3298"],"x":1055,"y":540,"wires":[]},{"id":"4d9a5ce5.eca8d4","type":"subflow:c8082d07.b6dbe","z":"9c8fbc42.476be","name":"","env":[],"x":280,"y":480,"wires":[["bbed75ea.cafd38"]]},{"id":"328575b7.e586ea","type":"function","z":"536ddfdb.b102e","name":"Matrix API","func":"\n\nmsg.url = \"https://m.tekos.co/_matrix/client/r0/admin/whois/\"+env.get('user')+\"?access_token=\"+env.get('token')\nmsg.payload = {\n}\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["ba6d2b8b.2a0d88"]]},{"id":"ba6d2b8b.2a0d88","type":"http request","z":"536ddfdb.b102e","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":370,"y":80,"wires":[["1fd24fbb.e0f09"]]},{"id":"1fd24fbb.e0f09","type":"function","z":"536ddfdb.b102e","name":"Get Ip Details","func":"\n\nmsg.url = \"https://freegeoip.app/json/\"+msg.payload.devices[\"\"].sessions[0].connections[0].ip\nmsg.payload = {\n}\nreturn msg;","outputs":1,"noerr":0,"x":540,"y":140,"wires":[["64e3a4f.3f90d5c"]]},{"id":"64e3a4f.3f90d5c","type":"http request","z":"536ddfdb.b102e","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":750,"y":140,"wires":[[]]},{"id":"594616c4.142e48","type":"function","z":"be6d1230.c6132","name":"Matrix API","func":"\n\nmsg.url = \"https://m.tekos.co/_matrix/client/r0/user/\"+env.get('user')+\"/rooms/\"+env.get('room')+\"/tags/\"+env.get('tag')+\"?access_token=\"+env.get('token')\nmsg.payload = {\n\n  \"order\": 0.25\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["8fa013a1.c0816"]]},{"id":"8fa013a1.c0816","type":"http request","z":"be6d1230.c6132","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":370,"y":80,"wires":[["c500e6b8.836aa8"]]},{"id":"c500e6b8.836aa8","type":"debug","z":"be6d1230.c6132","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":560,"y":160,"wires":[]},{"id":"4829f7b0.dda9f8","type":"inject","z":"9c8fbc42.476be","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":580,"y":160,"wires":[["74c6819f.4933c"]]},{"id":"f3b1d6fd.3d5108","type":"debug","z":"9c8fbc42.476be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":880,"y":180,"wires":[]},{"id":"74c6819f.4933c","type":"process-env","z":"9c8fbc42.476be","name":"","into":"payload","x":750,"y":160,"wires":[["f3b1d6fd.3d5108"]]},{"id":"c9701dfc.d0fca","type":"debug","z":"9c8fbc42.476be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":510,"y":1360,"wires":[]},{"id":"502996d4.3044c8","type":"inject","z":"9c8fbc42.476be","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":160,"y":1400,"wires":[["6a4691e6.d4665"]]},{"id":"6a4691e6.d4665","type":"subflow:536ddfdb.b102e","z":"9c8fbc42.476be","name":"","env":[],"x":320,"y":1400,"wires":[["c9701dfc.d0fca"],["9c45ef4c.b9a4b"]]},{"id":"9c45ef4c.b9a4b","type":"debug","z":"9c8fbc42.476be","name":"IP Details","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":540,"y":1440,"wires":[]},{"id":"1836aaac.4d01f5","type":"subflow:9b2392b3.300b4","z":"c8472726.d73988","name":"","env":[],"x":160,"y":240,"wires":[[]]}]