[{"id":"9c8fbc42.476be","type":"tab","label":"BoilerPlate & Handover","disabled":false,"info":""},{"id":"f65c1e1d.fa70b","type":"tab","label":"DialogFlow & Voice","disabled":true,"info":""},{"id":"c8472726.d73988","type":"tab","label":"temp","disabled":false,"info":""},{"id":"9b782c32.24018","type":"subflow","name":"Customize Bot Name & Avatar","info":" - Drag and drop the node in the palette and link it to the inject node\n  - Customize the name and the avatar using the mxc link (learn how to get the mxc file link here: http://bit.ly/get-mxc-link)\n  - Deploy\n - Click on the inject node\n - You're done\n\n\n![enter image description here](https://s3.amazonaws.com/cdn.freshdesk.com/data/helpdesk/attachments/production/43081642120/original/3tP-QasxD7e45Ksr1-aQAK5lenHd-frAjw.gif?1572521514)","category":"tekos chatbot","in":[{"x":160,"y":140,"wires":[{"id":"a898ea71.7e6e28"}]}],"out":[{"x":1060,"y":140,"wires":[{"id":"236f611.2e7279e","port":0}]}],"env":[{"name":"NAME","type":"str","value":"","ui":{"icon":"font-awesome/fa-address-card-o","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"AVATAR","type":"str","value":"","ui":{"icon":"font-awesome/fa-user-circle","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"TEKOS_BOT_ID","type":"env","value":"TEKOS_BOT_ID","ui":{"icon":"font-awesome/fa-commenting-o","type":"input","opts":{"types":["str","env"]},"label":{}}},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"icon":"font-awesome/fa-wrench","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DEB887","icon":"font-awesome/fa-user-circle-o"},{"id":"d0bf3750.bcab08","type":"subflow","name":"Human handover","info":"Human handover or takeover\nInvite a Human Operator to a discussion","category":"tekos chatbot","in":[{"x":40,"y":80,"wires":[{"id":"d776bb3b.1447b8"}]}],"out":[],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN","ui":{"icon":"font-awesome/fa-key","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"Operator","type":"str","value":"@","ui":{"icon":"font-awesome/fa-address-book","label":{},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#A6BBCF","icon":"font-awesome/fa-male"},{"id":"d5c46538.c915f8","type":"subflow","name":"Hubspot | Get contact","info":"","category":"CRM","in":[{"x":50,"y":30,"wires":[{"id":"c6946236.48316"}]}],"out":[{"x":620,"y":40,"wires":[{"id":"3808528c.de8f8e","port":0}]},{"x":460,"y":180,"wires":[{"id":"e1f9849f.67ae98","port":0}]},{"x":460,"y":240,"wires":[{"id":"e1f9849f.67ae98","port":1}]}],"env":[{"name":"hubspot_api_key","type":"str","value":"","ui":{"label":{"en-US":"HS API Key"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"display_data","type":"str","value":"","ui":{"label":{"en-US":"Display data format"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#FFAAAA","icon":"node-red/leveldb.png"},{"id":"19a4ce64.de4022","type":"subflow","name":"Hubspot | Create Contact","info":"","category":"CRM","in":[{"x":50,"y":30,"wires":[{"id":"8facad14.07966"}]}],"out":[{"x":760,"y":240,"wires":[{"id":"ece26f27.14534","port":0}]},{"x":920,"y":300,"wires":[{"id":"7f5b02e8.1fa73c","port":0}]}],"env":[{"name":"hubspot_api_key","type":"str","value":""},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#FFAAAA","icon":"node-red/leveldb.png"},{"id":"855c2bc0.26c788","type":"subflow","name":"Add Step ","info":"","category":"tekos chatbot","in":[{"x":200,"y":100,"wires":[{"id":"527f55fd.153f2c"}]}],"out":[{"x":460,"y":80,"wires":[{"id":"527f55fd.153f2c","port":0},{"id":"527f55fd.153f2c","port":1}]},{"x":460,"y":140,"wires":[{"id":"527f55fd.153f2c","port":2}]}],"env":[{"name":"step","type":"str","value":"","ui":{"icon":"font-awesome/fa-bolt","label":{"en-US":"name of the step"}}},{"name":"value","type":"str","value":""}],"color":"#F3B567","icon":"node-red-contrib-tekosbot/chatbot-quick-replies.png"},{"id":"941b9034.09257","type":"subflow","name":"File Upload Cloudinary (in progress)","info":"","category":"tekos chatbot","in":[{"x":140,"y":180,"wires":[{"id":"21234782.c72238"}]}],"out":[{"x":580,"y":180,"wires":[{"id":"901dc9ba.bb2268","port":0}]},{"x":420,"y":260,"wires":[{"id":"fa30f46e.d367c8","port":0}]}],"env":[{"name":"base_url","type":"env","value":"BASE_URL"},{"name":"cloudinary_cloud_name","type":"str","value":""},{"name":"cloudinary_upload_preset","type":"str","value":""},{"name":"post_url","type":"str","value":"/cloudinary"},{"name":"button_text","type":"str","value":"Upload Your File"},{"name":"flow_url","type":"env","value":"FLOW_URL"}],"color":"#A6BBCF","icon":"node-red/file-in.svg"},{"id":"11b3cac3.191255","type":"subflow","name":"Send a File (in progress)","info":"","category":"tekos chatbot","in":[{"x":40,"y":80,"wires":[{"id":"59f3dbad.703d24"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"ccf2bb15.472ad8","port":0}]}],"env":[{"name":"TOKEN","type":"str","value":""}],"color":"#D7D7A0","icon":"font-awesome/fa-file-text-o"},{"id":"9046be0b.a30f1","type":"subflow","name":"Get mxc link (in progress)","info":"","category":"tekos chatbot","in":[{"x":60,"y":80,"wires":[{"id":"4b6669bd.8320f8"}]}],"out":[{"x":540,"y":80,"wires":[{"id":"319f8d6c.e498a2","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"FILE_URL","type":"str","value":""},{"name":"content-type","type":"str","value":"","ui":{"type":"select","opts":{"opts":[{"l":{"en-US":"application/pdf"},"v":"application/pdf"},{"l":{"en-US":"audio/mp3"},"v":"audio/mp3"},{"l":{"en-US":"default-src 'none'"},"v":"default-src 'none'"},{"l":{"en-US":"script-src 'none'"},"v":"script-src 'none'"},{"l":{"en-US":"style-src 'unsafe-inline'"},"v":"style-src 'unsafe-inline'"},{"l":{"en-US":"object-src 'self'"},"v":"object-src 'self'"},{"l":{"en-US":"default-src 'none'"},"v":""}]}}}],"color":"#C0C0C0","icon":"node-red/cog.svg"},{"id":"509dfe6d.39977","type":"subflow","name":"Send Video","info":"Send a video to a room\n\nUse the MXC link and not a simple url\n\nses how to get the MXC link: [http://bit.ly/get-mxc-link](http://bit.ly/get-mxc-link)\n","category":"tekos chatbot","in":[{"x":100,"y":200,"wires":[{"id":"a3929fb3.32f98"}]}],"out":[{"x":600,"y":200,"wires":[{"id":"87b5ee2b.e9b5c","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"thumbnail_mxc","type":"str","value":""},{"name":"video_mxc","type":"str","value":"mxc://m.tekos.co/aorJJwIuRbxgcanVFhQKemhR"}],"color":"#E9967A","icon":"node-red-contrib-tekosbot/video.png"},{"id":"78fafaed.cd65d4","type":"subflow","name":"Send message","info":"Another way to send a simple message to the room","category":"tekos chatbot","in":[{"x":180,"y":260,"wires":[{"id":"88ba0759.b20fd8"}]}],"out":[{"x":640,"y":260,"wires":[{"id":"7780caf1.a6c774","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"message","type":"str","value":"Hey you 😀 "}],"color":"#DAC4B4","icon":"node-red-contrib-tekosbot/chatbot-waiting.png"},{"id":"4f80bedc.87cfc","type":"subflow","name":"Formatted Text","info":"","category":"tekos chatbot","in":[{"x":40,"y":80,"wires":[{"id":"3df7a186.5c2fae"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"bc109ded.1396b","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"message","type":"str","value":"\"thinks <b>this</b> is an example emote\""}],"color":"#D7D7A0","icon":"node-red-contrib-tekosbot/chatbot-waiting.png"},{"id":"afeae1e.cea212","type":"subflow","name":"Send notice","info":"","category":"tekos chatbot","in":[{"x":108,"y":66,"wires":[{"id":"b8e88272.6715"}]}],"out":[],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"message","type":"str","value":"this is a sample notice"},{"name":"room_id","type":"str","value":"","ui":{"label":{"en-US":"room_id (optional)"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#C0DEED","icon":"node-red/alert.svg"},{"id":"3ec0df30.dbad9","type":"subflow","name":"Send Audio File (in progress)","info":"","category":"tekos chatbot","in":[{"x":60,"y":80,"wires":[{"id":"e8567378.843b3"}]}],"out":[{"x":580,"y":80,"wires":[{"id":"a1f18b27.f0be08","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#D7D7A0","icon":"font-awesome/fa-file-audio-o"},{"id":"8059b36b.b7ac1","type":"subflow","name":"Trigger on deploy","info":"Use this Node to trigger an action when you deploy the flow","category":"common","in":[],"out":[{"x":340,"y":80,"wires":[{"id":"1f8b4d5e.4bac63","port":0}]}],"env":[],"color":"#E6E0F8","icon":"node-red-contrib-tekosbot/chatbot-quick-replies.png"},{"id":"63d4d540.a3421c","type":"subflow","name":"Pipedrive","info":"","category":"CRM","in":[{"x":40,"y":80,"wires":[{"id":"f33d5103.098ba"}]}],"out":[{"x":560,"y":80,"wires":[{"id":"41979909.178918","port":0}]}],"env":[{"name":"pipedrive_api","type":"str","value":""}],"color":"#DDAA99","icon":"font-awesome/fa-address-book-o"},{"id":"27aa6202.673c3e","type":"subflow","name":"PipeDrive | Receive Notifications","info":"# 1-Set The webhook\n - Go to Pipedrive Settings, Webhook\n - Choose the  Events that you need to receive\n - Add the webhook url yourtekosflow/pipedrive\n - Add your login and credentials to securise http calls\n\n\n# 2-Create the Bot\n - Create a Bot (for free) using tekos-bot by follwoing this link: [http://bit.ly/create-bot](http://bit.ly/create-bot)\n - Optional: Customize your bot [See how](http://bit.ly/customize-bot)\n\n\n# 3-Connect your bot\n3-Go to your tekos flow instance\nGrab teh PipeDrive | Receive Event Node, link it to your\nAdd bot credentials in Tekos-In\nChoose the room where you need to receive your notifications\n\n\n\n\nUpdated\nLast values (barré) new value\n\n![](https://i.imgur.com/Sd0Iyt8.png)","category":"CRM","in":[],"out":[{"x":1120,"y":360,"wires":[{"id":"ee7f8179.22d99","port":0}]}],"env":[{"name":"URL","type":"str","value":"/pipedrive"}],"color":"#b9b5bd","icon":"font-awesome/fa-rouble"},{"id":"7c9e2fef.b50e7","type":"subflow","name":"Send Image","info":"Send an image to a room\n\nUse the MXC link and not a simple url\n\nses how to get the MXC link: http://bit.ly/get-mxc-link","category":"tekos chatbot","in":[{"x":50,"y":30,"wires":[{"id":"d9f274ef.a78b28"}]}],"out":[{"x":551.9999847412109,"y":69.00000190734863,"wires":[{"id":"c8ff8afd.5b0628","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"MXC_URL","type":"str","value":""}],"color":"#C0DEED","icon":"font-awesome/fa-image"},{"id":"b2a24cf1.c0661","type":"subflow","name":"Zendesk | Get Notifications","info":"This integration allows your team to receive custom notifications in Tekos Chat depending on your trigger settings in Zendesk.\n\nGo to Zendesk - Webhooks\n\nexemple :https://tekos1.atlassian.net/plugins/servlet/webhooks\n\nAdd the Link:\nTHIS_FLOW_LINK/zendesk\n\n","category":"in progress","in":[],"out":[{"x":922.4999504089355,"y":99.9999942779541,"wires":[{"id":"4e48b343.fd7e8c","port":0}]}],"env":[],"color":"#A6BBCF","icon":"font-awesome/fa-bug"},{"id":"b92299a8.9af4c8","type":"subflow","name":"Trello (In progress)","info":"","category":"in progress","in":[{"x":195.8333282470703,"y":84.99999809265137,"wires":[{"id":"f5c1e9e0.e3aed8"}]}],"out":[{"x":1104.999994277954,"y":70.00000095367432,"wires":[{"id":"4c7a8993.9015f8","port":0}]}],"env":[],"color":"#DDAA99"},{"id":"8a95edf0.1b4f","type":"subflow","name":"Bitbucket In progress","info":"","category":"in progress","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"aab9f259.38912","type":"subflow","name":"Jira | Get Notifications (in progress)","info":"","category":"in progress","in":[],"out":[],"env":[],"color":"#DDAA99"},{"id":"f05d1061.cd31d","type":"subflow","name":"Https request Template","info":"","category":"network","in":[{"x":50,"y":30,"wires":[{"id":"7951f7b7.d83bf8"}]}],"out":[{"x":636.9999847412109,"y":71.00000095367432,"wires":[{"id":"52800a3c.025804","port":0}]}],"env":[],"color":"#D7D7A0","icon":"font-awesome/fa-chain"},{"id":"4456c207.c3886c","type":"subflow","name":"HubSpot Boilerplate (alpha)","info":"","category":"CRM","in":[{"x":50,"y":30,"wires":[]}],"out":[{"x":780,"y":280,"wires":[]},{"x":800,"y":340,"wires":[]}],"env":[{"name":"action","type":"str","value":""},{"name":"hubspot_api_key","type":"str","value":""}],"color":"#9ccc65","icon":"node-red/leveldb.png"},{"id":"a8e33d40.895b1","type":"subflow","name":"Hubspot | Create contact from Form","info":"","category":"CRM","in":[{"x":352,"y":152,"wires":[{"id":"c77bccb8.85f93"}]}],"out":[{"x":1193,"y":308,"wires":[{"id":"cf9f2756.eac818","port":0}]},{"x":1194,"y":362,"wires":[{"id":"c51a92d6.c8e2d","port":0}]}],"env":[{"name":"hubspot_api_key","type":"str","value":""},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#FA7820","icon":"node-red/leveldb.png"},{"id":"442c770f.96d248","type":"subflow","name":"Send Email with file attached","info":"","category":"social","in":[{"x":137,"y":142,"wires":[{"id":"577f3838.949218"}]}],"out":[{"x":498,"y":257,"wires":[{"id":"460a19a9.b9f758","port":0}]}],"env":[{"name":"email","type":"str","value":""},{"name":"host","type":"str","value":""},{"name":"username","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"port","type":"str","value":"465"}],"color":"#C7E9C0","icon":"node-red/envelope.svg"},{"id":"242600cf.12cc","type":"subflow","name":"Invite User to a Room","info":"Use this Node in order to get Invited to a room with the user and initiate a direct conversation with him","category":"tekos chatbot","in":[{"x":50.00000190734863,"y":78.00000190734863,"wires":[{"id":"eb24d868.c862e8"}]}],"out":[{"x":526.9999847412109,"y":76.00000190734863,"wires":[{"id":"a7b6ccea.1e6b3","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"Operator","type":"str","value":"","ui":{"label":{"en-US":"User ID"}}},{"name":"ROOM","type":"str","value":"","ui":{"label":{"en-US":"Room ID"}}}],"color":"#DEB887","icon":"font-awesome/fa-address-book-o"},{"id":"82767481.508078","type":"subflow","name":"Hubspot | Receive Notif Boilerplate (in progress)","info":"","category":"CRM","in":[],"out":[],"env":[],"color":"#DDAA99","icon":"font-awesome/fa-database"},{"id":"fde10ab5.552fe8","type":"subflow","name":"Interaction Classifier","info":"[]()","category":"tekos chatbot","in":[{"x":50,"y":30,"wires":[{"id":"1a1a7f05.afa3f1"}]}],"out":[{"x":684.0000190734863,"y":40.00001335144043,"wires":[{"id":"9ccfba7e.4cba88","port":0}]},{"x":460,"y":200,"wires":[{"id":"ad7d2657.a3c398","port":0},{"id":"ad7d2657.a3c398","port":1}]},{"x":1100,"y":160,"wires":[{"id":"23b18362.81f1cc","port":0},{"id":"23b18362.81f1cc","port":1}]},{"x":300,"y":140,"wires":[{"id":"8ff0b37c.f47e9","port":0},{"id":"8ff0b37c.f47e9","port":1}]},{"x":1280,"y":340,"wires":[{"id":"23b18362.81f1cc","port":3},{"id":"d531bdd3.97c5c","port":0}]},{"x":482,"y":88,"wires":[{"id":"2bb14ec8.9fd482","port":1}]}],"env":[{"name":"Bot","type":"env","value":"TEKOS_BOT_ID"},{"name":"Token","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"Bot_name","type":"env","value":"BOT_NAME"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#DAC4B4","inputLabels":["Tekos in "],"outputLabels":["New Interaction","@Bot Direct message","Ditect message (user to bot)","file message","Pending STEP",""],"icon":"font-awesome/fa-random"},{"id":"af0345b1.7c4e78","type":"subflow","name":"Dashbot | User message","info":"Send data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()","category":"Analytics","in":[{"x":120,"y":120,"wires":[{"id":"ce906c7.5f25f9"}]}],"out":[{"x":700,"y":100,"wires":[{"id":"96e114ac.503328","port":0}]}],"env":[{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#D8BFD8","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"45e63626.6388b8","type":"subflow","name":"Dashbot | Bot response","info":"Send data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()","category":"Analytics","in":[{"x":50,"y":30,"wires":[{"id":"4e7c77fc.e4b3a8"}]}],"out":[{"x":620,"y":80,"wires":[{"id":"2aa23085.8afea","port":0}]}],"env":[{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#A6BBCF","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"491f6cec.662034","type":"subflow","name":"Dashbot | Track Event","info":"\nSend data to [https://www.dashbot.io/]()\n\nUnderstand User Behaviors\n\nIncrease User Satisfaction, Engagement, and Monetization\n\nCheck Documentation here:\n\n[https://www.dashbot.io/docs/webchat/](https://www.dashbot.io/docs/webchat/)\n\n[https://www.dashbot.io/docs/universal/]()\n\n[https://www.dashbot.io/docs/universal/generic-events/]()","category":"Analytics","in":[{"x":160,"y":220,"wires":[{"id":"7d78bc33.d01994"}]}],"out":[{"x":680,"y":220,"wires":[{"id":"28b7f8ff.b20778","port":0}]}],"env":[{"name":"EVENT_NAME","type":"str","value":""},{"name":"DASHBOT_TOKEN","type":"str","value":""}],"color":"#AAAA66","icon":"node-red-contrib-tekosbot/chatbot-dialogflow.png"},{"id":"9b2392b3.300b4","type":"subflow","name":"Segment.com | Send Event","info":"Use segmet.com to send User Data\nMore infos here:\nhttps://segment.com/docs/sources/server/http/","category":"Analytics","in":[{"x":100,"y":80,"wires":[{"id":"58eebebc.649af"}]}],"out":[{"x":500,"y":80,"wires":[{"id":"a5d251fb.142d9","port":0}]}],"env":[{"name":"write_key","type":"str","value":"","ui":{"label":{"en-US":"Write Key encoded"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"EVENT","type":"str","value":"","ui":{"label":{"en-US":"Event"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#87A980","icon":"font-awesome/fa-database"},{"id":"6ec18374.f95cdc","type":"subflow","name":"Save User Attribute","info":"The attributes service is essentially a simple key/value store.\n\nIt allows you to keep track of any attribute (for example, a name, age, or preference).\n\nPlace this node before the bot question if you need to store the user reponse as the attribute value (like shown in the image).\n\nOtherwise, you can set the attribute and it's value whenever you need.\n\n\n\n\n![Attrbites & steps](https://i.imgur.com/Vkq5abQ.png)","category":"tekos chatbot","in":[{"x":160,"y":140,"wires":[{"id":"62cd8a0f.e2c444"}]}],"out":[{"x":440,"y":80,"wires":[{"id":"62cd8a0f.e2c444","port":0},{"id":"62cd8a0f.e2c444","port":1}]},{"x":440,"y":160,"wires":[{"id":"62cd8a0f.e2c444","port":2}]}],"env":[{"name":"step","type":"str","value":"","ui":{"label":{"en-US":"Attribute"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"value","type":"str","value":"","ui":{"label":{"en-US":"Value"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#FFCC66","icon":"font-awesome/fa-universal-access"},{"id":"927e6891.b73778","type":"subflow","name":"Set a STEP","info":"With STEPs you can prevent the user reponse to be passed throw the switch command or the NLP process.\n\nIn a user flow, is the attribute STEP exists, it can have only one value and it is ephemerical.\nWhen a pending Step Pass throw the 'Interaction classifier' Node, it disappean, unliess to call it again before a user response.\n\nThink of them as virtual checkpoints for where the user is within the conversational structure.\n\n\n\nhere is an example of setting a\n![Attributes & steps](https://i.imgur.com/Joigul5.png)\n\n\n![Attributes & steps](https://i.imgur.com/ixnD63S.png)\n\n\n\n![Attributes & steps](https://i.imgur.com/x1aj61B.png)\n\n\n","category":"tekos chatbot","in":[{"x":220,"y":160,"wires":[{"id":"752cecd6.dc4e44"}]}],"out":[{"x":500,"y":100,"wires":[{"id":"752cecd6.dc4e44","port":0},{"id":"752cecd6.dc4e44","port":1}]},{"x":500,"y":160,"wires":[{"id":"752cecd6.dc4e44","port":2}]}],"env":[{"name":"step","type":"str","value":"STEP","ui":{"type":"hide"}},{"name":"value","type":"str","value":"","ui":{"label":{"en-US":"Step Name"}}}],"color":"#E9967A","icon":"font-awesome/fa-bookmark"},{"id":"ed261d7.da9a4e","type":"subflow","name":"Event Subscription","info":"Use this node to subscribe to events in your room\nWire with tekos In as an input","category":"tekos chatbot","in":[{"x":218,"y":198,"wires":[{"id":"4dae2ab1.e19be4"}]}],"out":[],"env":[{"name":"Events to Send:","type":"str","value":"","ui":{"type":"none","label":{},"opts":{}}},{"name":"new room created","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-plus-circle","label":{"en-US":"new_interaction"},"type":"checkbox","opts":{}}},{"name":"direct_message","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-comment-o","label":{"en-US":"direct message"},"type":"checkbox","opts":{}}},{"name":"public_message","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-comments-o","label":{"en-US":"message in public"},"type":"checkbox","opts":{}}},{"name":"file","type":"bool","value":"true","ui":{"icon":"font-awesome/fa-file-text","type":"checkbox","label":{},"opts":{}}},{"name":"URL","type":"str","value":"https://","ui":{"icon":"font-awesome/fa-arrow-circle-right","label":{"en-US":"Send to https"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#C0DEED","inputLabels":["wire with Tekos In"],"icon":"node-red/arrow-in.svg"},{"id":"fc68b1d2.502e3","type":"subflow","name":"Incoming Webhook","info":"Wire with Tekos out\nYou need to specify a room when you want to send data ","category":"network","in":[],"out":[{"x":350,"y":132,"wires":[{"id":"d99f0aa2.a1f348","port":0}]}],"env":[{"name":"endpoint","type":"str","value":"","ui":{"label":{"en-US":"endpoint:  flowurl/"}}}],"color":"#F3B567","outputLabels":["wire with Tekos Out"],"icon":"node-red/status.svg"},{"id":"30517ddd.9e4af2","type":"subflow","name":"Send Email","info":"","category":"social","in":[{"x":306,"y":154,"wires":[{"id":"8c7f6e81.a0be8"}]}],"out":[],"env":[{"name":"email","type":"str","value":""},{"name":"host","type":"str","value":""},{"name":"username","type":"str","value":""},{"name":"password","type":"str","value":""},{"name":"port","type":"str","value":""},{"name":"body","type":"str","value":""},{"name":"topic","type":"str","value":""},{"name":"email_to","type":"str","value":""}],"color":"#C7E9C0","icon":"node-red/envelope.svg"},{"id":"1c882a73.955f76","type":"subflow","name":"Send message to room","info":"Another way to send a simple message to the room","category":"tekos chatbot","in":[{"x":180,"y":260,"wires":[{"id":"82acc61f.e3f268"}]}],"out":[{"x":640,"y":260,"wires":[{"id":"500a0b64.708ce4","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"message","type":"str","value":"Hey you 😀 "},{"name":"ROOM_ID","type":"str","value":""}],"color":"#DAC4B4","icon":"node-red-contrib-tekosbot/chatbot-waiting.png"},{"id":"468ab68b.786be8","type":"subflow","name":"Hubspot | Create contact","info":"","category":"CRM","in":[{"x":211,"y":229,"wires":[{"id":"e5e6d606.317378"}]}],"out":[{"x":1032,"y":185,"wires":[{"id":"e7dfcf35.0f3a4","port":0},{"id":"4fc83f66.db4bd","port":0}]},{"x":1033,"y":239,"wires":[{"id":"1b020433.5b363c","port":0}]}],"env":[{"name":"hubspot_api_key","type":"str","value":""},{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#FA7820","icon":"node-red/leveldb.png"},{"id":"c8082d07.b6dbe","type":"subflow","name":"Typing","info":"Place the typing node just before the interaction node, like text node.\nThe typing time is arount 2s but you can modify that value inside the subflow\n\n![](https://i.imgur.com/ymFjS3b.png)\n","category":"tekos chatbot","in":[{"x":60,"y":80,"wires":[{"id":"8e3f6844.bef968"}]}],"out":[{"x":926,"y":80,"wires":[{"id":"ce6ac7e2.adaae8","port":0}]}],"env":[{"name":"TEKOS_BOT_TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"TEKOS_BOT_ID","type":"env","value":"TEKOS_BOT_ID"},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#96ceb4","icon":"font-awesome/fa-commenting-o"},{"id":"be6d1230.c6132","type":"subflow","name":"Tag Room","info":"","category":"tekos chatbot","in":[{"x":40,"y":80,"wires":[{"id":"594616c4.142e48"}]}],"out":[{"x":520,"y":80,"wires":[{"id":"8fa013a1.c0816","port":0}]}],"env":[{"name":"token","type":"str","value":"","ui":{"label":{"en-US":"Your Token"}}},{"name":"user","type":"str","value":"","ui":{"label":{"en-US":"Your User ID"}}},{"name":"room","type":"str","value":"","ui":{"label":{"en-US":"Room To tag"}}},{"name":"tag","type":"str","value":"work","ui":{"label":{"en-US":"Tag"}}},{"name":"BASE_URL","type":"env","value":"BASE_URL"}],"color":"#A6BBCF","icon":"font-awesome/fa-hashtag"},{"id":"d80133c6.592fe","type":"subflow","name":"Add & Purge Events","info":"","category":"tekos chatbot","in":[{"x":86,"y":88,"wires":[{"id":"68a98592.2aa23c"}]}],"out":[{"x":1076,"y":110,"wires":[{"id":"b27cd33d.f87e5","port":0}]}],"env":[{"name":"operation","type":"str","value":"add","ui":{"type":"select","opts":{"opts":[{"l":{"en-US":"add last event"},"v":"add"},{"l":{"en-US":"purge all saved events"},"v":"purge"}]}}},{"name":"token","type":"env","value":"TEKOS_BOT_TOKEN"}],"color":"#E9967A","icon":"font-awesome/fa-trash-o"},{"id":"5f8bd47a.7b805c","type":"subflow","name":"Send Voice","info":"","category":"tekos chatbot","in":[{"x":160,"y":80,"wires":[{"id":"a96ebca1.e1f01"}]}],"out":[],"env":[{"name":"token","type":"env","value":"BOT_TOKEN"},{"name":"homeserver","type":"str","value":"m.tekos.co"}],"color":"#F3B567","icon":"font-awesome/fa-file-audio-o"},{"id":"9426deac.34161","type":"subflow","name":"Send Generic Message","info":"","category":"","in":[{"x":100,"y":120,"wires":[{"id":"c15cb14f.e8514"}]}],"out":[{"x":560,"y":120,"wires":[{"id":"9e117e.b6dede8","port":0}]}],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"message","type":"json","value":"{\"body\":\"\",\"msgtype\":\"m.text\",\"calendly\":{\"url\":\"https://calendly.com/mohamedayoubghaddab/15min\",\"text\":\"Schedule time with me\"}}"}],"color":"#DDAA99","icon":"node-red/cog.svg"},{"id":"439dde3b.17574","type":"subflow","name":"Schedule on Calendly","info":"","category":"tekos chatbot","in":[{"x":140,"y":140,"wires":[{"id":"c57565a7.64c448"}]}],"out":[],"env":[{"name":"TOKEN","type":"env","value":"TEKOS_BOT_TOKEN"},{"name":"BASE_URL","type":"env","value":"BASE_URL"},{"name":"cta","type":"str","value":"Schedule a Meeting","ui":{"label":{"en-US":"Call to Action"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}},{"name":"cal_url","type":"str","value":"https://calendly.com/**","ui":{"label":{"en-US":"Calendly URL"},"type":"input","opts":{"types":["str","num","bool","json","bin","env"]}}}],"color":"#DDAA99","icon":"font-awesome/fa-calendar-plus-o"},{"id":"d0a9b04.8c7f35","type":"tekos bot","z":"","name":"Your Bot","room":"","userId":"${TEKOS_BOT_ID}","accessToken":"${TEKOS_BOT_TOKEN}","matrixServerURL":"https://m.tekos.co"},{"id":"e65bbf12.d7e23","type":"tekos bot","z":"","name":"Your Bot","room":"","userId":"${TEKOS_BOT_ID}","accessToken":"${TEKOS_BOT_TOKEN}","matrixServerURL":"https://m.tekos.co"},{"id":"4fe304a9.fffffc","type":"dialogflowv2-token","z":"","name":"Tekos Bot AI"},{"id":"c4696253.ca80b","type":"node-red-contrib-httpauthcred","z":"","name":"","authType":"Basic","realm":"1","username":"Tekos","password":"@Tekos2020!","hashed":true},{"id":"a898ea71.7e6e28","type":"function","z":"9b782c32.24018","name":"Change name","func":"msg.url = \"https://\"+env.get('BASE_URL')+'/_matrix/client/r0/profile/' + env.get('TEKOS_BOT_ID')+ '/displayname?access_token='+ env.get('TEKOS_BOT_TOKEN')\nmsg.payload={\n\n  \"displayname\": env.get('NAME')\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":340,"y":140,"wires":[["9cc5f0d9.833e4","a1eeb86a.c4b7e8"]]},{"id":"9cc5f0d9.833e4","type":"http request","z":"9b782c32.24018","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":540,"y":140,"wires":[["96eb5745.d5c468"]]},{"id":"96eb5745.d5c468","type":"function","z":"9b782c32.24018","name":"change avatar","func":"msg.url = \"https://\"+env.get('BASE_URL')+'/_matrix/client/r0/profile/' + env.get('TEKOS_BOT_ID')+ '/avatar_url?access_token='+ env.get('TEKOS_BOT_TOKEN')\nmsg.payload={\n\n  \"avatar_url\": env.get('AVATAR')\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":720,"y":140,"wires":[["236f611.2e7279e"]]},{"id":"236f611.2e7279e","type":"http request","z":"9b782c32.24018","name":"","method":"PUT","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":910,"y":140,"wires":[[]]},{"id":"a1eeb86a.c4b7e8","type":"debug","z":"9b782c32.24018","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":420,"y":200,"wires":[]},{"id":"d776bb3b.1447b8","type":"function","z":"d0bf3750.bcab08","name":"Invite operator","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/invite?access_token=\"+env.get('TOKEN')\nmsg.payload={\n\n  \"user_id\": env.get('Operator')\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["c775e47c.7583d8"]]},{"id":"c775e47c.7583d8","type":"http request","z":"d0bf3750.bcab08","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":370,"y":80,"wires":[[]]},{"id":"5cac886d.f83b68","type":"http request","z":"d5c46538.c915f8","name":"Get Contact by Email","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":320,"y":120,"wires":[["596a6787.4c1778"]]},{"id":"c6946236.48316","type":"function","z":"d5c46538.c915f8","name":"API","func":"node.warn(\"start hubspot get contact\");\nnode.warn(msg);\nvar email = msg.payload.split(' ')[1]; \nnode.warn(email);\nmsg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+email+\"/profile?hapikey=\"+env.get('hubspot_api_key');\n\nreturn msg;\n","outputs":1,"noerr":0,"x":150,"y":120,"wires":[["5cac886d.f83b68"]]},{"id":"596a6787.4c1778","type":"switch","z":"d5c46538.c915f8","name":"","property":"payload.profile-token","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":500,"y":120,"wires":[["fb98b2c8.d2587"],["96555525.811a58"]]},{"id":"fb98b2c8.d2587","type":"link out","z":"d5c46538.c915f8","name":"","links":["c8e24e36.d6691"],"x":620,"y":100,"wires":[]},{"id":"96555525.811a58","type":"link out","z":"d5c46538.c915f8","name":"","links":["77b6a15d.16807"],"x":620,"y":160,"wires":[]},{"id":"3808528c.de8f8e","type":"link in","z":"d5c46538.c915f8","name":"","links":["ce8541ab.f7116"],"x":535,"y":40,"wires":[[]]},{"id":"e1f9849f.67ae98","type":"switch","z":"d5c46538.c915f8","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"contact does not exist","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":290,"y":200,"wires":[["284b2d.ce2354d4"],[]]},{"id":"77b6a15d.16807","type":"link in","z":"d5c46538.c915f8","name":"","links":["96555525.811a58"],"x":155,"y":200,"wires":[["e1f9849f.67ae98"]]},{"id":"284b2d.ce2354d4","type":"link out","z":"d5c46538.c915f8","name":"","links":[],"x":395,"y":160,"wires":[]},{"id":"d385c948.62ac18","type":"function","z":"d5c46538.c915f8","name":"display","func":"var data;\nnode.warn(msg.payload);\nif(env.get(\"display_data\")===\"text\"){\n    data = msg.payload;\n}else if(env.get(\"display_data\")===\"card\"){\n    var response = msg.payload;\nvar allThePlans = [];\nvar contact = {\n    title: response.properties.email.value,\n    subtitle:  response.properties.firstname.value +\" \"+response.properties.lastname.value,\n    img:\"https://i0.pngocean.com/files/281/858/545/logo-hubspot-inc-marketing-asg-capital-group-pty-ltd-brand-marketing.jpg\",\n    buttons: \n        [\n            {\n                type: \"url\",\n                label: \"Voir fiche\" ,// \"See more\",\n                url: response[\"profile-url\"],\n                alert: false\n            }\n        ]\n};\n\n    allThePlans.push(contact);\n//msg.payload.numresults = msg.payload.numresults - msg.payload.offset;\ndata = {\n                \"type\": \"generic-template\",\n                \"sharable\": true,\n                \"aspectRatio\": 'horizontal',\n                \"elements\": allThePlans,\n                \"chatId\": \"1771695592863159\",\n                \"messageId\":null,\n                \"inbound\":false,\n                \"options\":{},\n\n};\n\n}else{\n    data=msg.payload;\n}\nmsg.payload = data;\nreturn msg;\n","outputs":1,"noerr":0,"x":270,"y":300,"wires":[["ce8541ab.f7116"]]},{"id":"c8e24e36.d6691","type":"link in","z":"d5c46538.c915f8","name":"","links":["fb98b2c8.d2587"],"x":155,"y":300,"wires":[["d385c948.62ac18"]]},{"id":"ce8541ab.f7116","type":"link out","z":"d5c46538.c915f8","name":"","links":["3808528c.de8f8e"],"x":375,"y":300,"wires":[]},{"id":"8facad14.07966","type":"link out","z":"19a4ce64.de4022","name":"","links":["c19d9e85.0ba62"],"x":135,"y":40,"wires":[]},{"id":"117db0a1.977b9f","type":"function","z":"19a4ce64.de4022","name":"authorise","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/authorize/hubspot/1\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":335,"y":180,"wires":[["9286ce19.1cb2b"]]},{"id":"9286ce19.1cb2b","type":"http request","z":"19a4ce64.de4022","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":495,"y":180,"wires":[[]]},{"id":"c19d9e85.0ba62","type":"link in","z":"19a4ce64.de4022","name":"","links":["8facad14.07966"],"x":70,"y":160,"wires":[["8df3ffbe.43193"]]},{"id":"8df3ffbe.43193","type":"switch","z":"19a4ce64.de4022","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":185,"y":160,"wires":[["35b814f4.76ef9c"],["117db0a1.977b9f"]]},{"id":"35b814f4.76ef9c","type":"link out","z":"19a4ce64.de4022","name":"","links":["c566f8f2.71f6e8"],"x":310,"y":140,"wires":[]},{"id":"3c557909.014756","type":"function","z":"19a4ce64.de4022","name":"Contact form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\n\n\n\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.payload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Tell us a little about you ?',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/hs/create/\"+msg.payload.roomId+\"/\"+msg.payload.email,\n    \"buttontitle\": \"Update\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Nom\",\n        \"key\": \"name\",\n      },\n        {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Prenom\",\n        \"key\": \"prename\",\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Numéro de telephone\",\n        \"key\": \"phone\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Entreprise\",\n        \"key\": \"company\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Site web\",\n        \"key\": \"website\",\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":325,"y":280,"wires":[["86675b1f.8dfcd8"]]},{"id":"86675b1f.8dfcd8","type":"http request","z":"19a4ce64.de4022","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":475,"y":280,"wires":[["71405a4b.343e24"]]},{"id":"541b63dc.fe1e7c","type":"http response","z":"19a4ce64.de4022","name":"OK","statusCode":"200","headers":{},"x":305,"y":240,"wires":[]},{"id":"61ffe967.a57128","type":"http in","z":"19a4ce64.de4022","name":"Create ?","url":"/hs/create/:roomId/:email","method":"post","upload":false,"swaggerDoc":"","x":115,"y":340,"wires":[["cd3d526c.0d76e","e076ea95.4c56a8"]]},{"id":"992f9d59.fcea7","type":"http request","z":"19a4ce64.de4022","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":465,"y":340,"wires":[["71405a4b.343e24","ece26f27.14534"]]},{"id":"cd3d526c.0d76e","type":"function","z":"19a4ce64.de4022","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nmsg.roomId = msg.req.params.roomId\nvar dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": msg.req.params.email\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": msg.payload.prename\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": msg.payload.name\n    },\n    {\n      \"property\": \"website\",\n      \"value\": msg.payload.website\n    },\n    {\n      \"property\": \"company\",\n      \"value\": msg.payload.company\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": msg.payload.phone\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":265,"y":340,"wires":[["992f9d59.fcea7"]]},{"id":"71405a4b.343e24","type":"debug","z":"19a4ce64.de4022","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":310,"y":420,"wires":[]},{"id":"c566f8f2.71f6e8","type":"link in","z":"19a4ce64.de4022","name":"","links":["35b814f4.76ef9c","d95eb0d9.da049"],"x":215,"y":280,"wires":[["3c557909.014756"]]},{"id":"f917909a.69b87","type":"switch","z":"19a4ce64.de4022","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":410,"y":520,"wires":[["d95eb0d9.da049"],["35f4f9ed.b85fb6"]]},{"id":"af5a5926.a70438","type":"http in","z":"19a4ce64.de4022","name":"","url":"/authorize/hubspot/1","method":"post","upload":false,"swaggerDoc":"","x":210,"y":520,"wires":[["1add029a.06e34d","f917909a.69b87","9f1420e7.dd2af"]]},{"id":"1add029a.06e34d","type":"http response","z":"19a4ce64.de4022","name":"success","statusCode":"200","headers":{},"x":420,"y":480,"wires":[]},{"id":"d95eb0d9.da049","type":"link out","z":"19a4ce64.de4022","name":"link customer","links":["c566f8f2.71f6e8"],"x":515,"y":500,"wires":[]},{"id":"35f4f9ed.b85fb6","type":"link out","z":"19a4ce64.de4022","name":"error msg","links":[],"x":535,"y":540,"wires":[]},{"id":"9f1420e7.dd2af","type":"debug","z":"19a4ce64.de4022","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":430,"y":560,"wires":[]},{"id":"e076ea95.4c56a8","type":"http response","z":"19a4ce64.de4022","name":"success","statusCode":"200","headers":{},"x":120,"y":380,"wires":[]},{"id":"ece26f27.14534","type":"switch","z":"19a4ce64.de4022","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"Contact already exists","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":670,"y":300,"wires":[[],["7f5b02e8.1fa73c"]]},{"id":"7f5b02e8.1fa73c","type":"switch","z":"19a4ce64.de4022","name":"","property":"payload.vid","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":810,"y":320,"wires":[[],[]]},{"id":"527f55fd.153f2c","type":"function","z":"855c2bc0.26c788","name":"set pending","func":"msg.payload = msg.payload;\nvar roomID = msg.roomId;\nvar roomXD = roomID.substr(0, roomID.indexOf(':')); // \nvar data,pending;\nif(!roomID || !env.get(\"step\") || env.get(\"step\") === \"pendingstep\"){\n    node.error(\"parameter in set pending step missing\")\n    return [null,null,msg] // 3\n}else if(!env.get('value') ){\n         pending = env.get(\"step\")\n\n    node.warn(\"no value so pendingstep\")\nif(global.get(roomXD)){\n     data = global.get(roomXD);\n    data[\"pendingstep\"] = pending;\n    global.set(roomXD,data);\n     node.warn(\"set  pendingstep 1\")\n}else{\n    global.set(roomXD,{\"pendingstep\":pending});\n         node.warn(\"set  pendingstep 2\")\n\n\n}\nreturn [msg,null,null] // 1\n}else{\n         pending = env.get(\"step\")\n\n        node.warn(\"yes value so STEP\")\n       data = global.get(roomXD);\n       data[pending] = env.get('value');\n   \n        global.set(roomXD,data);\n      return [null,msg,null] // 2\n\n\n}\n\n\n","outputs":3,"noerr":0,"x":310,"y":100,"wires":[[],[],[]]},{"id":"21234782.c72238","type":"function","z":"941b9034.09257","name":"upload image","func":"global.set(\"msg1\", msg)\nlet roomId= msg.roomId.replace(/\\./g,'_')\nvar resultat= global.set(\"resultat\"+roomId, null)\nmsg.url = env.get('base_url')+'/_matrix/client/r0/rooms/'+msg.roomId+'/send/m.room.message?access_token='+env.get('TEKOS_BOT_TOKEN')\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    \"hintcloud\":{\n    \t\"cloudname\": env.get('cloudinary_cloud_name'),\n    \t\"uploadpreset\": env.get('cloudinary_upload_preset'),  //https://cloudinary.com/console/settings/upload\n    \t\"posturl\": env.get('flow_url')+env.get('post_url'),\n    \t\"buttontext\": env.get('button_text'),\n\t}\n}\n  \nreturn msg;","outputs":1,"noerr":0,"x":280,"y":180,"wires":[["901dc9ba.bb2268"]]},{"id":"901dc9ba.bb2268","type":"http request","z":"941b9034.09257","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","x":453.00000762939453,"y":180.00011897087097,"wires":[[]]},{"id":"1f8b4d5e.4bac63","type":"inject","z":"8059b36b.b7ac1","name":"","topic":"","payload":"Started!","payloadType":"str","repeat":"","crontab":"","once":true,"onceDelay":"","x":200,"y":80,"wires":[[]]},{"id":"59f3dbad.703d24","type":"function","z":"11b3cac3.191255","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n    \"body\": \"something-important.doc\",\n    \"filename\": \"something-important.doc\",\n    \"info\": {\n        \"mimetype\": \"application/msword\",\n        \"size\": 46144\n    },\n    \"msgtype\": \"m.file\",\n    \"url\": \"mxc://domain.com/FHyPlCeYUSFFxlgbQYZmoEoe\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["ccf2bb15.472ad8"]]},{"id":"ccf2bb15.472ad8","type":"http request","z":"11b3cac3.191255","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"4b6669bd.8320f8","type":"function","z":"9046be0b.a30f1","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/media/r0/upload?access_token='+env.get('TOKEN')+'&filename='+ env.get('FILE_URL')\n\nmsg.headers ={\n    \"Content-type\": +env.get('content-type')\n}\nmsg.payload={\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["319f8d6c.e498a2"]]},{"id":"319f8d6c.e498a2","type":"http request","z":"9046be0b.a30f1","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"a3929fb3.32f98","type":"function","z":"509dfe6d.39977","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n        \"body\": \"Test\",\n        \"info\": {\n            \"duration\": 2140786,\n            \"h\": 320,\n            \"mimetype\": \"video/mp4\",\n            \"size\": 1563685,\n        },\n        \"msgtype\": \"m.video\",\n        \"url\":env.get('video_mxc'),\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":240,"y":200,"wires":[["87b5ee2b.e9b5c"]]},{"id":"87b5ee2b.e9b5c","type":"http request","z":"509dfe6d.39977","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":440,"y":200,"wires":[[]]},{"id":"88ba0759.b20fd8","type":"function","z":"78fafaed.cd65d4","name":"send message","func":"msg.url = +env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n        \"body\": env.get('message'), //\"This is an example text message\",\n        \"msgtype\": \"m.text\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":260,"wires":[["7780caf1.a6c774"]]},{"id":"7780caf1.a6c774","type":"http request","z":"78fafaed.cd65d4","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":520,"y":260,"wires":[[]]},{"id":"3df7a186.5c2fae","type":"function","z":"4f80bedc.87cfc","name":"send message","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TEKOS_BOT_TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n        \"body\": \"Hello\",\n        \"format\": \"org.matrix.custom.html\",\n        \"formatted_body\": +env.get('message'), \n        \"msgtype\": \"m.emote\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["bc109ded.1396b"]]},{"id":"bc109ded.1396b","type":"http request","z":"4f80bedc.87cfc","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"b8e88272.6715","type":"function","z":"afeae1e.cea212","name":"notice","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n        \"body\": env.get('message'), //2 This is an example notice\n        \"format\": \"org.matrix.custom.html\",\n        \"formatted_body\": env.get('message'),//\"This is an <strong>example</strong> notice\",\n        \"msgtype\": \"m.notice\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":226,"y":66,"wires":[["ec8893d0.f493a"]]},{"id":"ec8893d0.f493a","type":"http request","z":"afeae1e.cea212","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":378,"y":66,"wires":[[]]},{"id":"e8567378.843b3","type":"function","z":"3ec0df30.dbad9","name":"audio","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TOKEN')\nmsg.payload={\n        \"body\": \"Bee Gees - Stayin' Alive\",\n        \"info\": {\n            \"duration\": 2140786,\n            \"mimetype\": \"audio/mpeg\",\n            \"size\": 1563685\n        },\n        \"msgtype\": \"m.audio\",\n        \"url\": \"mxc://m.tekos.co/iDQkPIUPzFIbrZXVRwpTXEJI\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["a1f18b27.f0be08"]]},{"id":"a1f18b27.f0be08","type":"http request","z":"3ec0df30.dbad9","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":420,"y":80,"wires":[[]]},{"id":"fa30f46e.d367c8","type":"http in","z":"941b9034.09257","name":"","url":"env.get('post_url')","method":"post","upload":false,"swaggerDoc":"","x":240,"y":260,"wires":[[]]},{"id":"41979909.178918","type":"http request","z":"63d4d540.a3421c","name":"PipeDrive API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"f33d5103.098ba","type":"function","z":"63d4d540.a3421c","name":"request pipedrive","func":"\nmsg.url='https://api.pipedrive.com/v1/persons?api_token='+env.get('pipedrive_key')\n\nflow.set(\"info\", msg.payload.text[0])\n\nmsg.headers = {\n\"Accept\": \"application/json\"\n}\nmsg.payload = {\n    \"name\": flow.get(\"name\"),\n    \"email\": [{\n        \"value\": flow.get(\"email\"),\n        \"primary\": true\n        }],\n    \"phone\": [{\n        \"value\": flow.get(\"phone\"),\n        \"primary\": true\n        }],\n    \"fac1b8302c0d6ca20ee4d32db247f03013fba556\" : flow.get(\"info\"),\n}\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["41979909.178918"]],"info":"how to add Custom-Fields\nhttps://support.pipedrive.com/hc/en-us/articles/207228075-Custom-Fields\n\nthen get the field key and add it to the body request"},{"id":"c483010d.d5e14","type":"http in","z":"27aa6202.673c3e","name":"","url":"/pipedrive","method":"post","upload":false,"swaggerDoc":"","x":120,"y":320,"wires":[["79c4a59f.164b3c","c9b1d0ea.22a3b","69e7e5b3.bba9ac"]]},{"id":"79c4a59f.164b3c","type":"http response","z":"27aa6202.673c3e","name":"","statusCode":"200","headers":{},"x":320,"y":200,"wires":[]},{"id":"c9b1d0ea.22a3b","type":"debug","z":"27aa6202.673c3e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":330,"y":240,"wires":[]},{"id":"69e7e5b3.bba9ac","type":"switch","z":"27aa6202.673c3e","name":"Event Action","property":"payload.meta.action","propertyType":"msg","rules":[{"t":"eq","v":"added","vt":"str"},{"t":"eq","v":"updated","vt":"str"},{"t":"eq","v":"merged","vt":"str"},{"t":"eq","v":"deleted","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":330,"y":320,"wires":[["3b10e137.51f7ce"],["3b10e137.51f7ce"],["3b10e137.51f7ce"],["3b10e137.51f7ce"]]},{"id":"3b10e137.51f7ce","type":"switch","z":"27aa6202.673c3e","name":"Event Object","property":"payload.meta.object","propertyType":"msg","rules":[{"t":"eq","v":"deal","vt":"str"},{"t":"eq","v":"activity","vt":"str"},{"t":"eq","v":"activityType","vt":"str"},{"t":"eq","v":"note","vt":"str"},{"t":"eq","v":"organization","vt":"str"},{"t":"eq","v":"person","vt":"str"},{"t":"eq","v":"pipeline","vt":"str"},{"t":"eq","v":"product","vt":"str"},{"t":"eq","v":"stage","vt":"str"},{"t":"eq","v":"user","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":11,"x":550,"y":280,"wires":[["76d4b643.05a7b8"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"],["4967239e.37f16c"]]},{"id":"ee7f8179.22d99","type":"link in","z":"27aa6202.673c3e","name":"","links":["d6e2e6fb.3a6828","1bda1d39.856ed3","cf4ba897.312cc8","f1737a7c.739f38","c1ad3af3.b0d0d8","b9826a6.52a6598","87b4db0a.711288"],"x":1055,"y":360,"wires":[["6f9fa7cf.3c5638"]]},{"id":"b99522da.3abb1","type":"comment","z":"27aa6202.673c3e","name":"https://www.pipedrive.com/fr/features/slack-crm-integration","info":"","x":450,"y":120,"wires":[]},{"id":"76d4b643.05a7b8","type":"chatbot-text","z":"27aa6202.673c3e","name":"Deal","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}: 👏\n{{current.title}}\nowner: {{current.owner_name}}\nvalue: {{current.formatted_weighted_value}}\nexpected close date: {{current.expected_close_date}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":750,"y":220,"wires":[["f1737a7c.739f38"]]},{"id":"f1737a7c.739f38","type":"link out","z":"27aa6202.673c3e","name":"","links":["ee7f8179.22d99"],"x":895,"y":220,"wires":[]},{"id":"4967239e.37f16c","type":"chatbot-text","z":"27aa6202.673c3e","name":"(generic)","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}:\n{{meta.object}} : {{current.name}}\nowner: {{current.owner_name}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":740,"y":320,"wires":[["c1ad3af3.b0d0d8"]]},{"id":"c1ad3af3.b0d0d8","type":"link out","z":"27aa6202.673c3e","name":"","links":["ee7f8179.22d99"],"x":895,"y":320,"wires":[]},{"id":"6f9fa7cf.3c5638","type":"debug","z":"27aa6202.673c3e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1170,"y":280,"wires":[]},{"id":"d9f274ef.a78b28","type":"function","z":"7c9e2fef.b50e7","name":"send file name","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+ env.get('TEKOS_BOT_TOKEN')\nmsg.payload={\n\n    \"body\": \"image.png\",\n    \"info\": {\n      \"size\": 6817,\n      \"mimetype\": \"image/png\",\n      \"thumbnail_info\": {\n        \"w\": 394,\n        \"h\": 75,\n        \"mimetype\": \"image/png\",\n        \"size\": 6950\n      },\n      \"w\": 394,\n      \"h\": 75,\n     // \"thumbnail_url\": \n    },\n    \"msgtype\": \"m.image\",\n    \"url\": env.get('MXC_URL')\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["c8ff8afd.5b0628"]]},{"id":"c8ff8afd.5b0628","type":"http request","z":"7c9e2fef.b50e7","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":400,"y":80,"wires":[[]]},{"id":"7935bea0.90c92","type":"http in","z":"b2a24cf1.c0661","name":"","url":"/zen","method":"post","upload":false,"swaggerDoc":"","x":200,"y":120,"wires":[["8275ae27.d5e91","b5f49f2c.9374d"]]},{"id":"8275ae27.d5e91","type":"debug","z":"b2a24cf1.c0661","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":410,"y":80,"wires":[]},{"id":"6d98892e.442fc8","type":"switch","z":"b2a24cf1.c0661","name":"","property":"payload.issue_event_type_name","propertyType":"msg","rules":[{"t":"eq","v":"issue_updated","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":570,"y":120,"wires":[["4e48b343.fd7e8c"],[]]},{"id":"4e48b343.fd7e8c","type":"chatbot-text","z":"b2a24cf1.c0661","name":"Update","message":[{"message":"The Jira {{issue.key}} was updated:\nhttps://tekos1.atlassian.net/browse/{{issue.key}}\n{{issue.fields.summary}} "}],"x":740,"y":100,"wires":[[]]},{"id":"b5f49f2c.9374d","type":"delay","z":"b2a24cf1.c0661","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":420,"y":120,"wires":[["6d98892e.442fc8"]],"info":"Optional"},{"id":"1ce5f517.e2957b","type":"function","z":"b92299a8.9af4c8","name":"check roomId","func":"if(!msg.roomId) {\n    msg.roomId = msg.room;\n}\nreturn msg;","outputs":1,"noerr":0,"x":194.16669845581055,"y":215.00000095367432,"wires":[["2eb4b40b.9767cc"]]},{"id":"ced6eaec.292d48","type":"chatbot-text","z":"b92299a8.9af4c8","name":"Get Started","message":[{"message":"Hi, to get started, grant me permission to access your trello account."}],"x":524.1666984558105,"y":195.00000095367432,"wires":[["2721e1ea.fe0c8e","6e476944.fbc1e8"]]},{"id":"2721e1ea.fe0c8e","type":"delay","z":"b92299a8.9af4c8","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":714.1666984558105,"y":235.00000095367432,"wires":[["eb53ea05.5dd7f8"]]},{"id":"eb53ea05.5dd7f8","type":"chatbot-generic-card","z":"b92299a8.9af4c8","name":"Token card","title":"Grant Access","subtitle":"","imageUrl":"https://wpcurve.com/wp-content/uploads/2015/01/trello-feature1.png","sharable":true,"aspectRatio":"horizontal","buttons":[{"type":"url","label":"Grant Permissions","url":"https://trello.com/1/authorize?expiration=never&scope=read,write,account&name=Tekos%20Trello%20Bot&callback_method=postMessage&key=87c22e290db53e5ea47415f258ef4f45"}],"x":884.1666984558105,"y":235.00000095367432,"wires":[["49d7dad8.8a7e34","6f94bcd7.e4d784"]]},{"id":"6e476944.fbc1e8","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":780,"y":125.00000051222742,"wires":[]},{"id":"4c7a8993.9015f8","type":"link in","z":"b92299a8.9af4c8","name":"","links":["49d7dad8.8a7e34","6e476944.fbc1e8","19906c5d.d87da4","50178464.cc29cc","7298f905.c74768","c3b354b5.86d808"],"x":1025.0000505447388,"y":80,"wires":[[]]},{"id":"49d7dad8.8a7e34","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":989.1666984558105,"y":195.00000095367432,"wires":[]},{"id":"f5c1e9e0.e3aed8","type":"link out","z":"b92299a8.9af4c8","name":"","links":["3d018302.f2da7c"],"x":300,"y":85.00000051222742,"wires":[]},{"id":"3d018302.f2da7c","type":"link in","z":"b92299a8.9af4c8","name":"","links":["f5c1e9e0.e3aed8"],"x":69.16669845581055,"y":215.00000095367432,"wires":[["1ce5f517.e2957b"]]},{"id":"393f0be4.c4cbc4","type":"chatbot-generic-form","z":"b92299a8.9af4c8","name":"Trello Token","title":"Trello Token","subtitle":"","formId":"1","posturl":"https://miled.tekos.co/auth","action":"Enter","cancel":"Cancel","options":[{"label":"Your Token","value":"userToken","type":"text","list":"","required":true}],"formValue":{"userToken":""},"payload":"","topic":"","x":224.16669845581055,"y":335.0000009536743,"wires":[["19906c5d.d87da4"]]},{"id":"6f94bcd7.e4d784","type":"delay","z":"b92299a8.9af4c8","name":"","pauseType":"delay","timeout":"3","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":1054.1666984558105,"y":235.00000095367432,"wires":[["5250a60a.a42438"]]},{"id":"5250a60a.a42438","type":"link out","z":"b92299a8.9af4c8","name":"","links":["65b9d6b1.95eb58"],"x":1175.000051498413,"y":229.16666793823242,"wires":[]},{"id":"65b9d6b1.95eb58","type":"link in","z":"b92299a8.9af4c8","name":"","links":["5250a60a.a42438"],"x":109.16669845581055,"y":335.0000009536743,"wires":[["393f0be4.c4cbc4"]]},{"id":"19906c5d.d87da4","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":329.16669845581055,"y":315.0000009536743,"wires":[]},{"id":"db3d634e.4e92","type":"http in","z":"b92299a8.9af4c8","name":"","url":"/auth","method":"post","upload":false,"swaggerDoc":"","x":434.16669845581055,"y":335.0000009536743,"wires":[["c73b3e0b.6565b","ca16b14f.6b7ab"]]},{"id":"c73b3e0b.6565b","type":"function","z":"b92299a8.9af4c8","name":"save token","func":"global.set(\"userToken\", msg.payload.userToken);\nreturn msg.payload;","outputs":1,"noerr":0,"x":624.1666984558105,"y":335.0000009536743,"wires":[["5f825e87.a8998"]]},{"id":"5f825e87.a8998","type":"chatbot-generic-form","z":"b92299a8.9af4c8","name":"Board Link","title":"Board Link","subtitle":"","formId":"2","posturl":"https://miled.tekos.co/board","action":"Save","cancel":"Cancel","options":[{"label":"Board Link","value":"boardUrl","type":"url","list":"","required":true}],"formValue":{"boardUrl":""},"payload":"","topic":"","x":844.1666984558105,"y":335.0000009536743,"wires":[["50178464.cc29cc"]]},{"id":"3d9bcb4b.083344","type":"http in","z":"b92299a8.9af4c8","name":"","url":"/board","method":"post","upload":false,"swaggerDoc":"","x":164.16669845581055,"y":455.0000009536743,"wires":[["acac006d.ae44e","a94b27a0.3a0068"]]},{"id":"50178464.cc29cc","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":1029.1666984558105,"y":295.0000009536743,"wires":[]},{"id":"ca16b14f.6b7ab","type":"http response","z":"b92299a8.9af4c8","name":"ok","statusCode":"200","headers":{},"x":484.16669845581055,"y":375.0000009536743,"wires":[]},{"id":"acac006d.ae44e","type":"http response","z":"b92299a8.9af4c8","name":"ok","statusCode":"200","headers":{},"x":264.16669845581055,"y":495.0000009536743,"wires":[]},{"id":"a94b27a0.3a0068","type":"function","z":"b92299a8.9af4c8","name":"save board","func":"global.set(\"boardUrl\", msg.payload.boardUrl);\nreturn msg.payload;","outputs":1,"noerr":0,"x":404.16669845581055,"y":455.0000009536743,"wires":[["594f56b9.f797c8"]]},{"id":"594f56b9.f797c8","type":"chatbot-generic-buttons","z":"b92299a8.9af4c8","name":"Actions","buttons":[{"type":"postback","label":"Add Cart","value":"Add Cart","alert":false}],"message":"choose an action","x":614.1666984558105,"y":455.0000009536743,"wires":[["7298f905.c74768"]]},{"id":"7298f905.c74768","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":729.1666984558105,"y":435.0000009536743,"wires":[]},{"id":"2eb4b40b.9767cc","type":"switch","z":"b92299a8.9af4c8","name":"","property":"messageContent","propertyType":"msg","rules":[{"t":"eq","v":"trello","vt":"str"},{"t":"eq","v":"Add Cart","vt":"str"}],"checkall":"true","repair":false,"outputs":2,"x":364.16669845581055,"y":215.00000095367432,"wires":[["ced6eaec.292d48"],["e2de0f7e.01fac"]]},{"id":"e2de0f7e.01fac","type":"link out","z":"b92299a8.9af4c8","name":"","links":["ce9fe006.1bdb1"],"x":469.16669845581055,"y":255.00000095367432,"wires":[]},{"id":"ce9fe006.1bdb1","type":"link in","z":"b92299a8.9af4c8","name":"","links":["e2de0f7e.01fac"],"x":129.16669845581055,"y":595.0000009536743,"wires":[["7b434eae.8a2c3"]]},{"id":"7b434eae.8a2c3","type":"chatbot-generic-form","z":"b92299a8.9af4c8","name":"Card Content","title":"","subtitle":"","formId":"3","posturl":"https://miled.tekos.co/addCart","action":"Enter","cancel":"Cancel","options":[{"label":"Card content","value":"cardContent","type":"text","list":"","required":true}],"formValue":{"cardContent":""},"payload":"","topic":"","x":274.16669845581055,"y":595.0000009536743,"wires":[["476e7904.29ff28","c3b354b5.86d808"]]},{"id":"470381e6.77e7f","type":"http in","z":"b92299a8.9af4c8","name":"","url":"/addCart","method":"post","upload":false,"swaggerDoc":"","x":514.1666984558105,"y":595.0000009536743,"wires":[["e0bc3dba.191d4","de7824b9.b774a8"]]},{"id":"e0bc3dba.191d4","type":"http response","z":"b92299a8.9af4c8","name":"ok","statusCode":"200","headers":{},"x":604.1666984558105,"y":675.0000009536743,"wires":[]},{"id":"476e7904.29ff28","type":"debug","z":"b92299a8.9af4c8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":384.16669845581055,"y":655.0000009536743,"wires":[]},{"id":"de7824b9.b774a8","type":"function","z":"b92299a8.9af4c8","name":"","func":"console.warn('something wierd is happening')\nreturn msg;","outputs":1,"noerr":0,"x":724.1666984558105,"y":595.0000009536743,"wires":[[]]},{"id":"c3b354b5.86d808","type":"link out","z":"b92299a8.9af4c8","name":"","links":["4c7a8993.9015f8"],"x":389.16669845581055,"y":535.0000009536743,"wires":[]},{"id":"e6a051f6.efbe","type":"comment","z":"b92299a8.9af4c8","name":"Lik to Tekos out","info":"","x":1102.5116271972656,"y":27.294567108154297,"wires":[]},{"id":"fa77cbbe.cf40c8","type":"comment","z":"b92299a8.9af4c8","name":"Libk to Tekos In","info":"","x":227.51735687255857,"y":37.29167302449544,"wires":[]},{"id":"b18a595b.0a1028","type":"http in","z":"8a95edf0.1b4f","name":"","url":"/bitbucket","method":"post","upload":false,"swaggerDoc":"","x":250,"y":260,"wires":[["1914e0a6.b99a3f","8e76b4a6.56b978"]]},{"id":"1914e0a6.b99a3f","type":"debug","z":"8a95edf0.1b4f","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":400,"y":220,"wires":[]},{"id":"d8c146e0.e69558","type":"comment","z":"8a95edf0.1b4f","name":"Attention, Changer le lien webhook vers le flow - Webhook links","info":"https://tekos1.atlassian.net/plugins/servlet/webhooks","x":380,"y":360,"wires":[]},{"id":"b623f4f0.3640e8","type":"switch","z":"8a95edf0.1b4f","name":"","property":"payload.issue_event_type_name","propertyType":"msg","rules":[{"t":"eq","v":"issue_updated","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":560,"y":260,"wires":[["6aa7b609.1fbef8"],[]]},{"id":"6aa7b609.1fbef8","type":"chatbot-text","z":"8a95edf0.1b4f","name":"Update","message":[{"message":"The Jira {{issue.key}} was updated:\nhttps://tekos1.atlassian.net/browse/{{issue.key}}\n{{issue.fields.summary}} "}],"x":730,"y":240,"wires":[["4274a848.450288"]]},{"id":"8e76b4a6.56b978","type":"delay","z":"8a95edf0.1b4f","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":410,"y":260,"wires":[["b623f4f0.3640e8"]],"info":"Optional"},{"id":"b46cb4a1.c71bc8","type":"switch","z":"8a95edf0.1b4f","name":"","property":"messageContent","propertyType":"msg","rules":[{"t":"eq","v":"config","vt":"str"}],"checkall":"true","repair":true,"outputs":1,"x":380,"y":120,"wires":[["5dae1ed0.0a59b"]]},{"id":"5dae1ed0.0a59b","type":"chatbot-text","z":"8a95edf0.1b4f","name":"","message":[{"message":"Ok, Voici le lien webhook à paramétrer pour ce channel:\nhttps://slim.tekosflow.xyz/bibucket"}],"x":580,"y":120,"wires":[["4274a848.450288"]]},{"id":"9dbe7ce9.5b866","type":"debug","z":"8a95edf0.1b4f","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":700,"y":400,"wires":[]},{"id":"d89dee31.433a8","type":"http response","z":"8a95edf0.1b4f","name":"","x":620,"y":480,"wires":[]},{"id":"7e02dc76.c4d534","type":"template","z":"8a95edf0.1b4f","name":"page","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head></head>\n    <body>\n        <h1>Hello {{req.params.token}}!</h1>\n    </body>\n</html>","x":460,"y":480,"wires":[["d89dee31.433a8","9dbe7ce9.5b866"]]},{"id":"1fb5ff73.3586c1","type":"http in","z":"8a95edf0.1b4f","name":"","url":"/bitbuckethook/:token","method":"post","upload":false,"swaggerDoc":"","x":280,"y":480,"wires":[["7e02dc76.c4d534"]]},{"id":"4274a848.450288","type":"link out","z":"8a95edf0.1b4f","name":"","links":[],"x":865,"y":140,"wires":[]},{"id":"7854b84b.b32e58","type":"link in","z":"8a95edf0.1b4f","name":"","links":[],"x":265,"y":120,"wires":[["b46cb4a1.c71bc8"]]},{"id":"60b060b5.c02b","type":"comment","z":"8a95edf0.1b4f","name":"tekos In","info":"","x":200,"y":80,"wires":[]},{"id":"cc92d1a9.1f77a","type":"comment","z":"8a95edf0.1b4f","name":"tekos out","info":"","x":950,"y":120,"wires":[]},{"id":"9f81da67.a6f8d8","type":"http in","z":"aab9f259.38912","name":"","url":"/jira","method":"post","upload":false,"swaggerDoc":"","x":210,"y":260,"wires":[["ccd2793f.b5e438","2ad436e.d01a1ca"]]},{"id":"ccd2793f.b5e438","type":"debug","z":"aab9f259.38912","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":380,"y":220,"wires":[]},{"id":"e455536e.295e","type":"comment","z":"aab9f259.38912","name":"Attention, Changer le lien webhook vers le flow - Webhook links","info":"https://tekos1.atlassian.net/plugins/servlet/webhooks","x":360,"y":360,"wires":[]},{"id":"127d5c76.e24754","type":"switch","z":"aab9f259.38912","name":"","property":"payload.issue_event_type_name","propertyType":"msg","rules":[{"t":"eq","v":"issue_updated","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":540,"y":260,"wires":[["a63926a0.7c6c28"],[]]},{"id":"a63926a0.7c6c28","type":"chatbot-text","z":"aab9f259.38912","name":"Update","message":[{"message":"The Jira {{issue.key}} was updated:\nhttps://tekos1.atlassian.net/browse/{{issue.key}}\n{{issue.fields.summary}} "}],"x":710,"y":240,"wires":[["5fc7802f.69c84"]]},{"id":"2ad436e.d01a1ca","type":"delay","z":"aab9f259.38912","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":390,"y":260,"wires":[["127d5c76.e24754"]],"info":"Optional"},{"id":"35854f22.ed6bf","type":"switch","z":"aab9f259.38912","name":"","property":"messageContent","propertyType":"msg","rules":[{"t":"eq","v":"config","vt":"str"}],"checkall":"true","repair":true,"outputs":1,"x":360,"y":120,"wires":[["33b2a579.86cc8a"]]},{"id":"766ad083.0f23d","type":"debug","z":"aab9f259.38912","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":700,"y":80,"wires":[]},{"id":"ca55c913.aa98e8","type":"chatbot-text","z":"aab9f259.38912","name":"","message":[{"message":"Ok, Voici le lien webhook à paramétrer pour ce channel:\nhttps://slim.tekosflow.xyz/hook?id={{token}}"}],"x":680,"y":120,"wires":[["e2b93c8b.91d6","5fc7802f.69c84"]]},{"id":"6d56e1a3.65f55","type":"link in","z":"aab9f259.38912","name":"","links":["e2b93c8b.91d6"],"x":770,"y":200,"wires":[[]]},{"id":"e2b93c8b.91d6","type":"link out","z":"aab9f259.38912","name":"","links":["6d56e1a3.65f55"],"x":765,"y":120,"wires":[]},{"id":"33b2a579.86cc8a","type":"function","z":"aab9f259.38912","name":"","func":"var token = Math.random().toString(8).substring(7);\n\nmsg.payload ={\n    \"token\": token\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":490,"y":120,"wires":[["ca55c913.aa98e8","766ad083.0f23d"]]},{"id":"7f93435d.b1d0fc","type":"debug","z":"aab9f259.38912","name":"debug","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":700,"y":420,"wires":[]},{"id":"e1846f5b.69da7","type":"http response","z":"aab9f259.38912","name":"","x":620,"y":500,"wires":[]},{"id":"ef367ee2.53052","type":"template","z":"aab9f259.38912","name":"page","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<html>\n    <head></head>\n    <body>\n        <h1>Hello {{req.params.token}}!</h1>\n    </body>\n</html>","x":460,"y":500,"wires":[["e1846f5b.69da7","7f93435d.b1d0fc"]]},{"id":"a7951d52.a681f","type":"http in","z":"aab9f259.38912","name":"","url":"/hook/:token","method":"post","upload":false,"swaggerDoc":"","x":260,"y":500,"wires":[["ef367ee2.53052"]]},{"id":"5fc7802f.69c84","type":"link out","z":"aab9f259.38912","name":"","links":[],"x":970,"y":180,"wires":[]},{"id":"2ce74daa.3e7282","type":"link in","z":"aab9f259.38912","name":"","links":[],"x":205,"y":120,"wires":[["35854f22.ed6bf"]]},{"id":"bd10f19c.a2fa1","type":"comment","z":"aab9f259.38912","name":"tekos in","info":"","x":200,"y":180,"wires":[]},{"id":"7bbefbd5.165f64","type":"comment","z":"aab9f259.38912","name":"tekos out","info":"","x":1070,"y":180,"wires":[]},{"id":"7951f7b7.d83bf8","type":"function","z":"f05d1061.cd31d","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/profile/' + env.get('BOT')+ '/displayname?access_token='+ env.get('TOKEN')\n\n//Header\nmsg.headers ={\n    \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/x-www-form-urlencoded\"\n}\n\n\n//Body\nmsg.payload={\n\n  \"displayname\": env.get('NAME')\n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":81.05899620056152,"wires":[["52800a3c.025804"]]},{"id":"52800a3c.025804","type":"http request","z":"f05d1061.cd31d","name":"","method":"GET","ret":"txt","paytoqs":false,"url":"","persist":false,"authType":"","x":438,"y":80,"wires":[[]]},{"id":"808afd3d.a219b","type":"function","z":"4456c207.c3886c","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/lists/all/contacts/all?hapikey=\"+env.get('hubspot_api_key');\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":227,"wires":[["dc0d5e2e.6b126"]]},{"id":"dc0d5e2e.6b126","type":"http request","z":"4456c207.c3886c","name":"Get All Contacts","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":373.6666717529297,"y":227,"wires":[["d6892411.3a0e48"]]},{"id":"25d7a2f3.7a877e","type":"link out","z":"4456c207.c3886c","name":"","links":["e880da22.cc3358"],"x":435,"y":20,"wires":[]},{"id":"e880da22.cc3358","type":"link in","z":"4456c207.c3886c","name":"","links":["25d7a2f3.7a877e"],"x":128.6666717529297,"y":227,"wires":[["808afd3d.a219b"]]},{"id":"bf6d20e4.b5102","type":"link out","z":"4456c207.c3886c","name":"","links":["a9e716c3.2ea158"],"x":468.6666717529297,"y":127,"wires":[]},{"id":"77e61640.9fa898","type":"function","z":"4456c207.c3886c","name":"NULL","func":"msg.payload = \"No such action\";\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":287,"wires":[["d6892411.3a0e48"]]},{"id":"a9e716c3.2ea158","type":"link in","z":"4456c207.c3886c","name":"","links":["bf6d20e4.b5102"],"x":128.6666717529297,"y":287,"wires":[["77e61640.9fa898"]]},{"id":"d6892411.3a0e48","type":"debug","z":"4456c207.c3886c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"payload","targetType":"msg","x":603.6666717529297,"y":287,"wires":[]},{"id":"78abb210.12d2fc","type":"function","z":"4456c207.c3886c","name":"switch","func":"var action = env.get(\"action\");\nif(action === \"all\"){\n    return[msg,null,null,null,null];\n}else if(action ===\"contact_email\"){\n    msg.email = \"ayoub@tekos.co\";\n    return[null,msg,null,null,null];\n}else if(action ===\"create_contact\"){\n    return[null,null,msg,null,null];\n}else if(action ===\"update_contact\"){\n    msg.email = \"ayoub@tekos.co\";\n    return[null,null,null,msg,null];\n}\nelse{\n    return[null,null,null,null,msg];\n}\n","outputs":5,"noerr":0,"x":263.6666717529297,"y":47,"wires":[["25d7a2f3.7a877e"],["e3dc86fd.641a28"],["81d674d5.497168"],["1f59fdbc.d4a132"],["bf6d20e4.b5102"]],"inputLabels":["env.get(\"action\")"],"outputLabels":["action","","","",""],"icon":"node-red/switch.png"},{"id":"4ff807c4.659598","type":"http request","z":"4456c207.c3886c","name":"Get Contact by Email","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":393.6666717529297,"y":347,"wires":[["d6892411.3a0e48"]]},{"id":"74dbca87.9bee14","type":"function","z":"4456c207.c3886c","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+msg.email+\"/profile?hapikey=\"+env.get('hubspot_api_key');\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":347,"wires":[["4ff807c4.659598"]]},{"id":"e9a4f9a5.24add8","type":"link in","z":"4456c207.c3886c","name":"","links":["e3dc86fd.641a28"],"x":128.6666717529297,"y":347,"wires":[["74dbca87.9bee14"]]},{"id":"e3dc86fd.641a28","type":"link out","z":"4456c207.c3886c","name":"","links":["e9a4f9a5.24add8"],"x":435,"y":60,"wires":[]},{"id":"c0652f94.7a466","type":"http request","z":"4456c207.c3886c","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":403.6666717529297,"y":407,"wires":[["d6892411.3a0e48"]]},{"id":"6637528b.b79cbc","type":"function","z":"4456c207.c3886c","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nvar dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": \"yamebixos@dmail1.net\"\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": \"yamebixos\"\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": \"Mott\"\n    },\n    {\n      \"property\": \"website\",\n      \"value\": \"http://hubspot.com\"\n    },\n    {\n      \"property\": \"company\",\n      \"value\": \"HubSpot\"\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": \"555-122-2323\"\n    },\n    {\n      \"property\": \"address\",\n      \"value\": \"25 First Street\"\n    },\n    {\n      \"property\": \"city\",\n      \"value\": \"Cambridge\"\n    },\n    {\n      \"property\": \"state\",\n      \"value\": \"MA\"\n    },\n    {\n      \"property\": \"zip\",\n      \"value\": \"02139\"\n    },\n     {\n      \"property\": \"cin\",\n      \"value\": \"https://kw.ambafrance.org/IMG/arton2779.jpg?1546892557\"\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":407,"wires":[["c0652f94.7a466"]]},{"id":"8d84f058.2038","type":"link in","z":"4456c207.c3886c","name":"","links":["81d674d5.497168"],"x":128.6666717529297,"y":407,"wires":[["6637528b.b79cbc"]]},{"id":"81d674d5.497168","type":"link out","z":"4456c207.c3886c","name":"","links":["8d84f058.2038"],"x":468.6666717529297,"y":87,"wires":[]},{"id":"8b03930f.171f7","type":"http request","z":"4456c207.c3886c","name":"Update Contact","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":393.6666717529297,"y":487,"wires":[["d6892411.3a0e48"]]},{"id":"30a4614.bc3eb9e","type":"function","z":"4456c207.c3886c","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/email/\"+msg.email+\"/profile?hapikey=\"+env.get('hubspot_api_key');\nvar dataString = {\n  \"properties\": [\n     {\n      \"property\": \"cin\",\n      \"value\": \"https://fr.ubergizmo.com/wp-content/uploads/2017/06/ID-3D-1000x800.jpg\"\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":223.6666717529297,"y":487,"wires":[["8b03930f.171f7"]]},{"id":"c5dcea9b.e51a18","type":"link in","z":"4456c207.c3886c","name":"","links":["1f59fdbc.d4a132"],"x":128.6666717529297,"y":487,"wires":[["30a4614.bc3eb9e"]]},{"id":"1f59fdbc.d4a132","type":"link out","z":"4456c207.c3886c","name":"","links":["c5dcea9b.e51a18"],"x":408.6666717529297,"y":87,"wires":[]},{"id":"c77bccb8.85f93","type":"link out","z":"a8e33d40.895b1","name":"","links":["b0acac1c.a1ba4"],"x":445,"y":154,"wires":[]},{"id":"ab9d6fa.124b99","type":"function","z":"a8e33d40.895b1","name":"authorise","func":"// this code exctract the roomid from the succc_url passed in the stripe session request\n// this data is been received from the post request and not from the tekos bot in, so we cant access the room_id data in this case.\nnode.warn(\"begining sending button\");\nnode.warn(msg)\n\n // end subsctract string code\nmsg.url = \"https://\"+env.get(\"BASE_URL\")+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\"); \nvar data = msg.payload;\nmsg.payload={\n\"msgtype\": \"m.text\",\n\"body\": \"\",\n\"authorize\": {\n\t\"url\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get('API_URL')+\"/authorize/hubspot/1\",\n\t\"data\":{data}\n}\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":603,"y":227,"wires":[["b43c16f4.489888"]]},{"id":"b43c16f4.489888","type":"http request","z":"a8e33d40.895b1","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":763,"y":227,"wires":[[]]},{"id":"b0acac1c.a1ba4","type":"link in","z":"a8e33d40.895b1","name":"","links":["c77bccb8.85f93"],"x":339,"y":222,"wires":[["6fa516d6.fbb798"]]},{"id":"6fa516d6.fbb798","type":"switch","z":"a8e33d40.895b1","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":454,"y":222,"wires":[["2dc87fe6.558ce"],["ab9d6fa.124b99"]]},{"id":"2dc87fe6.558ce","type":"link out","z":"a8e33d40.895b1","name":"","links":["c00fc34a.80d12"],"x":578,"y":187,"wires":[]},{"id":"a6dc090.f6a36f8","type":"function","z":"a8e33d40.895b1","name":"Contact form","func":"node.warn(\"finishing creating form\");\nnode.warn(msg)\n\n\n\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.payload.roomId+\"/send/m.room.message?access_token=\"+env.get(\"TEKOS_BOT_TOKEN\");\nvar customer = msg.customer;\n\nmsg.payload={\n    \"body\": \"\",\n    \"msgtype\": \"m.text\",\n    'titleform':'Tell us a little about you ?',\n    \"posturl\": \"https://\"+env.get(\"API_ACCESS_USER\")+\":\"+env.get(\"API_ACCESS_PASS\")+\"@\"+env.get(\"API_URL\")+\"/hs/create/\"+msg.payload.roomId+\"/\"+msg.payload.email,\n    \"buttontitle\": \"Update\",\n    \"tekosform\": [\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Nom\",\n        \"key\": \"name\",\n      },\n        {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Prenom\",\n        \"key\": \"prename\",\n      },\n       {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Numéro de telephone\",\n        \"key\": \"phone\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Entreprise\",\n        \"key\": \"company\",\n      },\n      {\n        \"type\": \"input\",\n        \"subtype\": \"text\",\n        \"label\": \"Site web\",\n        \"key\": \"website\",\n      }\n    ]\n}\n\nreturn msg;\n\n","outputs":1,"noerr":0,"x":451,"y":286,"wires":[["d2ed9fea.bd78f"]]},{"id":"d2ed9fea.bd78f","type":"http request","z":"a8e33d40.895b1","name":"Tekos API","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":610,"y":285,"wires":[["c1d8f2e8.57bfa"]]},{"id":"8ff238af.542508","type":"http in","z":"a8e33d40.895b1","name":"Create ?","url":"/hs/create/:roomId/:email","method":"post","upload":false,"swaggerDoc":"","x":391,"y":413,"wires":[["e846a874.642548","61c31c2a.811f94"]]},{"id":"5d92cc01.bcf904","type":"http request","z":"a8e33d40.895b1","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"","x":733,"y":387,"wires":[["cf9f2756.eac818","c1d8f2e8.57bfa"]]},{"id":"e846a874.642548","type":"function","z":"a8e33d40.895b1","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nmsg.roomId = msg.req.params.roomId\nvar dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": msg.req.params.email\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": msg.payload.prename\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": msg.payload.name\n    },\n    {\n      \"property\": \"website\",\n      \"value\": msg.payload.website\n    },\n    {\n      \"property\": \"company\",\n      \"value\": msg.payload.company\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": msg.payload.phone\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":533,"y":387,"wires":[["5d92cc01.bcf904"]]},{"id":"c1d8f2e8.57bfa","type":"debug","z":"a8e33d40.895b1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":930,"y":292,"wires":[]},{"id":"8eeef14f.528f6","type":"link in","z":"a8e33d40.895b1","name":"","links":["2705202d.3bb7c"],"x":341,"y":286,"wires":[["a6dc090.f6a36f8"]]},{"id":"2e880ec4.4dcda2","type":"switch","z":"a8e33d40.895b1","name":"","property":"payload.email","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":703,"y":596,"wires":[["2705202d.3bb7c"],["70336d4b.ca7b94"]]},{"id":"c39f16c8.2fd3c8","type":"http in","z":"a8e33d40.895b1","name":"","url":"/authorize/hubspot/1","method":"post","upload":false,"swaggerDoc":"","x":503,"y":596,"wires":[["f2ab703f.85919","2e880ec4.4dcda2","5013aa5.69b7454"]]},{"id":"f2ab703f.85919","type":"http response","z":"a8e33d40.895b1","name":"success","statusCode":"200","headers":{},"x":713,"y":556,"wires":[]},{"id":"2705202d.3bb7c","type":"link out","z":"a8e33d40.895b1","name":"link customer","links":["8eeef14f.528f6"],"x":808,"y":576,"wires":[]},{"id":"70336d4b.ca7b94","type":"link out","z":"a8e33d40.895b1","name":"error msg","links":[],"x":828,"y":616,"wires":[]},{"id":"5013aa5.69b7454","type":"debug","z":"a8e33d40.895b1","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":723,"y":636,"wires":[]},{"id":"61c31c2a.811f94","type":"http response","z":"a8e33d40.895b1","name":"success","statusCode":"200","headers":{},"x":563,"y":435,"wires":[]},{"id":"cf9f2756.eac818","type":"switch","z":"a8e33d40.895b1","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"Contact already exists","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":938,"y":347,"wires":[[],["c51a92d6.c8e2d"]]},{"id":"c51a92d6.c8e2d","type":"switch","z":"a8e33d40.895b1","name":"","property":"payload.vid","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":1078,"y":367,"wires":[[],[]]},{"id":"a0351355.c1123","type":"switch","z":"a8e33d40.895b1","name":"","property":"request","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":316,"y":353,"wires":[["efa6471f.49a808"],["a6dc090.f6a36f8"]]},{"id":"c00fc34a.80d12","type":"link in","z":"a8e33d40.895b1","name":"","links":["2dc87fe6.558ce"],"x":215,"y":348,"wires":[["a0351355.c1123"]]},{"id":"efa6471f.49a808","type":"link out","z":"a8e33d40.895b1","name":"","links":["f74932fa.615b8"],"x":427,"y":357,"wires":[]},{"id":"65c36295.701eec","type":"function","z":"a8e33d40.895b1","name":"data from previous payload","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nvar request = msg.request\nvar dataString = {\n  properties: [\n    {\n      property: \"email\",\n      value: request.email\n    },\n    {\n      property: \"firstname\",\n      value: request.name\n    },\n     {\n      property: \"zip\",\n      value: request.postal_code\n    },{\n        property:\"referring_url\",\n        value:request.url\n    }\n  ]\n}\nif(request.phone){\n    dataString.properties.push({\n      property: \"phone\",\n      value: request.phone\n    })\n}\nif(request.affiliate_id){\n      dataString.properties.push({\n      property: \"affiliate\",\n      value: request.affiliate_id\n    })\n\n}\nmsg.payload = dataString;\nreturn msg;\n","outputs":1,"noerr":0,"x":616,"y":500,"wires":[["5d92cc01.bcf904"]]},{"id":"f74932fa.615b8","type":"link in","z":"a8e33d40.895b1","name":"","links":["efa6471f.49a808"],"x":442,"y":499,"wires":[["65c36295.701eec"]]},{"id":"460a19a9.b9f758","type":"function","z":"442c770f.96d248","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\n\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nvar roomId = msg.roomId\nmsg={\n    payload:msg.payload,\n    topic:\"le client \"+msg.senderId+\" a télécharger un document \",\n    to:\"ayoub@tekos.co\",\n    roomId:roomId\n   \n};\n\nreturn msg;","outputs":1,"noerr":0,"x":315.00000381469727,"y":199,"wires":[[]]},{"id":"c48b5aeb.cbc6b8","type":"template","z":"442c770f.96d248","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{{payload.style}}}\n    </style>\n</head>\n\n\n<body>\n    <h3>Nom Fichier : {{file}}</h3>\n    <p>\n      Fichier source : <a href=\"{{imagesrc}}\">Lien vers le fichier</a>\n    </p>\n</body>","x":531.9999885559082,"y":140.99999046325684,"wires":[["460a19a9.b9f758"]]},{"id":"88024c15.7e99f","type":"template","z":"442c770f.96d248","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":391.9999885559082,"y":140.99999046325684,"wires":[["c48b5aeb.cbc6b8"]]},{"id":"577f3838.949218","type":"function","z":"442c770f.96d248","name":"send mail","func":"msg.subscription = msg.event.event;\nmsg.file = msg.payload;\nmsg.file.name = msg.payload;\nmsg.file.sender = msg.senderId;\nmsg.roomId = msg.roomId;\nmsg.file.src = msg.imagesrc;\nreturn msg;","outputs":1,"noerr":0,"x":261.9999885559082,"y":140.99999046325684,"wires":[["88024c15.7e99f"]]},{"id":"eb24d868.c862e8","type":"function","z":"242600cf.12cc","name":"Invite operator","func":"msg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+env.get('ROOM')+\"/invite?access_token=\"+env.get('TOKEN')\nmsg.payload={\n\n  \"user_id\": env.get('Operator')\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["a7b6ccea.1e6b3"]]},{"id":"a7b6ccea.1e6b3","type":"http request","z":"242600cf.12cc","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","proxy":"","authType":"basic","x":370,"y":80,"wires":[[]]},{"id":"5435e1a6.8b7b6","type":"http in","z":"82767481.508078","name":"","url":"/hubspot-notif","method":"post","upload":false,"swaggerDoc":"","x":200,"y":328.0000741481781,"wires":[["53baf24e.7384bc","ed5707d5.c2d8c8"]]},{"id":"53baf24e.7384bc","type":"http response","z":"82767481.508078","name":"","statusCode":"200","headers":{},"x":518,"y":201.00001525878906,"wires":[]},{"id":"ed5707d5.c2d8c8","type":"debug","z":"82767481.508078","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":528,"y":241.00001525878906,"wires":[]},{"id":"ed1b761.6969a88","type":"switch","z":"82767481.508078","name":"Event Action","property":"payload.meta.action","propertyType":"msg","rules":[{"t":"eq","v":"added","vt":"str"},{"t":"eq","v":"updated","vt":"str"},{"t":"eq","v":"merged","vt":"str"},{"t":"eq","v":"deleted","vt":"str"}],"checkall":"true","repair":false,"outputs":4,"x":528,"y":321.00001525878906,"wires":[["a137a085.c18c4"],["a137a085.c18c4"],["a137a085.c18c4"],["a137a085.c18c4"]]},{"id":"a137a085.c18c4","type":"switch","z":"82767481.508078","name":"Event Object","property":"payload.meta.object","propertyType":"msg","rules":[{"t":"eq","v":"deal","vt":"str"},{"t":"eq","v":"activity","vt":"str"},{"t":"eq","v":"activityType","vt":"str"},{"t":"eq","v":"note","vt":"str"},{"t":"eq","v":"organization","vt":"str"},{"t":"eq","v":"person","vt":"str"},{"t":"eq","v":"pipeline","vt":"str"},{"t":"eq","v":"product","vt":"str"},{"t":"eq","v":"stage","vt":"str"},{"t":"eq","v":"user","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":11,"x":748,"y":281.00001525878906,"wires":[["2d3e348d.b347cc"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"],["3f04b515.8c0d8a"]]},{"id":"5492c7f7.947cc8","type":"link in","z":"82767481.508078","name":"","links":["985f522d.c97bf","8d4f6054.9c5a3"],"x":1253,"y":361.00001525878906,"wires":[["acf76c3d.ccc98"]]},{"id":"a3d1cc80.15c5b","type":"comment","z":"82767481.508078","name":"https://hackernoon.com/what-are-hubspot-webhooks-and-why-are-they-useful-a0caed6d09b6","info":"","x":758.0000228881836,"y":80,"wires":[]},{"id":"2d3e348d.b347cc","type":"chatbot-text","z":"82767481.508078","name":"Deal","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}: 👏\n{{current.title}}\nowner: {{current.owner_name}}\nvalue: {{current.formatted_weighted_value}}\nexpected close date: {{current.expected_close_date}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":948,"y":221.00001525878906,"wires":[["985f522d.c97bf"]]},{"id":"985f522d.c97bf","type":"link out","z":"82767481.508078","name":"","links":["5492c7f7.947cc8"],"x":1093,"y":221.00001525878906,"wires":[]},{"id":"3f04b515.8c0d8a","type":"chatbot-text","z":"82767481.508078","name":"(generic)","message":[{"message":"Hi, a new {{meta.object}} was {{meta.action}}:\n{{meta.object}} : {{current.name}}\nowner: {{current.owner_name}}\nlink: {{meta.host}}/{{meta.object}}/{{meta.id}}"}],"x":938,"y":321.00001525878906,"wires":[["8d4f6054.9c5a3"]]},{"id":"8d4f6054.9c5a3","type":"link out","z":"82767481.508078","name":"","links":["5492c7f7.947cc8"],"x":1093,"y":321.00001525878906,"wires":[]},{"id":"acf76c3d.ccc98","type":"debug","z":"82767481.508078","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":1368,"y":281.00001525878906,"wires":[]},{"id":"3b6aa236.6a12ae","type":"function","z":"fde10ab5.552fe8","name":"Get members","func":"msg.url = env.get('BASE_URL')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/joined_members?access_token=\"+env.get('Token')\nmsg.payload={\n\n\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":440,"y":240,"wires":[["205fbd70.641182"]]},{"id":"205fbd70.641182","type":"http request","z":"fde10ab5.552fe8","name":"","method":"GET","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":610,"y":240,"wires":[["b8215146.7065c"]]},{"id":"b8215146.7065c","type":"function","z":"fde10ab5.552fe8","name":"calculate member's nb","func":"\nvar joined = Object.keys(msg.payload.joined).length;\n\nif(joined == 1){\n    msg.payload = msg.messageContent;\n    return [msg,null,null];\n    \n}else if(joined == 2){\n    msg.payload = msg.messageContent;\n    return [null,msg,null];\n}else{\n    return [null,null,msg];\n}\n\nreturn msg;","outputs":3,"noerr":0,"x":800,"y":240,"wires":[["23b18362.81f1cc"],["23b18362.81f1cc"],[]],"icon":"font-awesome/fa-thumbs-o-down"},{"id":"1a1a7f05.afa3f1","type":"switch","z":"fde10ab5.552fe8","name":"New Interaction ?","property":"room","propertyType":"msg","rules":[{"t":"nnull"},{"t":"null"}],"checkall":"true","repair":false,"outputs":2,"x":147.99998092651367,"y":83.99998664855957,"wires":[["2bb14ec8.9fd482"],["8ff0b37c.f47e9"]],"outputLabels":["","existing interaction"]},{"id":"9ccfba7e.4cba88","type":"function","z":"fde10ab5.552fe8","name":"Set Room ID","func":"msg.roomId= msg.room\nreturn msg;","outputs":1,"noerr":0,"x":532,"y":44,"wires":[[]],"outputLabels":["new room"]},{"id":"ad7d2657.a3c398","type":"function","z":"fde10ab5.552fe8","name":"is Dierct message (@bot) ***?","func":"\nvar str = msg.event.event.content.formatted_body;\nvar strmobile = msg.event.event.content.body;\nvar bot = env.get(\"Bot\");\nvar botname = env.get(\"Bot_name\");\nvar strtxt =   msg.payload;\n\nif(str){\n    if(str.includes(bot)){\n        strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[msg,null,null]\n    }\n   \n}else if(strmobile.includes(botname)){\n     strtxt = strtxt.substring(strtxt.indexOf(\":\") + 1); // remove all text before \":\" , that means delete the bot name from the payload\n        strtxt = strtxt.trim(); // remove any spaces if found\n\n        msg.payload = strtxt;\n         return[null,msg,null]\n    \n}\n\nelse{\n    \n    return[null,null,msg]\n}\nreturn msg;","outputs":3,"noerr":0,"x":210,"y":220,"wires":[[],[],["3b6aa236.6a12ae"]],"icon":"node-red/switch.svg"},{"id":"8ff0b37c.f47e9","type":"switch","z":"fde10ab5.552fe8","name":"","property":"event.event.content.msgtype","propertyType":"msg","rules":[{"t":"eq","v":"m.image","vt":"str"},{"t":"eq","v":"m.file","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":160,"y":154,"wires":[[],[],["ad7d2657.a3c398"]]},{"id":"c84d65d.061f498","type":"link out","z":"fde10ab5.552fe8","name":"","links":["45bdbd8e.4d7464"],"x":1215,"y":260,"wires":[]},{"id":"45bdbd8e.4d7464","type":"link in","z":"fde10ab5.552fe8","name":"","links":["c84d65d.061f498"],"x":95,"y":320,"wires":[["3589a4fa.2c4d9c"]]},{"id":"3589a4fa.2c4d9c","type":"function","z":"fde10ab5.552fe8","name":"pending step found ! ","func":"\nvar data = global.get(msg.roomXD);\nvar pending = data.pendingstep;\n\ndata[pending] = msg.payload;\ndelete data.pendingstep;\nglobal.set(msg.roomXD,data);\n\n\nmsg.step = pending;\nmsg.stepcontent = msg.payload;\n\n\n data = global.get(msg.roomXD);\n\n \n \nif(data[\"STEP\"] && data.hasOwnProperty(data[\"STEP\"])){\n    data = global.get(msg.roomXD);\n    delete data[\"STEP\"];\n    global.set(msg.roomXD,data);\n}\n\n\n\nif(data.STEP){\n        msg.currentstep = data.STEP\n\n         return[msg,null]; // 4\n    }else{\n        return [null,msg];\n    }\n","outputs":2,"noerr":0,"x":255,"y":320,"wires":[["1f365b35.bb1455"],[]]},{"id":"a6eabfae.1652d","type":"debug","z":"fde10ab5.552fe8","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":470,"y":360,"wires":[]},{"id":"23b18362.81f1cc","type":"function","z":"fde10ab5.552fe8","name":"pending step ?","func":"var roomId = msg.roomId;\nroomId= roomId.substr(0, roomId.indexOf(':'));\nif(!global.get(roomId)){\n    return[msg,null,null,null]; // 1\n}else{\n    \n    var data = global.get(roomId);\n    if(data.pendingstep){\n        msg.roomXD = roomId;\n        return [null,null,msg,null]; // 3\n    }else if(data.STEP){\n        msg.roomXD = roomId;\n        msg.currentstep = data.STEP\n         return[null,null,null,msg]; // 4\n    }else{\n   return[null,msg,null,null]; // 2\n\n    }\n}\n\nreturn msg;","outputs":4,"noerr":0,"x":1040,"y":240,"wires":[[],[],["c84d65d.061f498"],[]],"icon":"node-red/switch.svg"},{"id":"1f365b35.bb1455","type":"link out","z":"fde10ab5.552fe8","name":"","links":["d531bdd3.97c5c"],"x":415,"y":300,"wires":[]},{"id":"d531bdd3.97c5c","type":"link in","z":"fde10ab5.552fe8","name":"","links":["1f365b35.bb1455"],"x":1215,"y":380,"wires":[[]]},{"id":"ce906c7.5f25f9","type":"function","z":"af0345b1.7c4e78","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=incoming&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"text\": msg.payload,\n  \"userId\": msg.senderId,\n  \"platformJson\": {\n    \"displayname\": \"hey\"\n  } \n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":300,"y":120,"wires":[["96e114ac.503328"]]},{"id":"96e114ac.503328","type":"http request","z":"af0345b1.7c4e78","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":530,"y":120,"wires":[["2684a379.f373bc"]]},{"id":"2684a379.f373bc","type":"debug","z":"af0345b1.7c4e78","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":730,"y":160,"wires":[]},{"id":"4e7c77fc.e4b3a8","type":"function","z":"45e63626.6388b8","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=outgoing&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"text\": msg.payload,\n  \"userId\": msg.senderId,\n  \"platformJson\": {\n    \"displayname\": \"hey\"\n  } \n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["2aa23085.8afea"]]},{"id":"2aa23085.8afea","type":"http request","z":"45e63626.6388b8","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":430,"y":80,"wires":[[]]},{"id":"7d78bc33.d01994","type":"function","z":"491f6cec.662034","name":"Http request template","func":"//Request URL (you will define the endpoitn later)\nmsg.url = 'https://tracker.dashbot.io/track?platform=webchat&v=10.4.2-rest&type=event&apiKey='+ env.get('DASHBOT_TOKEN')\n// https://tracker.dashbot.io/track?platform=universal&v=10.1.1-rest&type=incoming&apiKey=\n//Header\nmsg.headers ={\n  //  \"Authorization\" : \"Bearer \"+env.get(\"STRIPE_SEC_KEY\"),\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\nmsg.payload={\n    \n  \"name\": env.get('EVENT_NAME'),\n  \"type\": \"customEvent\",\n  \"userId\": msg.senderId,\n  \"extraInfo\": {\n    \"start\": 1500504070512,\n    \"difference\": 374,\n    \"end\": 1500504070886\n  }\n\n  \n\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":220,"wires":[["28b7f8ff.b20778"]]},{"id":"28b7f8ff.b20778","type":"http request","z":"491f6cec.662034","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":550,"y":220,"wires":[[]]},{"id":"a5d251fb.142d9","type":"http request","z":"9b2392b3.300b4","name":"Segment","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":360,"y":80,"wires":[[]]},{"id":"58eebebc.649af","type":"function","z":"9b2392b3.300b4","name":"","func":"msg.url = 'https://api.segment.io/v1/track'\n\n\n\nmsg.headers ={\n    \"Authorization\" : \"Basic \"+env.get('write_key'),  //RUFRU2xLV05ZN***=\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload = {\n  \"userId\": msg.payload.email,\n  \"email\": msg.payload.email,\n  \"event\": env.get('EVENT')\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":200,"y":80,"wires":[["a5d251fb.142d9"]]},{"id":"62cd8a0f.e2c444","type":"function","z":"6ec18374.f95cdc","name":"set pending","func":"msg.payload = msg.payload;\nvar roomID = msg.roomId;\nvar roomXD = roomID.substr(0, roomID.indexOf(':')); // \nvar data,pending;\nif(!roomID || !env.get(\"step\") || env.get(\"step\") === \"pendingstep\"){\n    node.error(\"parameter in set pending step missing\")\n    return [null,null,msg] // 3\n}else if(!env.get('value') ){\n         pending = env.get(\"step\")\n\n    node.warn(\"no value so pendingstep\")\nif(global.get(roomXD)){\n     data = global.get(roomXD);\n    data[\"pendingstep\"] = pending;\n    global.set(roomXD,data);\n     node.warn(\"set  pendingstep 1\")\n}else{\n    global.set(roomXD,{\"pendingstep\":pending});\n         node.warn(\"set  pendingstep 2\")\n\n\n}\nreturn [msg,null,null] // 1\n}else{\n         pending = env.get(\"step\")\n\n        node.warn(\"yes value so STEP\")\n       data = global.get(roomXD);\n       data[pending] = env.get('value');\n   \n        global.set(roomXD,data);\n      return [null,msg,null] // 2\n\n\n}\n\n\n","outputs":3,"noerr":0,"x":310,"y":140,"wires":[[],[],[]]},{"id":"752cecd6.dc4e44","type":"function","z":"927e6891.b73778","name":"set pending","func":"msg.payload = msg.payload;\nvar roomID = msg.roomId;\nvar roomXD = roomID.substr(0, roomID.indexOf(':')); // \nvar data,pending;\nif(!roomID || !env.get(\"step\") || env.get(\"step\") === \"pendingstep\"){\n    node.error(\"parameter in set pending step missing\")\n    return [null,null,msg] // 3\n}else if(!env.get('value') ){\n         pending = env.get(\"step\")\n\n    node.warn(\"no value so pendingstep\")\nif(global.get(roomXD)){\n     data = global.get(roomXD);\n    data[\"pendingstep\"] = pending;\n    global.set(roomXD,data);\n     node.warn(\"set  pendingstep 1\")\n}else{\n    global.set(roomXD,{\"pendingstep\":pending});\n         node.warn(\"set  pendingstep 2\")\n\n\n}\nreturn [msg,null,null] // 1\n}else{\n         pending = env.get(\"step\")\n\n        node.warn(\"yes value so STEP\")\n       data = global.get(roomXD);\n       data[pending] = env.get('value');\n   \n        global.set(roomXD,data);\n      return [null,msg,null] // 2\n\n\n}\n\n\n","outputs":3,"noerr":0,"x":330,"y":160,"wires":[[],[],[]]},{"id":"4dae2ab1.e19be4","type":"subflow:fde10ab5.552fe8","z":"ed261d7.da9a4e","name":"Event","env":[],"x":336,"y":198,"wires":[["69fb08ec.ad49d8"],["e96f0722.677d98"],["11bc45ba.04c3fa"],["c4e81a78.b16148"],[],[]]},{"id":"c50cad5a.322ab","type":"comment","z":"ed261d7.da9a4e","name":"Event Subscription","info":"","x":332,"y":22,"wires":[]},{"id":"d99f0aa2.a1f348","type":"http in","z":"fc68b1d2.502e3","name":"${endpoint}","url":"/env.get('endpoint')","method":"post","upload":true,"swaggerDoc":"","x":180,"y":132,"wires":[["bfc37b46.e1e208"]]},{"id":"bfc37b46.e1e208","type":"http response","z":"fc68b1d2.502e3","name":"","statusCode":"200","headers":{},"x":390,"y":88,"wires":[]},{"id":"f5cf4f27.304c3","type":"http request","z":"ed261d7.da9a4e","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":796,"y":198,"wires":[["a4cc6bf0.d2fbe8"]]},{"id":"cac1f101.d0fec","type":"function","z":"ed261d7.da9a4e","name":"","func":"msg.url = env.get('URL')\n//Header\nmsg.headers ={\n    //\"Authorization\" : \"Bearer \",\n    \"Content-type\": \"application/json\"\n}\n\n\n//Body\n//msg.payload={\n\n\n\n//}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":644,"y":198,"wires":[["f5cf4f27.304c3"]]},{"id":"a4cc6bf0.d2fbe8","type":"debug","z":"ed261d7.da9a4e","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":950,"y":198,"wires":[]},{"id":"69fb08ec.ad49d8","type":"switch","z":"ed261d7.da9a4e","name":"","property":"new_interaction","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":110,"wires":[["cac1f101.d0fec"]]},{"id":"11bc45ba.04c3fa","type":"switch","z":"ed261d7.da9a4e","name":"","property":"direct_message","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":198,"wires":[["cac1f101.d0fec"]]},{"id":"e96f0722.677d98","type":"switch","z":"ed261d7.da9a4e","name":"","property":"public_message","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":154,"wires":[["cac1f101.d0fec"]]},{"id":"c4e81a78.b16148","type":"switch","z":"ed261d7.da9a4e","name":"","property":"file","propertyType":"env","rules":[{"t":"true"}],"checkall":"true","repair":false,"outputs":1,"x":468,"y":242,"wires":[["cac1f101.d0fec"]]},{"id":"2bb14ec8.9fd482","type":"switch","z":"fde10ab5.552fe8","name":"","property":"event.event.unsigned.prev_content","propertyType":"msg","rules":[{"t":"null"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":380,"y":44,"wires":[["9ccfba7e.4cba88"],[]]},{"id":"79c985f1.dee81c","type":"e-mail","z":"30517ddd.9e4af2","server":"${host}","port":"${port}","secure":true,"tls":false,"name":"","dname":"Send Subscription Token","x":748,"y":220,"wires":[]},{"id":"5d5d93a2.79543c","type":"function","z":"30517ddd.9e4af2","name":"Transactional Emails","func":"node.warn(\"LOG\")\nnode.warn(msg);\nvar email;\nif(msg.payload.email){\n    email = msg.payload.email;\n}else if(msg.email){\n    email = msg.email;\n}else{\n    email = env.get(\"email_to\")\n}\nmsg.Userid = env.get(\"username\");\nmsg.Password = env.get(\"password\");\nvar roomId = msg.roomId\nmsg={\n    payload:msg.payload,\n    topic:msg.topic,\n    to:email,\n \n   \n};\n\nreturn msg;","outputs":1,"noerr":0,"x":494.00000381469727,"y":220,"wires":[["79c985f1.dee81c"]]},{"id":"bf71b538.0bf0b8","type":"template","z":"30517ddd.9e4af2","name":"html","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<head>\n    <style>\n        {{payload.style}}\n    </style>\n</head>\n\n\n<body>\n   <p>{{text}}</p>\n</body>","x":710.9999885559082,"y":161.99999046325684,"wires":[["5d5d93a2.79543c"]]},{"id":"73982323.f550ec","type":"template","z":"30517ddd.9e4af2","name":"css","field":"payload.style","fieldType":"msg","format":"html","syntax":"mustache","template":"table {\n    color: #333;\n    font-family: Helvetica, Arial, sans-serif;\n    width: 100%;\n    border-collapse: collapse;\n    border-spacing: 0;\n}\ntd, th {\n    border: 1px solid transparent;\n    /* No more visible border */\n    height: 30px;\n    transition: all 0.3s;\n    /* Simple transition for hover effect */\n}\nth {\n    background: #DFDFDF;\n    /* Darken header a bit */\n    font-weight: bold;\n}\ntd {\n    background: #FAFAFA;\n    text-align: center;\n}\n\n/* Cells in even rows (2,4,6...) are one color */\n\ntr:nth-child(even) td {\n    background: #F1F1F1;\n}\n\n/* Cells in odd rows (1,3,5...) are another (excludes header cells)  */\n\ntr:nth-child(odd) td {\n    background: #FEFEFE;\n}\ntr td:hover {\n    background: #666;\n    color: #FFF;\n}\n\n/* Hover cell effect! */","x":570.9999885559082,"y":161.99999046325684,"wires":[["bf71b538.0bf0b8"]]},{"id":"8c7f6e81.a0be8","type":"function","z":"30517ddd.9e4af2","name":"send mail","func":"\nif(!msg.body){\n    msg.body = env.get(\"body\")\n}\nif(!msg.topic){\nmsg.topic = env.get(\"topic\");   \n}\n\nreturn msg;","outputs":1,"noerr":0,"x":440.9999885559082,"y":161.99999046325684,"wires":[["73982323.f550ec"]]},{"id":"82acc61f.e3f268","type":"function","z":"1c882a73.955f76","name":"send message","func":"msg.url = +env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +env.get('ROOM_ID')+ '/send/m.room.message?access_token='+env.get('TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\nmsg.payload={\n        \"body\": env.get('message'), //\"This is an example text message\",\n        \"msgtype\": \"m.text\"\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":320,"y":260,"wires":[["500a0b64.708ce4"]]},{"id":"500a0b64.708ce4","type":"http request","z":"1c882a73.955f76","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":520,"y":260,"wires":[[]]},{"id":"9842aad4.d6a6a8","type":"http request","z":"468ab68b.786be8","name":"Create Contact by email","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":550,"y":220,"wires":[["e7dfcf35.0f3a4"]]},{"id":"e5e6d606.317378","type":"function","z":"468ab68b.786be8","name":"API","func":"msg.url = \"https://api.hubapi.com/contacts/v1/contact/?hapikey=\"+env.get('hubspot_api_key');\nmsg.roomId = msg.req.params.roomId\nvar load = msg.payload;\nif(load.email && load.firstname && load.lastname){\n  var dataString = {\n  \"properties\": [\n    {\n      \"property\": \"email\",\n      \"value\": msg.payload.email\n    },\n    {\n      \"property\": \"firstname\",\n      \"value\": msg.payload.firstname\n    },\n    {\n      \"property\": \"lastname\",\n      \"value\": msg.payload.lastname\n    },\n    {\n      \"property\": \"website\",\n      \"value\": msg.payload.website\n    },\n    {\n      \"property\": \"company\",\n      \"value\": msg.payload.company\n    },\n    {\n      \"property\": \"phone\",\n      \"value\": msg.payload.phone\n    }\n  ]\n}\nmsg.payload = dataString;\nreturn [msg,null];  \n}else{\n    return[null,msg];\n}\n\n","outputs":2,"noerr":0,"x":351,"y":229,"wires":[["9842aad4.d6a6a8"],["71a3c84b.620f08"]]},{"id":"e7dfcf35.0f3a4","type":"switch","z":"468ab68b.786be8","name":"","property":"payload.message","propertyType":"msg","rules":[{"t":"eq","v":"Contact already exists","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":777,"y":224,"wires":[[],["1b020433.5b363c"]]},{"id":"1b020433.5b363c","type":"switch","z":"468ab68b.786be8","name":"","property":"payload.vid","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":917,"y":244,"wires":[[],[]]},{"id":"4fc83f66.db4bd","type":"link in","z":"468ab68b.786be8","name":"","links":["ec720a64.e51c98","71a3c84b.620f08"],"x":939,"y":141,"wires":[[]]},{"id":"71a3c84b.620f08","type":"link out","z":"468ab68b.786be8","name":"","links":["4fc83f66.db4bd"],"x":455,"y":264,"wires":[]},{"id":"db8bd978.459ee8","type":"link in","z":"9c8fbc42.476be","name":"","links":["7129bcbb.f56c34","c476caba.03dec8","3e803112.4ad10e","d6f8779d.3b3c08","26f871a0.d51a3e"],"x":815,"y":160,"wires":[["de179e1a.df878"]]},{"id":"f8650e5f.33986","type":"Tekos out","z":"9c8fbc42.476be","name":"","bot":"e65bbf12.d7e23","x":440,"y":200,"wires":[]},{"id":"92e47762.827e98","type":"link out","z":"9c8fbc42.476be","name":"","links":["b24489b5.5c1268"],"x":245,"y":203,"wires":[]},{"id":"8e879bc8.7f2788","type":"link out","z":"9c8fbc42.476be","name":"start","links":["fb6d19ce.2289c8"],"x":375,"y":260,"wires":[],"info":"Link to onbording interaction"},{"id":"fb6d19ce.2289c8","type":"link in","z":"9c8fbc42.476be","name":"","links":["8e879bc8.7f2788","55b9255f.498e4c"],"x":595,"y":300,"wires":[["a529dfcb.5376e"]]},{"id":"4e930477.a4e66c","type":"chatbot-text","z":"9c8fbc42.476be","name":"Onbording","message":[{"message":"Hello, Welcome. My Name is Teksa, I'm asked my collegue, a human, to join our conversation 😃 "}],"x":854,"y":300,"wires":[["3301f50e.cc62ba","6d3eb641.e2ce58"]]},{"id":"3301f50e.cc62ba","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298","4b5a232d.4e28fc"],"x":955,"y":260,"wires":[]},{"id":"56165057.b3298","type":"link in","z":"9c8fbc42.476be","name":"TekosOut","links":["ba7ce9c5.aace78","a6129d24.0da04","cb322ea0.3631e","79844ae8.305824","3301f50e.cc62ba","48323382.384d2c","80533fcd.c4ae","2e1a67fc.b5ab68","efb78ffa.795f8","9780b1b7.e2d35","8e9b8033.42b7c","7b50f906.830de8","6019764.b9ad088","8b833035.834ae","700965d3.e3fc2c","76c70e2e.71396","4a48a08.e900e6","3b135afa.ba9bf6","24642811.787118","26d91ab7.570356","20f06907.6962d6","65c21c4.f4044e4","8ac227d9.f65d88","13e693de.0ee42c","9f869059.7c014","346e2f7.6bf54d","3db9cb7.b2f4634","713a3fcd.c7fc7","ab6c884f.043998","7252c493.fa00ac","423e6837.667528","15c7555f.ea072b","8799b02c.bda23","e53db452.889128","45d8540d.9a258c","6ca1f2b4.965cdc","51c72751.af9c98","ef8cca20.204848","b6e1939b.f46d7","f562994f.47a488","b25dd224.8228d","848f70f5.b68ac","a753e9ea.8444c8","ef358403.c9b3e8","7099eedf.f10f8","bc08308.6e726d","c9ea4cfb.7ba2f","5e9741e3.6dba6","5ca430e.c5866d","7aa2a2d8.8f825c","c4b32145.88b71","bdb94b32.4b2fb8","6e187b08.3be594","c5beba23.690178","916779f.feda788","21467d5e.ba91c2","59272024.cd32d","e2f3679e.be80f8","bd82a545.71abd8","4a9437e7.f8a038","51a60ec1.588d9","48bfa5f4.246bac","4687b71b.7fa6c8","b597d08e.b0c7b","7929bcde.f77764","5f599e01.38c13","4e83ab52.51dc84","c1ea86ab.91c628","44e53416.2e89ac","5d5fa886.29ed58","cc222265.74ade","4e19994d.993458","6984a4b2.93847c","ab4f8c9e.bed59","ead22a8f.61ee18","70a1a76a.2b8798","7cdc912b.354f7","50c864e9.ce303c","e8cbf7c5.403728","cc443cb8.660f4","e4c49a5c.8a3048","6b94e86b.aeafe8","6daca5bf.0593ec","87197028.d636e","df8e0a7e.4bb988","5e47bffc.f3b84","c03ca3ea.235ab","ae2c2da.9b56bd","254660ac.f08bf","fccb2d1f.89853","3f1936ea.e961ca","37b977be.ac61d8","6c0d248.5f710dc","e4b18a65.639fa8","bf5b5b0c.3b48c8","257530a7.5055c","a4935bf1.708638","fae501a3.cbaa2"],"x":329,"y":202,"wires":[["f8650e5f.33986"]]},{"id":"cd248150.9908a","type":"chatbot-generic-buttons","z":"9c8fbc42.476be","name":"Menu","buttons":[{"type":"postback","label":"Action 1","value":"action 1","alert":false},{"type":"url","label":"Visit Support Center","url":"https://tekos.freshdesk.com/a/solutions/articles/43000542170"}],"message":"Plans: ","x":1150,"y":160,"wires":[["cb322ea0.3631e","9725b9c9.f51148"]]},{"id":"cb322ea0.3631e","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":1235,"y":120,"wires":[]},{"id":"fb873ffb.279f2","type":"switch","z":"9c8fbc42.476be","name":"onbording","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"menu","vt":"str"},{"t":"eq","v":"services","vt":"str"},{"t":"eq","v":"start","vt":"str"},{"t":"eq","v":"talk to human","vt":"str"},{"t":"eq","v":"Contact Support","vt":"str"},{"t":"eq","v":"video","vt":"str"},{"t":"cont","v":"deploy template","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":8,"x":200,"y":860,"wires":[["c476caba.03dec8"],["c476caba.03dec8"],["55b9255f.498e4c"],["91f10d1e.8e601"],["91f10d1e.8e601"],["ce9f9824.16e988"],["e1ed7b8f.04fc28"],["d90fea52.ce36d8"]]},{"id":"279d002f.28752","type":"link in","z":"9c8fbc42.476be","name":"","links":["5893370.a6ee9c8"],"x":563,"y":884,"wires":[["10565f99.87c63"]]},{"id":"10565f99.87c63","type":"chatbot-text","z":"9c8fbc42.476be","name":"Fallback","message":[{"message":"Désolé je n'ai pas compris votre message 😃"},{"message":"Je suis encore un bot"}],"x":674,"y":882,"wires":[["a6129d24.0da04"]]},{"id":"a6129d24.0da04","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":778.0000286102295,"y":882.0000896453857,"wires":[]},{"id":"3e803112.4ad10e","type":"link out","z":"9c8fbc42.476be","name":"","links":["db8bd978.459ee8"],"x":875,"y":200,"wires":[]},{"id":"c476caba.03dec8","type":"link out","z":"9c8fbc42.476be","name":"","links":["db8bd978.459ee8"],"x":419,"y":779,"wires":[]},{"id":"55b9255f.498e4c","type":"link out","z":"9c8fbc42.476be","name":"","links":["fb6d19ce.2289c8"],"x":419,"y":819,"wires":[]},{"id":"4b580fb5.e3f93","type":"link out","z":"9c8fbc42.476be","name":"","links":["83b71f9e.f5496"],"x":419,"y":1058,"wires":[]},{"id":"91f10d1e.8e601","type":"link out","z":"9c8fbc42.476be","name":"","links":["74712369.9a7b1c","146071e.c8df58e","2fceaeb5.3c97f2"],"x":419,"y":860,"wires":[]},{"id":"85b478be.b47a48","type":"switch","z":"9c8fbc42.476be","name":"actions","property":"payload","propertyType":"msg","rules":[{"t":"eq","v":"action 1","vt":"str"},{"t":"eq","v":"action 2","vt":"str"},{"t":"else"}],"checkall":"false","repair":false,"outputs":3,"x":208,"y":1124,"wires":[["4b580fb5.e3f93"],["ce41a7b4.3b6e78"],["4122874.51f9278"]]},{"id":"ce41a7b4.3b6e78","type":"link out","z":"9c8fbc42.476be","name":"","links":["83d73190.c1bf7"],"x":419,"y":1102,"wires":[]},{"id":"83d73190.c1bf7","type":"link in","z":"9c8fbc42.476be","name":"","links":["ce41a7b4.3b6e78","ce9f9824.16e988"],"x":515,"y":1180,"wires":[["d42b85be.c4abb8"]]},{"id":"6d3eb641.e2ce58","type":"chatbot-text","z":"9c8fbc42.476be","name":"capabilites","message":[{"message":"How can I help you today ?"}],"x":1050,"y":300,"wires":[["ef358403.c9b3e8","37f8b278.71f27e"]]},{"id":"ef358403.c9b3e8","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":1155,"y":280,"wires":[]},{"id":"f62c2ee8.588ef","type":"Tekos in","z":"9c8fbc42.476be","name":"","bot":"e65bbf12.d7e23","x":150,"y":203,"wires":[["92e47762.827e98"]]},{"id":"1be0dc06.d713d4","type":"chatbot-text","z":"9c8fbc42.476be","name":"will connect ","message":[{"message":"ok, i'll try to find a human connected. \nYou can also rise a support ticket here: https://tekos.freshdesk.com/support/tickets/new\n\n"}],"x":684,"y":972,"wires":[["6e187b08.3be594"]]},{"id":"6e187b08.3be594","type":"link out","z":"9c8fbc42.476be","name":"","links":["677b0cc5.72afa4","ae715241.a6aa1","56165057.b3298"],"x":805,"y":928,"wires":[]},{"id":"2fceaeb5.3c97f2","type":"link in","z":"9c8fbc42.476be","name":"","links":["60628679.a9a3b8","91f10d1e.8e601","cb5f2660.8441d8"],"x":564.9999713897705,"y":971.9999103546143,"wires":[["1be0dc06.d713d4"]]},{"id":"b24489b5.5c1268","type":"link in","z":"9c8fbc42.476be","name":"","links":["92e47762.827e98"],"x":55,"y":300,"wires":[["d77ea64d.b2fe68"]]},{"id":"fecf3017.0f271","type":"inject","z":"9c8fbc42.476be","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":40,"wires":[["c830ce4.e9b8d3"]]},{"id":"83b71f9e.f5496","type":"link in","z":"9c8fbc42.476be","name":"","links":["4b580fb5.e3f93","c939c4e7.7e3238","9e9ce9fa.f46ae8","87fec19b.2393a","f860a85e.919d08"],"x":563,"y":1024,"wires":[[]]},{"id":"c830ce4.e9b8d3","type":"subflow:9b782c32.24018","z":"9c8fbc42.476be","name":"","env":[{"name":"NAME","value":"Tekos Test","type":"str"},{"name":"AVATAR","value":"mxc://m.tekos.co/PcQNEQaOanMsjrvSTnZtOLKG","type":"str"}],"x":362,"y":41,"wires":[[]]},{"id":"6113902d.5059a","type":"link in","z":"9c8fbc42.476be","name":"","links":["ac637e20.539e","4122874.51f9278"],"x":55,"y":500,"wires":[["efb22fd9.68d69"]]},{"id":"d90fea52.ce36d8","type":"link out","z":"9c8fbc42.476be","name":"","links":["59ab4824.7ca398"],"x":419,"y":939,"wires":[]},{"id":"59ab4824.7ca398","type":"link in","z":"9c8fbc42.476be","name":"","links":["d90fea52.ce36d8"],"x":83,"y":1124,"wires":[["85b478be.b47a48"]]},{"id":"4a4880d3.2a512","type":"link out","z":"9c8fbc42.476be","name":"","links":["77f1b3ca.4d21ac"],"x":375,"y":300,"wires":[]},{"id":"77f1b3ca.4d21ac","type":"link in","z":"9c8fbc42.476be","name":"","links":["4a4880d3.2a512","aaac7a2a.fe3f58"],"x":67,"y":869,"wires":[["fb873ffb.279f2"]]},{"id":"4122874.51f9278","type":"link out","z":"9c8fbc42.476be","name":"","links":["b1200440.54a4e8","6113902d.5059a"],"x":423,"y":1184,"wires":[]},{"id":"9725b9c9.f51148","type":"chatbot-generic-buttons","z":"9c8fbc42.476be","name":"Menu","buttons":[{"type":"postback","label":"Talk to our team","value":"talk to human","alert":false},{"type":"postback","label":"create your action","value":"action 2","alert":false}],"message":"Account","x":1290,"y":160,"wires":[["87197028.d636e"]]},{"id":"87197028.d636e","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":1375,"y":300,"wires":[]},{"id":"169baa3a.2de206","type":"link in","z":"9c8fbc42.476be","name":"","links":["aff23b44.afa338","8dbc066a.1ddb08"],"x":955,"y":340,"wires":[["6d3eb641.e2ce58"]]},{"id":"fbe227b3.5c3508","type":"chatbot-generic-buttons","z":"9c8fbc42.476be","name":"handover ?","buttons":[{"type":"postback","label":"Talk to human","value":"Talk to human","alert":false}],"message":"Do you need to talk to a human ?","x":1290,"y":80,"wires":[[]]},{"id":"9aacee.88d1931","type":"link in","z":"9c8fbc42.476be","name":"","links":[],"x":1185,"y":80,"wires":[["fbe227b3.5c3508"]]},{"id":"e1ed7b8f.04fc28","type":"link out","z":"9c8fbc42.476be","name":"","links":["51848f1c.38d28"],"x":419,"y":904,"wires":[]},{"id":"37f8b278.71f27e","type":"chatbot-text","z":"9c8fbc42.476be","name":"emoji","message":[{"message":"🤗"}],"x":1230,"y":300,"wires":[["e4b18a65.639fa8","2809c49d.a61d3c"]]},{"id":"e4b18a65.639fa8","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298"],"x":1315,"y":280,"wires":[]},{"id":"de179e1a.df878","type":"chatbot-text","z":"9c8fbc42.476be","name":"","message":[{"message":"This is the main Menu 😎 "}],"x":940,"y":160,"wires":[["cd248150.9908a","bf5b5b0c.3b48c8"]]},{"id":"bf5b5b0c.3b48c8","type":"link out","z":"9c8fbc42.476be","name":"","links":["56165057.b3298","4b5a232d.4e28fc"],"x":1035,"y":140,"wires":[]},{"id":"c249a546.485808","type":"comment","z":"9c8fbc42.476be","name":"Use NLP service","info":"","x":268,"y":1184,"wires":[]},{"id":"5d27b77b.3ab328","type":"function","z":"c8082d07.b6dbe","name":"typing status","func":"msg.url = 'https://'+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/typing/' +env.get('TEKOS_BOT_ID')+ '?access_token=' + env.get('TEKOS_BOT_TOKEN')\n\nmsg.headers ={\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload={\n  \"typing\": true,\n  \"timeout\": 3000\n}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":410,"y":80,"wires":[["627365f5.3894ec"]]},{"id":"627365f5.3894ec","type":"http request","z":"c8082d07.b6dbe","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":610,"y":80,"wires":[["ce6ac7e2.adaae8"]]},{"id":"ce6ac7e2.adaae8","type":"delay","z":"c8082d07.b6dbe","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":780,"y":80,"wires":[[]]},{"id":"8e3f6844.bef968","type":"delay","z":"c8082d07.b6dbe","name":"","pauseType":"delay","timeout":"1","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":240,"y":80,"wires":[["5d27b77b.3ab328"]]},{"id":"a529dfcb.5376e","type":"subflow:c8082d07.b6dbe","z":"9c8fbc42.476be","name":"","env":[],"x":710,"y":300,"wires":[["4e930477.a4e66c"]]},{"id":"6364faca.b4a7b4","type":"link in","z":"9c8fbc42.476be","name":"","links":["5893370.a6ee9c8"],"x":55,"y":560,"wires":[["441504e2.d776ec"]]},{"id":"441504e2.d776ec","type":"chatbot-text","z":"9c8fbc42.476be","name":"Fallback","message":[{"message":"Désolé je n'ai pas compris votre message 😃"},{"message":"Je suis encore un bot"}],"x":166,"y":558,"wires":[["470b6ec1.adfb1"]]},{"id":"470b6ec1.adfb1","type":"link out","z":"9c8fbc42.476be","name":"","links":["bbf29bc7.eb9a88"],"x":270.0000286102295,"y":558.0000896453857,"wires":[]},{"id":"efb22fd9.68d69","type":"dialogflowv2","z":"9c8fbc42.476be","dialogflow":"4fe304a9.fffffc","language":"en","debug":false,"variable":"topic","x":180,"y":500,"wires":[["4d9a5ce5.eca8d4"]]},{"id":"bbed75ea.cafd38","type":"switch","z":"9c8fbc42.476be","name":"action","property":"_dialogflow.action","propertyType":"msg","rules":[{"t":"eq","v":"show_menu","vt":"str"},{"t":"eq","v":"give_capabilities","vt":"str"},{"t":"eq","v":"handover_request","vt":"str"},{"t":"eq","v":"invite_to_room","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":5,"x":490,"y":500,"wires":[["abd2390b.c9db58"],["fc6c018a.da398"],["cc0d0f37.9a2b9"],["c78dc032.1b2df"],["bcbd8e38.ed75c"]]},{"id":"bcbd8e38.ed75c","type":"change","z":"9c8fbc42.476be","name":"msg","rules":[{"t":"set","p":"payload","pt":"msg","to":"_dialogflow.fulfillmentMessages[0].text.text[0]","tot":"msg"}],"action":"","property":"","from":"","to":"","reg":false,"x":675,"y":560,"wires":[["9b943925.b11ef8"]],"l":false},{"id":"abd2390b.c9db58","type":"link out","z":"9c8fbc42.476be","name":"","links":["eefdb4c9.9bd638"],"x":675,"y":380,"wires":[]},{"id":"fc6c018a.da398","type":"link out","z":"9c8fbc42.476be","name":"","links":["bafe1309.ead79","fcda4a3b.dab258"],"x":675,"y":418,"wires":[]},{"id":"cc0d0f37.9a2b9","type":"link out","z":"9c8fbc42.476be","name":"","links":["307a2e8c.dc52b2"],"x":675,"y":440,"wires":[]},{"id":"11c35644.32be9a","type":"link out","z":"9c8fbc42.476be","name":"","links":["5dc70f13.28596"],"x":675,"y":522,"wires":[]},{"id":"c78dc032.1b2df","type":"link out","z":"9c8fbc42.476be","name":"","links":["b3cc5e8b.75542"],"x":675,"y":480,"wires":[]},{"id":"9b943925.b11ef8","type":"chatbot-text","z":"9c8fbc42.476be","name":"fullfillment message","message":[{"message":""}],"x":810,"y":560,"wires":[["a4935bf1.708638"]]},{"id":"a4935bf1.708638","type":"link out","z":"9c8fbc42.476be","name":"","links":["bbf29bc7.eb9a88","56165057.b3298","8df4a57c.1356c8"],"x":935,"y":560,"wires":[]},{"id":"4d9a5ce5.eca8d4","type":"subflow:c8082d07.b6dbe","z":"9c8fbc42.476be","name":"","env":[],"x":340,"y":500,"wires":[["bbed75ea.cafd38"]]},{"id":"594616c4.142e48","type":"function","z":"be6d1230.c6132","name":"Matrix API","func":"\n\nmsg.url = \"https://\"+env.get('BASE_URL')+\"/_matrix/client/r0/user/\"+env.get('user')+\"/rooms/\"+env.get('room')+\"/tags/\"+env.get('tag')+\"?access_token=\"+env.get('token')\nmsg.payload = {\n\n  \"order\": 0.25\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":190,"y":80,"wires":[["8fa013a1.c0816"]]},{"id":"8fa013a1.c0816","type":"http request","z":"be6d1230.c6132","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":370,"y":80,"wires":[["c500e6b8.836aa8"]]},{"id":"c500e6b8.836aa8","type":"debug","z":"be6d1230.c6132","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":560,"y":160,"wires":[]},{"id":"4829f7b0.dda9f8","type":"inject","z":"9c8fbc42.476be","name":"","topic":"","payload":"","payloadType":"date","repeat":"","crontab":"","once":false,"onceDelay":0.1,"x":120,"y":80,"wires":[["74c6819f.4933c"]]},{"id":"f3b1d6fd.3d5108","type":"debug","z":"9c8fbc42.476be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":430,"y":80,"wires":[]},{"id":"74c6819f.4933c","type":"process-env","z":"9c8fbc42.476be","name":"","into":"payload","x":290,"y":80,"wires":[["f3b1d6fd.3d5108"]]},{"id":"ce9f9824.16e988","type":"link out","z":"9c8fbc42.476be","name":"","links":["83d73190.c1bf7"],"x":463,"y":884,"wires":[]},{"id":"2538d75d.d00fe8","type":"subflow:509dfe6d.39977","z":"9c8fbc42.476be","name":"","env":[],"x":690,"y":1100,"wires":[["1412e853.a5a2d8"]]},{"id":"5f9f0ad0.11ae74","type":"subflow:78fafaed.cd65d4","z":"9c8fbc42.476be","name":"","env":[],"x":700,"y":1220,"wires":[["1412e853.a5a2d8"]]},{"id":"2809c49d.a61d3c","type":"subflow:d0bf3750.bcab08","z":"9c8fbc42.476be","name":"","env":[{"name":"Operator","value":"@miled.essaafi:m.tekos.co","type":"str"}],"x":1190,"y":360,"wires":[]},{"id":"6ca308c1.6b4dd8","type":"switch","z":"d80133c6.592fe","name":"Operation ? ","property":"operation","propertyType":"env","rules":[{"t":"eq","v":"add","vt":"str"},{"t":"eq","v":"purge","vt":"str"},{"t":"else"}],"checkall":"true","repair":false,"outputs":3,"x":378,"y":88,"wires":[["3eb51baa.2b06b4"],["c65e2439.4fe198"],["86a2bba6.e7a368"]]},{"id":"86a2bba6.e7a368","type":"link out","z":"d80133c6.592fe","name":"","links":[],"x":521,"y":132,"wires":[]},{"id":"3eb51baa.2b06b4","type":"switch","z":"d80133c6.592fe","name":"","property":"roomId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":578,"y":22,"wires":[["121ca355.04a20d"],[]]},{"id":"121ca355.04a20d","type":"switch","z":"d80133c6.592fe","name":"","property":"payload.eventId","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":732,"y":22,"wires":[["b27cd33d.f87e5"],["caa3ab1.4208158"]]},{"id":"b27cd33d.f87e5","type":"function","z":"d80133c6.592fe","name":"add event id","func":"let roomId = msg.roomId.replace(/\\./g,'_')\nroomId = roomId.replace('!','');\nlet events;\nnode.warn(\"start add event id 1\")\nnode.warn(msg.payload);\nif(global.get(\"event@payload.\"+roomId)){\n    events = global.get(\"event@payload.\"+roomId);\n    events.push(msg.payload.eventId);\n    global.set(\"event@payload.\"+roomId,events);\n\n}else{\n    events = [];\n    events.push(msg.payload.eventId);\n    global.set(\"event@payload.\"+roomId,events);\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":906,"y":22,"wires":[[]]},{"id":"68a98592.2aa23c","type":"function","z":"d80133c6.592fe","name":"get operation","func":"node.warn(\"get operation\");\nnode.warn(msg);\nif(!msg.payload){\n    msg.payload = {};\n}\nnode.warn(env.get(\"operation\"));\nif(env.get(\"operation\") == \"add\"){\n    msg.payload.operation = \"add\";\n    msg.payload.eventId = msg.payload.event_id;\n    return [msg,null];\n}else if(env.get(\"operation\") == \"purge\"){\n        msg.payload.operation = \"purge\";\nnode.warn(msg);\n\n    return [msg,null];\n\n}else{\n        return [null,msg];\n\n}\n","outputs":2,"noerr":0,"x":202,"y":88,"wires":[["6ca308c1.6b4dd8"],[]]},{"id":"c65e2439.4fe198","type":"function","z":"d80133c6.592fe","name":"delete all eventid id in room","func":"node.warn(\"start delete\");\nlet roomId = msg.roomId.replace(/\\./g,'_')\nroomId = roomId.replace('!','');\n\nvar eventid = global.get(\"event@payload.\"+roomId);\nnode.warn(eventid)\nnode.warn(eventid.length);\n if(eventid){\n    for (let i = 0; i < eventid.length; i++) {\n    node.warn(eventid[i]);\n     msg.url =  \"https://m.tekos.co/_matrix/client/r0/rooms/\"+msg.roomId+\"/redact/\"+eventid[i]+\"/1?access_token=\"+env.get('token');\n     msg.payload={\"reason\": \"Indecent material\"}\n     node.send(msg);\n     }\n global.set(\"event@payload.\"+roomId,[]);\n\n }\n\n","outputs":2,"noerr":0,"x":670,"y":88,"wires":[["c1bff0de.ce4c8"],[]]},{"id":"c1bff0de.ce4c8","type":"http request","z":"d80133c6.592fe","name":"","method":"PUT","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":906,"y":88,"wires":[["9532b926.11a948"]]},{"id":"9532b926.11a948","type":"debug","z":"d80133c6.592fe","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":1062,"y":66,"wires":[]},{"id":"caa3ab1.4208158","type":"link out","z":"d80133c6.592fe","name":"","links":[],"x":829,"y":44,"wires":[]},{"id":"5e77e990.7fd5b8","type":"switch","z":"d80133c6.592fe","name":"","property":"payload.event_id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":622,"y":264,"wires":[["4b539bb9.c44e14"],["b81bba76.1ef768"]]},{"id":"c9a3e937.3282f8","type":"link in","z":"d80133c6.592fe","name":"","links":[],"x":521,"y":264,"wires":[["5e77e990.7fd5b8"]]},{"id":"4b539bb9.c44e14","type":"function","z":"d80133c6.592fe","name":"add event id","func":"let roomId = msg.roomId.replace(/\\./g,'_')\nroomId = roomId.replace('!','');\nlet events;\nnode.warn(\"start add event id 2\")\nnode.warn(msg.payload);\nif(global.get(\"event@payload.\"+roomId)){\n    events = global.get(\"event@payload.\"+roomId);\n    events.push(msg.payload.event_id);\n    global.set(\"event@payload.\"+roomId,events);\n\n}else{\n    events = [];\n    events.push(msg.payload.event_id);\n    global.set(\"event@payload.\"+roomId,events);\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":796,"y":242,"wires":[[]]},{"id":"b81bba76.1ef768","type":"switch","z":"d80133c6.592fe","name":"","property":"id","propertyType":"msg","rules":[{"t":"nnull"},{"t":"else"}],"checkall":"true","repair":false,"outputs":2,"x":798,"y":308,"wires":[["d6767fd.511808"],[]]},{"id":"d6767fd.511808","type":"function","z":"d80133c6.592fe","name":"add event id","func":"let roomId = msg.roomId.replace(/\\./g,'_')\nroomId = roomId.replace('!','');\nlet events;\nnode.warn(\"start add event id 3\")\nnode.warn(msg.id);\nif(global.get(\"event@payload.\"+roomId)){\n    events = global.get(\"event@payload.\"+roomId);\n    events.push(msg.id);\n    global.set(\"event@payload.\"+roomId,events);\n\n}else{\n    events = [];\n    events.push(msg.id);\n    global.set(\"event@payload.\"+roomId,events);\n\n}\nreturn msg;","outputs":1,"noerr":0,"x":950,"y":308,"wires":[[]]},{"id":"d7b7d0c5.bef81","type":"file","z":"5f8bd47a.7b805c","name":"","filename":"audio.wav","appendNewline":true,"createDir":false,"overwriteFile":"true","encoding":"none","x":520,"y":80,"wires":[["487b9126.0e1af"]]},{"id":"487b9126.0e1af","type":"base64","z":"5f8bd47a.7b805c","name":"","action":"","property":"payload","x":680,"y":80,"wires":[["44c2e5b6.d9145c"]]},{"id":"44c2e5b6.d9145c","type":"function","z":"5f8bd47a.7b805c","name":"upload","func":"msg.url = \"https://\"+env.get('homeserver')+\"/_matrix/media/r0/upload?filename=audio.wav&access_token=\"+env.get('token')\n\nvar audio = msg.payload;\nvar base64data = new Buffer(audio, 'base64');\nmsg.payload = base64data;\nmsg.headers ={\n    \"Content-type\": \"audio/wav\"\n}\n\nreturn msg;","outputs":1,"noerr":0,"x":830,"y":80,"wires":[["9106793b.ed1148"]]},{"id":"9106793b.ed1148","type":"http request","z":"5f8bd47a.7b805c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":970,"y":80,"wires":[["597dd51c.0cd6cc"]]},{"id":"2b4c8bfd.e5aed4","type":"function","z":"5f8bd47a.7b805c","name":"set room","func":"//msg.roomId = '!LAMIpamy.tekos.co'\nvar audiofile = msg.payload.content_uri\nvar delay = +env.get('delay')\nmsg.url = \"https://\"+env.get('homeserver')+\"/_matrix/client/r0/rooms/\"+msg.roomId+\"/send/m.room.message?access_token=\"+env.get('token')\nmsg.payload={\n      \"msgtype\": \"m.audio\",\n        \"url\": audiofile,\n     \"body\": \"Tekos Bot\",\n}\nnode.warn(msg.url)\nreturn msg;","outputs":1,"noerr":0,"x":280,"y":200,"wires":[["e5d372bf.4de73"]]},{"id":"e5d372bf.4de73","type":"http request","z":"5f8bd47a.7b805c","name":"","method":"POST","ret":"obj","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":450,"y":200,"wires":[["1c781da6.b28f02","6b89909f.3d734"]]},{"id":"1c781da6.b28f02","type":"debug","z":"5f8bd47a.7b805c","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"true","targetType":"full","x":590,"y":140,"wires":[]},{"id":"a96ebca1.e1f01","type":"ffmpeg-conversion","z":"5f8bd47a.7b805c","name":"","format":"wav","audiochannels":"mono","x":330,"y":80,"wires":[["d7b7d0c5.bef81"]]},{"id":"7da02991.f00438","type":"link in","z":"5f8bd47a.7b805c","name":"","links":["597dd51c.0cd6cc"],"x":155,"y":200,"wires":[["2b4c8bfd.e5aed4"]]},{"id":"597dd51c.0cd6cc","type":"link out","z":"5f8bd47a.7b805c","name":"","links":["7da02991.f00438"],"x":1095,"y":80,"wires":[]},{"id":"6b89909f.3d734","type":"subflow:d80133c6.592fe","z":"5f8bd47a.7b805c","name":"","env":[],"x":290,"y":280,"wires":[["f6064389.ee389"]]},{"id":"f6064389.ee389","type":"delay","z":"5f8bd47a.7b805c","name":"","pauseType":"delay","timeout":"5","timeoutUnits":"seconds","rate":"1","nbRateUnits":"1","rateUnits":"second","randomFirst":"1","randomLast":"5","randomUnits":"seconds","drop":false,"x":500,"y":280,"wires":[["73924fdc.c8121"]]},{"id":"73924fdc.c8121","type":"subflow:d80133c6.592fe","z":"5f8bd47a.7b805c","name":"","env":[{"name":"operation","value":"purge","type":"str"}],"x":710,"y":280,"wires":[[]]},{"id":"f9e0c0fd.a0ec1","type":"template","z":"9c8fbc42.476be","name":"Expressive SSML","field":"payload","fieldType":"msg","format":"handlebars","syntax":"mustache","template":"<express-as type=\"GoodNews\">\n {{payload.content}}\n</express-as>","output":"str","x":830,"y":620,"wires":[["8149d518.ac2948"]]},{"id":"8149d518.ac2948","type":"watson-text-to-speech","z":"9c8fbc42.476be","name":"Tekos TTS","lang":"en-US","langhidden":"en-US","langcustom":"NoCustomisationSetting","langcustomhidden":"","voice":"en-US_AllisonVoice","voicehidden":"en-US_AllisonVoice","format":"audio/mp3","password":"Miloud4!","apikey":"iQpk9TQqv-HW6oFDQkuWFtU_yeb9C76F0mXoK3vLrmJt","payload-response":true,"service-endpoint":"https://stream-fra.watsonplatform.net/text-to-speech/api","x":1010,"y":620,"wires":[["c39da4e5.266578"]]},{"id":"c39da4e5.266578","type":"subflow:5f8bd47a.7b805c","z":"9c8fbc42.476be","name":"Send Audio","env":[{"name":"token","value":"TEKOS_BOT_TOKEN","type":"env"},{"name":"room_id","value":"!LAMIpamyCBxUOVQhii:m.tekos.co","type":"str"}],"x":1170,"y":620,"wires":[]},{"id":"5657774b.80ada8","type":"comment","z":"9c8fbc42.476be","name":"https://console.bluemix.net/docs/services/text-to-speech/SSML-expressive.html","info":"","x":1040,"y":740,"wires":[]},{"id":"1095e30b.ae5ebd","type":"comment","z":"9c8fbc42.476be","name":"<express-as type=\"GoodNews\">   I have good news: I was able to reduce the payments on your monthly bill! </express-as>","info":"","x":1170,"y":780,"wires":[]},{"id":"2474bac6.47a706","type":"comment","z":"9c8fbc42.476be","name":"or Link to Audio out (NR Dashbaord)","info":"","x":1400,"y":700,"wires":[]},{"id":"8df4a57c.1356c8","type":"link in","z":"9c8fbc42.476be","name":"","links":["a4935bf1.708638"],"x":695,"y":620,"wires":[["f9e0c0fd.a0ec1"]]},{"id":"d77ea64d.b2fe68","type":"subflow:fde10ab5.552fe8","z":"9c8fbc42.476be","name":"","x":210,"y":300,"wires":[["8e879bc8.7f2788"],["4a4880d3.2a512"],["4a4880d3.2a512"],[],[],[]]},{"id":"736db747.a50338","type":"subflow:afeae1e.cea212","z":"9c8fbc42.476be","name":"","env":[],"x":690,"y":1140,"wires":[]},{"id":"1412e853.a5a2d8","type":"debug","z":"9c8fbc42.476be","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":910,"y":1180,"wires":[]},{"id":"e3d878c3.798be8","type":"node-red-contrib-httpauth","z":"9c8fbc42.476be","name":"","file":"","cred":"","authType":"Basic","realm":"","username":"","password":"","hashed":false,"x":380,"y":1280,"wires":[[]]},{"id":"c15cb14f.e8514","type":"function","z":"9426deac.34161","name":"send message","func":"msg.url = \"https://\"+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\n\nmsg.payload=env.get('message')\n//msg.payload={\n      //  \"body\": env.get('message'), //\"This is an example text message\",\n       // \"msgtype\": \"m.text\"\n//}\n\nreturn msg;\n","outputs":1,"noerr":0,"x":240,"y":120,"wires":[["9e117e.b6dede8"]]},{"id":"9e117e.b6dede8","type":"http request","z":"9426deac.34161","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":410,"y":120,"wires":[[]]},{"id":"db6ba47d.e196c8","type":"subflow:9426deac.34161","z":"9c8fbc42.476be","name":"","env":[],"x":700,"y":1180,"wires":[["1412e853.a5a2d8"]]},{"id":"c57565a7.64c448","type":"function","z":"439dde3b.17574","name":"send message","func":"msg.url = \"https://\"+env.get('BASE_URL')+'/_matrix/client/r0/rooms/' +msg.roomId+ '/send/m.room.message?access_token='+env.get('TOKEN')\nmsg.headers ={\n //   \"Authorization\" : \"Bearer sk_test_LYtqjhDKfkXv3fOmb4PT4va400SSWORV4p\",\n    \"Content-type\": \"application/json\"\n}\n\n\nmsg.payload={\n\t\"body\":\"\",\n\t\"msgtype\":\"m.text\",\n      \"calendly\":{\n    \t\"url\":env.get('cal_url'),\n    \t\"text\":env.get('cta') \n    \t}\n}\n\nreturn msg;\n\n\n","outputs":1,"noerr":0,"x":280,"y":140,"wires":[["9e4c8431.aaad48"]]},{"id":"9e4c8431.aaad48","type":"http request","z":"439dde3b.17574","name":"","method":"POST","ret":"txt","paytoqs":false,"url":"","tls":"","persist":false,"proxy":"","authType":"","x":450,"y":140,"wires":[["ae8d6d8e.b6adf"]]},{"id":"d42b85be.c4abb8","type":"subflow:439dde3b.17574","z":"9c8fbc42.476be","name":"","env":[{"name":"cal_url","value":"mohamedayoubghaddab/15min","type":"str"}],"x":740,"y":1300,"wires":[]},{"id":"ae8d6d8e.b6adf","type":"debug","z":"439dde3b.17574","name":"","active":true,"tosidebar":true,"console":false,"tostatus":false,"complete":"false","x":650,"y":140,"wires":[]}]